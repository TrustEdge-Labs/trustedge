# Copyright (c) 2025 TRUSTEDGE LABS LLC
# MPL-2.0: https://mozilla.org/MPL/2.0/
# Project: trustedge — Privacy and trust at the edge.

name: CI
permissions:
  contents: read

on:
  push:
    branches: [ main ]
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ── Fast checks (no Rust compilation) ─────────────────────────
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: fmt
        run: cargo fmt --all -- --check

      - name: Copyright headers
        run: |
          missing=0
          while IFS= read -r file; do
            if ! head -10 "$file" | grep -q "Copyright (c) 2025 TRUSTEDGE LABS LLC"; then
              echo "Missing copyright header: $file"
              missing=$((missing + 1))
            fi
          done < <(find . -type f \( -name "*.rs" -o -name "*.yml" -o -name "*.yaml" -o -name "*.toml" \) \
            -not -path "./target/*" -not -path "./.git/*" -not -path "./.planning/*")
          if [ $missing -gt 0 ]; then
            echo "::error::$missing files missing copyright headers. Run: ./scripts/fix-copyright.sh"
            exit 1
          fi

      - name: TODO hygiene
        run: |
          count=$(grep -rn '// TODO\|// FIXME\|// HACK\|// XXX\|todo!()\|unimplemented!()' \
            --include="*.rs" crates/ 2>/dev/null | wc -l || echo 0)
          if [ "$count" -gt 0 ]; then
            echo "::error::Found $count unimplemented TODO/FIXME/HACK/XXX markers"
            grep -rn '// TODO\|// FIXME\|// HACK\|// XXX\|todo!()\|unimplemented!()' \
              --include="*.rs" crates/ || true
            exit 1
          fi

      - name: Secret struct derive check
        run: |
          ok=true
          for file_struct in \
            "crates/core/src/backends/yubikey.rs:YubiKeyConfig" \
            "crates/core/src/backends/software_hsm.rs:SoftwareHsmConfig" \
            "crates/platform/src/ca/models.rs:LoginRequest" \
            "crates/platform/src/ca/mod.rs:CAConfig"; do
            FILE="${file_struct%%:*}"
            STRUCT="${file_struct##*:}"
            if grep -B2 "pub struct $STRUCT" "$FILE" | grep -q "Serialize"; then
              echo "::error::$STRUCT in $FILE has Serialize derive (forbidden on secret-holding structs)"
              ok=false
            fi
            if ! grep -q "REDACTED" "$FILE"; then
              echo "::error::$STRUCT in $FILE missing [REDACTED] in Debug impl"
              ok=false
            fi
          done
          [ "$ok" = true ]

  # ── Clippy + feature compatibility + WASM ─────────────────────
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@cargo-hack

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libpcsclite-dev pkg-config pkgconf

      - name: clippy (all buildable features)
        run: |
          cargo clippy -p trustedge-core --all-targets --all-features -- -D warnings
          cargo clippy -p trustedge-platform --all-targets --features "http,ca,openapi,yubikey" -- -D warnings
          cargo clippy -p trustedge-platform-server --all-targets -- -D warnings
          cargo clippy -p trustedge-cli --all-targets --all-features -- -D warnings
          cargo clippy -p trustedge-trst-cli --all-targets -- -D warnings
          cargo clippy -p trustedge-trst-protocols --all-targets -- -D warnings
          cargo clippy -p trustedge-types --all-targets -- -D warnings
          cargo clippy -p trustedge-wasm --all-targets -- -D warnings
          cargo clippy -p trustedge-trst-wasm --all-targets -- -D warnings

      - name: Feature compatibility (each feature individually)
        run: |
          cargo hack check --each-feature --no-dev-deps --package trustedge-core
          cargo hack check --each-feature --no-dev-deps --package trustedge-cli

      - name: WASM build verification
        run: |
          rustup target add wasm32-unknown-unknown
          cargo check -p trustedge-wasm --target wasm32-unknown-unknown
          cargo check -p trustedge-trst-wasm --target wasm32-unknown-unknown

      - name: Dependency tree size
        run: |
          dep_count=$(cargo tree --workspace --depth 1 --prefix none --no-dedupe 2>/dev/null | sort -u | wc -l)
          echo "Dependency tree: $dep_count unique crates (baseline: 70)"
          if [ "$dep_count" -gt 80 ]; then
            echo "::warning::Dependency tree grew beyond threshold ($dep_count > 80)"
          fi

  # ── Build + test ──────────────────────────────────────────────
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libpcsclite-dev pkg-config pkgconf

      - name: Build workspace (all buildable features, excludes postgres — sqlx removed)
        run: |
          cargo build -p trustedge-core --bins --all-features
          cargo build -p trustedge-platform --bins --features "http,ca,openapi,yubikey"
          cargo build -p trustedge-platform-server --bins
          cargo build -p trustedge-cli --bins --all-features
          cargo build -p trustedge-trst-cli --bins
          cargo build --workspace --bins --no-default-features

      - name: Test workspace (no default features)
        run: cargo test --workspace --no-default-features --locked

      - name: Test trustedge-core (all non-yubikey features)
        run: cargo test -p trustedge-core --features "audio,git-attestation,keyring,insecure-tls" --locked

      - name: Test trustedge-core (yubikey simulation)
        run: cargo test -p trustedge-core --features yubikey --lib --locked

      - name: Test trustedge-platform features
        run: |
          cargo test -p trustedge-platform --lib --locked
          cargo test -p trustedge-platform --test verify_integration --locked
          cargo test -p trustedge-platform --test verify_integration --features http --locked

  # ── Security audit ────────────────────────────────────────────
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@cargo-audit
      - uses: taiki-e/install-action@cargo-semver-checks

      - name: Security audit
        run: cargo audit

      - name: API compatibility
        continue-on-error: true
        run: cargo semver-checks --package trustedge-core --baseline-rev HEAD~1
