# Codebase Concerns

**Analysis Date:** 2026-02-09

## Tech Debt

**Certificate Handling in QUIC Transport (Placeholder Keys):**
- Issue: Development mode uses hardcoded placeholder private keys and accepts any server certificate
- Files: `crates/core/src/transport/quic.rs` (lines 76-93, 152-171)
- Impact: The `create_client_endpoint()` uses `SkipServerVerification` which accepts any TLS certificate without validation. The `create_placeholder_private_key()` function uses a hardcoded Ed25519 key from examples, not suitable for any production scenario
- Audience risk: Applications using these APIs in development could silently accept MITM attacks without realizing it
- Fix approach: Replace placeholder verification with proper certificate pinning. Document security implications clearly. Add warnings to documentation and code. Consider gating these methods behind a feature flag for production use.

**YubiKey Backend Placeholder Signatures and Public Keys:**
- Issue: YubiKey backend generates placeholder/dummy public keys and signatures instead of extracting real hardware keys
- Files: `crates/core/src/backends/yubikey.rs` (lines 430, 470-533, 2339-2340, 1525, 1806)
- Impact: Signatures generated by YubiKey backend are not cryptographically valid - they're deterministic placeholders. Public key extraction returns dummy P-256 keys. This breaks the security guarantees of hardware-backed operations
- Audience risk: Users believing they have hardware-backed signatures actually have predictable dummy signatures that don't verify against real keys
- Fix approach: Complete the real PKCS#11 key extraction and signing operations. The code comments indicate these are stubs waiting for proper implementation. Consider making this a phased implementation with clear warnings about current limitations.

**Pubky Integration Status (Experimental/Community):**
- Issue: Pubky crates (`trustedge-pubky`, `trustedge-pubky-advanced`) are not part of core product roadmap and are community contributions
- Files: `crates/pubky/`, `crates/pubky-advanced/`
- Impact: These crates have different testing/maturity levels than core. The `envelope_v2_bridge.rs` format detection and Pubky client integration are experimental. May not be maintained at same pace as core.
- Audience risk: Users consuming Pubky integration may find it unmaintained or incompatible with future core versions
- Fix approach: Make experimental status clear in documentation. Consider moving to separate repository or clearly documenting maintenance expectations. Add version locks to prevent surprise incompatibilities.

**Certificate Generation Using ASN.1 Length Placeholders:**
- Issue: Multiple places in YubiKey backend build X.509 certificates with placeholder/hardcoded DER lengths instead of calculating correct lengths
- Files: `crates/core/src/backends/yubikey.rs` (lines 1941, 2061, 2066, 2183, 2188, 2250, 2293, 2302, 2307)
- Impact: Generated certificates have incorrect DER encoding with placeholder length fields. These won't parse correctly by strict validators
- Audience risk: Certificates that appear to be valid but are malformed DER structures
- Fix approach: Use proper DER encoding library (crate already has `der` dependency). Calculate and insert correct lengths. Add validation step to verify DER structure after generation.

## Known Bugs

**Audio Stream Resource Cleanup:**
- Symptoms: Audio streams may not be properly cleaned up if they go out of scope unexpectedly
- Files: `crates/core/src/audio.rs` (lines 21-30, 100+)
- Trigger: Creating AudioCapture, starting stream, then dropping before explicit close
- Workaround: Explicitly call cleanup/drop methods before scope exit. The `drop` implementation for streams is async-aware but this isn't documented
- Current mitigation: Tokio's async drop handles cleanup, but resource leaks possible in error paths

**Default Passphrase for Software HSM:**
- Symptoms: Software HSM uses a hardcoded default passphrase for demo purposes
- Files: `crates/core/src/backends/software_hsm.rs` (line 49)
- Trigger: Using software HSM backend without providing custom passphrase
- Workaround: This is noted as development-only, production systems must provide custom passphrases
- Current mitigation: Clear comment documenting this is for development use only

## Security Considerations

**TLS Certificate Validation Gap (High Priority):**
- Risk: Accept-any-certificate verification in QUIC transport enables man-in-the-middle attacks
- Files: `crates/core/src/transport/quic.rs` (lines 78-93, 100-102)
- Current mitigation: Hardware-backed verification path exists (`create_hardware_verified_endpoint`) but default path is insecure. Code comment warns "in production, you should use proper certificate validation"
- Recommendations:
  1. Make proper certificate validation the default, not placeholder verification
  2. Add pre-connection checks to verify server certificates before sending data
  3. Implement certificate pinning for known servers
  4. Document that insecure verification is development-only

**YubiKey Public Key Extraction Reliability:**
- Risk: The PKCS#11 public key extraction code (lines 636-676) may not work correctly with all YubiKey firmware versions
- Files: `crates/core/src/backends/yubikey.rs` (lines 602-876)
- Current mitigation: Code includes fallback to placeholder keys if extraction fails
- Recommendations:
  1. Add comprehensive PKCS#11 error handling with context
  2. Test against multiple YubiKey models and firmware versions
  3. Document known incompatibilities
  4. Consider requiring specific minimum firmware version

**Cryptographic Domain Separation (Well-Designed):**
- Status: Properly implemented with `b"trustedge.manifest.v1"` domain separation prefix
- Files: `crates/core/src/manifest.rs` (line 228), `crates/trst-core/src/manifest.rs` (line 240)
- No concerns - this is a security strength, not a weakness

## Performance Bottlenecks

**YubiKey Initialization Overhead:**
- Problem: YubiKey backend initialization requires PKCS#11 library loading and device discovery on every instantiation
- Files: `crates/core/src/backends/yubikey.rs` (full file - 3236 lines)
- Cause: No caching of PKCS#11 context or device handles between operations
- Improvement path: Implement singleton pattern for PKCS#11 context. Cache device handles. Consider async initialization to not block on hardware discovery.

**X.509 Certificate Generation Performance:**
- Problem: Manual DER encoding of certificates in YubiKey backend is done incrementally with many vector allocations
- Files: `crates/core/src/backends/yubikey.rs` (lines 1900-2340)
- Cause: Building certificate DER byte-by-byte instead of using DER encoder library
- Improvement path: Delegate to `der` crate encoder. Pre-allocate buffer with correct size. Consider using ASN.1 builder patterns for cleaner code.

**Large Chunk Processing Memory:**
- Problem: Envelope sealing reads entire chunk into memory (DEFAULT_CHUNK_SIZE = 64KB per chunk) and could hit issues with very large files
- Files: `crates/core/src/envelope.rs` (line 21, 126)
- Cause: Default chunk size is fixed at 64KB - could cause many allocations for large files or be too small for streaming scenarios
- Improvement path: Make chunk size configurable. Implement streaming chunking for network transport. Consider variable chunk sizes based on available memory.

## Fragile Areas

**YubiKey Backend Feature Gating:**
- Files: `crates/core/src/backends/yubikey.rs` (entire file)
- Why fragile: 97% of the code is behind `#[cfg(feature = "yubikey")]`. The no-feature stub is minimal. This means code paths diverge significantly between builds. Testing without hardware misses entire implementation.
- Safe modification:
  1. Keep feature gate but expand no-feature impl to be more complete
  2. Add integration tests that run against mock PKCS#11 for CI
  3. Document explicitly that hardware tests must be manual
  4. Consider feature-gated test modules

**Universal Backend Trait Dispatching:**
- Files: `crates/core/src/backends/mod.rs`, `crates/core/src/backends/universal.rs`
- Why fragile: Capability detection via `supports_operation()` is critical to behavior, but test coverage of all code paths uncertain
- Safe modification:
  1. Add comprehensive matrix tests: all operations Ã— all backends
  2. Document which operations each backend must support
  3. Add runtime validation that backend capabilities match advertised support
  4. Add tests for graceful degradation when operations aren't supported

**Envelope Format Detection with V1/V2 Bridge:**
- Files: `crates/core/src/envelope_v2_bridge.rs` (mentioned in pubky-advanced)
- Why fragile: Auto-detection of envelope format version could accept wrong format and fail mysteriously
- Safe modification:
  1. Add explicit version field to envelope headers (already done in V2)
  2. Add format validation tests with malformed inputs
  3. Document which versions are supported in which crates
  4. Add version negotiation for cross-version compatibility

**Transport Stream State Machine:**
- Files: `crates/core/src/transport/tcp.rs` (217 lines), `crates/core/src/transport/quic.rs` (965 lines)
- Why fragile: Optional fields (endpoint, connection, send_stream, recv_stream) in struct mean many possible invalid states
- Safe modification:
  1. Use type-level state machine (e.g., with phantom types) to encode valid states
  2. Add comprehensive state validation in critical paths
  3. Add transition tests covering all state sequences
  4. Document valid state transitions

## Scaling Limits

**Memory Usage with Large Payloads:**
- Current capacity: 64KB default chunks, 100,000 PBKDF2 iterations per key derivation
- Limit: Very large payloads (>1GB) could accumulate many chunk allocations. PBKDF2 iterations scale linearly with payload.
- Scaling path:
  1. Implement streaming mode that doesn't keep all chunks in memory
  2. Consider adaptive chunk sizing based on available memory
  3. Add progress callbacks for long operations
  4. Benchmark memory usage at 100MB, 1GB, 10GB scales

**QUIC Connection Limits:**
- Current capacity: Single connection per QuicTransport instance
- Limit: No multiplexing of multiple concurrent streams. Connection timeout is hardcoded to config value.
- Scaling path:
  1. Support multiple concurrent bidirectional streams
  2. Implement connection pooling for multiple destinations
  3. Add backpressure handling for slow receivers
  4. Consider QUIC congestion control tuning

**YubiKey Session Limits:**
- Current capacity: Single PKCS#11 session per YubiKeyBackend instance
- Limit: No session pooling. Device discovery on each init. No batch operations.
- Scaling path:
  1. Implement session caching and reuse
  2. Batch cryptographic operations
  3. Consider async operation queuing
  4. Add metrics for session utilization

## Dependencies at Risk

**Pubky Dependency (0.5.4):**
- Risk: Pubky is a community-maintained crate for decentralized key discovery. May have breaking changes.
- Impact: `crates/pubky/` and `crates/pubky-advanced/` directly depend on it. If Pubky major version breaks, this crate breaks.
- Migration plan:
  1. Pin Pubky version with careful upgrade testing
  2. Consider abstracting Pubky behind adapter pattern
  3. Evaluate alternative key discovery mechanisms
  4. Plan compatibility testing matrix

**PKCS#11 Wrapper (pkcs11 0.5):**
- Risk: PKCS#11 crate is thin wrapper around native PKCS#11. Changes to YubiKey firmware could break compatibility.
- Impact: YubiKey backend won't work with incompatible firmware versions.
- Migration plan:
  1. Add PKCS#11 version negotiation
  2. Document YubiKey firmware version requirements
  3. Add firmware detection and compatibility warnings
  4. Consider maintaining compatibility shim layer

**YubiKey Crate (0.7 with `untested` feature):**
- Risk: The `untested` feature flag indicates untested functionality. Production use uncertain.
- Impact: Using untested YubiKey operations could have undefined behavior.
- Migration plan:
  1. Thoroughly test all used operations before production
  2. Document which operations are tested vs untested
  3. Monitor upstream crate for maturity improvements
  4. Consider contributing tests back upstream

**Quinn QUIC Library (0.11):**
- Risk: QUIC protocol is relatively new, Quinn is still pre-1.0. Breaking changes possible.
- Impact: Network transport layer may need significant refactoring on major version bumps.
- Migration plan:
  1. Pin Quinn version with compatibility window
  2. Abstract QUIC behind Transport trait (already done - good)
  3. Plan for alternative transport implementations
  4. Test compatibility with multiple Quinn versions

## Missing Critical Features

**Hardware-Backed Private Key Integration:**
- Problem: YubiKey backend extracts public keys but doesn't actually use YubiKey for signing. Signatures are placeholder values.
- Blocks: Cannot use hardware for actual cryptographic operations. Security guarantees of "hardware-backed" are not realized.
- Fix approach:
  1. Implement real PKCS#11 signing operations
  2. Replace placeholder signature generation with actual calls to hardware
  3. Add end-to-end tests verifying signature validity
  4. Phase 1: Proof of concept with single key slot
  5. Phase 2: Full PIV operations with certificate handling

**Session/Certificate Caching:**
- Problem: Every authentication creates new session, every operation may need new key material derivation
- Blocks: Poor performance for repeated operations. No session resumption across connections.
- Fix approach:
  1. Implement session cache with TTL
  2. Add certificate caching
  3. Support session resumption in TLS
  4. Add metrics for cache hit rates

**Proper Key Rotation:**
- Problem: No mechanism for rotating keys, versioning encrypted data with key versions, or rekeying existing encrypted payloads
- Blocks: Long-lived encrypted data becomes unrecoverable if key is compromised
- Fix approach:
  1. Add key version field to envelope format
  2. Implement key rotation API
  3. Support re-encryption with new keys
  4. Add retention policies for old keys

**External Security Audit:**
- Problem: Security audit status is "TBD" / "Pending". Pre-1.0 software without external review.
- Blocks: Cannot recommend for production use without cryptographic audit
- Fix approach:
  1. Schedule external security audit before v1.0
  2. Address findings and retest
  3. Publish audit results
  4. Document any remaining limitations

## Test Coverage Gaps

**Certificate Path Validation:**
- What's not tested: End-to-end certificate chain validation, certificate expiration checks, revocation lists
- Files: `crates/core/src/transport/quic.rs`, `crates/core/src/backends/yubikey.rs`
- Risk: Invalid or expired certificates may be accepted silently
- Priority: High - affects security-critical path

**YubiKey Hardware Operations (Without Hardware):**
- What's not tested: Real PKCS#11 operations against actual YubiKey devices in CI
- Files: `crates/core/tests/yubikey_*.rs`
- Risk: Code that appears to work in CI may fail against real hardware
- Priority: High - currently relying on placeholder implementations
- Note: Tests like `yubikey_real_operations.rs` exist but marked as requiring actual hardware

**Concurrent Access to Backends:**
- What's not tested: Multiple threads/tasks accessing same backend simultaneously
- Files: `crates/core/src/backends/`
- Risk: Race conditions, double initialization, dropped session handles
- Priority: Medium - could affect threaded/async applications
- Gap: No stress tests with concurrent operations

**Network Error Scenarios:**
- What's not tested: Connection drops mid-transfer, packet loss, out-of-order delivery, timeout edge cases
- Files: `crates/core/src/transport/quic.rs`, `crates/core/src/transport/tcp.rs`
- Risk: Partial data corruption, hung connections, buffer exhaustion
- Priority: Medium - affects reliability in poor network conditions
- Gap: Need chaos engineering tests

**Large Payload Edge Cases:**
- What's not tested: Payloads at chunk boundaries, very large files (>1GB), memory exhaustion scenarios
- Files: `crates/core/src/envelope.rs`
- Risk: Off-by-one errors in chunking, memory panics, silent data corruption
- Priority: Medium - boundary conditions often hide bugs
- Gap: Integration tests only cover small payloads

**Format Version Compatibility:**
- What's not tested: Cross-version compatibility between envelope V1 and V2, forward compatibility scenarios
- Files: `crates/core/src/envelope.rs`, `crates/pubky-advanced/src/envelope.rs`
- Risk: Data encrypted with V1 cannot be decrypted by future V2-only systems
- Priority: Medium - important for data longevity
- Gap: No explicit compatibility tests

---

*Concerns audit: 2026-02-09*
