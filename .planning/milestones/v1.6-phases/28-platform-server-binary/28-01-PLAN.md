---
phase: 28-platform-server-binary
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/platform-server/Cargo.toml
  - crates/platform-server/src/main.rs
autonomous: true
requirements:
  - PLAT-01
  - PLAT-02
  - PLAT-03
  - PLAT-04

must_haves:
  truths:
    - "Running `trustedge-platform-server serve` starts an Axum HTTP server on the configured port"
    - "Server reads PORT, DATABASE_URL, and JWT_AUDIENCE from environment (dotenvy + env vars)"
    - "All routing is via `trustedge_platform::http::create_router()` — main.rs has zero routing logic"
    - "SIGTERM or SIGINT triggers graceful shutdown via tokio::signal — in-flight requests complete before exit"
    - "`trustedge-platform-server migrate` runs database migrations via `trustedge_platform::database::run_migrations()`"
    - "Startup banner prints binary name, version, port, and mode (verify-only vs full/postgres)"
  artifacts:
    - path: "crates/platform-server/Cargo.toml"
      provides: "Binary crate manifest with features http+postgres+openapi default, ca optional"
      contains: "name = \"trustedge-platform-server\""
    - path: "crates/platform-server/src/main.rs"
      provides: "Thin entry point — clap CLI, env config, AppState wiring, graceful shutdown"
      min_lines: 80
    - path: "Cargo.toml"
      provides: "Workspace member registration for platform-server"
      contains: "crates/platform-server"
  key_links:
    - from: "crates/platform-server/src/main.rs"
      to: "trustedge_platform::http::create_router"
      via: "direct function call with AppState"
      pattern: "create_router\\(state\\)"
    - from: "crates/platform-server/src/main.rs"
      to: "trustedge_platform::http::Config"
      via: "Config::from_env()"
      pattern: "Config::from_env"
    - from: "crates/platform-server/src/main.rs"
      to: "tokio::signal"
      via: "graceful shutdown select loop"
      pattern: "signal::unix|signal::ctrl_c|axum::serve.*with_graceful_shutdown"
---

<objective>
Create the `crates/platform-server` binary crate — a thin entry point that boots the `trustedge-platform` Axum HTTP service.

Purpose: PLAT-01 through PLAT-04 are all satisfied by this one binary crate. The main.rs wires together the existing trustedge-platform public API (Config::from_env, AppState, create_router) with a clap CLI, dotenvy env loading, startup banner, and tokio graceful shutdown.

Output: A deployable `trustedge-platform-server` binary that builds with `cargo build -p trustedge-platform-server`.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-platform-server-binary/28-CONTEXT.md

Key platform APIs already available:
- `trustedge_platform::http::Config::from_env()` — loads PORT, JWT_AUDIENCE (DATABASE_URL when postgres feature)
- `trustedge_platform::http::create_router(AppState)` — returns `axum::Router`
- `trustedge_platform::http::AppState` — holds `keys: Arc<RwLock<KeyManager>>` (and `db_pool` when postgres feature)
- `trustedge_platform::database::create_connection_pool(url)` — returns `Result<PgPool>`
- `trustedge_platform::database::run_migrations(pool)` — runs embedded sqlx migrations

The platform crate's `Config::from_env()` already calls `dotenvy::dotenv().ok()` internally. The binary should NOT call dotenvy again — it relies on the platform crate's config loading.

@crates/platform/src/http/config.rs
@crates/platform/src/http/state.rs
@crates/platform/src/http/router.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create crates/platform-server crate with Cargo.toml and register in workspace</name>
  <files>crates/platform-server/Cargo.toml</files>
  <files>Cargo.toml</files>
  <action>
Create directory `crates/platform-server/src/` and write `crates/platform-server/Cargo.toml`:

```toml
#
# Copyright (c) 2025 TRUSTEDGE LABS LLC
# This source code is subject to the terms of the Mozilla Public License, v. 2.0.
# If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
#
# Project: trustedge — Privacy and trust at the edge.
#

[package]
name = "trustedge-platform-server"
version = "0.1.0"
edition = "2021"
license = "MPL-2.0"
description = "TrustEdge Platform Server — standalone binary that boots the platform HTTP service"

[package.metadata.trustedge]
tier = "stable"
maintained = true

[[bin]]
name = "trustedge-platform-server"
path = "src/main.rs"

[dependencies]
trustedge-platform = { path = "../platform", features = ["http", "postgres", "openapi"] }
trustedge-core = { path = "../core" }
anyhow = { workspace = true }
clap = { workspace = true }
tokio = { workspace = true }
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter"] }

[features]
default = []
ca = ["trustedge-platform/ca"]
```

Then add `"crates/platform-server"` to the `members` array in the workspace `Cargo.toml` (under `crates/platform`). Preserve the existing members list exactly, just insert the new entry in alphabetical/logical order after `crates/platform`.
  </action>
  <verify>
`cargo build -p trustedge-platform-server 2>&1 | head -5` — should compile (will fail on missing main.rs until Task 2, so just check Cargo.toml parses: `cargo metadata --no-deps -q 2>&1 | grep platform-server`)
  </verify>
  <done>
`cargo metadata --no-deps -q` lists `trustedge-platform-server` as a workspace member with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement main.rs — clap CLI, startup banner, AppState wiring, graceful shutdown</name>
  <files>crates/platform-server/src/main.rs</files>
  <action>
Write `crates/platform-server/src/main.rs`. The file MUST include the MPL-2.0 copyright header.

Structure:

1. **CLI (clap derive)**: Two subcommands — `serve` (default) and `migrate`. Use `#[command(name = "trustedge-platform-server")]` on the root struct. No extra CLI args beyond subcommand for `serve` — all config comes from env.

2. **`serve` subcommand implementation**:
   a. Initialize tracing: `tracing_subscriber::fmt::init()` (respects RUST_LOG env var)
   b. Load config: `let config = Config::from_env()?;` — Config::from_env() already calls dotenvy internally, do NOT call dotenvy again in main.rs
   c. Determine mode:
      - With `postgres` feature AND DATABASE_URL set: "full" mode
      - Otherwise: "verify-only" mode
   d. Print startup banner using `tracing::info!` (NOT println):
      ```
      trustedge-platform-server v{VERSION} starting
      Port: {port}
      Mode: verify-only | full (postgres)
      Routes: POST /v1/verify, GET /.well-known/jwks.json, GET /healthz [+ /v1/devices, /v1/receipts/:id if postgres]
      ```
   e. Build AppState: `let keys = Arc::new(RwLock::new(KeyManager::new()));`
      - With `postgres` feature: also create `db_pool = create_connection_pool(&config.database_url).await?`
      - Construct `AppState { keys, ... }` per feature flags
   f. Build router: `let router = create_router(state);`
   g. Bind listener: `let listener = tokio::net::TcpListener::bind(format!("0.0.0.0:{}", config.port)).await?;`
   h. Graceful shutdown: Use `axum::serve(listener, router).with_graceful_shutdown(shutdown_signal())` where `shutdown_signal()` is an async fn that awaits SIGTERM (Unix) or Ctrl+C using `tokio::signal`. On non-Unix platforms, fall back to ctrl_c only.
   i. Log "Server shut down cleanly" after serve completes.

3. **`migrate` subcommand implementation** (postgres feature only):
   - Load config via `Config::from_env()?`
   - `let pool = create_connection_pool(&config.database_url).await?;`
   - `run_migrations(&pool).await?;`
   - Print `tracing::info!("Migrations complete")`
   - On non-postgres builds: print error and return `Err(anyhow!("Built without postgres feature"))`

4. **shutdown_signal() async fn**:
```rust
async fn shutdown_signal() {
    let ctrl_c = async {
        tokio::signal::ctrl_c()
            .await
            .expect("failed to install Ctrl+C handler");
    };

    #[cfg(unix)]
    let terminate = async {
        tokio::signal::unix::signal(tokio::signal::unix::SignalKind::terminate())
            .expect("failed to install SIGTERM handler")
            .recv()
            .await;
    };

    #[cfg(not(unix))]
    let terminate = std::future::pending::<()>();

    tokio::select! {
        _ = ctrl_c => {},
        _ = terminate => {},
    }
    tracing::info!("Shutdown signal received, draining connections...");
}
```

Import requirements in main.rs:
- `use trustedge_platform::http::{create_router, AppState, Config};`
- `use trustedge_platform::verify::jwks::KeyManager;`
- `use std::sync::Arc;`
- `use tokio::sync::RwLock;`
- `#[cfg(feature = "postgres")] use trustedge_platform::database::{create_connection_pool, run_migrations};`

The VERSION in the banner: use `env!("CARGO_PKG_VERSION")`.

No routing logic in main.rs — zero route definitions. main.rs is ONLY wiring.
  </action>
  <verify>
```bash
cargo build -p trustedge-platform-server 2>&1
cargo clippy -p trustedge-platform-server -- -D warnings 2>&1
```
Both must succeed with no errors. Then run:
```bash
PORT=13001 JWT_AUDIENCE=test timeout 3 ./target/debug/trustedge-platform-server serve 2>&1 || true
```
Output must contain the startup banner with port and mode.
  </verify>
  <done>
`cargo build -p trustedge-platform-server` succeeds. Running the binary with PORT env set prints the startup banner. `cargo clippy -p trustedge-platform-server -- -D warnings` passes. `cargo test --workspace` passes (no regressions).
  </done>
</task>

</tasks>

<verification>
1. `cargo build -p trustedge-platform-server` — compiles without errors
2. `cargo clippy -p trustedge-platform-server -- -D warnings` — no warnings or errors
3. `cargo test --workspace` — full test suite passes (265+ tests), no regressions
4. `PORT=13001 JWT_AUDIENCE=test timeout 3 ./target/debug/trustedge-platform-server serve 2>&1 || true` — banner printed, exits cleanly after 3s timeout (no crash)
5. `./target/debug/trustedge-platform-server --help` — shows serve and migrate subcommands
6. Grep main.rs for route definitions: `grep -n "\.route\(" crates/platform-server/src/main.rs` — should return nothing (all routing in platform crate)
7. Copyright header present: `head -8 crates/platform-server/src/main.rs` — shows MPL-2.0 header
</verification>

<success_criteria>
- Binary `trustedge-platform-server` builds and runs
- All 4 PLAT requirements satisfied: standalone binary (PLAT-01), env config (PLAT-02), router via create_router (PLAT-03), graceful shutdown (PLAT-04)
- Zero routing logic in main.rs
- Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/28-platform-server-binary/28-01-SUMMARY.md` using the summary template.
</output>
