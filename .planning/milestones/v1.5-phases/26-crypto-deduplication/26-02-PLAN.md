---
phase: 26-crypto-deduplication
plan: 02
type: execute
wave: 2
depends_on:
  - 26-01
files_modified:
  - crates/platform/Cargo.toml
  - crates/platform/src/verify/jwks.rs
  - crates/platform/src/verify/signing.rs
  - crates/platform/src/verify/engine.rs
autonomous: true
requirements:
  - CRYPTO-01
  - CRYPTO-02

must_haves:
  truths:
    - "blake3 is removed from trustedge-platform's production [dependencies] section"
    - "ed25519-dalek is removed from trustedge-platform's production [dependencies] section"
    - "ed25519-dalek remains in [dev-dependencies] for integration test fixtures"
    - "jwks.rs and signing.rs use ed25519-dalek types re-exported through trustedge-core (not direct imports)"
    - "The full workspace test suite passes: cargo test --workspace"
    - "cargo clippy passes for the entire workspace"
  artifacts:
    - path: "crates/platform/Cargo.toml"
      provides: "Clean dependency list with trustedge-core as sole crypto dep"
    - path: "crates/platform/src/verify/jwks.rs"
      provides: "Key management using ed25519-dalek types via trustedge-core re-export"
  key_links:
    - from: "crates/platform/src/verify/jwks.rs"
      to: "trustedge_core"
      via: "Re-exported ed25519_dalek types"
      pattern: "trustedge_core::"
    - from: "crates/platform/Cargo.toml"
      to: "trustedge-core"
      via: "Sole crypto dependency"
      pattern: "trustedge-core"
---

<objective>
Remove blake3 and ed25519-dalek from trustedge-platform's production dependencies. Route jwks.rs key management through trustedge-core re-exports so the platform has exactly one crypto dependency. Run full workspace test suite as final validation.

Purpose: Complete the crypto deduplication — after this plan, trustedge-platform depends only on trustedge-core for all cryptographic operations. No parallel crypto dependency trees remain.

Output: Clean Cargo.toml with trustedge-core as sole crypto dep; all tests green; CI passing.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-crypto-deduplication/26-CONTEXT.md
@.planning/phases/26-crypto-deduplication/26-01-SUMMARY.md
@crates/core/src/lib.rs
@crates/core/src/crypto.rs
@crates/platform/Cargo.toml
@crates/platform/src/verify/jwks.rs
@crates/platform/src/verify/signing.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ed25519-dalek re-exports to trustedge-core and update jwks.rs</name>
  <files>
    crates/core/src/lib.rs
    crates/platform/src/verify/jwks.rs
    crates/platform/src/verify/signing.rs
  </files>
  <action>
**trustedge-core re-exports:**

Add re-exports of the ed25519-dalek types that trustedge-platform needs for JWKS key management. In `crates/core/src/lib.rs`, add to the existing crypto re-exports:

```rust
// Ed25519 types re-exported for downstream crates (JWKS, key management)
pub use ed25519_dalek::{SigningKey, VerifyingKey};
```

This is the minimal addition. Core already depends on ed25519-dalek, so this adds no new transitive dependencies.

**jwks.rs changes:**

Replace `use ed25519_dalek::{SigningKey, VerifyingKey};` with:
```rust
use trustedge_core::{SigningKey, VerifyingKey};
```

All other code in jwks.rs stays exactly the same — these are the same types, just re-routed through core's public API.

Also replace `use base64::{engine::general_purpose::STANDARD as BASE64, Engine};` — check if the base64 usage in jwks.rs can stay as-is (it's used for key serialization/deserialization and JWK format). The `base64` crate is still a direct dependency of trustedge-platform (used by engine.rs, handlers.rs, etc.), so this import can remain unchanged.

**signing.rs changes:**

signing.rs currently has no direct `ed25519_dalek` import — it accesses `SigningKey` through `KeyManager::current_signing_key()` which returns `&SigningKey`. Since `SigningKey` is now re-exported through core, the type resolution still works. No changes to signing.rs needed unless the compiler complains about type mismatch (which it won't since it's the same type via re-export). Verify by compiling.

If signing.rs has any hidden dependency on `ed25519_dalek` types (check `.to_bytes()` call on line 51), confirm it still resolves through the re-exported type. It should, since `to_bytes()` is a method on `SigningKey` regardless of how it's imported.
  </action>
  <verify>
Run: `cargo build -p trustedge-platform` — must compile with default features.
Run: `cargo build -p trustedge-platform --features "http,postgres,ca"` — must compile with all features.
Grep: `grep -n "use ed25519_dalek" crates/platform/src/verify/jwks.rs` — must return no results.
Grep: `grep -n "use trustedge_core" crates/platform/src/verify/jwks.rs` — must show the new import.
  </verify>
  <done>
jwks.rs imports ed25519-dalek types through trustedge-core re-exports. No direct ed25519_dalek imports remain in any platform production source file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove blake3/ed25519-dalek from production deps and run full validation</name>
  <files>
    crates/platform/Cargo.toml
    crates/platform/src/verify/engine.rs
  </files>
  <action>
**Cargo.toml dependency removal:**

1. Remove `blake3 = { workspace = true }` from `[dependencies]` section entirely.
2. Remove `ed25519-dalek = { workspace = true }` from `[dependencies]` section entirely.
3. Verify `ed25519-dalek = { workspace = true }` remains in `[dev-dependencies]` (line 79 — tests need it for creating signing keys in fixtures).

After removal, the crypto-related production dependencies should be:
- `trustedge-core = { path = "../core" }` (always-on, provides chain + crypto + key types)
- `base64 = "0.22"` (encoding/decoding, used by engine, handlers, jwks)
- `jsonwebtoken = "9.2"` (JWT signing, used by signing.rs)

**Verify no remaining direct blake3 or ed25519_dalek usage in production source:**

Check all `.rs` files under `crates/platform/src/` for `blake3::` or `ed25519_dalek::` usage. After Plan 01 + Task 1 above:
- engine.rs: should have zero direct imports (uses trustedge_core)
- jwks.rs: should import from trustedge_core (Task 1 above)
- handlers.rs: should use trustedge_core (Plan 01)
- signing.rs: no direct import (accesses via KeyManager)

If any `blake3::` reference remains in engine.rs tests (the `#[cfg(test)] mod tests`), update those tests to use `trustedge_core::chain` equivalents. For example, `test_genesis_hash_computation` currently creates a `blake3::Hasher` — replace with `trustedge_core::chain::genesis()`.

**Full workspace validation:**

Run the complete validation sequence:
1. `cargo fmt --check` — formatting
2. `cargo clippy --workspace -- -D warnings` — lint entire workspace
3. `cargo test --workspace` — all 265+ tests
4. `cargo test -p trustedge-platform --test verify_integration --features http` — HTTP integration tests
5. `cargo build -p trustedge-platform --features "http,postgres,ca"` — full feature build

**Update CLAUDE.md if test count changed** (unlikely but check).

**Update DEPENDENCIES.md** if it exists — remove blake3 and ed25519-dalek from the trustedge-platform section, note trustedge-core as the sole crypto provider.
  </action>
  <verify>
Run: `cargo test --workspace` — all tests pass (265+).
Run: `cargo clippy --workspace -- -D warnings` — zero warnings.
Grep: `grep "^blake3" crates/platform/Cargo.toml` — must return no results (removed from production deps).
Grep: `grep "^ed25519-dalek" crates/platform/Cargo.toml` — must appear only in [dev-dependencies].
Run: `cargo tree -p trustedge-platform --depth 1 | grep -c "blake3\|ed25519-dalek"` — should show these as transitive through trustedge-core only (not direct deps).
  </verify>
  <done>
blake3 and ed25519-dalek removed from trustedge-platform production dependencies. trustedge-core is the sole crypto dependency. ed25519-dalek remains as dev-dependency for test fixtures. Full workspace test suite passes. Cargo clippy clean.
  </done>
</task>

</tasks>

<verification>
1. `cargo test --workspace` — all 265+ tests pass
2. `cargo clippy --workspace -- -D warnings` — zero warnings
3. `cargo fmt --check` — properly formatted
4. `grep -rn "use blake3" crates/platform/src/` — no results in any production source file
5. `grep -rn "use ed25519_dalek" crates/platform/src/` — no results in any production source file
6. `grep "^blake3" crates/platform/Cargo.toml` — not in production dependencies
7. `grep "^ed25519-dalek" crates/platform/Cargo.toml` — only in dev-dependencies
8. `grep -rn "Phase 26:" crates/platform/src/` — no remaining Phase 26 markers (verified in Plan 01)
9. `./scripts/ci-check.sh` — full CI validation passes
</verification>

<success_criteria>
- blake3 and ed25519-dalek completely removed from trustedge-platform production deps
- trustedge-core is the sole crypto dependency for production code
- ed25519-dalek retained in dev-dependencies for test fixture creation
- jwks.rs uses ed25519 types via trustedge-core re-exports
- Full workspace test suite passes (265+ tests)
- CI validation script passes
</success_criteria>

<output>
After completion, create `.planning/phases/26-crypto-deduplication/26-02-SUMMARY.md`
</output>
