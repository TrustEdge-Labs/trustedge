---
phase: 37-keyring-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/core/src/backends/keyring.rs
  - crates/core/src/backends/universal_keyring.rs
  - crates/core/src/backends/traits.rs
  - crates/core/src/backends/universal.rs
  - crates/core/src/bin/trustedge-client.rs
autonomous: true
requirements:
  - KEY-01
  - KEY-02
  - KEY-03
  - KEY-04
  - TST-03

must_haves:
  truths:
    - "keyring.rs PBKDF2 iteration count is 600,000"
    - "keyring.rs salt length is 32 bytes"
    - "universal_keyring.rs PBKDF2 iteration count is 600,000"
    - "universal_keyring.rs salt length is 32 bytes"
    - "All keyring encryption/decryption tests pass with updated parameters"
    - "cargo test -p trustedge-core --lib passes with no regressions"
  artifacts:
    - path: "crates/core/src/backends/keyring.rs"
      provides: "Keyring backend with OWASP 2023 PBKDF2 parameters"
      contains: "600_000"
    - path: "crates/core/src/backends/universal_keyring.rs"
      provides: "Universal keyring backend with OWASP 2023 PBKDF2 parameters"
      contains: "600_000"
    - path: "crates/core/src/backends/traits.rs"
      provides: "KeyContext default iterations updated to 600,000"
      contains: "600_000"
    - path: "crates/core/src/backends/universal.rs"
      provides: "KeyDerivationContext default iterations updated to 600,000"
      contains: "600_000"
  key_links:
    - from: "crates/core/src/backends/keyring.rs"
      to: "crates/core/src/backends/traits.rs"
      via: "KeyContext.iterations default and salt length validation"
      pattern: "600_000|32 bytes"
    - from: "crates/core/src/backends/universal_keyring.rs"
      to: "crates/core/src/backends/universal.rs"
      via: "KeyDerivationContext.iterations default and salt length validation"
      pattern: "600_000|32 bytes"
---

<objective>
Harden both keyring backends (keyring.rs, universal_keyring.rs) to OWASP 2023-recommended PBKDF2 parameters: 600,000 iterations and 32-byte salts. Also update the default iteration counts in KeyContext and KeyDerivationContext structs, and the CLI salt validation in trustedge-client.rs.

Purpose: Keyring-encrypted secrets currently use 100,000 iterations and 16-byte salts, which fall below OWASP 2023 recommendations for brute-force resistance. This plan brings both backends to current security standards.
Output: Updated keyring backends with hardened parameters, passing test suite.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@crates/core/src/backends/keyring.rs
@crates/core/src/backends/universal_keyring.rs
@crates/core/src/backends/traits.rs
@crates/core/src/backends/universal.rs
@crates/core/src/bin/trustedge-client.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update PBKDF2 parameters in keyring backends and context structs</name>
  <files>
    crates/core/src/backends/keyring.rs
    crates/core/src/backends/universal_keyring.rs
    crates/core/src/backends/traits.rs
    crates/core/src/backends/universal.rs
    crates/core/src/bin/trustedge-client.rs
  </files>
  <action>
Update PBKDF2 iteration count defaults from 100,000 to 600,000 and salt length from 16 to 32 bytes across all four keyring-related source files and the CLI binary.

**crates/core/src/backends/keyring.rs:**
1. Line 67: Change `context.salt.len() != 16` to `context.salt.len() != 32`
2. Line 69: Change error message from "Salt must be exactly 16 bytes" to "Salt must be exactly 32 bytes for keyring backend"
3. Lines 79-80: Change `let mut salt_array = [0u8; 16];` to `let mut salt_array = [0u8; 32];`
4. Line 83: Change `context.iterations.unwrap_or(100_000)` to `context.iterations.unwrap_or(600_000)`

**crates/core/src/backends/universal_keyring.rs:**
1. Line 63: Change `context.salt.len() != 16` to `context.salt.len() != 32`
2. Line 64: Change error message from "Salt must be exactly 16 bytes" to "Salt must be exactly 32 bytes for keyring backend"
3. Lines 73-74: Change `let mut salt_array = [0u8; 16];` to `let mut salt_array = [0u8; 32];`
4. Line 77: Change `context.iterations.unwrap_or(100_000)` to `context.iterations.unwrap_or(600_000)`

**crates/core/src/backends/traits.rs:**
1. Line 62: In `KeyContext::new`, change `iterations: Some(100_000)` to `iterations: Some(600_000)`
2. Update the comment to read `// OWASP 2023 recommended PBKDF2 iterations`

**crates/core/src/backends/universal.rs:**
1. Line 66: In `KeyDerivationContext::new`, change `iterations: Some(100_000)` to `iterations: Some(600_000)`
2. Update the comment to read `// OWASP 2023 recommended PBKDF2 iterations`

**crates/core/src/bin/trustedge-client.rs:**
1. Line 83: Update help text from "32 chars -> 16 bytes" to "64 chars -> 32 bytes"
2. Line 282: Change `salt_bytes.len() != 16` to `salt_bytes.len() != 32`
3. Line 283: Change error message from "Salt must be 16 bytes (32 hex chars)" to "Salt must be 32 bytes (64 hex chars)"
4. Line 285: Change `let mut salt = [0u8; 16];` to `let mut salt = [0u8; 32];`
5. The `derive_key(&salt, &context)` call on line 291 passes `salt` as key_id (&[u8; 16]) -- this will need to change to a 16-byte slice of the salt or a separate key_id since the KeyBackend::derive_key signature takes `&[u8; 16]`. Keep the first 16 bytes of the salt as key_id: `let mut key_id = [0u8; 16]; key_id.copy_from_slice(&salt[..16]);` and pass `&key_id` instead of `&salt`.

Do NOT change the function signatures of `KeyBackend::derive_key` or `UniversalBackend::perform_operation`. Only change parameter values and validation thresholds.
  </action>
  <verify>
    <automated>cd /home/john/vault/projects/github.com/trustedge && cargo build --workspace 2>&1 | tail -5</automated>
    <manual>Verify no compilation errors from changed parameter sizes</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>
All five files compile cleanly with 600,000 iteration defaults and 32-byte salt validation. No function signature changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update keyring tests for 32-byte salts and verify full test suite</name>
  <files>
    crates/core/src/backends/keyring.rs
    crates/core/src/backends/universal_keyring.rs
  </files>
  <action>
Update all test cases in both keyring files to use 32-byte salts instead of 16-byte salts, and update salt validation error message assertions.

**crates/core/src/backends/keyring.rs tests:**
1. `test_key_derivation_requires_16_byte_salt` -- rename to `test_key_derivation_requires_32_byte_salt`
2. Change the test's `KeyContext::new(vec![1, 2, 3])` to still use 3 bytes (wrong length) -- this is correct, testing rejection
3. Update the assertion from `contains("Salt must be exactly 16 bytes")` to `contains("Salt must be exactly 32 bytes")`

**crates/core/src/backends/universal_keyring.rs tests:**
1. `test_supports_operation`: Change `KeyDerivationContext::new(vec![1; 16])` to `KeyDerivationContext::new(vec![1; 32])`
2. `test_key_derivation_operation`: Change `KeyDerivationContext::new(vec![1; 16])` to `KeyDerivationContext::new(vec![1; 32])`

**crates/core/src/backends/universal.rs tests (if any use 16-byte salts in KeyDerivationContext::new):**
1. `test_key_derivation_context_builder`: Uses `vec![1, 2, 3, 4]` -- this is fine, it tests the builder not validation
2. `test_operation_type_supported`: Uses `KeyDerivationContext::new(vec![1, 2, 3, 4])` -- also fine, tests type matching not execution

After all test updates, run the full core lib test suite to confirm zero regressions.
  </action>
  <verify>
    <automated>cd /home/john/vault/projects/github.com/trustedge && cargo test -p trustedge-core --lib 2>&1 | tail -20</automated>
    <manual>Confirm "test result: ok" with zero failures</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>
All keyring tests pass with 32-byte salts and 600,000-iteration defaults. `cargo test -p trustedge-core --lib` shows zero failures. TST-03 satisfied.
  </done>
</task>

</tasks>

<verification>
1. Source check: `grep -n '600_000' crates/core/src/backends/keyring.rs` shows iteration count
2. Source check: `grep -n '600_000' crates/core/src/backends/universal_keyring.rs` shows iteration count
3. Source check: `grep -n '32 bytes' crates/core/src/backends/keyring.rs` shows salt validation
4. Source check: `grep -n '32 bytes' crates/core/src/backends/universal_keyring.rs` shows salt validation
5. Source check: `grep -n '600_000' crates/core/src/backends/traits.rs` shows KeyContext default
6. Source check: `grep -n '600_000' crates/core/src/backends/universal.rs` shows KeyDerivationContext default
7. Test suite: `cargo test -p trustedge-core --lib` passes with zero failures
8. Workspace: `cargo build --workspace --release` compiles cleanly
</verification>

<success_criteria>
- keyring.rs contains `600_000` iteration default and `32`-byte salt validation
- universal_keyring.rs contains `600_000` iteration default and `32`-byte salt validation
- traits.rs KeyContext::new defaults to `600_000` iterations
- universal.rs KeyDerivationContext::new defaults to `600_000` iterations
- trustedge-client.rs validates 32-byte salts for keyring mode
- All tests in `cargo test -p trustedge-core --lib` pass
- No compilation warnings or errors across the workspace
</success_criteria>

<output>
After completion, create `.planning/phases/37-keyring-hardening/37-01-SUMMARY.md`
</output>
