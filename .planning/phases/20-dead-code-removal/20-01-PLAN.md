---
phase: 20-dead-code-removal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/core/src/bin/trustedge-server.rs
  - crates/core/src/backends/universal_keyring.rs
  - crates/core/src/transport/tcp.rs
  - crates/core/src/backends/software_hsm.rs
  - crates/core/tests/software_hsm_integration.rs
  - crates/core/src/vectors.rs
autonomous: true

must_haves:
  truths:
    - "No legacy server functions (handle_connection, process_and_decrypt_chunk, save_chunk_to_disk) remain in trustedge-server.rs"
    - "No reserved/unimplemented functions (encrypt_aes_gcm, decrypt_aes_gcm) remain in universal_keyring.rs"
    - "ProcessingSession contains only fields actively used by handle_hardened_connection and process_chunk_hardened"
    - "Every #[allow(dead_code)] in the codebase is either justified with a comment or the dead code is deleted"
    - "cargo build --workspace produces no dead_code warnings"
  artifacts:
    - path: "crates/core/src/bin/trustedge-server.rs"
      provides: "Server with only hardened connection handler, no legacy code"
    - path: "crates/core/src/backends/universal_keyring.rs"
      provides: "Keyring backend with no reserved functions"
  key_links:
    - from: "crates/core/src/bin/trustedge-server.rs"
      to: "ProcessingSession struct"
      via: "handle_hardened_connection uses session fields"
      pattern: "session\\.(connection_id|output_file|expected_seq_next|stream_nonce_prefix|header_verified|header_locked|authenticated|session_id|client_identity|bytes_received|chunks_received|last_activity)"
---

<objective>
Remove all dead code from the trustedge workspace: legacy server functions, reserved keyring methods, unused struct fields, and unused test helpers.

Purpose: Eliminate misleading dead code that creates maintenance burden and false impressions of implemented functionality. The v1.4 milestone goal is "if it doesn't work, it doesn't exist."

Output: Clean codebase with zero dead_code warnings and every remaining `#[allow(dead_code)]` justified.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@crates/core/src/bin/trustedge-server.rs
@crates/core/src/backends/universal_keyring.rs
@crates/core/src/transport/tcp.rs
@crates/core/src/backends/software_hsm.rs
@crates/core/tests/software_hsm_integration.rs
@crates/core/src/vectors.rs
@crates/core/src/applications/attestation/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete legacy server functions and clean ProcessingSession</name>
  <files>crates/core/src/bin/trustedge-server.rs</files>
  <action>
In `crates/core/src/bin/trustedge-server.rs`:

1. **Delete the entire legacy `handle_connection` function** (lines 691-852, from the "Legacy Connection handler" comment section through the closing brace). This is ~160 lines of dead code with `#[allow(dead_code)]` that duplicates `handle_hardened_connection`.

2. **Delete the entire `process_and_decrypt_chunk` function** (lines 854-981, from the "Chunk processing" comment section through the closing brace). This is ~125 lines of dead code with `#[allow(dead_code)]` that is only called by the legacy `handle_connection`.

3. **Delete the entire `save_chunk_to_disk` function** (lines 993-1023). This is ~30 lines of dead code with `#[allow(dead_code)]` that is only called by the legacy `handle_connection`.

4. **Clean ProcessingSession struct** - remove fields that are only used by the deleted legacy functions and not by `handle_hardened_connection` or `process_chunk_hardened`:
   - Remove `chunks: HashMap<u64, (Vec<u8>, SignedManifest)>` (line 113-114) -- never read in hardened path. Also remove `HashMap` from imports and `SignedManifest` from the `use trustedge_core::{ ... }` import if no longer needed.
   - Remove `stream_header_hash: Option<[u8; 32]>` (line 121-122) -- only set/read in deleted `process_and_decrypt_chunk`
   - Remove `connection_start: Instant` (line 135-136) -- never read anywhere
   - Remove all `#[allow(dead_code)]` attributes from ProcessingSession fields.

5. **Update the session initialization** in the `main()` function's connection accept block (around line 274) to remove deleted fields from the `ProcessingSession { ... }` struct literal. Remove `chunks: HashMap::new()`, `stream_header_hash: None`, and `connection_start: now`.

6. **Check if `cipher` field is still needed.** In the hardened path: `cipher` is set on session creation (line 277) but never read in `process_chunk_hardened` (which has `_decrypt: bool` and doesn't actually decrypt -- see the comment at line 660-661). The `cipher` field IS used in `handle_hardened_connection` for creating the output file conditionally (line 457: `if config.decrypt`), but the actual `session.cipher` is never read in the hardened codepath. Since the cipher is stored in the session but never accessed in the hardened handler, remove the `cipher` field and its `#[allow(dead_code)]` too. Remove `Aes256Gcm` from ProcessingSession. Note: the `cipher` variable in `main()` is still used to construct the session, so after removing the field, also remove the `cipher` variable construction in `main()` (lines 161-200) ONLY if no remaining code references it. Actually, `config.decrypt` flag controls whether decryption happens, and the hardened path doesn't actually decrypt. Keep the `--decrypt` CLI flag and `config.decrypt` as they control output file creation. Only remove the `cipher` field from ProcessingSession and the `Aes256Gcm::new(...)` construction if nothing else references it. If the `cipher` local variable is still passed to the session struct, remove that assignment. Verify that the `Aes256Gcm` type, `aes_gcm` imports, and `Payload` import are still needed -- the hardened code path doesn't use them, but they might be used elsewhere. If they're only used by deleted legacy code, remove the imports too.

7. **Clean up the `#![allow(unused_imports)]` at line 8.** After removing legacy code, check if `KeyBackend`, `KeyContext`, `SignedManifest`, `Manifest`, `NONCE_LEN`, and `build_aad` are still needed. The hardened path uses `NetworkChunk`, `SessionManager`, `server_authenticate`. Remove any imports that are no longer referenced. If all keyring-feature-gated imports are still used, keep the `#![allow(unused_imports)]` with its comment. If not, remove it.

8. **Also remove imports only used by deleted code:** `ed25519_dalek::{Signature, VerifyingKey}`, `aes_gcm::*` (if no longer needed), `serde_json` (used only in `save_chunk_to_disk`). The `chrono` usage was only in `save_chunk_to_disk` -- if that's deleted, chrono is no longer needed in this file.

After all changes, `cargo build -p trustedge-core --release` must succeed with no warnings related to trustedge-server.
  </action>
  <verify>
Run: `cargo build -p trustedge-core --release 2>&1 | grep -i "trustedge-server\|dead_code\|unused"`
Expected: No warnings. Clean build.

Run: `grep -n "allow(dead_code)" crates/core/src/bin/trustedge-server.rs`
Expected: No matches (all dead code annotations removed).

Run: `grep -n "handle_connection\b" crates/core/src/bin/trustedge-server.rs`
Expected: Only `handle_connection_with_shutdown` and `handle_hardened_connection` references remain.

Run: `grep -n "process_and_decrypt_chunk\|save_chunk_to_disk" crates/core/src/bin/trustedge-server.rs`
Expected: No matches.
  </verify>
  <done>
Legacy functions handle_connection, process_and_decrypt_chunk, save_chunk_to_disk are deleted. ProcessingSession contains only fields actively used by the hardened connection handler. No #[allow(dead_code)] remains in trustedge-server.rs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove reserved keyring functions, unused test helpers, and audit remaining allow(dead_code)</name>
  <files>
    crates/core/src/backends/universal_keyring.rs
    crates/core/src/transport/tcp.rs
    crates/core/src/backends/software_hsm.rs
    crates/core/tests/software_hsm_integration.rs
    crates/core/src/vectors.rs
  </files>
  <action>
**universal_keyring.rs (DEAD-02):**
1. Delete the `encrypt_aes_gcm` method (lines 116-135) and its `#[allow(dead_code)]` attribute.
2. Delete the `decrypt_aes_gcm` method (lines 137-158) and its `#[allow(dead_code)]` attribute.
3. Check if any imports become unused after deletion. The `Aes256Gcm`, `Aead`, `KeyInit`, `rand_core::{OsRng, RngCore}` imports are only used by these two methods. Remove them. Keep `aes_gcm` imports ONLY if `Aes256Gcm` is still referenced elsewhere in the file -- check `perform_operation` and other methods. Looking at the code: `perform_operation` for Encrypt/Decrypt returns `Err(BackendError::UnsupportedOperation(...))` without actually using the cipher, so the aes_gcm imports are indeed only used by the deleted methods. Remove: `use aes_gcm::{aead::{Aead, KeyInit}, Aes256Gcm};` and `use rand_core::{OsRng, RngCore};`.
4. The module doc comment says "supporting key derivation and AES encryption/decryption operations" -- update to "supporting key derivation and hash operations" since encrypt/decrypt are being removed.

**transport/tcp.rs (DEAD-04):**
1. The `connection_start: Instant` field (line 32) has `#[allow(dead_code)]`. It is set in `new()` but never read. Remove the field, its `#[allow(dead_code)]`, and the `connection_start: now` assignment in `new()`.

**software_hsm.rs (DEAD-04):**
1. The `create_test_backend_with_config` function (line 513-516) in the `#[cfg(test)]` module has `#[allow(dead_code)]`. It is never called by any test. Delete it.

**software_hsm_integration.rs (DEAD-04):**
1. The `generate_key_pair_via_universal_backend` function (lines 85-94) has `#[allow(dead_code)]`. It is never called. Delete it. Also remove any imports that become unused (check if `AsymmetricAlgorithm` is used elsewhere in the file).

**vectors.rs (DEAD-04):**
1. The file-level `#![allow(dead_code)]` (line 1) exists because the module contains helper functions used only within `#[cfg(test)] mod tests { ... }`. Since the entire module's content is test-gated, the helpers (`make_file_header`, `make_nonce`, `deterministic_trst`, `make_golden_input`) are test code used by the test. The `#![allow(dead_code)]` can be safely removed since all functions are used within the test module. If removing causes warnings, move the allow to specific items. However, a cleaner approach: since `vectors.rs` contains ONLY `#[cfg(test)] mod tests { ... }`, the functions inside are test-private and should not trigger dead_code warnings. Remove `#![allow(dead_code)]` and verify no warnings appear.

**attestation/mod.rs (DEAD-04 -- justified, no change):**
The `#[allow(dead_code)]` on `verification_key` field in `AttestationFile` (line 336) is justified: the field must exist for correct `serde::Deserialize` behavior (bincode reads it from the binary format). The struct is deserialized via `bincode::deserialize_from` and the field must be present to consume the correct bytes. Add a comment: `// Field required for correct bincode deserialization layout` to replace the bare `#[allow(dead_code)]`.

**trustedge-client.rs (DEAD-04 -- justified, no change):**
The `#![allow(unused_imports)]` is justified by the comment explaining keyring feature-gated imports. No change needed.

After all changes, run `cargo build --workspace --release` and `cargo test --workspace` to verify.
  </action>
  <verify>
Run: `cargo build --workspace --release 2>&1 | grep -i "dead_code\|unused_import\|unused_variable"`
Expected: No warnings.

Run: `cargo test --workspace 2>&1 | tail -5`
Expected: All tests pass.

Run: `grep -rn "#\[allow(dead_code)\]" crates/`
Expected: Only two justified instances remain:
  - `crates/core/src/applications/attestation/mod.rs` (serde deserialization layout)
  - Any WASM-related or other genuinely justified cases.

Run: `grep -rn "encrypt_aes_gcm\|decrypt_aes_gcm" crates/core/src/backends/universal_keyring.rs`
Expected: No matches.

Run: `grep -rn "create_test_backend_with_config" crates/core/src/backends/software_hsm.rs`
Expected: No matches.
  </verify>
  <done>
Reserved encrypt_aes_gcm/decrypt_aes_gcm deleted from universal_keyring.rs. Unused test helpers deleted. connection_start dead field removed from tcp.rs. Every remaining #[allow(dead_code)] has documented justification. Workspace builds and tests pass cleanly.
  </done>
</task>

</tasks>

<verification>
1. `cargo build --workspace --release 2>&1 | grep -c "warning"` returns 0
2. `cargo test --workspace` passes (all 340+ tests)
3. `grep -rn "#\[allow(dead_code)\]" crates/ | grep -v "target/"` shows only justified instances
4. `grep -rn "handle_connection\b" crates/core/src/bin/trustedge-server.rs` shows only hardened variants
5. `grep -rn "encrypt_aes_gcm\|decrypt_aes_gcm" crates/` shows no matches
6. `grep -rn "process_and_decrypt_chunk\|save_chunk_to_disk" crates/` shows no matches
7. `./scripts/ci-check.sh` passes
</verification>

<success_criteria>
- Legacy functions (handle_connection, process_and_decrypt_chunk, save_chunk_to_disk) deleted from trustedge-server.rs
- Reserved functions (encrypt_aes_gcm, decrypt_aes_gcm) deleted from universal_keyring.rs
- ProcessingSession contains only active fields (no chunks, no stream_header_hash, no connection_start, no cipher)
- Every remaining #[allow(dead_code)] has a comment explaining why it's justified
- cargo build --workspace produces zero dead_code warnings
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-dead-code-removal/20-01-SUMMARY.md`
</output>
