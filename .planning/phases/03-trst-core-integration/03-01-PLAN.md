<!--
Copyright (c) 2025 TRUSTEDGE LABS LLC
MPL-2.0: https://mozilla.org/MPL/2.0/
Project: trustedge — Privacy and trust at the edge.
GitHub: https://github.com/TrustEdge-Labs/trustedge
-->


---
phase: 03-trst-core-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/trst-protocols/Cargo.toml
  - crates/trst-protocols/src/lib.rs
  - crates/trst-protocols/src/archive/mod.rs
  - crates/trst-protocols/src/archive/manifest.rs
  - crates/trst-protocols/src/archive/chunks.rs
  - crates/trst-protocols/src/archive/signatures.rs
  - crates/trst-protocols/src/capture/mod.rs
  - crates/trst-protocols/src/capture/profile.rs
  - crates/trst-wasm/Cargo.toml
  - crates/trst-wasm/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "trst-protocols crate compiles with cargo check -p trustedge-trst-protocols"
    - "trst-protocols is WASM-safe: cargo check -p trustedge-trst-protocols --target wasm32-unknown-unknown succeeds"
    - "All 5 trst-core manifest tests preserved in trst-protocols"
    - "trst-wasm compiles against trst-protocols (no trst-core references remain)"
    - "Old crates/trst-core/ directory no longer exists"
  artifacts:
    - path: "crates/trst-protocols/Cargo.toml"
      provides: "Renamed crate with trustedge-trst-protocols package name"
      contains: "trustedge-trst-protocols"
    - path: "crates/trst-protocols/src/lib.rs"
      provides: "Crate root with archive and capture modules"
      contains: "pub mod archive"
    - path: "crates/trst-protocols/src/archive/manifest.rs"
      provides: "CamVideoManifest type, ManifestFormatError, canonical serialization, validation"
      contains: "ManifestFormatError"
    - path: "crates/trst-protocols/src/archive/chunks.rs"
      provides: "ChunkFormatError and chunk structure types"
      contains: "ChunkFormatError"
    - path: "crates/trst-protocols/src/archive/signatures.rs"
      provides: "SignatureFormatError and signature envelope types"
      contains: "SignatureFormatError"
    - path: "crates/trst-protocols/src/capture/profile.rs"
      provides: "ProfileFormatError placeholder for cam.video profile types"
      contains: "ProfileFormatError"
  key_links:
    - from: "Cargo.toml"
      to: "crates/trst-protocols"
      via: "workspace members list"
      pattern: "crates/trst-protocols"
    - from: "crates/trst-wasm/Cargo.toml"
      to: "crates/trst-protocols"
      via: "dependency path"
      pattern: "trustedge-trst-protocols"
    - from: "crates/trst-wasm/src/lib.rs"
      to: "trustedge_trst_protocols"
      via: "use import"
      pattern: "trustedge_trst_protocols"
---

<objective>
Rename trst-core to trst-protocols, restructure into domain-based submodules (archive + capture), define scoped error types per sub-module, and update the trst-wasm consumer.

Purpose: Establish the single source of truth for protocol/format definitions with proper module hierarchy, WASM-safe by design. This creates the foundation that Plan 02 will wire into trustedge-core.

Note on INTG-01: The roadmap requirement INTG-01 specifies "trustedge-core applications/archives/manifest/" as the location for manifest types. Per CONTEXT.md user decisions (gathered after roadmap), the canonical source is trst-protocols with a `protocols/` layer. INTG-01 is satisfied through re-exports — types are accessible through trustedge-core (Plan 02 wires this), just sourced from trst-protocols as the single source of truth.

Output: A renamed and restructured crates/trst-protocols/ crate with archive::manifest, archive::chunks, archive::signatures, and capture::profile submodules, each with scoped error types. trst-wasm updated to import from the new crate name.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-trst-core-integration/03-CONTEXT.md
@.planning/phases/03-trst-core-integration/03-RESEARCH.md
@crates/trst-core/Cargo.toml
@crates/trst-core/src/lib.rs
@crates/trst-core/src/manifest.rs
@crates/trst-wasm/Cargo.toml
@crates/trst-wasm/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename trst-core to trst-protocols and restructure into domain submodules</name>
  <files>
    Cargo.toml
    crates/trst-protocols/Cargo.toml
    crates/trst-protocols/src/lib.rs
    crates/trst-protocols/src/archive/mod.rs
    crates/trst-protocols/src/archive/manifest.rs
    crates/trst-protocols/src/archive/chunks.rs
    crates/trst-protocols/src/archive/signatures.rs
    crates/trst-protocols/src/capture/mod.rs
    crates/trst-protocols/src/capture/profile.rs
  </files>
  <action>
    **Step 1: Rename directory and update workspace**

    Move `crates/trst-core/` to `crates/trst-protocols/` using `git mv`. Update root `Cargo.toml` workspace members: change `"crates/trst-core"` to `"crates/trst-protocols"`.

    Update `crates/trst-protocols/Cargo.toml`:
    - Change `name = "trustedge-trst-core"` to `name = "trustedge-trst-protocols"`
    - Update description to: "Protocol and format definitions for TrustEdge archives and capture profiles (WASM-compatible)"
    - Dependencies stay the same (serde, serde_json, thiserror only — already WASM-safe)

    **Step 2: Restructure into domain submodules**

    Delete the old flat `crates/trst-protocols/src/manifest.rs`. Replace with nested submodule structure:

    Create `crates/trst-protocols/src/archive/mod.rs`:
    ```rust
    pub mod manifest;
    pub mod chunks;
    pub mod signatures;

    // Re-export commonly used items at domain level
    pub use manifest::{CamVideoManifest, CaptureInfo, ChunkInfo, DeviceInfo, ManifestFormatError, SegmentInfo};
    pub use chunks::ChunkFormatError;
    pub use signatures::SignatureFormatError;
    ```

    Create `crates/trst-protocols/src/archive/manifest.rs`:
    - Move ALL content from old `manifest.rs` into this file
    - Rename error type: `ManifestError` becomes `ManifestFormatError` (per user decision — scoped error naming)
    - Keep ALL existing types: CamVideoManifest, DeviceInfo, CaptureInfo, ChunkInfo, SegmentInfo
    - Keep ALL methods: new(), to_canonical_bytes(), serialize_with_ordered_keys(), set_signature(), validate()
    - Keep Default impl
    - Keep ALL 5 tests (test_manifest_creation, test_canonical_bytes_excludes_signature, test_key_ordering, test_validation, test_stable_canonicalization)
    - Add MPL-2.0 copyright header

    Create `crates/trst-protocols/src/archive/chunks.rs`:
    ```rust
    // MPL-2.0 header
    //! Chunk structure types and validation for .trst archives.
    use thiserror::Error;

    /// Errors related to chunk format validation
    #[derive(Error, Debug)]
    pub enum ChunkFormatError {
        #[error("Invalid chunk header: {0}")]
        InvalidHeader(String),
        #[error("Chunk sequence gap at index {0}")]
        SequenceGap(usize),
    }
    ```

    Create `crates/trst-protocols/src/archive/signatures.rs`:
    ```rust
    // MPL-2.0 header
    //! Signature envelope types for .trst archives.
    use thiserror::Error;

    /// Errors related to signature envelope parsing
    #[derive(Error, Debug)]
    pub enum SignatureFormatError {
        #[error("Invalid signature format: {0}")]
        InvalidFormat(String),
        #[error("Missing signature field: {0}")]
        MissingField(String),
    }
    ```

    Create `crates/trst-protocols/src/capture/mod.rs`:
    ```rust
    pub mod profile;
    pub use profile::ProfileFormatError;
    ```

    Create `crates/trst-protocols/src/capture/profile.rs`:
    ```rust
    // MPL-2.0 header
    //! Capture profile types for cam.video and future profiles.
    use thiserror::Error;

    /// Errors related to capture profile validation
    #[derive(Error, Debug)]
    pub enum ProfileFormatError {
        #[error("Invalid profile field: {0}")]
        InvalidField(String),
    }
    ```

    **Step 3: Update crate root (lib.rs)**

    Rewrite `crates/trst-protocols/src/lib.rs`:
    - Update doc comments to describe protocol definitions crate
    - Declare `pub mod archive;` and `pub mod capture;`
    - Add convenience re-exports at crate root for backward compatibility:
      `pub use archive::manifest::{CamVideoManifest, CaptureInfo, ChunkInfo, DeviceInfo, ManifestFormatError, SegmentInfo};`
    - Also re-export `ManifestFormatError as ManifestError` at crate root for temporary backward compat with trst-wasm

    **CRITICAL: All files must include the MPL-2.0 copyright header from CLAUDE.md.**
  </action>
  <verify>
    1. `cargo check -p trustedge-trst-protocols` compiles successfully
    2. `cargo test -p trustedge-trst-protocols` runs 5 manifest tests + doc test, all pass
    3. `cargo check -p trustedge-trst-protocols --target wasm32-unknown-unknown` succeeds (WASM-safe)
    4. `ls crates/trst-core/` should fail (directory no longer exists)
    5. `ls crates/trst-protocols/src/archive/manifest.rs` should succeed
  </verify>
  <done>
    trst-protocols crate builds, passes all 5+1 tests, compiles for WASM target. Old trst-core directory is gone. Archive and capture submodule structure is in place with scoped error types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update trst-wasm to use trst-protocols</name>
  <files>
    crates/trst-wasm/Cargo.toml
    crates/trst-wasm/src/lib.rs
  </files>
  <action>
    **Step 1: Update Cargo.toml**

    In `crates/trst-wasm/Cargo.toml`:
    - Replace `trustedge-trst-core = { path = "../trst-core" }` with `trustedge-trst-protocols = { path = "../trst-protocols" }`
    - Update the comment above the dependency from "Canonical manifest types from trst-core" to "Protocol definitions from trst-protocols"

    **Step 2: Update source imports**

    In `crates/trst-wasm/src/lib.rs`:
    - Change `use trustedge_trst_core::CamVideoManifest;` to `use trustedge_trst_protocols::CamVideoManifest;`
    - Update doc comment on line 12 from `trustedge-trst-core` to `trustedge-trst-protocols`
    - Update line 23 comment from "Import canonical manifest types from trst-core" to "Import canonical manifest types from trst-protocols"

    No other code changes needed — CamVideoManifest has the same API surface. The `ManifestError` type was renamed to `ManifestFormatError` inside protocols, but trst-wasm doesn't import that error type directly (it uses `.map_err()` with JsValue).
  </action>
  <verify>
    1. `cargo check -p trustedge-trst-wasm` compiles (note: native check only since it requires web-sys)
    2. `grep -r "trst_core\|trst-core" crates/trst-wasm/` returns no results — all references updated
    3. `cargo check --workspace` passes — no workspace breakage
  </verify>
  <done>
    trst-wasm depends on trst-protocols directly (stays lightweight, no trustedge-core dependency). All trst-core references in trst-wasm are replaced with trst-protocols references.
  </done>
</task>

</tasks>

<verification>
1. `cargo check -p trustedge-trst-protocols` — crate compiles
2. `cargo check -p trustedge-trst-protocols --target wasm32-unknown-unknown` — WASM-safe
3. `cargo test -p trustedge-trst-protocols` — all 5 manifest tests pass
4. `cargo check --workspace` — no workspace breakage from rename
5. `grep -r "trst-core\|trst_core" crates/trst-wasm/ crates/trst-protocols/` — no stale references
6. `ls crates/trst-core/ 2>/dev/null` — old directory does not exist
</verification>

<success_criteria>
- trst-protocols crate exists with archive (manifest, chunks, signatures) and capture (profile) submodules
- Each submodule has its own scoped error type (ManifestFormatError, ChunkFormatError, SignatureFormatError, ProfileFormatError)
- CamVideoManifest and all manifest types live in trst-protocols as the single source of truth
- WASM target compiles successfully for trst-protocols
- trst-wasm imports from trst-protocols, not trst-core
- Old trst-core crate is completely removed
- All 5 manifest tests preserved and passing
</success_criteria>

<output>
After completion, create `.planning/phases/03-trst-core-integration/03-01-SUMMARY.md`
</output>
