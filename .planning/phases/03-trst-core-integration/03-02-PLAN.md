---
phase: 03-trst-core-integration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - crates/core/Cargo.toml
  - crates/core/src/lib.rs
  - crates/core/src/error.rs
  - crates/core/src/archive.rs
  - crates/trst-cli/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "trustedge-core depends on trustedge-trst-protocols for manifest types (not self-defined)"
    - "core's manifest.rs is deleted — types come from trst-protocols re-exported through core"
    - "Existing import paths (trustedge_core::CamVideoManifest, etc.) still work via re-exports"
    - "All 133+ core lib tests pass (no functionality loss)"
    - "trst-cli compiles with only trustedge-core dependency (trst-core dep removed)"
    - "core's TrustEdgeError wraps ManifestFormatError from trst-protocols via From impl"
    - "core's ArchiveError wraps ManifestFormatError from trst-protocols via From impl"
    - "Full workspace builds and all tests pass"
  artifacts:
    - path: "crates/core/Cargo.toml"
      provides: "Core crate depending on trst-protocols"
      contains: "trustedge-trst-protocols"
    - path: "crates/core/src/error.rs"
      provides: "ManifestError replaced by ManifestFormatError from trst-protocols"
      contains: "ManifestFormatError"
    - path: "crates/core/src/lib.rs"
      provides: "Re-exports of trst-protocols types at core root"
      contains: "protocols::archive::manifest"
  key_links:
    - from: "crates/core/Cargo.toml"
      to: "crates/trst-protocols"
      via: "dependency path"
      pattern: "trustedge-trst-protocols.*trst-protocols"
    - from: "crates/core/src/lib.rs"
      to: "trustedge_trst_protocols"
      via: "pub use re-exports"
      pattern: "pub use.*protocols"
    - from: "crates/core/src/error.rs"
      to: "trustedge_trst_protocols::archive::manifest::ManifestFormatError"
      via: "#[from] conversion"
      pattern: "ManifestFormatError"
    - from: "crates/core/src/archive.rs"
      to: "trst-protocols manifest types"
      via: "use import"
      pattern: "CamVideoManifest"
---

<objective>
Wire trustedge-core to depend on trst-protocols for manifest types, delete core's duplicate manifest.rs, update error.rs with From impls for protocols errors, and update trst-cli to remove stale trst-core dependency.

Purpose: Complete the deduplication by making trustedge-core import manifest types from trst-protocols instead of defining them itself. This eliminates the 8 exact type duplicates (~1,200 LOC) identified in Phase 1 audit. Core re-exports types for backward compatibility so trst-cli and all existing consumers continue working without import changes.

Output: trustedge-core uses trst-protocols as its source of truth for manifest types. Core's manifest.rs is deleted. Error hierarchy wraps ManifestFormatError. All workspace tests pass.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-trst-core-integration/03-CONTEXT.md
@.planning/phases/03-trst-core-integration/03-RESEARCH.md
@.planning/phases/03-trst-core-integration/03-01-SUMMARY.md
@crates/core/Cargo.toml
@crates/core/src/lib.rs
@crates/core/src/error.rs
@crates/core/src/manifest.rs
@crates/core/src/archive.rs
@crates/trst-cli/Cargo.toml
@crates/trst-cli/src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire core to trst-protocols and replace manifest.rs with re-exports</name>
  <files>
    crates/core/Cargo.toml
    crates/core/src/manifest.rs
    crates/core/src/lib.rs
    crates/core/src/archive.rs
    crates/core/src/error.rs
  </files>
  <action>
    **Three-bucket triage of core's manifest.rs** (per user decision):

    Examine every item in `crates/core/src/manifest.rs`:
    - Bucket 1 (Type definitions): CamVideoManifest, DeviceInfo, CaptureInfo, ChunkInfo, SegmentInfo structs, ManifestError enum, new(), to_canonical_bytes(), serialize_with_ordered_keys(), set_signature(), validate(), Default impl, all tests → These are ALL already in trst-protocols (moved in Plan 01). **Delete from core.**
    - Bucket 2 (Operational logic): None in this file — manifest.rs is purely types and validation.
    - Bucket 3 (Duplicated code identical to trst-core): ALL of manifest.rs is duplicated. **Delete entirely.**

    Result: Delete `crates/core/src/manifest.rs` entirely. The 6 tests in this file (test_manifest_creation, test_canonical_bytes_excludes_signature, test_key_ordering, test_decimal_precision, test_validation, test_stable_canonicalization) already exist in trst-protocols (5 of 6 are exact duplicates; test_decimal_precision is core-only and should be added to trst-protocols' manifest.rs test block before deleting core's version).

    **Step 1: Add trst-protocols dependency to core**

    In `crates/core/Cargo.toml`, add under `[dependencies]`:
    ```toml
    trustedge-trst-protocols = { path = "../trst-protocols" }
    ```

    **Step 2: Update error.rs**

    In `crates/core/src/error.rs`:
    - Remove the locally-defined `ManifestError` enum entirely (lines 99-106)
    - Import ManifestFormatError from trst-protocols and create a type alias for backward compat:
      ```rust
      /// Re-export ManifestFormatError from trst-protocols as ManifestError for backward compatibility
      pub use trustedge_trst_protocols::archive::manifest::ManifestFormatError as ManifestError;
      ```
    - Update `TrustEdgeError::Manifest` variant: change `#[from] ManifestError` to `#[from] ManifestError` (same syntax but now points to the re-exported type)
    - Update `ArchiveError::Manifest` variant: same treatment — `#[from] ManifestError` continues to work because ManifestError is now a type alias
    - **IMPORTANT**: ManifestError in the existing error.rs has `#[from] serde_json::Error` for its Serialization variant. The new ManifestFormatError in trst-protocols also has this. Check that there's no duplicate `From<serde_json::Error>` conflict. If TrustEdgeError already has a `Json(#[from] serde_json::Error)` variant AND ManifestError has `Serialization(#[from] serde_json::Error)`, the `#[from]` on the ManifestError variant inside TrustEdgeError won't create a conflict because it's wrapping ManifestError, not serde_json::Error directly. Verify this compiles.

    **Step 3: Delete core's manifest.rs and add test_decimal_precision to trst-protocols**

    First, add the `test_decimal_precision` test to `crates/trst-protocols/src/archive/manifest.rs` test block (this test exists in core but not trst-core, so it would be lost):
    ```rust
    #[test]
    fn test_decimal_precision() {
        let mut manifest = CamVideoManifest::new();
        manifest.capture.fps = 29.97;
        manifest.capture.started_at = "2025-01-15T10:30:00Z".to_string();
        manifest.capture.ended_at = "2025-01-15T10:30:02Z".to_string();
        manifest.device.id = "TEST001".to_string();
        manifest.device.public_key = "ed25519:test_key".to_string();
        manifest.segments.push(SegmentInfo {
            chunk_file: "00000.bin".to_string(),
            blake3_hash: "abc123".to_string(),
            start_time: "2025-01-15T10:30:00Z".to_string(),
            duration_seconds: 2.0,
            continuity_hash: "def456".to_string(),
        });

        let canonical_bytes = manifest.to_canonical_bytes().unwrap();
        let json_str = String::from_utf8(canonical_bytes).unwrap();
        assert!(json_str.contains("29.97"));
    }
    ```

    Then delete `crates/core/src/manifest.rs` entirely.

    **Step 4: Update lib.rs re-exports**

    In `crates/core/src/lib.rs`:
    - Remove `pub mod manifest;` declaration
    - Add `pub use trustedge_trst_protocols as protocols;` to expose the full protocols crate
    - Replace the manifest re-export line:
      ```rust
      // Old:
      pub use manifest::{
          CamVideoManifest, CaptureInfo, ChunkInfo, DeviceInfo, ManifestError, SegmentInfo,
      };
      // New:
      pub use protocols::archive::manifest::{
          CamVideoManifest, CaptureInfo, ChunkInfo, DeviceInfo, SegmentInfo,
      };
      pub use error::ManifestError;  // ManifestError is re-exported from error.rs (which aliases ManifestFormatError)
      ```
    - This preserves all existing `use trustedge_core::{CamVideoManifest, DeviceInfo, ManifestError, ...}` import paths.

    **Step 5: Update archive.rs imports**

    In `crates/core/src/archive.rs`:
    - Change `use crate::manifest::CamVideoManifest;` to `use crate::CamVideoManifest;` (or `use trustedge_trst_protocols::archive::manifest::CamVideoManifest;`)
    - The `pub use crate::error::{ArchiveError, ChainError, ManifestError};` line stays unchanged since ManifestError is now a re-export in error.rs
    - The test block uses `use crate::manifest::{CamVideoManifest, SegmentInfo};` — change to `use crate::{CamVideoManifest, SegmentInfo};`
  </action>
  <verify>
    1. `cargo check -p trustedge-core` compiles successfully
    2. `cargo test -p trustedge-core --lib` — all 133+ tests pass (manifest tests are now in trst-protocols, not double-counted)
    3. `cargo test -p trustedge-trst-protocols` — now has 6 tests (5 original + test_decimal_precision)
    4. `ls crates/core/src/manifest.rs` should fail (file deleted)
    5. `cargo tree -p trustedge-core | grep trustedge-trst-protocols` — shows trst-protocols as dependency
  </verify>
  <done>
    trustedge-core imports manifest types from trst-protocols. core's manifest.rs is deleted. Error hierarchy wraps ManifestFormatError. All core lib tests pass. No test loss (test_decimal_precision preserved in trst-protocols).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update trst-cli dependency and validate full workspace</name>
  <files>
    crates/trst-cli/Cargo.toml
  </files>
  <action>
    **Step 1: Remove stale trst-core dependency from trst-cli**

    In `crates/trst-cli/Cargo.toml`:
    - Remove the line: `trustedge-trst-core = { path = "../trst-core" }`
    - trst-cli already imports all types from trustedge-core (verified: `grep -r "trustedge_trst_core" crates/trst-cli/` returns no results). The dependency is unused.

    **Step 2: Full workspace validation**

    Run comprehensive validation:
    1. `cargo check --workspace` — all crates compile
    2. `cargo test --workspace` — all tests pass, no test count decrease
    3. `cargo check -p trustedge-trst-protocols --target wasm32-unknown-unknown` — WASM still works
    4. `cargo clippy --workspace -- -D warnings` — no new warnings

    **Step 3: Verify no stale references**

    Confirm no references to old trst-core crate name remain anywhere:
    - `grep -r "trst-core\|trst_core" crates/ Cargo.toml --include="*.toml" --include="*.rs"` should return zero results
    - If any remain, update them to reference trst-protocols

    **Expected test counts after this plan:**
    - trst-protocols: 6 tests (5 original + test_decimal_precision moved from core)
    - trustedge-core lib tests: ~127 (133 minus 6 manifest tests that were duplicates, but verify — some manifest tests in core's archive.rs test block will still exist since they test I/O operations, not types)
    - Total workspace: same or higher than baseline (431 test entries)
  </action>
  <verify>
    1. `cargo check --workspace` — compiles
    2. `cargo test --workspace` — all tests pass
    3. `cargo check -p trustedge-trst-protocols --target wasm32-unknown-unknown` — WASM check passes
    4. `grep -r "trst-core" crates/ Cargo.toml --include="*.toml" --include="*.rs" | grep -v trst-protocols | grep -v ".planning"` — no stale references
    5. `cargo clippy --workspace -- -D warnings` — clean
    6. Workspace test count is >= 431 (baseline from before this phase)
  </verify>
  <done>
    trst-cli has no stale trst-core dependency. Full workspace compiles, tests pass, clippy clean. No references to old trst-core crate name remain. WASM target verified. Test count preserved or increased.
  </done>
</task>

</tasks>

<verification>
1. `cargo check --workspace` — all crates compile
2. `cargo test --workspace` — all tests pass (count >= 431 baseline)
3. `cargo test -p trustedge-trst-protocols` — 6 manifest tests pass
4. `cargo check -p trustedge-trst-protocols --target wasm32-unknown-unknown` — WASM verified
5. `cargo tree -p trustedge-core | grep trustedge-trst-protocols` — core depends on protocols
6. `ls crates/core/src/manifest.rs 2>/dev/null` — deleted (exit 1)
7. `grep -r "trst-core" crates/ Cargo.toml --include="*.toml" --include="*.rs"` — no stale refs (only trst-protocols references)
8. `cargo clippy --workspace -- -D warnings` — clean
</verification>

<success_criteria>
- trustedge-core depends on trustedge-trst-protocols and imports manifest types from it
- core's manifest.rs is deleted — types come from trst-protocols, re-exported through core
- Existing import paths (trustedge_core::CamVideoManifest, etc.) still work via re-exports in lib.rs
- core's TrustEdgeError and ArchiveError wrap ManifestFormatError from trst-protocols
- trst-cli builds with only trustedge-core (no trst-core dependency)
- All workspace tests pass with count >= 431 baseline
- WASM compilation verified for trst-protocols
- No stale trst-core references anywhere in workspace
</success_criteria>

<output>
After completion, create `.planning/phases/03-trst-core-integration/03-02-SUMMARY.md`
</output>
