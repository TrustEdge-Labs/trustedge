<!--
Copyright (c) 2025 TRUSTEDGE LABS LLC
MPL-2.0: https://mozilla.org/MPL/2.0/
Project: trustedge — Privacy and trust at the edge.
GitHub: https://github.com/TrustEdge-Labs/trustedge
-->


---
phase: 08-validation
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - Cargo.toml (workspace members' dependencies)
  - .planning/phases/08-validation/VALIDATION-REPORT.md
  - .planning/phases/08-validation/YUBIKEY-MANUAL-PROTOCOL.md
autonomous: true

must_haves:
  truths:
    - "Unused dependencies identified and removed (cargo-machete with metadata)"
    - "Workspace still builds and tests after cleanup"
    - "YubiKey manual testing protocol documented"
    - "Final validation report shows consolidation success"
  artifacts:
    - path: ".planning/phases/08-validation/YUBIKEY-MANUAL-PROTOCOL.md"
      provides: "Manual testing protocol for YubiKey hardware integration"
      min_lines: 50
      contains: ["Prerequisites", "Test Steps", "Expected Results"]
    - path: ".planning/phases/08-validation/VALIDATION-REPORT.md"
      provides: "Updated with final validation status"
      contains: ["Unused Dependencies", "YubiKey Hardware", "Overall Status"]
  key_links:
    - from: "cargo-machete --with-metadata"
      to: "Cargo.toml files"
      via: "unused dependency removal"
      pattern: "cargo machete.*--with-metadata"
    - from: "VALIDATION-REPORT.md"
      to: "Phase 8 completion"
      via: "consolidation validation summary"
      pattern: "Overall.*PASS"
---

<objective>
Complete final validation by cleaning up unused dependencies and documenting YubiKey manual testing protocol.

Purpose: Address deferred cleanup from Phase 1 (cargo-machete findings) and document hardware testing procedure. Finalize validation report with overall consolidation status.

Output: Clean dependency tree, documented YubiKey testing protocol, and final validation report showing successful consolidation.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-validation/08-RESEARCH.md
@.planning/phases/01-foundation/MACHETE-REPORT.md
@.planning/phases/08-validation/08-01-SUMMARY.md
@scripts/ci-check.sh
@crates/core/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unused dependency cleanup with cargo-machete</name>
  <files>
    crates/*/Cargo.toml
    .planning/phases/08-validation/VALIDATION-REPORT.md
  </files>
  <action>
Run cargo-machete with --with-metadata and clean up confirmed unused dependencies (deferred from Phase 1):

1. Run cargo-machete with metadata mode for accuracy:
   ```bash
   cargo machete --with-metadata > .planning/phases/08-validation/MACHETE-CURRENT.txt 2>&1
   ```

2. Compare with Phase 1 MACHETE-REPORT.md findings:
   - Phase 1 flagged: thiserror, serde_bytes, trustedge-trst-core, getrandom, serde-wasm-bindgen
   - Cross-reference against known false positives from research:
     * thiserror: Used via #[derive(Error)] macro - FALSE POSITIVE, keep
     * serde_bytes: Used via #[serde(with = "serde_bytes")] - FALSE POSITIVE, keep
     * getrandom: Required for WASM RNG - FALSE POSITIVE, keep
     * serde-wasm-bindgen: WASM serialization - FALSE POSITIVE, keep
     * trustedge-trst-core: NOW trustedge-trst-protocols after Phase 3 rename - verify still needed

3. Identify REAL unused dependencies (if any):
   - Dependencies with zero usage and not in false positive list
   - Dependencies from consolidation churn (e.g., moved functionality)

4. Remove confirmed unused dependencies:
   - Edit relevant Cargo.toml files
   - Remove dependency entries
   - Commit each removal separately with justification

5. Verify workspace still builds and tests:
   ```bash
   cargo build --workspace --release
   cargo test --workspace --no-fail-fast
   ```

6. Document in VALIDATION-REPORT.md Unused Dependencies section:
   - cargo-machete findings count
   - False positives identified (with reasons)
   - Real unused dependencies removed (with crate names)
   - Post-cleanup verification: PASS (builds and tests) or FAIL

Research indicates most Phase 1 findings are false positives from derive macros and WASM usage. Use --with-metadata to reduce false positive rate. Manual verification required for each flagged dependency.
  </action>
  <verify>
   ```bash
   # Verify machete report exists
   test -f .planning/phases/08-validation/MACHETE-CURRENT.txt

   # Verify unused dependencies section in validation report
   grep -q "Unused Dependencies" .planning/phases/08-validation/VALIDATION-REPORT.md

   # Verify workspace still builds after cleanup
   cargo check --workspace --quiet
   ```
  </verify>
  <done>
Unused dependencies identified via cargo-machete --with-metadata, false positives documented, real unused dependencies removed from Cargo.toml files, workspace verified to build and test successfully. VALIDATION-REPORT.md has Unused Dependencies section with cleanup summary.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document YubiKey manual testing protocol</name>
  <files>.planning/phases/08-validation/YUBIKEY-MANUAL-PROTOCOL.md</files>
  <action>
Create comprehensive YubiKey hardware integration testing protocol (success criterion #4):

1. Document current YubiKey test coverage:
   - Simulation tests: 90+ tests that run without hardware (from research and project memory)
   - What they test: Backend initialization, configuration, capability discovery
   - What they DON'T test: Actual hardware signing, PIV slot operations, physical key interaction

2. Create YUBIKEY-MANUAL-PROTOCOL.md with sections:

   **Prerequisites:**
   - YubiKey 5 series hardware with PIV support
   - PCSC smart card daemon installed and running
   - Build with yubikey feature: `cargo build --features yubikey`
   - YubiKey Management Key and PIN (default: 123456 for both)

   **Setup:**
   - Insert YubiKey into USB port
   - Verify detection: `pcsc_scan` or `ykman info`
   - Reset PIV application if needed: `ykman piv reset`
   - Set up test slot (9a - Authentication)

   **Test Steps:**
   1. Backend Detection Test
      - Run: `cargo run --features yubikey --example [relevant example]` (check examples directory)
      - Expected: YubiKey backend appears in available backends list
      - Verify: Backend info shows correct serial number and PIV capabilities

   2. Key Generation Test
      - Generate Ed25519 key in PIV slot 9a
      - Expected: Key generation succeeds, public key exported
      - Verify: Public key format is valid Ed25519

   3. Signing Test
      - Sign test data using generated key
      - Expected: Signature operation succeeds without error
      - Verify: Signature verifies with public key

   4. Key Persistence Test
      - Restart application, list keys
      - Expected: Previously generated key still available
      - Verify: Same public key exported

   5. PIN Retry Limit Test
      - Attempt operation with wrong PIN 3 times
      - Expected: YubiKey locks, retry counter shows 0
      - Verify: Correct error message displayed
      - Cleanup: Reset PIV application to restore

   **Expected Results:**
   - All tests pass: Hardware integration working correctly
   - Backend detection fails: Check PCSC daemon and YubiKey connection
   - Signing fails: Verify PIV slot contains correct key type

   **Troubleshooting:**
   - "No YubiKey detected": Check USB connection, verify with `ykman list`
   - "PCSC error": Ensure pcscd daemon running (`systemctl status pcscd`)
   - "Authentication failed": Verify default PIN (123456) or use custom PIN
   - "Slot empty": Generate key first before signing

   **Success Criteria:**
   All 5 test steps complete successfully with expected results.

3. Reference existing simulation tests in crates/core/tests/yubikey_integration.rs to show what's already covered automatically.

4. Note in protocol: Simulation tests (90+) run in CI, manual protocol required only for hardware-specific validation.

This documents the existing testing approach (simulation + manual) rather than creating new tests. Success criterion is documentation, not execution.
  </action>
  <verify>
   ```bash
   # Verify protocol document exists and has required sections
   test -f .planning/phases/08-validation/YUBIKEY-MANUAL-PROTOCOL.md
   grep -q "Prerequisites" .planning/phases/08-validation/YUBIKEY-MANUAL-PROTOCOL.md
   grep -q "Test Steps" .planning/phases/08-validation/YUBIKEY-MANUAL-PROTOCOL.md
   grep -q "Expected Results" .planning/phases/08-validation/YUBIKEY-MANUAL-PROTOCOL.md
   grep -q "Troubleshooting" .planning/phases/08-validation/YUBIKEY-MANUAL-PROTOCOL.md
   ```
  </verify>
  <done>
YUBIKEY-MANUAL-PROTOCOL.md created with complete manual testing protocol including prerequisites, setup, 5 test steps, expected results, and troubleshooting. Documents relationship between simulation tests (90+) and manual hardware validation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Finalize validation report with overall status</name>
  <files>.planning/phases/08-validation/VALIDATION-REPORT.md</files>
  <action>
Complete VALIDATION-REPORT.md with final sections and overall consolidation status:

1. Add YubiKey Hardware Integration section:
   - Simulation test coverage: 90+ tests (automated, run in CI)
   - Manual testing protocol: DOCUMENTED (see YUBIKEY-MANUAL-PROTOCOL.md)
   - Hardware testing status: Protocol available for hardware validation when needed
   - Status: PASS (protocol documented per success criterion #4)

2. Add Overall Validation Status section summarizing all validation dimensions:

   **Validation Summary:**
   | Criterion | Requirement | Status | Details |
   |-----------|-------------|--------|---------|
   | Test Count | ≥348 tests preserved | [PASS/FAIL] | [current count] tests (baseline: 348) |
   | API Compatibility | No breaking changes | [PASS/FAIL] | cargo-semver-checks results |
   | All-Features CI | Executed successfully | [PASS/SKIP] | [reason if skipped] |
   | WASM Build | Verified wasm32 target | [PASS/SKIP] | [reason if skipped] |
   | Build Time | <5 min acceptable | PASS | [duration] (baseline established) |
   | Unused Deps | Cleanup complete | PASS | [N] false positives, [M] removed |
   | YubiKey Protocol | Documented | PASS | Manual protocol created |

   **Overall Status:** [PASS/FAIL]
   - PASS requires: Test count ≥348, no API breakage, build time acceptable, deps cleaned, protocol documented
   - SKIP acceptable for: All-features (missing ALSA/PCSC), WASM (missing target)
   - FAIL if: Test count <348, API breakage detected, workspace doesn't build

3. Add Consolidation Impact section:
   - Pre-consolidation: 10 crates with duplicated code (receipts, attestation, manifest)
   - Post-consolidation: Monolithic core with thin facades
   - Code eliminated: ~2,500 LOC of duplication (from Phase 3-5 summaries)
   - Tests preserved: [current count] of 348 baseline
   - API stability: Maintained (no breaking changes)
   - Migration path: 6-month deprecation window (Phase 7)

4. Add Next Steps section:
   - If validation PASS: Consolidation complete, proceed to announce deprecation timeline
   - If validation FAIL: Address failures before declaring consolidation complete
   - Facade removal: Scheduled for 0.4.0 (August 2026)
   - Future work: Monitor downstream consumers during migration window

5. Format report for readability:
   - Use tables for structured data
   - Include links to supporting evidence files
   - Add timestamps and version information
   - Include contact/support information if validation issues found

6. Verify all supporting evidence files referenced in report exist:
   - TEST-COUNT-CURRENT.txt
   - SEMVER-*.txt files
   - BUILD-TIME.txt
   - MACHETE-CURRENT.txt
   - YUBIKEY-MANUAL-PROTOCOL.md

Pull actual results from prior tasks in this plan and Plan 08-01. This task synthesizes validation results into final consolidated status.
  </action>
  <verify>
   ```bash
   # Verify all sections present in validation report
   grep -q "YubiKey Hardware Integration" .planning/phases/08-validation/VALIDATION-REPORT.md
   grep -q "Overall Validation Status" .planning/phases/08-validation/VALIDATION-REPORT.md
   grep -q "Consolidation Impact" .planning/phases/08-validation/VALIDATION-REPORT.md
   grep -q "Next Steps" .planning/phases/08-validation/VALIDATION-REPORT.md

   # Verify overall status declared
   grep -E "Overall.*Status.*PASS|FAIL" .planning/phases/08-validation/VALIDATION-REPORT.md
   ```
  </verify>
  <done>
VALIDATION-REPORT.md complete with YubiKey section, overall validation status summary table, consolidation impact assessment, and next steps. Overall status (PASS/FAIL) clearly declared based on all validation criteria.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Verify VALIDATION-REPORT.md is complete:
   - All sections from Plan 08-01: Test Count, API Compatibility, CI Execution, Build Time
   - All sections from Plan 08-02: Unused Dependencies, YubiKey Hardware, Overall Status, Consolidation Impact, Next Steps
   - Overall status clearly declared as PASS or FAIL

2. Verify all supporting artifacts exist:
   - From 08-01: TEST-COUNT-CURRENT.txt, SEMVER-*.txt, BUILD-TIME.txt, WASM-*.txt
   - From 08-02: MACHETE-CURRENT.txt, YUBIKEY-MANUAL-PROTOCOL.md

3. Verify workspace is clean and functional:
   ```bash
   cargo check --workspace
   cargo test --workspace --no-fail-fast
   cargo clippy --workspace -- -D warnings
   ```

4. Verify all validation requirements met:
   - VAL-01: Test count ≥348 (from VALIDATION-REPORT.md)
   - VAL-02: WASM build succeeds (from WASM-*.txt or skip documented)
   - VAL-03: No API breakage (from SEMVER-*.txt)
   - Success criterion #4: YubiKey protocol documented (YUBIKEY-MANUAL-PROTOCOL.md exists)
   - Success criterion #5: Build time acceptable (from BUILD-TIME.txt)

5. Check if Phase 8 can be marked complete:
   - Overall status in VALIDATION-REPORT.md is PASS
   - All required artifacts committed to git
   - ROADMAP.md can be updated to mark Phase 8 complete
</verification>

<success_criteria>
1. cargo-machete unused dependencies cleaned up (with false positive documentation)
2. Workspace builds and tests successfully after cleanup
3. YUBIKEY-MANUAL-PROTOCOL.md created with comprehensive testing protocol
4. VALIDATION-REPORT.md finalized with overall PASS/FAIL status
5. All validation requirements satisfied (VAL-01, VAL-02, VAL-03)
6. Phase 8 validation artifacts ready for git commit
</success_criteria>

<output>
After completion, create `.planning/phases/08-validation/08-02-SUMMARY.md` documenting:
- Unused dependency cleanup results
- YubiKey manual protocol creation
- Final validation report status
- Overall Phase 8 outcome (PASS/FAIL)
- Consolidation project completion status (if PASS)
- Next steps: Update ROADMAP.md, announce deprecation timeline
</output>
