---
phase: 25-service-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/platform/Cargo.toml
  - crates/platform/src/lib.rs
  - crates/platform/src/verify/mod.rs
  - crates/platform/src/verify/core.rs
  - crates/platform/src/verify/receipt.rs
  - crates/platform/src/verify/signing.rs
  - crates/platform/src/verify/jwks.rs
  - crates/platform/src/verify/validation.rs
  - crates/platform/src/verify/types.rs
  - crates/platform/src/ca/mod.rs
  - crates/platform/src/ca/service.rs
  - crates/platform/src/ca/models.rs
  - crates/platform/src/ca/error.rs
  - crates/platform/src/ca/api.rs
  - crates/platform/src/ca/auth.rs
  - crates/platform/src/ca/database.rs
autonomous: true
requirements: [SVC-01, SVC-02]

must_haves:
  truths:
    - "trustedge-platform crate exists in the workspace and compiles with `cargo build -p trustedge-platform`"
    - "Verification core logic (signature verify, continuity check, receipt construction) is callable from the crate"
    - "CA service module is a private module inside trustedge-platform, not a separate workspace crate"
    - "The crate builds with default features (no postgres) and with --features postgres"
  artifacts:
    - path: "crates/platform/Cargo.toml"
      provides: "Crate manifest with feature-gated postgres"
      contains: "trustedge-platform"
    - path: "crates/platform/src/lib.rs"
      provides: "Crate root with module declarations"
      contains: "mod verify"
    - path: "crates/platform/src/verify/core.rs"
      provides: "Verification logic (BLAKE3 chaining, Ed25519 sig verify)"
      contains: "verify_to_report"
    - path: "crates/platform/src/ca/service.rs"
      provides: "Certificate Authority service using UniversalBackend"
      contains: "CertificateAuthorityService"
  key_links:
    - from: "crates/platform/src/verify/core.rs"
      to: "blake3, ed25519-dalek"
      via: "direct dependency"
      pattern: "blake3::Hasher|ed25519_dalek::VerifyingKey"
    - from: "crates/platform/src/ca/service.rs"
      to: "trustedge-core"
      via: "UniversalBackend trait"
      pattern: "trustedge_core::UniversalBackend"
---

<objective>
Create the trustedge-platform crate skeleton with verification core logic and CA module.

Purpose: Establish the new consolidated crate in the workspace with the non-HTTP, non-DB core logic from both verify-core and trustedge-ca. This is the foundation that Plan 02 builds the HTTP layer on top of.

Output: A compiling `trustedge-platform` workspace crate with `verify` and `ca` modules.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-service-consolidation/25-CONTEXT.md
@.planning/phases/24-type-centralization/24-02-SUMMARY.md

# Source repos to copy from (READ these for exact code):
# Verification core logic:
@~/vault/projects/github.com/trustedge-verify-core/crates/verify-core/src/lib.rs
@~/vault/projects/github.com/trustedge-verify-core/crates/verify-core/src/types.rs
@~/vault/projects/github.com/trustedge-verify-core/crates/verify-core/src/receipt.rs
@~/vault/projects/github.com/trustedge-verify-core/crates/verify-core/src/verification.rs
@~/vault/projects/github.com/trustedge-verify-core/crates/verify-service/src/signing.rs
@~/vault/projects/github.com/trustedge-verify-core/crates/verify-service/src/jwks.rs
@~/vault/projects/github.com/trustedge-verify-core/crates/verify-service/src/validation.rs
@~/vault/projects/github.com/trustedge-verify-core/crates/verify-service/src/types.rs
# CA source:
@~/vault/projects/github.com/trustedge-platform-api/trustedge-ca/src/lib.rs
@~/vault/projects/github.com/trustedge-platform-api/trustedge-ca/src/ca.rs
@~/vault/projects/github.com/trustedge-platform-api/trustedge-ca/src/models.rs
@~/vault/projects/github.com/trustedge-platform-api/trustedge-ca/src/error.rs
@~/vault/projects/github.com/trustedge-platform-api/trustedge-ca/src/api.rs
@~/vault/projects/github.com/trustedge-platform-api/trustedge-ca/src/auth.rs
@~/vault/projects/github.com/trustedge-platform-api/trustedge-ca/src/database.rs
# Existing workspace Cargo.toml:
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trustedge-platform crate with Cargo.toml and verification core module</name>
  <files>
    Cargo.toml
    crates/platform/Cargo.toml
    crates/platform/src/lib.rs
    crates/platform/src/verify/mod.rs
    crates/platform/src/verify/core.rs
    crates/platform/src/verify/receipt.rs
    crates/platform/src/verify/signing.rs
    crates/platform/src/verify/jwks.rs
    crates/platform/src/verify/validation.rs
    crates/platform/src/verify/types.rs
  </files>
  <action>
    **1. Create `crates/platform/Cargo.toml`:**
    - Package name: `trustedge-platform`
    - Edition 2021, license MPL-2.0, description "TrustEdge Platform — consolidated verification and CA service"
    - `[lib]` only (no `[[bin]]` — per user decision: library-only crate)
    - Add `[package.metadata.trustedge]` tier = "stable", maintained = true
    - Dependencies (non-optional, always needed for verify logic):
      - `trustedge-types = { workspace = true }` (shared wire types from Phase 24)
      - `anyhow = { workspace = true }`, `thiserror = { workspace = true }`
      - `serde = { workspace = true }`, `serde_json = { workspace = true }`
      - `blake3 = { workspace = true }`, `ed25519-dalek = { workspace = true }`
      - `base64 = "0.22"` (used by verify-core for encoding)
      - `chrono = { workspace = true }`, `uuid = { workspace = true }`
      - `tracing = "0.1"`, `rand = { workspace = true }`
      - `jsonwebtoken = "9.2"` (for JWS receipt signing)
      - `regex = "1.0"` (for validation)
      - `utoipa = { version = "4.0", features = ["axum_extras", "chrono", "uuid"], optional = true }`
    - Dependencies (feature-gated behind `postgres`):
      - `sqlx = { version = "0.7", features = ["runtime-tokio-rustls", "postgres", "chrono", "uuid", "migrate"], optional = true }`
      - `dotenvy = { version = "0.15", optional = true }`
      - `sha2 = { version = "0.10", optional = true }` (for auth token hashing)
      - `bcrypt = { version = "0.15", optional = true }`
      - `reqwest` is NOT needed — consolidation removes the HTTP forwarding
    - Dependencies (feature-gated behind `ca`):
      - `trustedge-core = { path = "../core", optional = true }` (CA uses UniversalBackend)
      - `x509-parser = { version = "0.16", optional = true }`
      - `der = { version = "0.7", optional = true }`
      - `spki = { version = "0.7", optional = true }`
      - `pkcs8 = { version = "0.10", optional = true }`
      - `x509-cert = { version = "0.2", optional = true }`
      - `const-oid = { version = "0.9", optional = true }`
      - `hex = { version = "0.4", optional = true }`
    - Dependencies for HTTP layer (feature-gated behind `http`):
      - `axum = { version = "0.7", optional = true }`
      - `tower = { version = "0.4", optional = true }`
      - `tower-http = { version = "0.5", features = ["cors", "trace"], optional = true }`
      - `tokio = { workspace = true, optional = true }`
      - `utoipa-swagger-ui = { version = "6.0", features = ["axum"], optional = true }`
    - `[features]` section:
      ```
      default = []
      postgres = ["dep:sqlx", "dep:dotenvy", "dep:sha2", "dep:bcrypt"]
      ca = ["dep:trustedge-core", "dep:x509-parser", "dep:der", "dep:spki", "dep:pkcs8", "dep:x509-cert", "dep:const-oid", "dep:hex"]
      http = ["dep:axum", "dep:tower", "dep:tower-http", "dep:tokio", "dep:utoipa-swagger-ui"]
      openapi = ["dep:utoipa"]
      ```
    - `[dev-dependencies]`: `tokio = { workspace = true }`, `rand = { workspace = true }`, `tower = { version = "0.4", features = ["util"] }`, `axum-test = "14.0"`

    **2. Update root `Cargo.toml`:**
    - Add `"crates/platform"` to `[workspace] members` list
    - Update Tier 1 classification comment to include trustedge-platform

    **3. Create `crates/platform/src/lib.rs`:**
    - MPL-2.0 copyright header
    - `pub mod verify;` (always available)
    - `#[cfg(feature = "ca")] pub mod ca;` (feature-gated)
    - `#[cfg(feature = "postgres")] pub mod database;` (placeholder, Plan 02 creates this)
    - `#[cfg(feature = "http")] pub mod http;` (placeholder, Plan 02 creates this)

    **4. Create verification module by copying from verify-core and verify-service:**

    `crates/platform/src/verify/mod.rs`:
    - Re-export public items from submodules: `pub use core::*;`, `pub use types::*;`, etc.
    - Note: the `core` module name will collide with std `core` — use `pub mod engine;` instead of `pub mod core;` to avoid the naming conflict. Name the file `engine.rs` instead.

    Actually, to avoid confusion: name the verification logic module `engine.rs` (not `core.rs`).
    ```
    pub mod engine;
    pub mod receipt;
    pub mod signing;
    pub mod jwks;
    pub mod validation;
    pub mod types;
    ```

    `crates/platform/src/verify/engine.rs`:
    - Copy the verification logic from `~/vault/projects/github.com/trustedge-verify-core/crates/verify-core/src/lib.rs`
    - Includes: `SegmentDigest`, `VerifyReport`, `VerificationResult`, `VerificationMetadata`, `Receipt` structs
    - Includes: `verify_to_report()`, `receipt_from_report()`, and all private helpers (`verify_signature`, `verify_continuity`, `canonicalize_manifest_for_signature`, `compute_genesis_hash`, `compute_chain_link`, `compute_chain_tip`)
    - Include the `#[cfg(test)] mod tests` block with all 5 unit tests
    - Update copyright header to MPL-2.0 trustedge format
    - Keep `#[cfg_attr(feature = "openapi", derive(utoipa::ToSchema))]` on structs (maps to crate's `openapi` feature)
    - NOTE: verify-core's `types.rs`, `receipt.rs`, `verification.rs` are all `pub use crate::*;` re-exports with no actual code — they can be skipped. All logic is in `lib.rs`.

    `crates/platform/src/verify/types.rs`:
    - Copy from `~/vault/projects/github.com/trustedge-verify-core/crates/verify-service/src/types.rs`
    - Structs: `VerifyRequest`, `VerifyOptions`, `VerifyResponse`, `HealthResponse`
    - Update imports to reference `super::engine::{SegmentDigest, VerifyReport}` instead of `trustedge_verify_core::{...}`
    - Keep `#[derive(utoipa::ToSchema)]` — gate with `#[cfg_attr(feature = "openapi", derive(utoipa::ToSchema))]`

    `crates/platform/src/verify/validation.rs`:
    - Copy from `~/vault/projects/github.com/trustedge-verify-core/crates/verify-service/src/validation.rs`
    - Struct: `ValidationError`, fn: `validate_verify_request`, `validate_segment_hashes`
    - Update imports to use `super::types::VerifyRequest` and `super::engine::SegmentDigest`
    - Include all 5 unit tests
    - Gate ToSchema with `#[cfg_attr(feature = "openapi", derive(utoipa::ToSchema))]`

    `crates/platform/src/verify/signing.rs`:
    - Copy from `~/vault/projects/github.com/trustedge-verify-core/crates/verify-service/src/signing.rs`
    - `sign_receipt_jws()` function
    - Update import of `Receipt` to `super::engine::Receipt`
    - Update import of `KeyManager` to `super::jwks::KeyManager`

    `crates/platform/src/verify/jwks.rs`:
    - Copy from `~/vault/projects/github.com/trustedge-verify-core/crates/verify-service/src/jwks.rs`
    - `KeyManager` struct with all methods
    - No import changes needed (standalone, uses ed25519_dalek directly)

    `crates/platform/src/verify/receipt.rs`:
    - Leave empty or remove — the receipt construction function `receipt_from_report` is already in `engine.rs` from the verify-core lib.rs copy. If you create this file, just add a comment saying receipt logic is in engine.rs.
    - Actually, skip this file entirely. Update `mod.rs` to not declare `pub mod receipt;`.

    **5. Verify compilation:**
    - Run `cargo build -p trustedge-platform` (default features — no postgres, no ca, no http)
    - Run `cargo test -p trustedge-platform --lib` (should pass the unit tests from engine.rs and validation.rs)
    - Fix any compilation errors from import path changes
  </action>
  <verify>
    `cargo build -p trustedge-platform` succeeds with exit code 0.
    `cargo test -p trustedge-platform --lib` passes all unit tests (expect ~10 tests: 5 from engine.rs, 5 from validation.rs).
    `cargo clippy -p trustedge-platform -- -D warnings` passes.
  </verify>
  <done>
    trustedge-platform compiles in the workspace with default features. Verification core logic (verify_to_report, validate_verify_request, sign_receipt_jws, KeyManager) is callable. 10 unit tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CA module as private module inside trustedge-platform</name>
  <files>
    crates/platform/src/ca/mod.rs
    crates/platform/src/ca/service.rs
    crates/platform/src/ca/models.rs
    crates/platform/src/ca/error.rs
    crates/platform/src/ca/api.rs
    crates/platform/src/ca/auth.rs
    crates/platform/src/ca/database.rs
  </files>
  <action>
    **1. Create CA module by copying from trustedge-ca:**

    `crates/platform/src/ca/mod.rs`:
    - Copy structure from `~/vault/projects/github.com/trustedge-platform-api/trustedge-ca/src/lib.rs`
    - Declare submodules: `pub mod service;`, `pub mod models;`, `pub mod error;`
    - Gate HTTP-dependent modules: `#[cfg(feature = "http")] pub mod api;`
    - `pub mod auth;`, `pub mod database;` (these are placeholders in the original, keep them gated or present as-is)
    - Re-export key types: `pub use service::CertificateAuthorityService;`, `pub use error::{CAError, CAResult};`
    - Add `CAConfig` struct (from trustedge-ca/src/lib.rs)
    - Update copyright header to MPL-2.0 trustedge format

    `crates/platform/src/ca/service.rs`:
    - Copy from `~/vault/projects/github.com/trustedge-platform-api/trustedge-ca/src/ca.rs`
    - `CertificateAuthorityService` struct and all methods
    - `create_yubikey_ca_service()` helper function
    - Update copyright header
    - Imports reference `super::models::*`, `super::error::*`
    - `trustedge_core::{CryptoOperation, CryptoResult, SignatureAlgorithm, UniversalBackend}` stays as-is (via `ca` feature dep)

    `crates/platform/src/ca/models.rs`:
    - Copy from `~/vault/projects/github.com/trustedge-platform-api/trustedge-ca/src/models.rs`
    - All model types: TenantId, UserId, Certificate, CertificateRequest, etc.
    - Update copyright header

    `crates/platform/src/ca/error.rs`:
    - Copy from `~/vault/projects/github.com/trustedge-platform-api/trustedge-ca/src/error.rs`
    - `CAError` enum, `CAResult` type alias
    - Update copyright header
    - NOTE: `CAError::Database(#[from] sqlx::Error)` variant needs to be gated: `#[cfg(feature = "postgres")]` on that variant, OR change it to store a String. Since CA currently depends on sqlx directly, gate the variant: use `#[cfg(feature = "postgres")] #[error("Database error: {0}")] Database(#[from] sqlx::Error)` and add a non-postgres fallback: `#[cfg(not(feature = "postgres"))] #[error("Database error: {0}")] Database(String)`.

    `crates/platform/src/ca/api.rs`:
    - Copy from `~/vault/projects/github.com/trustedge-platform-api/trustedge-ca/src/api.rs`
    - Gate entire file content with `#[cfg(feature = "http")]` (at module level via mod.rs)
    - Includes: `create_router`, `issue_certificate`, `revoke_certificate`, `list_certificates`, `health_check`, `get_ca_certificate` handlers
    - Includes all validation functions and 11 unit tests (these are pure validation, no HTTP needed)
    - Actually: split the validation tests out so they run without the `http` feature. Put `validate_certificate_request`, `validate_revocation_request`, `validate_list_query` functions directly in models.rs or a validation submodule. The route handlers stay in api.rs behind `http` feature. The tests for validation functions should always run.
    - Simpler approach: just keep api.rs behind `http` feature entirely. The tests in api.rs test validation logic but also reference Axum types in the handler functions. Keep it simple — all behind `http` feature.
    - Update imports to use `super::models::*`, `super::CertificateAuthorityService`
    - Update copyright header

    `crates/platform/src/ca/auth.rs`:
    - Copy from `~/vault/projects/github.com/trustedge-platform-api/trustedge-ca/src/auth.rs`
    - Placeholder auth service (original is unimplemented)
    - Update imports, copyright header

    `crates/platform/src/ca/database.rs`:
    - Copy from `~/vault/projects/github.com/trustedge-platform-api/trustedge-ca/src/database.rs`
    - Placeholder database (original is unimplemented)
    - Update imports, copyright header

    **2. Update `crates/platform/src/lib.rs`:**
    - Ensure `#[cfg(feature = "ca")] mod ca;` is declared (private, per user decision — NOT `pub mod ca`)
    - However, for testing and internal access, make it `pub(crate)` or `pub` with a doc comment saying it's not part of the public API. Per user decision "CA is a private module" — use `#[cfg(feature = "ca")] mod ca;` (no pub).

    **3. Verify compilation with ca feature:**
    - Run `cargo build -p trustedge-platform --features ca` — should compile
    - Run `cargo build -p trustedge-platform` (no features) — should compile without CA
    - Fix any compilation errors
  </action>
  <verify>
    `cargo build -p trustedge-platform --features ca` succeeds.
    `cargo build -p trustedge-platform` (default) still succeeds.
    `cargo test -p trustedge-platform --lib` still passes all verify tests (~10).
    `cargo clippy -p trustedge-platform --features ca -- -D warnings` passes (or only has pre-existing warnings from copied code that are acceptable).
  </verify>
  <done>
    CA module exists as a private module inside trustedge-platform, feature-gated behind `ca`. CertificateAuthorityService is callable from within the crate when the feature is enabled. The crate compiles both with and without the `ca` feature.
  </done>
</task>

</tasks>

<verification>
1. `cargo build -p trustedge-platform` — compiles with default features
2. `cargo build -p trustedge-platform --features ca` — compiles with CA feature
3. `cargo test -p trustedge-platform --lib` — all unit tests pass (~10 tests)
4. `cargo clippy -p trustedge-platform -- -D warnings` — no warnings
5. `grep -r "trustedge-platform" Cargo.toml` — workspace member registered
</verification>

<success_criteria>
- trustedge-platform crate exists in workspace, builds successfully
- Verification core logic callable: verify_to_report, KeyManager, sign_receipt_jws
- CA module is private (mod ca, not pub mod ca), gated behind `ca` feature
- ~10 unit tests pass from verification logic
- No regressions in existing workspace tests
</success_criteria>

<output>
After completion, create `.planning/phases/25-service-consolidation/25-01-SUMMARY.md`
</output>
