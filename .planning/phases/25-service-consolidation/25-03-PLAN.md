---
phase: 25-service-consolidation
plan: 03
type: execute
wave: 3
depends_on: [25-02]
files_modified:
  - crates/platform/tests/verify_integration.rs
  - crates/platform/tests/platform_integration.rs
  - scripts/ci-check.sh
  - CLAUDE.md
  - DEPENDENCIES.md
autonomous: true
requirements: [SVC-03, SVC-04]

must_haves:
  truths:
    - "All 18 verify-core tests pass in the consolidated crate (6 unit in engine.rs, 5 unit in validation.rs, 7 integration)"
    - "All 11 platform-api tests are present and marked #[ignore] (require PostgreSQL)"
    - "CI validates trustedge-platform as Tier 1 (blocking)"
    - "CLAUDE.md updated to reflect 12-crate workspace with trustedge-platform"
  artifacts:
    - path: "crates/platform/tests/verify_integration.rs"
      provides: "7 integration tests from verify-core"
      contains: "test_happy_path_verification"
    - path: "crates/platform/tests/platform_integration.rs"
      provides: "11 integration tests from platform-api"
      contains: "test_auth_middleware"
    - path: "scripts/ci-check.sh"
      provides: "Updated CI with trustedge-platform Tier 1"
      contains: "trustedge-platform"
  key_links:
    - from: "crates/platform/tests/verify_integration.rs"
      to: "crates/platform/src/verify/engine.rs"
      via: "integration test imports"
      pattern: "trustedge_platform::verify"
    - from: "scripts/ci-check.sh"
      to: "crates/platform/Cargo.toml"
      via: "cargo test/clippy -p trustedge-platform"
      pattern: "trustedge-platform"
---

<objective>
Migrate all tests from both source repos and update CI and documentation.

Purpose: Validate that the consolidated crate passes all 29 original tests (18 from verify-core + 11 from platform-api), update CI to treat trustedge-platform as Tier 1 blocking, and update workspace documentation.

Output: Complete test suite, CI integration, updated docs.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-service-consolidation/25-CONTEXT.md
@.planning/phases/25-service-consolidation/25-01-SUMMARY.md
@.planning/phases/25-service-consolidation/25-02-SUMMARY.md

# Source test files:
@~/vault/projects/github.com/trustedge-verify-core/tests/integration_tests.rs
@~/vault/projects/github.com/trustedge-platform-api/platform-api/tests/integration_test.rs

# Existing CI and docs:
@scripts/ci-check.sh
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate verify-core integration tests</name>
  <files>
    crates/platform/tests/verify_integration.rs
  </files>
  <action>
    **1. Create `crates/platform/tests/verify_integration.rs`:**
    - MPL-2.0 copyright header
    - Migrate all 7 tests from `~/vault/projects/github.com/trustedge-verify-core/tests/integration_tests.rs`

    **Tests to migrate (all should run without any external deps):**
    1. `test_health_endpoint` — Uses Axum tower::ServiceExt oneshot. Needs `http` feature.
    2. `test_jwks_endpoint` — Same pattern. Needs `http` feature.
    3. `test_happy_path_verification` — Pure crypto test. No feature needed.
    4. `test_tampered_segment_verification` — Pure crypto test.
    5. `test_wrong_key_verification` — Pure crypto test.
    6. `test_empty_segments_verification` — Pure crypto test.
    7. `test_key_manager_creation_and_jwks` — Tests KeyManager. No feature needed.

    **Import updates:**
    - Replace `trustedge_verify_core::{verify_to_report, SegmentDigest}` with `trustedge_platform::verify::{verify_to_report, SegmentDigest}`
    - Replace `trustedge_verify_service::{AppState, KeyManager}` with `trustedge_platform::verify::jwks::KeyManager` and `trustedge_platform::http::AppState` (for HTTP tests)
    - For HTTP tests (health, JWKS), use `trustedge_platform::http::create_router` with the AppState from the http module

    **HTTP integration tests (tests 1, 2):**
    - Gate behind `#[cfg(feature = "http")]`
    - Create a test helper `create_test_app()` that builds the router with a KeyManager in AppState (no DB pool — these are stateless endpoints)
    - The original integration_tests.rs defines its own `verify_handler`, `jwks_handler`, `health_handler` — instead, use the real handlers from the consolidated crate via `create_router`
    - Actually, the original tests define simplified local handlers because they can't import the service handlers easily. In our consolidated crate, we CAN import the real router. Replace the local handler definitions with `trustedge_platform::http::create_router(state)`.
    - These tests use `tower::ServiceExt::oneshot` to test the router.

    **Pure crypto tests (tests 3-7):**
    - These just call `verify_to_report()` and `KeyManager::new()` — no feature gates needed
    - Update imports to `trustedge_platform::verify::*`

    **2. Verify all 7 tests pass:**
    - `cargo test -p trustedge-platform --test verify_integration` (pure crypto tests)
    - `cargo test -p trustedge-platform --test verify_integration --features http` (includes HTTP tests)
  </action>
  <verify>
    `cargo test -p trustedge-platform --test verify_integration` passes the 5 non-HTTP integration tests.
    `cargo test -p trustedge-platform --test verify_integration --features http` passes all 7 integration tests.
  </verify>
  <done>
    All 7 verify-core integration tests pass in the consolidated crate. HTTP tests gated behind `http` feature. Pure crypto tests always available.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate platform-api integration tests and update CI/docs</name>
  <files>
    crates/platform/tests/platform_integration.rs
    scripts/ci-check.sh
    CLAUDE.md
    DEPENDENCIES.md
  </files>
  <action>
    **1. Create `crates/platform/tests/platform_integration.rs`:**
    - MPL-2.0 copyright header
    - Migrate all 11 tests from `~/vault/projects/github.com/trustedge-platform-api/platform-api/tests/integration_test.rs`
    - ALL tests get `#[ignore]` attribute — they require a running PostgreSQL instance (matching YubiKey test pattern per user decision)
    - Gate behind `#[cfg(all(feature = "http", feature = "postgres"))]` at file level

    **Tests to migrate (all #[ignore]):**
    1. `test_auth_middleware` — Tests 401 without token, 200 with valid token
    2. `test_device_registration` — Tests POST /v1/devices
    3. `test_org_isolation` — Tests multi-tenant isolation
    4. `test_jwks_proxy` — Tests JWKS endpoint (now returns local keys, not proxy; expect 200 not 502)
    5. `test_verify_invalid_payload_returns_400`
    6. `test_verify_empty_device_pub_returns_400`
    7. `test_verify_empty_manifest_returns_400`
    8. `test_verify_invalid_segments_returns_400`
    9. `test_verify_valid_payload_forwards_to_core` — Rename to `test_verify_valid_payload_inline_verification`. Now expect actual verification result (not 502 from missing verify-core). The test sends a basic payload with `device_pub: "ed25519:test"` — this will fail verification (invalid key), but should return a proper verification result with `success: false`, not a 502. Adjust the expected status code and response based on the inline verification behavior.
    10. `test_verify_malformed_json_returns_400`
    11. `test_verify_unknown_fields_returns_400`

    **Import updates:**
    - Replace `platform_api::handlers::create_test_app` with `trustedge_platform::http::handlers::create_test_app` (or the equivalent from the consolidated crate)
    - Replace `platform_api::auth::{generate_token, hash_token_for_storage}` with `trustedge_platform::http::auth::{generate_token, hash_token_for_storage}`
    - Replace `platform_api::database::*` with `trustedge_platform::database::*`
    - Use `axum_test::TestServer` pattern (same as original)

    **Key behavioral change for test 4 (JWKS):**
    - Original: JWKS proxied to verify_core_url which was mock → returned 502
    - Consolidated: JWKS served from local KeyManager → should return 200 with valid JWKS
    - Update test expectation: `assert_eq!(response.status_code(), 200)` and validate JWKS structure

    **Key behavioral change for test 9 (verify valid payload):**
    - Original: forwarded to verify_core_url via HTTP → returned 502 (mock server not running)
    - Consolidated: calls verify_to_report() directly → returns verification result
    - The test payload has `device_pub: "ed25519:test"`, `manifest: "test manifest"`, `segments: [{"index": 0, "hash": "a".repeat(64)}]`
    - `validate_segments` from te_shared would catch the segments (hash without `b3:` prefix), but the platform-api handlers check `device_pub` and `manifest` first. With inline verification, the validation order may differ.
    - The segment hash `"a".repeat(64)` lacks the `b3:` prefix — the verify-service validation would reject it, but platform-api's `te_shared::validate_segments` may accept it differently.
    - Safest: update this test to send a properly formatted request and expect a verification error (bad key), returning 200 with `result.success = false`. OR keep the segment format that triggers a 400 validation error. Test the exact behavior after compilation and adjust.

    **2. Update `scripts/ci-check.sh`:**
    - Add trustedge-platform to Tier 1 clippy step (Step 4):
      `cargo clippy -p trustedge-platform -- -D warnings`
      Also: `cargo clippy -p trustedge-platform --features "http,postgres,ca" -- -D warnings`
    - Add trustedge-platform to Tier 1 test step (Step 11):
      `cargo test -p trustedge-platform --lib` (unit tests, no features)
      `cargo test -p trustedge-platform --test verify_integration` (integration tests, no DB needed)
    - Do NOT add `--test platform_integration` to CI — those are #[ignore] (need PostgreSQL)
    - **Raise dependency tree baseline (Step 21):** Per user decision, the dep tree threshold must be raised to accommodate platform deps (axum, sqlx, tower, hyper). Update `baseline=60` to the new count after building with all features. Run `cargo tree --workspace --depth 1 --prefix none --no-dedupe 2>/dev/null | sort -u | wc -l` with full features to determine the new count, then set `baseline` to that value (expect ~120-150 given axum+sqlx transitive deps). The `threshold` formula (`baseline + 10`) stays the same.
    - Read the current ci-check.sh to find the exact step numbers and format

    **3. Update `CLAUDE.md`:**
    - Update crate count from 11 to 12 (adding trustedge-platform)
    - Add `trustedge-platform` to the Core Platform section in Architecture Overview
    - Add test command: `cargo test -p trustedge-platform --lib` and `cargo test -p trustedge-platform --test verify_integration`
    - Add build command with features: `cargo build -p trustedge-platform --features "http,postgres,ca"`
    - Update the "Key Modules" table or add trustedge-platform as a crate entry
    - Update Crate Classification comment reference

    **4. Update `DEPENDENCIES.md`:**
    - Add trustedge-platform entry documenting new dependencies:
      - axum, tower, tower-http (HTTP framework — feature-gated `http`)
      - sqlx (database — feature-gated `postgres`)
      - jsonwebtoken (JWS receipt signing)
      - sha2 (token hashing — feature-gated `postgres`)
      - bcrypt (password hashing — feature-gated `postgres`)
      - dotenvy (env var loading — feature-gated `postgres`)
      - regex (validation)
      - utoipa, utoipa-swagger-ui (OpenAPI — feature-gated `openapi`, `http`)
    - Note: reqwest is NOT used (consolidation removed HTTP forwarding)
    - Read existing DEPENDENCIES.md format first and follow it

    **5. Run full CI validation:**
    - `cargo test --workspace` to verify no regressions
    - `./scripts/ci-check.sh` or at minimum the clippy + test steps
  </action>
  <verify>
    `cargo test -p trustedge-platform --test verify_integration` passes all non-HTTP tests.
    `cargo test -p trustedge-platform --test verify_integration --features http` passes all 7 tests.
    `cargo test -p trustedge-platform --lib` passes all 11 unit tests (6 engine + 5 validation).
    Platform integration tests exist and are #[ignore]: `cargo test -p trustedge-platform --test platform_integration --features "http,postgres" -- --list` shows 11 tests.
    `cargo test --workspace` passes (no regressions).
    `cargo clippy -p trustedge-platform --features "http,postgres,ca" -- -D warnings` passes.
    CLAUDE.md mentions trustedge-platform and says 12 crates.
    ci-check.sh includes trustedge-platform in Tier 1 steps.
  </verify>
  <done>
    All 18 verify-core tests pass (11 unit + 7 integration). 11 platform-api tests present as #[ignore]. CI validates trustedge-platform as Tier 1. CLAUDE.md and DEPENDENCIES.md updated. Total: 29 tests accounted for (18 running, 11 ignored/DB-dependent).
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p trustedge-platform --lib` — 11 unit tests pass (6 engine + 5 validation)
2. `cargo test -p trustedge-platform --test verify_integration --features http` — 7 integration tests pass
3. `cargo test -p trustedge-platform --test platform_integration --features "http,postgres" -- --list` — 11 tests listed
4. `cargo test --workspace` — no regressions in existing 235+ tests
5. `cargo clippy -p trustedge-platform --features "http,postgres,ca" -- -D warnings` — clean
6. `grep "trustedge-platform" scripts/ci-check.sh` — present in Tier 1 steps
7. `grep "12" CLAUDE.md` or `grep "trustedge-platform" CLAUDE.md` — documented
</verification>

<success_criteria>
- 18 verify-core tests pass: 6 engine.rs unit + 5 validation.rs unit + 7 integration
- 11 platform-api tests present with #[ignore] (require PostgreSQL)
- Total 29 tests accounted for per SVC-04
- CI treats trustedge-platform as Tier 1 blocking
- CLAUDE.md reflects 12-crate workspace
- DEPENDENCIES.md documents new deps
- No regressions in existing workspace tests
</success_criteria>

<output>
After completion, create `.planning/phases/25-service-consolidation/25-03-SUMMARY.md`
</output>
