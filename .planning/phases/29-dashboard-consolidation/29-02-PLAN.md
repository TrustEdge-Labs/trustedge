---
phase: 29-dashboard-consolidation
plan: 02
type: execute
wave: 2
depends_on:
  - "29-01"
files_modified:
  - scripts/generate-types.sh
  - web/dashboard/src/lib/types.ts
  - web/dashboard/src/lib/types-local.ts
autonomous: true
requirements:
  - WEB-03

must_haves:
  truths:
    - "web/dashboard/src/lib/types.ts is generated from trustedge-types JSON schemas, not hand-written"
    - "Running scripts/generate-types.sh regenerates types.ts from current Rust schemas"
    - "Dashboard TypeScript types match the Rust wire types (VerifyReport, Receipt, VerifyRequest, VerifyResponse, etc.)"
    - "Dashboard-only types (Device, DevicesResponse, CreateDeviceRequest) remain available for use"
    - "npm run build still succeeds after type replacement"
  artifacts:
    - path: "scripts/generate-types.sh"
      provides: "Type generation pipeline script"
      contains: "json-schema-to-typescript"
    - path: "web/dashboard/src/lib/types.ts"
      provides: "Generated TypeScript interfaces from Rust schemas"
      contains: "VerifyReport"
    - path: "web/dashboard/src/lib/types-local.ts"
      provides: "Hand-written dashboard-only types not in trustedge-types"
      contains: "Device"
  key_links:
    - from: "scripts/generate-types.sh"
      to: "crates/types/tests/fixtures/*.json"
      via: "reads JSON Schema fixture files"
      pattern: "crates/types/tests/fixtures"
    - from: "scripts/generate-types.sh"
      to: "web/dashboard/src/lib/types.ts"
      via: "writes generated output"
      pattern: "web/dashboard/src/lib/types.ts"
    - from: "web/dashboard/src/lib/api.ts"
      to: "web/dashboard/src/lib/types.ts"
      via: "import type"
      pattern: "import.*types"
---

<objective>
Replace hand-written dashboard TypeScript types with types generated from trustedge-types JSON schemas.

Purpose: Ensure the dashboard's TypeScript interfaces stay in sync with the Rust wire types. When Rust types change, re-running the generation script updates the TypeScript automatically -- no manual synchronization needed.

Output: A `scripts/generate-types.sh` script, a generated `web/dashboard/src/lib/types.ts`, and a `web/dashboard/src/lib/types-local.ts` for dashboard-only types.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-dashboard-consolidation/29-CONTEXT.md
@.planning/phases/29-dashboard-consolidation/29-01-SUMMARY.md
@crates/types/src/schema.rs
@crates/types/src/lib.rs
@crates/types/tests/fixtures/verify_report.v1.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create type generation script and split dashboard types</name>
  <files>
    scripts/generate-types.sh
    web/dashboard/src/lib/types-local.ts
  </files>
  <action>
    **Step 1: Create scripts/generate-types.sh**

    Create a shell script that:
    1. Sets -euo pipefail for safety
    2. Determines REPO_ROOT via `git rev-parse --show-toplevel`
    3. Reads the 4 existing JSON Schema fixture files from `crates/types/tests/fixtures/` (verify_report.v1.json, receipt.v1.json, verify_request.v1.json, verify_response.v1.json). These are the already-committed schema fixtures pinned by snapshot tests -- no need to run Rust to dump schemas.
    4. Also generates a JSON Schema for PolicyV0 by running a small Rust snippet via `cargo test`. Specifically, add a test in `crates/types/tests/schema_snapshot.rs` that writes policy_v0.v1.json to fixtures, OR use a simpler approach: create a temporary combined JSON Schema file that merges all 4 fixture schemas into a single file, then feed that to json-schema-to-typescript.

    **Simplest approach (preferred):** The 4 fixture JSON files already exist. The script should:
    - Check that `npx` is available (it comes with npm)
    - For each .json fixture file in `crates/types/tests/fixtures/`, run `npx json-schema-to-typescript` to convert it to TypeScript
    - Concatenate all generated TypeScript into a single `web/dashboard/src/lib/types.ts` file
    - Add a "DO NOT EDIT" header comment to the generated file explaining it was generated from Rust schemas

    The script should produce output like:
    ```typescript
    // AUTO-GENERATED from trustedge-types JSON schemas.
    // Do not edit manually. Run scripts/generate-types.sh to regenerate.
    //
    // Source: crates/types/tests/fixtures/*.json
    // Generator: json-schema-to-typescript (via npx)

    export interface VerifyReport {
      signature: string;
      continuity: string;
      // ... fields from schema
    }
    // ... other types
    ```

    Use `npx json-schema-to-typescript` (the npm package is `json-schema-to-typescript` and provides a `json2ts` CLI). The command is:
    ```
    npx --yes json2ts -i <input.json> --no-additionalProperties --bannerComment ""
    ```

    Use `--bannerComment ""` to suppress the default banner (we add our own header), and `--no-additionalProperties` since our schemas already have `additionalProperties: false`.

    Run each schema file through json2ts separately, capture output, then combine into one file with the header.

    Make the script executable: `chmod +x scripts/generate-types.sh`

    **Step 2: Create web/dashboard/src/lib/types-local.ts**

    Move the dashboard-only types (that do NOT exist in trustedge-types) into a new file `types-local.ts`. These are types specific to the platform API that the dashboard consumes but that aren't in the trustedge-types crate:

    ```typescript
    // Dashboard-local types not generated from trustedge-types schemas.
    // These are platform-API types specific to the dashboard.

    export interface Device {
      id: string;
      device_id: string;
      public_key: string;
      label: string;
      created_at: string;
      updated_at: string;
    }

    export interface DevicesResponse {
      devices: Device[];
    }

    export interface CreateDeviceRequest {
      device_id: string;
      public_key: string;
      label: string;
    }

    export interface ReceiptsResponse {
      receipts: Receipt[];
      total: number;
      page: number;
      limit: number;
    }
    ```

    Note: ReceiptsResponse references `Receipt` which will come from the generated types.ts. Add an import at the top:
    ```typescript
    import type { Receipt } from './types';
    ```

    Wait -- the generated Receipt from trustedge-types has different fields than the dashboard's hand-written Receipt. The trustedge-types Receipt has: verification_id, profile, device_id, manifest_digest, segments, duration_s, signature (string), continuity (string), issued_at, service_kid, chain_tip. The dashboard's Receipt has: id, device_id, signature (boolean!), continuity (boolean!), segments, issued_at, payload. These are structurally different.

    This means the dashboard Receipt is a dashboard-specific view of receipts (what the platform API returns for the dashboard endpoint), not the same as the trustedge-types Receipt (which is the verification receipt wire type). Per CONTEXT.md decision: "no hand-written TypeScript interface definitions remain for types that exist in trustedge-types." The dashboard Receipt IS different from trustedge-types Receipt, so we should:
    - Generate types.ts from trustedge-types (VerifyReport, Receipt, VerifyRequest, VerifyResponse, SegmentRef, VerifyOptions, OutOfOrder, PolicyV0)
    - Keep the dashboard's original Receipt as `DashboardReceipt` in types-local.ts (renamed to avoid confusion)
    - Update dashboard source files to use `DashboardReceipt` where they reference the dashboard-shaped receipt

    Actually, simpler: looking at the dashboard code, its Receipt is used in ReceiptsResponse and the receipts pages. The generated types.ts will have the trustedge-types Receipt. The dashboard pages likely use the dashboard-shaped receipt. So:
    - types.ts = generated from trustedge-types schemas (the canonical wire types)
    - types-local.ts = dashboard UI types (DashboardReceipt renamed from Receipt, Device, DevicesResponse, CreateDeviceRequest, ReceiptsResponse)
    - Update imports in api.ts, routes/receipts/*.svelte, routes/devices/*.svelte to import from the correct file

    In types-local.ts, rename the dashboard's Receipt to avoid collision:
    ```typescript
    // Dashboard-specific receipt shape (as returned by the platform list/get API).
    // This differs from the trustedge-types Receipt which is the verification receipt wire type.
    export interface DashboardReceipt {
      id: string;
      device_id: string;
      signature: boolean;
      continuity: boolean;
      segments: number;
      issued_at: string;
      payload?: any;
    }

    export interface ReceiptsResponse {
      receipts: DashboardReceipt[];
      total: number;
      page: number;
      limit: number;
    }
    ```

    Then update any dashboard `.svelte` or `.ts` files that import `Receipt` from `./types` to instead import `DashboardReceipt` from `./types-local`. Specifically check: api.ts, routes/receipts/+page.svelte, routes/receipts/[id]/+page.svelte.
  </action>
  <verify>
    Run `bash scripts/generate-types.sh` -- must exit 0 and produce web/dashboard/src/lib/types.ts.
    Run `grep 'AUTO-GENERATED' web/dashboard/src/lib/types.ts` -- must find the header.
    Run `grep 'VerifyReport' web/dashboard/src/lib/types.ts` -- must find the generated interface.
    Run `grep 'Receipt' web/dashboard/src/lib/types.ts` -- must find the trustedge-types Receipt.
    Run `grep 'DashboardReceipt' web/dashboard/src/lib/types-local.ts` -- must find dashboard-specific type.
    Run `grep 'Device' web/dashboard/src/lib/types-local.ts` -- must find Device type.
    Run `cd web/dashboard && npm run build` -- must exit 0 (all imports resolve correctly).
  </verify>
  <done>
    scripts/generate-types.sh exists and produces types.ts from JSON Schema fixtures. types-local.ts contains dashboard-only types. Dashboard builds successfully with the new type split. No hand-written TypeScript interfaces remain for types that exist in trustedge-types.
  </done>
</task>

</tasks>

<verification>
1. `bash scripts/generate-types.sh` exits 0
2. `web/dashboard/src/lib/types.ts` contains "AUTO-GENERATED" header
3. `web/dashboard/src/lib/types.ts` contains interfaces for VerifyReport, Receipt, VerifyRequest, VerifyResponse (from trustedge-types schemas)
4. `web/dashboard/src/lib/types-local.ts` contains Device, DashboardReceipt, DevicesResponse, CreateDeviceRequest
5. `cd web/dashboard && npm run build` exits 0
6. `cd web/dashboard && npm run check` exits 0 (TypeScript validation passes)
7. No hand-written TypeScript interfaces remain for types that exist in trustedge-types
</verification>

<success_criteria>
- scripts/generate-types.sh converts JSON Schema fixtures to TypeScript via json-schema-to-typescript
- web/dashboard/src/lib/types.ts is fully generated (not hand-written) with correct interfaces
- Dashboard-only types live in types-local.ts
- Dashboard builds and type-checks successfully
- Re-running generate-types.sh produces identical output (idempotent)
</success_criteria>

<output>
After completion, create `.planning/phases/29-dashboard-consolidation/29-02-SUMMARY.md`
</output>
