---
phase: 21-core-stub-elimination
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/core/src/envelope_v2_bridge.rs
  - crates/core/src/lib.rs
  - crates/core/src/protocols/mod.rs
  - crates/core/src/backends/universal.rs
  - crates/core/src/backends/software_hsm.rs
  - crates/core/src/backends/yubikey.rs
autonomous: true

must_haves:
  truths:
    - "envelope_v2_bridge.rs does not exist in the codebase"
    - "No public API exports EnvelopeFormat, UnifiedEnvelope, EnvelopeInfo, or detect_envelope_format"
    - "HashAlgorithm enum has exactly 3 variants: Sha256, Sha384, Sha512"
    - "Software HSM hash_data function has no Blake2b match arm"
    - "YubiKey piv_generate has no TODO comment about future implementation"
    - "YubiKey piv_generate error message directs users to ykman with specific command"
    - "cargo test --workspace passes with zero failures"
    - "cargo build --workspace --release produces zero warnings"
  artifacts:
    - path: "crates/core/src/lib.rs"
      provides: "Module declarations and re-exports without envelope_v2_bridge"
    - path: "crates/core/src/backends/universal.rs"
      provides: "HashAlgorithm enum without Blake2b variant"
    - path: "crates/core/src/backends/software_hsm.rs"
      provides: "Hash implementation with only Sha256/Sha384/Sha512 support"
    - path: "crates/core/src/backends/yubikey.rs"
      provides: "piv_generate with actionable error and no TODO"
  key_links:
    - from: "crates/core/src/backends/software_hsm.rs"
      to: "crates/core/src/backends/universal.rs"
      via: "HashAlgorithm enum usage"
      pattern: "HashAlgorithm::(Sha256|Sha384|Sha512)"
---

<objective>
Delete the envelope_v2_bridge.rs stub module, remove the unimplemented Blake2b hash variant from the Universal Backend, and clean up the YubiKey generate_key TODO comment with an actionable error message.

Purpose: Eliminate incomplete features from trustedge-core so the crate only advertises functionality it actually implements. This is the "don't advertise what you can't do" principle.

Output: Cleaner trustedge-core with no stub modules, no unimplemented hash variants, and clear YubiKey error guidance.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@crates/core/src/envelope_v2_bridge.rs
@crates/core/src/lib.rs
@crates/core/src/backends/universal.rs
@crates/core/src/backends/software_hsm.rs
@crates/core/src/backends/yubikey.rs
@crates/core/src/protocols/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete envelope_v2_bridge.rs and remove all references</name>
  <files>
    crates/core/src/envelope_v2_bridge.rs
    crates/core/src/lib.rs
    crates/core/src/protocols/mod.rs
  </files>
  <action>
    STUB-01: The envelope_v2_bridge.rs module is a Pubky integration stub with 3 TODOs and 2 of 3 envelope formats returning errors. It has zero external consumers. Delete it entirely.

    1. **Delete** `crates/core/src/envelope_v2_bridge.rs` (the entire file).

    2. **Edit** `crates/core/src/lib.rs`:
       - Remove line `pub mod envelope_v2_bridge;` (line 102).
       - Remove the `pub use envelope_v2_bridge::{...}` block (lines 159-161) that re-exports `detect_envelope_format`, `EnvelopeFormat`, `EnvelopeInfo`, `UnifiedEnvelope`.

    3. **Edit** `crates/core/src/protocols/mod.rs`:
       - Remove the documentation block referencing envelope_v2_bridge (lines 44-47):
         ```
         //! - `envelope_v2_bridge.rs` (from `crates/core/src/envelope_v2_bridge.rs`)
         //!   - `detect_envelope_format()` - V1 vs V2 detection
         //!   - `EnvelopeFormat` enum - version enumeration
         //!   - `UnifiedEnvelope` - cross-version wrapper
         ```

    NOTE: The `EnvelopeInfo` reference in `crates/core/README.md` line 541 (`pub fn inspect(&self) -> Result<EnvelopeInfo>`) refers to a different conceptual type in the Envelope API documentation, not the deleted struct. Leave it as-is since it documents the Envelope API, not envelope_v2_bridge.

    NOTE: `HybridEnvelope` is defined in `hybrid.rs` and only re-exported from `envelope_v2_bridge.rs`. Since no external code imports `HybridEnvelope` through `envelope_v2_bridge`, no re-export replacement is needed.
  </action>
  <verify>
    Run these checks:
    1. `test ! -f crates/core/src/envelope_v2_bridge.rs` — file must not exist
    2. `grep -c "envelope_v2_bridge" crates/core/src/lib.rs` — must return 0
    3. `grep -c "envelope_v2_bridge" crates/core/src/protocols/mod.rs` — must return 0
    4. `cargo build --workspace --release 2>&1 | grep -c "warning"` — zero warnings
    5. `cargo test -p trustedge-core --lib` — all core tests pass
  </verify>
  <done>
    envelope_v2_bridge.rs is deleted, all references removed from lib.rs and protocols/mod.rs, workspace builds clean with zero warnings, all tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove Blake2b stub and clean YubiKey generate_key TODO</name>
  <files>
    crates/core/src/backends/universal.rs
    crates/core/src/backends/software_hsm.rs
    crates/core/src/backends/yubikey.rs
  </files>
  <action>
    STUB-02: Remove Blake2b from HashAlgorithm. It is defined but never implemented — Software HSM returns an error for it, and `supports_operation` and `get_capabilities` already correctly exclude it.

    1. **Edit** `crates/core/src/backends/universal.rs`:
       - Remove `Blake2b,` from the `HashAlgorithm` enum (line 46). The enum should have exactly 3 variants: `Sha256`, `Sha384`, `Sha512`.

    2. **Edit** `crates/core/src/backends/software_hsm.rs`:
       - Remove the `HashAlgorithm::Blake2b` match arm from `hash_data()` (lines 346-349):
         ```rust
         HashAlgorithm::Blake2b => {
             / Note: blake2 crate would be needed for full implementation
             Err(anyhow::anyhow!("Blake2b not implemented in this demo"))
         }
         ```
       - In the `test_operation_support` test, remove the Blake2b unsupported assertion block (lines 1097-1101):
         ```rust
         let unsupported_hash = CryptoOperation::Hash {
             data: vec![1, 2, 3],
             algorithm: HashAlgorithm::Blake2b,
         };
         assert!(!backend.supports_operation(&unsupported_hash));
         ```

    3. After removing Blake2b from the enum, the compiler will flag any other match arms referencing it. Fix each one:
       - Search for `Blake2b` across all crates and fix any remaining references. Based on the grep, the only references are in the 2 files above, but verify at compile time.

    STUB-03: Clean up YubiKey generate_key TODO comment. The error message already directs users to ykman, which is correct. Clean up the stale TODO that implies this will be implemented later.

    4. **Edit** `crates/core/src/backends/yubikey.rs`:
       - In `piv_generate()` (around lines 305-316), replace the current comment block:
         ```rust
         / NOTE: Key generation requires PinPolicy and TouchPolicy types which are
         // in a private module in yubikey crate 0.7. This will be addressed in a future
         // update. For now, keys must be pre-generated using ykman or other tools.

         // TODO: Implement key generation once yubikey crate exports policy types
         // or find a workaround using the raw PIV protocol.
         ```
         With a definitive comment (no TODO, no "will be addressed"):
         ```rust
         // Key generation requires PinPolicy and TouchPolicy types that are not
         // publicly exported by the yubikey crate (v0.7). Use ykman CLI instead.
         ```
       - Improve the error message to include a concrete ykman command example. Replace:
         ```rust
         "Key generation not yet implemented. \
          Generate keys using 'ykman piv keys generate' and import certificates."
         ```
         With:
         ```rust
         "Key generation is not supported by TrustEdge. \
          Use the YubiKey Manager CLI instead: \
          `ykman piv keys generate -a ECCP256 9a pubkey.pem`"
         ```
         This changes "not yet implemented" (implying it will be) to "not supported" (definitive), and provides an actual command users can copy-paste.
  </action>
  <verify>
    Run these checks:
    1. `grep -rn "Blake2b" crates/` — must return zero matches
    2. `grep -n "TODO.*generate_key\|TODO.*key gen\|TODO.*yubikey.*export\|TODO.*policy types" crates/core/src/backends/yubikey.rs` — must return zero matches
    3. `grep -c "not supported by TrustEdge" crates/core/src/backends/yubikey.rs` — must return 1
    4. `grep -c "ykman piv keys generate" crates/core/src/backends/yubikey.rs` — must return 1
    5. `cargo build --workspace --release 2>&1 | grep -c "warning"` — zero warnings
    6. `cargo test --workspace` — all tests pass
  </verify>
  <done>
    Blake2b variant removed from HashAlgorithm enum and all implementation/test references. YubiKey piv_generate has no TODO comments and returns an actionable error with a concrete ykman command example. Full workspace builds and tests pass.
  </done>
</task>

</tasks>

<verification>
1. `test ! -f crates/core/src/envelope_v2_bridge.rs` — file deleted
2. `grep -rn "envelope_v2_bridge" crates/` — zero matches
3. `grep -rn "Blake2b" crates/` — zero matches
4. `grep -rn "TODO" crates/core/src/backends/yubikey.rs | grep -ic "generate\|key gen\|policy"` — zero matches
5. `cargo build --workspace --release` — zero warnings
6. `cargo test --workspace` — all tests pass
7. `cargo clippy --workspace -- -D warnings` — no clippy warnings
</verification>

<success_criteria>
- envelope_v2_bridge.rs deleted, no references remain anywhere in crates/
- HashAlgorithm has exactly 3 variants (Sha256, Sha384, Sha512), no Blake2b anywhere
- YubiKey piv_generate error says "not supported" with concrete ykman command, no TODO
- All 370+ tests pass, zero build warnings, zero clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/21-core-stub-elimination/21-01-SUMMARY.md`
</output>
