---
phase: 14-ci-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - scripts/ci-check.sh
autonomous: true

must_haves:
  truths:
    - "Core crates (core, cli, trst-protocols, trst-cli, trst-wasm) receive full CI validation (clippy, tests, build) and failures block merge"
    - "Experimental crates (wasm, pubky, pubky-advanced, receipts, attestation) build in CI but failures do not block merge"
    - "Dependency tree size is baselined and tracked in CI so regressions are caught"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "Tiered CI pipeline with core blocking and experimental non-blocking"
      contains: "continue-on-error"
    - path: "scripts/ci-check.sh"
      provides: "Local CI check script matching tiered behavior"
      contains: "experimental"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "Cargo.toml workspace members"
      via: "cargo test/clippy/build commands"
      pattern: "cargo (test|clippy|build)"
---

<objective>
Update CI pipeline and local ci-check.sh to implement tiered validation: core crates get comprehensive checks that block merge, experimental crates build but do not block. Add dependency tree size baseline and tracking.

Purpose: Prevents experimental crate issues from blocking core development while maintaining build visibility. Establishes dependency tree size tracking to catch regressions.
Output: Updated ci.yml and ci-check.sh with tiered CI behavior and dep tree tracking.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.github/workflows/ci.yml
@scripts/ci-check.sh
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement tiered CI pipeline</name>
  <files>.github/workflows/ci.yml, scripts/ci-check.sh</files>
  <action>
  Update `.github/workflows/ci.yml` to separate core and experimental crate validation:

  **Core crates (blocking — failures stop the pipeline):**
  These are the 5 stable tier crates that must pass all checks:
  - trustedge-core
  - trustedge-cli (package name: trustedge-cli)
  - trustedge-trst-protocols
  - trustedge-trst-cli
  - trustedge-trst-wasm

  The existing workflow already runs workspace-wide checks. The key change is to add a SEPARATE step for experimental crates that uses `continue-on-error: true` so failures are visible but non-blocking.

  **Implementation approach for ci.yml:**

  1. Keep the existing workspace-level `cargo fmt --all -- --check` (formatting applies to all code equally).
  2. Keep the existing copyright header check (applies to all files).
  3. **Split the clippy step**: Replace the single workspace clippy with TWO steps:
     - "clippy (core crates)" — runs `cargo clippy` with explicit `--package` flags for each of the 5 core crates plus `cam-video-example`. This step is blocking (no continue-on-error).
     - "clippy (experimental crates — non-blocking)" — runs `cargo clippy` with `--package` flags for the 5 experimental crates (trustedge-wasm, trustedge-pubky, trustedge-pubky-advanced, trustedge-receipts, trustedge-attestation). Add `continue-on-error: true`.
  4. **Split the test step**: Replace the single workspace test with TWO steps:
     - "tests (core crates)" — runs `cargo test` with explicit `--package` flags for each of the 5 core crates plus `cam-video-example`. Blocking.
     - "tests (experimental crates — non-blocking)" — runs `cargo test` with `--package` flags for the 5 experimental crates. Add `continue-on-error: true`.
  5. Keep all existing feature-specific steps (audio clippy/test, yubikey clippy/test, all-features, cargo-hack, WASM, semver) unchanged — these already target specific packages.
  6. The build step should remain workspace-wide (`cargo build --workspace`) since we want to verify everything compiles. But move the blocking test step to only cover core crates.

  **Note on `--package` syntax**: Use multiple `-p` flags: `cargo clippy -p trustedge-core -p trustedge-cli -p trustedge-trst-protocols -p trustedge-trst-cli -p trustedge-trst-wasm -p cam-video-example --all-targets --no-default-features -- -D warnings`

  **Update `scripts/ci-check.sh`:**

  1. In Step 3 (Clippy workspace), split into two sub-steps:
     - Core crates clippy (uses `fail` on error — blocking)
     - Experimental crates clippy (reports as warning, does NOT increment FAIL counter — use a new `warn` function that logs `"  ⚠ $1 (warning)"` and increments a WARN counter)
  2. In Step 7 (Build + test workspace), split into two sub-steps:
     - Build remains workspace-wide
     - Core crate tests (blocking)
     - Experimental crate tests (warning-only, non-blocking)
  3. Add WARN counter to summary output: "Results: $PASS passed, $FAIL failed, $WARN warnings, $SKIP skipped"
  4. Keep all other steps (audio, yubikey, feature powerset, WASM, semver) unchanged.
  </action>
  <verify>
  1. `bash -n scripts/ci-check.sh` passes (no syntax errors)
  2. Verify ci.yml has `continue-on-error: true` on experimental crate steps
  3. Verify ci.yml has NO `continue-on-error` on core crate steps
  4. Verify both files reference all 5 core crates and all 5 experimental crates
  </verify>
  <done>
  Core crate clippy and tests are blocking in CI. Experimental crate clippy and tests are non-blocking (continue-on-error). Local ci-check.sh matches this behavior with warning-only for experimental crates. All existing feature-specific steps unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dependency tree size baseline and CI tracking</name>
  <files>.github/workflows/ci.yml, scripts/ci-check.sh</files>
  <action>
  Add a dependency tree size tracking step to both CI and the local check script.

  **In `.github/workflows/ci.yml`:**

  Add a new step after the build step (and before WASM):

  ```yaml
  - name: Dependency tree size check
    run: |
      # Count unique crates in dependency tree
      dep_count=$(cargo tree --workspace --depth 1 --prefix none --no-dedupe 2>/dev/null | sort -u | wc -l)
      echo "Dependency tree size: $dep_count unique crates"
      # Baseline: established 2026-02-12 during v1.2 Phase 14
      # If count exceeds baseline + 10, warn (not block)
      baseline=XXX
      threshold=$((baseline + 10))
      if [ "$dep_count" -gt "$threshold" ]; then
        echo "::warning::Dependency tree grew beyond threshold ($dep_count > $threshold). Review new dependencies."
      fi
  ```

  Before writing XXX, first run `cargo tree --workspace --depth 1 --prefix none --no-dedupe 2>/dev/null | sort -u | wc -l` locally to get the actual baseline number. Use that number as the baseline value.

  **In `scripts/ci-check.sh`:**

  Add a new Step 14 (after Step 13 semver check, before Summary):

  ```bash
  # ── Step 14: Dependency tree size ────────────────────────────────────
  step "Step 14: Dependency tree size check"
  dep_count=$(cargo tree --workspace --depth 1 --prefix none --no-dedupe 2>/dev/null | sort -u | wc -l)
  echo "  Dependency tree: $dep_count unique crates (baseline: $baseline)"
  baseline=XXX
  threshold=$((baseline + 10))
  if [ "$dep_count" -gt "$threshold" ]; then
      echo "  ⚠ Dependency tree grew beyond threshold ($dep_count > $threshold)"
      WARN=$((WARN + 1))
  else
      pass "dependency tree within baseline"
  fi
  ```

  Use the same baseline number. This step uses the WARN counter (non-blocking) because dep growth is informational, not a hard failure.
  </action>
  <verify>
  1. Run `cargo tree --workspace --depth 1 --prefix none --no-dedupe 2>/dev/null | sort -u | wc -l` and confirm the baseline is reasonable
  2. `bash -n scripts/ci-check.sh` passes (no syntax errors)
  3. Verify ci.yml has the dependency tree step
  4. Verify the baseline number matches in both files
  </verify>
  <done>
  Dependency tree size baseline is established with the actual current count. Both CI and local script track the dep tree size and warn (non-blocking) if it grows beyond baseline + 10 crates. CI-02 requirement satisfied.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/ci-check.sh` — no syntax errors
2. ci.yml validates as valid YAML (check with `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"`)
3. Core crate steps in ci.yml do NOT have `continue-on-error`
4. Experimental crate steps in ci.yml HAVE `continue-on-error: true`
5. Dependency tree baseline number is set in both files
6. All existing CI functionality preserved (audio, yubikey, WASM, semver, cargo-hack)
</verification>

<success_criteria>
- CI-01: Core crates get comprehensive blocking CI; experimental crates build but don't block
- CI-02: Dependency tree size baseline established and tracked
- No regressions in existing CI behavior
- Local ci-check.sh mirrors CI tiered approach
</success_criteria>

<output>
After completion, create `.planning/phases/14-ci-documentation/14-01-SUMMARY.md`
</output>
