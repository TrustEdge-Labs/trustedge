---
phase: 22-pubky-stub-elimination
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/pubky/src/bin/trustedge-pubky.rs
  - crates/pubky-advanced/src/pubky_client.rs
autonomous: true

must_haves:
  truths:
    - "No unimplemented CLI commands remain in trustedge-pubky binary"
    - "discover_identities is removed from PubkyClient"
    - "Placeholder migrate command is removed from CLI"
    - "batch_resolve TODO comments are resolved as documented known limitations"
    - "All 17 existing Pubky tests pass unchanged"
  artifacts:
    - path: "crates/pubky/src/bin/trustedge-pubky.rs"
      provides: "CLI with only implemented commands (generate, resolve, encrypt, decrypt)"
    - path: "crates/pubky-advanced/src/pubky_client.rs"
      provides: "PubkyClient without placeholder methods"
  key_links:
    - from: "crates/pubky/src/bin/trustedge-pubky.rs"
      to: "crates/pubky/src/lib.rs"
      via: "CLI uses lib functions"
      pattern: "send_trusted_data|receive_trusted_data|create_pubky_backend"
---

<objective>
Remove all placeholder code, unimplemented commands, and misleading TODOs from the experimental Pubky crates.

Purpose: Eliminate code that claims functionality but doesn't deliver — users shouldn't see commands that bail with "not yet implemented". This is the v1.4 principle: if it doesn't work, it doesn't exist.

Output: Clean Pubky crates with only working functionality, no placeholder stubs.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@crates/pubky/src/bin/trustedge-pubky.rs
@crates/pubky/src/lib.rs
@crates/pubky-advanced/src/pubky_client.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove unimplemented CLI commands and stubs from trustedge-pubky</name>
  <files>crates/pubky/src/bin/trustedge-pubky.rs</files>
  <action>
Remove the `Publish` and `Migrate` CLI commands entirely from the trustedge-pubky binary. These are requirements PUBK-01 and PUBK-03.

Specific changes in `crates/pubky/src/bin/trustedge-pubky.rs`:

1. **Delete the `Publish` variant** from the `Commands` enum (lines 93-101) — the entire variant including doc comment and all fields (`key`, `trustedge_key`).

2. **Delete the `Migrate` variant** from the `Commands` enum (lines 198-218) — the entire variant including doc comment and all fields (`input`, `output`, `recipient`, `v1_key`, `pubky_key`).

3. **Delete the `Commands::Publish` match arm** in `main()` (line 230) — `Commands::Publish { key, trustedge_key } => publish_key(key, trustedge_key),`

4. **Delete the `Commands::Migrate` match arm** in `main()` (lines 243-249) — the entire migrate match arm.

5. **Delete the `publish_key()` function** entirely (lines 332-335) — it's just a TODO stub that bails.

6. **Delete the `migrate_envelope()` function** entirely (lines 512-558) — it's a placeholder that always bails.

7. **Update the CLI long_about description** (lines 23-50) to remove references to:
   - "Publish public keys to the decentralized Pubky network" (line 30)
   - "Migration tools for envelope format upgrades" (line 33)
   Remove these two bullet points from the "Key Features:" section.

Do NOT touch the working commands: `Generate`, `Resolve`, `Encrypt`, `Decrypt`. These are fully implemented.
  </action>
  <verify>
Run `cargo build -p trustedge-pubky` to confirm compilation.
Run `cargo test -p trustedge-pubky --lib` to confirm all 7 existing tests pass.
Verify with `cargo run -p trustedge-pubky -- --help` that only generate, resolve, encrypt, decrypt appear.
Grep for "TODO" and "placeholder" in the modified file to confirm none remain.
  </verify>
  <done>
The trustedge-pubky CLI only exposes generate, resolve, encrypt, and decrypt commands. No publish or migrate commands exist. No TODO comments remain in the file. All 7 lib tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove placeholders and resolve TODOs in pubky-advanced</name>
  <files>crates/pubky-advanced/src/pubky_client.rs</files>
  <action>
Remove the `discover_identities` placeholder method and resolve the `batch_resolve` TODO. These are requirements PUBK-02 and PUBK-04.

Specific changes in `crates/pubky-advanced/src/pubky_client.rs`:

1. **Delete the `discover_identities()` method entirely** (lines 199-208) — it returns an empty Vec with a placeholder comment and TODO. This method is not called anywhere and provides no value. This satisfies PUBK-02.

2. **Resolve the `batch_resolve_encryption_keys` TODO** (lines 228-249) — The current sequential implementation is correct and functional (resolves keys one by one). The TODO says "Implement actual batch resolution for efficiency". Replace the TODO comment block (lines 234-235) with a doc-style explanation that sequential resolution is the intended behavior since the Pubky protocol does not provide a batch resolution API. Change the two comment lines:
   ```
   // TODO: Implement actual batch resolution for efficiency
   // For now, resolve one by one
   ```
   to:
   ```
   // Sequential resolution — Pubky protocol resolves one identity at a time.
   // Errors are logged but do not abort resolution of remaining IDs.
   ```
   This satisfies PUBK-04.

3. **Clean up the `with_config` placeholder comment** (line 71) — The comment `// Note: This is a placeholder - actual Pubky client configuration may differ` and the commented-out code `// builder = builder.homeserver(homeserver);` (line 72) should be replaced with a clear explanation. Replace lines 70-73:
   ```rust
   if let Some(_homeserver) = homeserver {
       // Note: This is a placeholder - actual Pubky client configuration may differ
       // builder = builder.homeserver(homeserver);
   }
   ```
   with:
   ```rust
   if let Some(_homeserver) = homeserver {
       // Homeserver configuration is accepted but not yet supported by the
       // pubky client SDK. The parameter is retained for forward compatibility.
   }
   ```

Do NOT modify any test code. Do NOT touch `keys.rs` or `envelope.rs` — they have no placeholders.
  </action>
  <verify>
Run `cargo build -p trustedge-pubky-advanced` to confirm compilation.
Run `cargo test -p trustedge-pubky-advanced --lib` to confirm all 10 existing tests pass.
Grep for "TODO" and "placeholder" in `crates/pubky-advanced/src/pubky_client.rs` to confirm none remain.
  </verify>
  <done>
The `discover_identities` method no longer exists on PubkyClient. The `batch_resolve_encryption_keys` TODO is replaced with a clear rationale comment. The `with_config` placeholder comment is replaced with a forward-compatibility note. No TODO or placeholder comments remain. All 10 tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cargo build -p trustedge-pubky -p trustedge-pubky-advanced` succeeds
2. `cargo test -p trustedge-pubky --lib` passes all 7 tests
3. `cargo test -p trustedge-pubky-advanced --lib` passes all 10 tests
4. `cargo clippy -p trustedge-pubky -p trustedge-pubky-advanced -- -D warnings` passes
5. No occurrences of "TODO", "placeholder", "stub", "not yet implemented" in modified files
6. `cargo run -p trustedge-pubky -- --help` shows only: generate, resolve, encrypt, decrypt
</verification>

<success_criteria>
- PUBK-01: publish_key CLI command removed — no Publish variant in Commands enum
- PUBK-02: discover_identities method removed from PubkyClient
- PUBK-03: migrate CLI command removed — no Migrate variant in Commands enum
- PUBK-04: batch_resolve TODO replaced with documented rationale
- All 17 tests (7 pubky + 10 pubky-advanced) pass
- Zero placeholder/TODO comments in modified files
</success_criteria>

<output>
After completion, create `.planning/phases/22-pubky-stub-elimination/22-01-SUMMARY.md`
</output>
