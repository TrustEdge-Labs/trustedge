---
phase: 11-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/core/src/backends/yubikey.rs
autonomous: true

must_haves:
  truths:
    - "Simulation tests validate capability reporting without hardware"
    - "Simulation tests validate slot parsing for valid and invalid IDs"
    - "Simulation tests validate error mapping (yubikey errors to BackendError)"
    - "Simulation tests validate config defaults and custom config"
    - "Anti-pattern test proves signing fails without hardware (returns HardwareError, not software fallback)"
    - "Anti-pattern test proves empty/invalid slot IDs return errors (not placeholder keys)"
    - "Negative tests cover unsupported algorithms (Ed25519), invalid slot IDs, missing PIN"
    - "Every test function contains at least one assert!, assert_eq!, or expect() call"
  artifacts:
    - path: "crates/core/src/backends/yubikey.rs"
      provides: "#[cfg(test)] module with simulation tests"
      contains: "#[cfg(test)]"
  key_links:
    - from: "yubikey.rs #[cfg(test)] tests"
      to: "YubiKeyBackend private methods"
      via: "use super::*"
      pattern: "mod tests"
---

<objective>
Add simulation tests (no hardware required) to the YubiKey backend as unit tests in a #[cfg(test)] module inside yubikey.rs.

Purpose: These tests run in CI on every commit without a physical YubiKey, validating all testable backend logic: capability reporting, slot parsing, error mapping, config validation, and fail-closed anti-pattern behavior. Satisfies TEST-01, TEST-03 (non-hardware), TEST-04, TEST-06 (non-hardware).

Output: #[cfg(test)] mod tests block in crates/core/src/backends/yubikey.rs with 12-15 simulation tests.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/11-test-infrastructure/11-RESEARCH.md
@crates/core/src/backends/yubikey.rs
@crates/core/src/backends/universal.rs
@crates/core/src/error.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add simulation test module to yubikey.rs</name>
  <files>crates/core/src/backends/yubikey.rs</files>
  <action>
Add a `#[cfg(test)]` module at the bottom of crates/core/src/backends/yubikey.rs with the following tests. These are UNIT tests that can access private methods (parse_slot, ensure_connected, etc.) via `use super::*`.

IMPORTANT: Every test MUST have at least one assert!, assert_eq!, or expect() call. No empty tests.

**Helper function:**
- `fn create_test_config() -> YubiKeyConfig` - returns config with pin Some("123456"), default_slot "9c", verbose false, max_pin_retries 3

**Slot Parsing Tests (TEST-01, TEST-06):**

1. `test_parse_slot_valid_authentication` - parse_slot("9a") returns Ok(SlotId::Authentication). Use assert_eq!.
2. `test_parse_slot_valid_signature` - parse_slot("9c") returns Ok(SlotId::Signature). Use assert_eq!.
3. `test_parse_slot_valid_key_management` - parse_slot("9d") returns Ok(SlotId::KeyManagement). Use assert_eq!.
4. `test_parse_slot_valid_card_authentication` - parse_slot("9e") returns Ok(SlotId::CardAuthentication). Use assert_eq!.
5. `test_parse_slot_case_insensitive` - parse_slot("9A") returns Ok(SlotId::Authentication). Verify case insensitivity works (the impl uses to_lowercase()).
6. `test_parse_slot_invalid_returns_key_not_found` - parse_slot("invalid") returns Err. Assert is_err() AND assert matches!(err, BackendError::KeyNotFound(_)). Verify error message contains "Invalid PIV slot".
7. `test_parse_slot_empty_string_returns_error` - parse_slot("") returns Err(BackendError::KeyNotFound). Assert is_err().

**Capability Reporting Tests (TEST-01):**

8. `test_capabilities_reports_hardware_backed` - Create backend with_config(default). Call get_capabilities(). Assert: hardware_backed is true, signature_algorithms contains EcdsaP256, signature_algorithms contains RsaPkcs1v15, signature_algorithms does NOT contain Ed25519 (use !contains), supports_key_generation is false (deferred), supports_attestation is false (deferred), max_key_size is Some(2048).
9. `test_capabilities_asymmetric_algorithms` - get_capabilities(). Assert asymmetric_algorithms contains EcdsaP256 and Rsa2048. Assert symmetric_algorithms is empty (PIV doesn't do symmetric).

**Backend Info Tests (TEST-01):**

10. `test_backend_info_without_hardware` - Create backend with_config(default). Call backend_info(). Assert name == "yubikey", description == "YubiKey PIV hardware security backend", version == "1.0.0", available == false (no hardware present in CI). Assert config_requirements is not empty.

**Config Validation Tests (TEST-01):**

11. `test_default_config_values` - Create YubiKeyConfig::default(). Assert pin is None, default_slot == "9c", verbose == false, max_pin_retries == 3.
12. `test_custom_config_preserved` - Create config with custom values (pin Some("654321"), default_slot "9a", verbose true, max_pin_retries 5). Create backend with_config(custom). Verify backend was created Ok (the backend creation should succeed even without hardware since connect is non-fatal).

**Anti-Pattern Tests (TEST-03):**

13. `test_signing_without_hardware_returns_hardware_error` - Create backend (no hardware). Call perform_operation with Sign { data: b"test".to_vec(), algorithm: SignatureAlgorithm::EcdsaP256 }. Assert result is_err(). Assert matches error to BackendError::HardwareError(_). This proves fail-closed design: no software fallback.
14. `test_get_public_key_without_hardware_returns_error` - Create backend (no hardware). Call perform_operation with GetPublicKey. Assert is_err() and matches HardwareError. No placeholder keys returned.

**Unsupported Algorithm Tests (TEST-06):**

15. `test_ed25519_signing_not_supported` - Create backend. Check supports_operation for Sign with Ed25519 returns false. Also call perform_operation with Ed25519 Sign and verify it returns UnsupportedOperation error (not HardwareError -- the algorithm check happens before the hardware check in piv_sign, but actually looking at the code: perform_operation calls parse_slot first then piv_sign which calls ensure_connected first, so without hardware it will return HardwareError. Instead: just test supports_operation returns false for Ed25519 Sign).

Actually, re-examining the code flow: supports_operation() is a pure check that doesn't need hardware. So test supports_operation:
- Sign with EcdsaP256 returns true
- Sign with RsaPkcs1v15 returns true
- Sign with Ed25519 returns false
- GetPublicKey returns true
- GenerateKeyPair returns false (deferred)
- Attest returns false (deferred)

This covers the unsupported algorithm check cleanly without needing hardware.

**Error Mapping Test (TEST-01):**

16. `test_hash_sha256_works_without_hardware` - Call perform_operation with Hash { data: b"test data".to_vec(), algorithm: HashAlgorithm::Sha256 } on key_id "". Assert it returns Ok with CryptoResult::Hash. Assert hash length is 32 bytes. (Hash is software operation, should work without hardware.)
17. `test_unsupported_hash_algorithm_returns_error` - Call perform_operation with Hash { data: b"test".to_vec(), algorithm: HashAlgorithm::Sha512 }. Assert is_err() and error is UnsupportedOperation.

Note on import: The test module needs `use super::*;` plus additional imports as needed for SlotId from yubikey::piv.
  </action>
  <verify>
Run: `cargo test -p trustedge-core --features yubikey --lib -- yubikey::tests` and confirm all tests pass.
Run: `cargo clippy -p trustedge-core --features yubikey -- -D warnings` and confirm zero warnings.
Grep the test module for "fn test_" and count: should be 15-17 test functions.
Grep for "assert" in the test module: every test function must have at least one assert.
  </verify>
  <done>
15-17 simulation tests exist in yubikey.rs #[cfg(test)] module. All pass without hardware. All contain assertions. cargo clippy passes with zero warnings. Tests validate: slot parsing (valid/invalid/empty/case), capability reporting (algorithms, hardware_backed, limitations), backend info, config defaults, fail-closed anti-patterns (signing/pubkey fail without hardware), supports_operation for all operation types, and hash operations.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p trustedge-core --features yubikey --lib -- yubikey::tests` - all simulation tests pass
2. `cargo test --workspace` - existing tests still pass (no regression)
3. `cargo clippy -p trustedge-core --features yubikey -- -D warnings` - zero warnings
4. Every test function has at least one assert!/assert_eq!/expect() (grep verification)
5. No test requires hardware (none marked #[ignore])
</verification>

<success_criteria>
- 15+ simulation tests in yubikey.rs #[cfg(test)] module
- All tests pass in CI (no hardware required)
- Zero clippy warnings
- Every test has at least one assertion
- Slot parsing, capabilities, backend info, config, anti-patterns, unsupported operations all covered
- Requirements TEST-01, TEST-03 (non-hardware), TEST-04, TEST-06 (non-hardware) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/11-test-infrastructure/11-01-SUMMARY.md`
</output>
