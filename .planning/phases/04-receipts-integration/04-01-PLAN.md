<!--
Copyright (c) 2025 TRUSTEDGE LABS LLC
MPL-2.0: https://mozilla.org/MPL/2.0/
Project: trustedge — Privacy and trust at the edge.
GitHub: https://github.com/TrustEdge-Labs/trustedge
-->


---
phase: 04-receipts-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/core/src/applications/mod.rs
  - crates/core/src/applications/receipts/mod.rs
  - crates/core/src/lib.rs
  - crates/core/Cargo.toml
  - crates/core/examples/receipts_demo.rs
  - crates/receipts/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "All 23 receipt tests pass inside trustedge-core (cargo test -p trustedge-core applications::receipts)"
    - "Receipt types and functions are importable from trustedge_core crate root (Receipt, create_receipt, assign_receipt, verify_receipt_chain, extract_receipt)"
    - "No circular dependencies in trustedge-core module graph (cargo modules --acyclic)"
    - "Full workspace builds and all tests pass (cargo test --workspace)"
    - "Receipts demo is runnable as cargo example (cargo run -p trustedge-core --example receipts_demo)"
  artifacts:
    - path: "crates/core/src/applications/receipts/mod.rs"
      provides: "Receipt implementation (struct, create, assign, verify, extract)"
      contains: "pub struct Receipt"
    - path: "crates/core/src/applications/mod.rs"
      provides: "Layer 4 module declaration including receipts"
      contains: "pub mod receipts"
    - path: "crates/core/examples/receipts_demo.rs"
      provides: "Runnable receipt demo example"
      contains: "fn main"
  key_links:
    - from: "crates/core/src/applications/receipts/mod.rs"
      to: "crates/core/src/envelope.rs"
      via: "crate::Envelope import"
      pattern: "use crate::Envelope"
    - from: "crates/core/src/lib.rs"
      to: "crates/core/src/applications/receipts/mod.rs"
      via: "pub use re-export"
      pattern: "pub use applications::receipts"
---

<objective>
Move the receipts crate (1,281 LOC, 23 tests) into trustedge-core at applications/receipts/, preserving all tests, adding crate-root re-exports, and converting the demo binary into a runnable example.

Purpose: Consolidate the digital receipt system into the monolithic core, eliminating the separate crate while maintaining full API access through core's public interface.
Output: Receipt code lives in core, all 23 tests pass, demo is a cargo example, no circular dependencies.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-receipts-integration/04-RESEARCH.md
@.planning/phases/03-trst-core-integration/03-02-SUMMARY.md
@crates/receipts/src/lib.rs
@crates/receipts/src/bin/demo.rs
@crates/core/src/lib.rs
@crates/core/src/applications/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move receipts implementation into core applications layer</name>
  <files>
    crates/core/src/applications/receipts/mod.rs
    crates/core/src/applications/mod.rs
    crates/core/src/lib.rs
  </files>
  <action>
    Move the receipts implementation into trustedge-core's application layer:

    1. **Create the receipts module directory and file:**
       - `mkdir -p crates/core/src/applications/receipts/`
       - `git mv crates/receipts/src/lib.rs crates/core/src/applications/receipts/mod.rs`
       - This preserves git history for the file.

    2. **Update imports in the moved file** (`crates/core/src/applications/receipts/mod.rs`):
       - Change `use trustedge_core::Envelope;` to `use crate::Envelope;`
       - The remaining imports (anyhow, ed25519_dalek, serde, serde_json) stay the same since they're workspace dependencies already in core's Cargo.toml.
       - Update the module-level doc comments: change `trustedge_receipts` references to `trustedge_core::applications::receipts` in the `//!` doc block at the top.
       - Update the doc example `use trustedge_receipts::{Receipt, create_receipt, assign_receipt};` to `use trustedge_core::{Receipt, create_receipt, assign_receipt};`

    3. **Declare the receipts module in applications/mod.rs:**
       - Add `pub mod receipts;` to `crates/core/src/applications/mod.rs`
       - Update the module doc comment's "Status" section to reflect receipts are now live (not just scaffolding)

    4. **Add re-exports to core lib.rs:**
       - Add to the re-export section in `crates/core/src/lib.rs`:
         ```rust
         pub use applications::receipts::{Receipt, create_receipt, assign_receipt, extract_receipt, verify_receipt_chain};
         ```
       - Place this after the existing re-exports block, near the other `pub use` statements.

    5. **Verify the move compiles:**
       - `cargo check -p trustedge-core` must succeed
       - `cargo test -p trustedge-core --lib -- applications::receipts` must run all 23 tests

    **Important:** Do NOT modify the receipts crate's Cargo.toml yet -- the separate crate still needs to compile for workspace validation. The backward-compatibility facade for the receipts crate is deferred to Phase 7.
  </action>
  <verify>
    - `cargo check -p trustedge-core` compiles without errors
    - `cargo test -p trustedge-core --lib -- applications::receipts 2>&1 | grep "test result:"` shows "23 passed"
    - `grep "pub mod receipts" crates/core/src/applications/mod.rs` finds the declaration
    - `grep "pub use applications::receipts" crates/core/src/lib.rs` finds the re-exports
  </verify>
  <done>
    Receipt implementation (1,281 LOC) lives at crates/core/src/applications/receipts/mod.rs with all 23 tests passing. Receipt, create_receipt, assign_receipt, extract_receipt, and verify_receipt_chain are importable from trustedge_core crate root.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert demo to example and validate full workspace</name>
  <files>
    crates/core/examples/receipts_demo.rs
    crates/core/Cargo.toml
    crates/receipts/src/lib.rs
  </files>
  <action>
    Move the demo binary to a cargo example and ensure the full workspace is healthy:

    1. **Move demo.rs to core examples:**
       - `git mv crates/receipts/src/bin/demo.rs crates/core/examples/receipts_demo.rs`
       - Update imports in the moved file:
         - Change `use trustedge_receipts::{assign_receipt, create_receipt, verify_receipt_chain};` to `use trustedge_core::{assign_receipt, create_receipt, verify_receipt_chain};`
       - Add the copyright header if not already present (it should be preserved from git mv).

    2. **Add example entry to core Cargo.toml** (if not auto-discovered):
       - Cargo auto-discovers examples in the `examples/` directory, so no explicit `[[example]]` entry needed unless the example has special dependencies. Verify `cargo run -p trustedge-core --example receipts_demo -- --help` works (or just compiles).

    3. **Create stub lib.rs for receipts crate to maintain workspace compilation:**
       - Replace `crates/receipts/src/lib.rs` with a minimal re-export file that imports from core:
         ```rust
         // Copyright header (keep existing)
         //! # TrustEdge Receipts
         //!
         //! **DEPRECATED:** Receipt functionality has moved to `trustedge_core::applications::receipts`.
         //! This crate re-exports from core for backward compatibility.
         //! It will be fully deprecated in Phase 7.

         pub use trustedge_core::{Receipt, create_receipt, assign_receipt, extract_receipt, verify_receipt_chain};
         ```
       - This ensures `cargo test -p trustedge-receipts` still works (tests now live in core, so the receipts crate will have 0 tests but still compile).
       - Remove the `[[bin]]` section from `crates/receipts/Cargo.toml` (demo.rs no longer exists there) and delete the now-empty `crates/receipts/src/bin/` directory.

    4. **Verify no circular dependencies:**
       - Run `cargo modules dependencies --lib -p trustedge-core --acyclic` (should succeed with no cycles).

    5. **Full workspace validation:**
       - `cargo check --workspace` — all crates compile
       - `cargo test --workspace` — all tests pass (total should be ~325, with 23 receipt tests now in core instead of receipts crate)
       - `cargo clippy --workspace -- -D warnings` — clean
       - `cargo run -p trustedge-core --example receipts_demo` — demo runs successfully

    6. **Verify test count integrity:**
       - `cargo test -p trustedge-core --lib -- applications::receipts 2>&1 | grep "test result:"` — 23 passed
       - `cargo test -p trustedge-receipts 2>&1 | grep "test result:"` — 0 tests (re-export only)
       - Total workspace test count should be unchanged (tests moved, not lost)
  </action>
  <verify>
    - `cargo run -p trustedge-core --example receipts_demo` runs without error
    - `cargo check --workspace` succeeds
    - `cargo test --workspace 2>&1 | grep "test result:"` shows all tests passing
    - `cargo clippy --workspace -- -D warnings` succeeds
    - `cargo modules dependencies --lib -p trustedge-core --acyclic` shows no cycles
    - `ls crates/receipts/src/bin/demo.rs` fails (file moved)
    - `ls crates/core/examples/receipts_demo.rs` succeeds (file exists)
  </verify>
  <done>
    Demo converted to cargo example at crates/core/examples/receipts_demo.rs. Receipts crate reduced to thin re-export facade. Full workspace compiles, all tests pass (23 receipt tests in core, 0 in receipts crate), no circular dependencies, clippy clean.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p trustedge-core --lib -- applications::receipts` — 23 tests pass
2. `cargo test --workspace` — total test count unchanged (~325)
3. `cargo modules dependencies --lib -p trustedge-core --acyclic` — no cycles
4. `cargo run -p trustedge-core --example receipts_demo` — demo executes
5. `cargo clippy --workspace -- -D warnings` — clean
6. Receipt types importable: `use trustedge_core::{Receipt, create_receipt, assign_receipt, extract_receipt, verify_receipt_chain};`
</verification>

<success_criteria>
- All 23 receipt tests pass inside trustedge-core
- Receipt struct and functions available at crate root (pub use re-exports)
- No circular dependencies in core module graph
- Demo runnable as `cargo run -p trustedge-core --example receipts_demo`
- Full workspace builds clean (check + clippy + test)
- Receipts crate still compiles as thin re-export facade
</success_criteria>

<output>
After completion, create `.planning/phases/04-receipts-integration/04-01-SUMMARY.md`
</output>
