---
phase: 06-feature-flags
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/core/Cargo.toml
  - crates/core/src/lib.rs
  - crates/core/src/audio.rs
  - crates/core/src/backends/yubikey.rs
  - crates/core/src/backends/universal_registry.rs
  - crates/core/src/transport/quic.rs
autonomous: true

must_haves:
  truths:
    - "Feature flags are documented with semantic categories (backend, platform)"
    - "Feature-gated public APIs show their feature requirement in generated docs"
    - "docs.rs builds with all features enabled, showing complete API surface"
  artifacts:
    - path: "crates/core/Cargo.toml"
      provides: "docs.rs metadata and categorized feature comments"
      contains: "[package.metadata.docs.rs]"
    - path: "crates/core/src/lib.rs"
      provides: "Feature Flags documentation section and doc(cfg) annotations"
      contains: "Feature Flags"
  key_links:
    - from: "crates/core/Cargo.toml"
      to: "crates/core/src/lib.rs"
      via: "docsrs cfg flag enables doc(cfg) annotations"
      pattern: "docsrs"
---

<objective>
Add feature flag documentation and doc(cfg) annotations to trustedge-core.

Purpose: Users of trustedge-core need to know which features exist, what they enable, and which public APIs require specific features. Currently, feature-gated APIs like AudioCapture lack doc(cfg) annotations, so generated documentation does not indicate which feature is required. The Cargo.toml also lacks docs.rs metadata for building documentation with all features.

Output: Updated Cargo.toml with docs.rs metadata and category comments on features. Updated lib.rs with Feature Flags documentation section. All feature-gated public APIs annotated with #[cfg_attr(docsrs, doc(cfg(...)))].
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-feature-flags/06-RESEARCH.md
@crates/core/Cargo.toml
@crates/core/src/lib.rs
@crates/core/src/audio.rs
@crates/core/src/backends/yubikey.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add docs.rs metadata and feature category comments to Cargo.toml</name>
  <files>crates/core/Cargo.toml</files>
  <action>
Add `[package.metadata.docs.rs]` section to crates/core/Cargo.toml with:
```toml
[package.metadata.docs.rs]
all-features = true
rustdoc-args = ["--cfg", "docsrs"]
```

Also add semantic category comments to the existing `[features]` section. The current features section is:
```toml
[features]
default = []
audio = ["cpal"]
yubikey = ["pkcs11", "dep:yubikey", "x509-cert", "der", "spki", "signature"]
```

Update it to:
```toml
[features]
default = []         # No features by default — fast CI, maximum portability

# Backend: Hardware/storage integrations
yubikey = ["pkcs11", "dep:yubikey", "x509-cert", "der", "spki", "signature"]

# Platform: I/O and system capabilities
audio = ["cpal"]
```

Note: Move yubikey before audio so categories read top-down (backend before platform). Do NOT add new features — only reorganize comments. Do NOT rename or change any feature values. Place the `[package.metadata.docs.rs]` section after `[features]` and before `[dev-dependencies]`.
  </action>
  <verify>Run `cargo check -p trustedge-core` to confirm Cargo.toml parses correctly. Run `grep -c "package.metadata.docs.rs" crates/core/Cargo.toml` to confirm metadata section exists.</verify>
  <done>Cargo.toml has [package.metadata.docs.rs] with all-features=true and rustdoc-args, and features section has category comments (Backend, Platform).</done>
</task>

<task type="auto">
  <name>Task 2: Add Feature Flags docs to lib.rs and doc(cfg) annotations to all feature-gated public APIs</name>
  <files>crates/core/src/lib.rs, crates/core/src/audio.rs, crates/core/src/backends/yubikey.rs, crates/core/src/backends/universal_registry.rs, crates/core/src/transport/quic.rs</files>
  <action>
**Part A: Add Feature Flags section to lib.rs doc comment.**

In crates/core/src/lib.rs, after the existing "## Architecture" doc comment section (line ~49), add a new "## Feature Flags" section:

```rust
//!
//! ## Feature Flags
//!
//! TrustEdge Core uses `default = []` (no features enabled) for fast CI and maximum portability.
//! Enable features as needed for your deployment:
//!
//! ### Backend Features
//!
//! Hardware and storage integrations:
//!
//! - **`yubikey`** — YubiKey PIV hardware signing and key management via PKCS#11.
//!   Requires PCSC libraries (`libpcsclite-dev` on Linux, built-in on macOS).
//!
//! ### Platform Features
//!
//! I/O and system capabilities:
//!
//! - **`audio`** — Live audio capture from microphones via cpal.
//!   Requires audio libraries (`libasound2-dev` on Linux, CoreAudio on macOS, WASAPI on Windows).
//!
//! ### Usage
//!
//! ```toml
//! [dependencies]
//! trustedge-core = { version = "0.2", features = ["audio"] }
//! ```
```

**Part B: Add `#![cfg_attr(docsrs, feature(doc_cfg))]` crate-level attribute.**

At the very top of lib.rs (after the copyright header, before the doc comments), add:
```rust
#![cfg_attr(docsrs, feature(doc_cfg))]
```

This enables the `doc(cfg(...))` attribute when building on docs.rs (nightly). Note: On stable Rust, we use `#[cfg_attr(docsrs, doc(cfg(...)))]` on individual items which is a no-op unless the `docsrs` cfg is set.

**Part C: Add `#[cfg_attr(docsrs, doc(cfg(feature = "audio")))]` annotations.**

In crates/core/src/lib.rs, add the annotation to the AudioCapture re-export (line 91-92):
```rust
#[cfg(feature = "audio")]
#[cfg_attr(docsrs, doc(cfg(feature = "audio")))]
pub use audio::AudioCapture;
```

In crates/core/src/audio.rs, add annotations to the feature-gated public items:
- The `AudioCapture` struct definition (line ~118-120): add `#[cfg_attr(docsrs, doc(cfg(feature = "audio")))]` after the `#[cfg(feature = "audio")]` line
- The `impl AudioCapture` block (line ~130): add `#[cfg_attr(docsrs, doc(cfg(feature = "audio")))]` after the `#[cfg(feature = "audio")]` line
- The `impl Drop for AudioCapture` (line ~371): add the annotation

Do NOT add annotations to the stub `#[cfg(not(feature = "audio"))]` items — those are internal fallbacks, not part of the public API docs.

**Part D: Add `#[cfg_attr(docsrs, doc(cfg(feature = "yubikey")))]` annotations.**

In crates/core/src/backends/yubikey.rs, add the annotation to key public items that are feature-gated. The entire file is essentially `#[cfg(feature = "yubikey")]` gated. Add the doc(cfg) annotation to:
- The main public struct definitions (look for `pub struct` lines that are inside `#[cfg(feature = "yubikey")]` blocks)
- The main public impl blocks

In crates/core/src/backends/universal_registry.rs, the `#[cfg(feature = "yubikey")]` blocks at lines 17 and 54 are internal wiring (use statements and registration), not public API — do NOT add doc(cfg) to these.

In crates/core/src/transport/quic.rs, the `#[cfg(feature = "yubikey")]` blocks are internal wiring for certificate handling — do NOT add doc(cfg) to these.

**Rule of thumb:** Only add `#[cfg_attr(docsrs, doc(cfg(...)))]` to items that appear in `pub use` re-exports in lib.rs or are `pub struct`/`pub fn`/`pub trait` visible to downstream users. Internal `use` statements and private functions do NOT need it.
  </action>
  <verify>
Run `cargo check -p trustedge-core` to confirm all annotations compile correctly.
Run `cargo doc -p trustedge-core --no-deps` (without --all-features first to verify default build docs work).
Run `cargo doc -p trustedge-core --no-deps --all-features` to verify all-features docs build.
Run `grep -c "cfg_attr(docsrs" crates/core/src/lib.rs` to confirm at least 2 annotations exist (crate-level + AudioCapture re-export).
  </verify>
  <done>lib.rs has Feature Flags documentation section. Crate-level #![cfg_attr(docsrs, feature(doc_cfg))] is set. All feature-gated public API items (AudioCapture struct, AudioCapture impl, re-exports) have #[cfg_attr(docsrs, doc(cfg(...)))] annotations. Both default and all-features doc builds succeed.</done>
</task>

</tasks>

<verification>
1. `cargo check -p trustedge-core` passes (no compilation errors)
2. `cargo check -p trustedge-core --all-features` passes
3. `cargo doc -p trustedge-core --no-deps --all-features` builds without warnings
4. `grep "package.metadata.docs.rs" crates/core/Cargo.toml` shows the metadata section
5. `grep "Feature Flags" crates/core/src/lib.rs` shows the documentation section
6. `grep "cfg_attr(docsrs" crates/core/src/lib.rs` shows annotations
7. `cargo test -p trustedge-core --lib` passes (no regressions)
</verification>

<success_criteria>
- Cargo.toml has docs.rs metadata with all-features=true and docsrs rustdoc-args
- Features section has semantic category comments (Backend, Platform)
- lib.rs has Feature Flags documentation describing both features with usage examples
- All feature-gated public APIs have doc(cfg) annotations
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-feature-flags/06-01-SUMMARY.md`
</output>
