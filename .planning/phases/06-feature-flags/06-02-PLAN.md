---
phase: 06-feature-flags
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/ci-check.sh
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "CI tests all-features build and test for trustedge-core"
    - "CI tests downstream crate feature propagation (trustedge-cli)"
    - "WASM crate builds successfully without pulling platform-incompatible features"
  artifacts:
    - path: "scripts/ci-check.sh"
      provides: "All-features test step and downstream feature check"
      contains: "all-features"
    - path: ".github/workflows/ci.yml"
      provides: "All-features CI step and downstream feature check"
      contains: "all-features"
  key_links:
    - from: "scripts/ci-check.sh"
      to: ".github/workflows/ci.yml"
      via: "Both scripts mirror each other for local/CI parity"
      pattern: "all-features"
---

<objective>
Add all-features testing and downstream crate feature verification to CI pipeline.

Purpose: The current CI tests individual features (audio, yubikey) and the powerset check, but never tests all features enabled simultaneously. It also does not verify that downstream crates (trustedge-cli) correctly propagate features from core. This leaves a gap where feature interaction bugs between audio and yubikey could go undetected, and feature propagation issues from core to cli would not be caught.

Output: Updated ci-check.sh and ci.yml with: (1) all-features build+test step for trustedge-core, (2) downstream crate feature-powerset check for trustedge-cli, (3) WASM build verification to ensure no feature contamination.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-feature-flags/06-RESEARCH.md
@scripts/ci-check.sh
@.github/workflows/ci.yml
@crates/trustedge-cli/Cargo.toml
@crates/wasm/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add all-features and downstream feature testing to ci-check.sh</name>
  <files>scripts/ci-check.sh</files>
  <action>
Add three new steps to scripts/ci-check.sh. Insert them AFTER Step 11 (yubikey tests, line ~98) and BEFORE the current Step 12 (semver-checks, line ~101). Renumber the semver-checks step accordingly.

**New Step 12: All-features build and test.** This tests audio+yubikey together, catching interaction bugs.

```bash
echo "■ Step 12: Build and test all features together..."
# Only run if both platform dependencies are available
if pkg-config --exists alsa 2>/dev/null && pkg-config --exists libpcsclite 2>/dev/null; then
    cargo build -p trustedge-core --all-features
    cargo test -p trustedge-core --all-features --locked --verbose
    echo "✔ All-features test passed"
else
    echo "⚠ Not all platform libraries available - skipping all-features test"
fi
echo
```

**New Step 13: Downstream crate feature propagation check.** This verifies trustedge-cli correctly propagates audio feature to core.

```bash
echo "■ Step 13: Downstream crate feature check (trustedge-cli)..."
cargo hack check --feature-powerset --no-dev-deps --package trustedge-cli
echo "✔ Downstream feature check passed"
echo
```

**New Step 14: WASM build verification.** This confirms WASM target builds without accidentally enabling platform-incompatible features.

```bash
echo "■ Step 14: WASM build verification..."
if rustup target list --installed | grep -q wasm32-unknown-unknown; then
    cargo check -p trustedge-wasm --target wasm32-unknown-unknown
    cargo check -p trustedge-trst-wasm --target wasm32-unknown-unknown
    echo "✔ WASM build check passed"
else
    echo "⚠ wasm32-unknown-unknown target not installed - skipping WASM check"
    echo "  Install with: rustup target add wasm32-unknown-unknown"
fi
echo
```

Renumber the old Step 12 (semver-checks) to Step 15. Update the final success message to reflect the new step count.

The ordering rationale: all-features (12) tests core thoroughly, then downstream (13) tests propagation, then WASM (14) tests compatibility, and finally semver-checks (15) validates API stability. This follows the existing pattern of cargo-hack after clippy, before tests of more complex scenarios.
  </action>
  <verify>
Run `bash -n scripts/ci-check.sh` to verify script syntax is valid.
Run `grep -c "Step" scripts/ci-check.sh` to confirm 16 steps exist (Step 0 through Step 15).
Run `grep "all-features" scripts/ci-check.sh` to confirm the new step exists.
  </verify>
  <done>ci-check.sh has Step 12 (all-features), Step 13 (downstream feature check), Step 14 (WASM verification), and Step 15 (semver-checks, renumbered). All steps have conditional guards for missing platform dependencies. Script passes syntax validation.</done>
</task>

<task type="auto">
  <name>Task 2: Add all-features and downstream feature testing to GitHub CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Add three new steps to .github/workflows/ci.yml. Insert them AFTER the "tests (trustedge-core with yubikey)" step (line ~97) and BEFORE the "API compatibility check" step (line ~99).

**New step: Build and test all features together.**

```yaml
      - name: Build and test all features (trustedge-core)
        if: steps.audio-deps.outputs.audio-available == 'true' && steps.yubikey-deps.outputs.yubikey-available == 'true'
        run: |
          cargo build -p trustedge-core --all-features
          cargo test -p trustedge-core --all-features --locked --verbose
```

**New step: Downstream crate feature propagation check.**

```yaml
      - name: Downstream crate feature check (trustedge-cli)
        run: cargo hack check --feature-powerset --no-dev-deps --package trustedge-cli
```

**New step: WASM build verification.**

```yaml
      - name: WASM build verification
        run: |
          rustup target add wasm32-unknown-unknown
          cargo check -p trustedge-wasm --target wasm32-unknown-unknown
          cargo check -p trustedge-trst-wasm --target wasm32-unknown-unknown
```

These steps mirror ci-check.sh for local/CI parity. The CI workflow uses GitHub Actions conditionals (if: steps.*.outputs) instead of bash conditionals for the all-features step. The WASM step installs the target explicitly (CI may not have it by default). The downstream check runs unconditionally since cargo-hack is already installed and cli features are simple.
  </action>
  <verify>
Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"` (or use `yq` if available).
Run `grep "all-features" .github/workflows/ci.yml` to confirm the new step exists.
Run `grep "wasm32-unknown-unknown" .github/workflows/ci.yml` to confirm WASM step exists.
Run `grep "trustedge-cli" .github/workflows/ci.yml` to confirm downstream check exists.
  </verify>
  <done>ci.yml has three new steps: all-features build+test (conditional on both audio+yubikey deps), downstream feature-powerset check for trustedge-cli, and WASM build verification. CI workflow mirrors ci-check.sh for parity.</done>
</task>

</tasks>

<verification>
1. `bash -n scripts/ci-check.sh` passes (no syntax errors)
2. ci.yml is valid YAML
3. `grep "all-features" scripts/ci-check.sh .github/workflows/ci.yml` shows matches in both files
4. `grep "wasm32-unknown-unknown" scripts/ci-check.sh .github/workflows/ci.yml` shows matches in both files
5. `grep "trustedge-cli" scripts/ci-check.sh .github/workflows/ci.yml` shows matches in both files
6. Running `cargo hack check --feature-powerset --no-dev-deps --package trustedge-cli` succeeds locally
7. Running `cargo check -p trustedge-wasm --target wasm32-unknown-unknown` succeeds locally (if target installed)
</verification>

<success_criteria>
- ci-check.sh and ci.yml both test all-features for trustedge-core
- ci-check.sh and ci.yml both run downstream feature-powerset check on trustedge-cli
- ci-check.sh and ci.yml both verify WASM builds without feature contamination
- All steps have appropriate guards for missing platform dependencies
- Local ci-check.sh and GitHub CI workflow remain in parity
</success_criteria>

<output>
After completion, create `.planning/phases/06-feature-flags/06-02-SUMMARY.md`
</output>
