---
phase: 15-feature-gating
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/core/Cargo.toml
  - crates/core/src/backends/mod.rs
  - crates/core/src/backends/keyring.rs
  - crates/core/src/backends/universal_keyring.rs
  - crates/core/src/backends/universal_registry.rs
  - crates/core/src/applications/attestation/mod.rs
  - crates/core/src/lib.rs
  - crates/core/tests/universal_backend_integration.rs
  - crates/trustedge-cli/Cargo.toml
  - crates/trustedge-cli/src/main.rs
autonomous: true

must_haves:
  truths:
    - "Running `cargo build --workspace` does not compile git2 or keyring crates"
    - "Running `cargo build -p trustedge-core --features git-attestation` compiles git2 and attestation git-discovery code"
    - "Running `cargo build -p trustedge-core --features keyring` compiles keyring backend and related code"
    - "All existing tests pass when features are explicitly enabled"
    - "Default build (no features) still compiles and runs all non-gated tests"
  artifacts:
    - path: "Cargo.toml"
      provides: "Workspace-level git2 and keyring dependency declarations (unchanged but referenced)"
    - path: "crates/core/Cargo.toml"
      provides: "Feature flags git-attestation and keyring with optional deps"
      contains: "git-attestation"
    - path: "crates/core/src/backends/mod.rs"
      provides: "Conditional module declarations and re-exports for keyring"
      contains: "cfg(feature"
    - path: "crates/core/src/applications/attestation/mod.rs"
      provides: "git2 usage behind cfg(feature = git-attestation)"
      contains: "cfg(feature"
    - path: "crates/core/src/lib.rs"
      provides: "Conditional re-exports for KeyringBackend and UniversalKeyringBackend"
      contains: "cfg(feature"
    - path: "crates/trustedge-cli/Cargo.toml"
      provides: "Feature forwarding for keyring to trustedge-core"
      contains: "keyring"
  key_links:
    - from: "crates/core/Cargo.toml"
      to: "crates/core/src/backends/keyring.rs"
      via: "feature = keyring makes keyring dep optional"
      pattern: 'keyring.*optional.*true'
    - from: "crates/core/Cargo.toml"
      to: "crates/core/src/applications/attestation/mod.rs"
      via: "feature = git-attestation makes git2 dep optional"
      pattern: 'git2.*optional.*true'
    - from: "crates/trustedge-cli/Cargo.toml"
      to: "crates/core/Cargo.toml"
      via: "feature forwarding keyring = trustedge-core/keyring"
      pattern: 'keyring.*trustedge-core/keyring'
---

<objective>
Feature-gate git2 and keyring dependencies behind opt-in feature flags in trustedge-core

Purpose: Heavy optional dependencies (git2, keyring) should not compile when not needed. This reduces default build time, binary size, and attack surface. Follows the same pattern already established for `yubikey` and `audio` features.

Output: Modified Cargo.toml files with new feature flags, all source files wrapped in `#[cfg(feature = "...")]` guards, conditional re-exports in lib.rs, and feature forwarding in trustedge-cli.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@crates/core/Cargo.toml
@crates/core/src/backends/mod.rs
@crates/core/src/lib.rs
@crates/trustedge-cli/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Feature-gate git2 behind git-attestation flag</name>
  <files>
    crates/core/Cargo.toml
    crates/core/src/applications/attestation/mod.rs
  </files>
  <action>
1. In `crates/core/Cargo.toml`:
   - Change `git2 = { workspace = true }` to `git2 = { workspace = true, optional = true }`
   - Add a new feature: `git-attestation = ["git2"]` in the `[features]` section (after the existing `yubikey` and `audio` features)

2. In `crates/core/src/applications/attestation/mod.rs`:
   - Wrap the git2 usage in `create_signed_attestation()` (lines 134-146) with `#[cfg(feature = "git-attestation")]` conditional compilation
   - When the feature is NOT enabled, the `source_commit_hash` field should default to `"unknown".to_string()` (graceful degradation, same as the current fallback when not in a git repo)
   - Structure it as:
     ```rust
     let source_commit_hash = {
         #[cfg(feature = "git-attestation")]
         {
             use git2::Repository;
             match Repository::discover(".") {
                 Ok(repo) => repo.head()
                     .and_then(|head| head.peel_to_commit())
                     .map(|commit| commit.id().to_string())
                     .unwrap_or_else(|_| "unknown".to_string()),
                 Err(_) => "unknown".to_string(),
             }
         }
         #[cfg(not(feature = "git-attestation"))]
         {
             "unknown".to_string()
         }
     };
     ```

This follows the same pattern as `#[cfg(feature = "yubikey")]` already used in the codebase.
  </action>
  <verify>
- `cargo build -p trustedge-core --no-default-features` succeeds (git2 not compiled)
- `cargo build -p trustedge-core --features git-attestation` succeeds (git2 compiled)
- `cargo test -p trustedge-core --lib --features git-attestation` passes all attestation tests
- `cargo test -p trustedge-core --lib --no-default-features` passes (attestation tests still work, just with "unknown" commit hash)
  </verify>
  <done>
git2 compiles only when `--features git-attestation` is passed. Default workspace build excludes git2. Attestation module gracefully degrades to "unknown" commit hash without the feature.
  </done>
</task>

<task type="auto">
  <name>Task 2: Feature-gate keyring behind keyring flag</name>
  <files>
    crates/core/Cargo.toml
    crates/core/src/backends/mod.rs
    crates/core/src/backends/keyring.rs
    crates/core/src/backends/universal_keyring.rs
    crates/core/src/backends/universal_registry.rs
    crates/core/src/lib.rs
    crates/core/tests/universal_backend_integration.rs
    crates/trustedge-cli/Cargo.toml
    crates/trustedge-cli/src/main.rs
  </files>
  <action>
1. In `crates/core/Cargo.toml`:
   - Change `keyring = { workspace = true }` to `keyring = { workspace = true, optional = true }`
   - Add feature: `keyring = ["dep:keyring"]` in `[features]` section. NOTE: Since the feature name matches the dependency name, use `dep:keyring` syntax to disambiguate (Cargo 1.60+). This is necessary because `keyring` as a feature name would otherwise conflict with the dependency name.

2. In `crates/core/src/backends/mod.rs`:
   - Wrap `pub mod keyring;` with `#[cfg(feature = "keyring")]`
   - Wrap `pub mod universal_keyring;` with `#[cfg(feature = "keyring")]`
   - Wrap `pub use keyring::KeyringBackend;` with `#[cfg(feature = "keyring")]`
   - Wrap `pub use universal_keyring::UniversalKeyringBackend;` with `#[cfg(feature = "keyring")]`
   - Leave `BackendRegistry` unchanged -- it references KeyringBackend in `create_backend()`. Wrap the keyring match arm with cfg:
     ```rust
     #[cfg(feature = "keyring")]
     "keyring" => Ok(Box::new(KeyringBackend::new()?)),
     #[cfg(not(feature = "keyring"))]
     "keyring" => Err(anyhow::anyhow!("Keyring backend requires the 'keyring' feature. Build with: --features keyring")),
     ```
   - In `list_available_backends()`, conditionally include "keyring":
     ```rust
     let mut backends = vec![];
     #[cfg(feature = "keyring")]
     backends.push("keyring");
     ```

3. In `crates/core/src/backends/universal_registry.rs`:
   - Wrap the `use crate::backends::universal_keyring::UniversalKeyringBackend;` import with `#[cfg(feature = "keyring")]`
   - Wrap the keyring backend registration in `with_defaults()` with `#[cfg(feature = "keyring")]`:
     ```rust
     #[cfg(feature = "keyring")]
     {
         if let Ok(keyring_backend) = UniversalKeyringBackend::new() {
             registry.register_backend("keyring".to_string(), Box::new(keyring_backend));
         }
     }
     ```

4. In `crates/core/src/lib.rs`:
   - Wrap `KeyringBackend` and `UniversalKeyringBackend` re-exports with `#[cfg(feature = "keyring")]`:
     ```rust
     #[cfg(feature = "keyring")]
     #[cfg_attr(docsrs, doc(cfg(feature = "keyring")))]
     pub use backends::{KeyringBackend, UniversalKeyringBackend};
     ```
   - Remove `KeyringBackend` and `UniversalKeyringBackend` from the main (unconditional) `pub use backends::{...}` block

5. In `crates/core/tests/universal_backend_integration.rs`:
   - Add `#![cfg(feature = "keyring")]` at the top of the file (the entire integration test file is keyring-specific -- all tests use UniversalKeyringBackend or rely on the keyring backend being in the registry). This ensures these tests only run when keyring feature is enabled.

6. In `crates/trustedge-cli/Cargo.toml`:
   - Add feature forwarding: `keyring = ["trustedge-core/keyring"]` in the `[features]` section
   - This allows `cargo build -p trustedge-cli --features keyring` to enable keyring in core

7. In `crates/trustedge-cli/src/main.rs`:
   - Wrap the `--set-passphrase` handler (lines 903-908) with `#[cfg(feature = "keyring")]` and add a `#[cfg(not(feature = "keyring"))]` branch that returns an error: "Keyring support requires the 'keyring' feature. Build with: --features keyring"
   - Wrap the `use_keyring` / keyring-dependent code paths in `select_aes_key_with_backend()` with appropriate cfg guards. When keyring feature is disabled and user passes `--use-keyring`, return an error: "Keyring backend requires the 'keyring' feature."
   - The `create_backend_from_args()` function's keyring match arm should be similarly guarded
   - IMPORTANT: The CLI struct fields (`set_passphrase`, `use_keyring`, `backend`) should remain unconditional so the CLI still parses these arguments. Only the implementation bodies should be gated, returning helpful errors when the feature is not enabled.
  </action>
  <verify>
- `cargo build -p trustedge-core --no-default-features` succeeds (keyring not compiled)
- `cargo build -p trustedge-core --features keyring` succeeds (keyring compiled)
- `cargo test -p trustedge-core --lib --no-default-features` passes all non-keyring tests
- `cargo test -p trustedge-core --lib --features keyring` passes including keyring-specific tests
- `cargo test -p trustedge-core --features keyring --test universal_backend_integration` passes
- `cargo build -p trustedge-cli --features keyring` succeeds
- `cargo build --workspace --no-default-features` succeeds (neither git2 nor keyring compiled)
- `cargo clippy --workspace --no-default-features -- -D warnings` passes
- `cargo clippy -p trustedge-core --features git-attestation,keyring -- -D warnings` passes
  </verify>
  <done>
keyring crate compiles only when `--features keyring` is passed. Default workspace build excludes keyring. KeyringBackend and UniversalKeyringBackend are conditionally exported. CLI gracefully tells users to enable the feature if they try keyring operations without it. Integration tests are gated behind the keyring feature.
  </done>
</task>

</tasks>

<verification>
Run the following commands to verify Phase 15 Plan 01 is complete:

```bash
# 1. Default build excludes git2 and keyring
cargo build --workspace --no-default-features 2>&1 | grep -E "Compiling (git2|keyring)" && echo "FAIL: git2/keyring compiled in default build" || echo "PASS: git2/keyring excluded"

# 2. Feature-enabled builds work
cargo build -p trustedge-core --features git-attestation
cargo build -p trustedge-core --features keyring
cargo build -p trustedge-core --features git-attestation,keyring

# 3. All tests pass with features enabled
cargo test -p trustedge-core --features git-attestation,keyring --locked
cargo test -p trustedge-core --features keyring --test universal_backend_integration

# 4. Default tests pass without features
cargo test -p trustedge-core --no-default-features --locked

# 5. Clippy clean in both modes
cargo clippy --workspace --no-default-features -- -D warnings
cargo clippy -p trustedge-core --features git-attestation,keyring -- -D warnings

# 6. CLI builds with feature forwarding
cargo build -p trustedge-cli --features keyring
```
</verification>

<success_criteria>
- git2 dependency is optional, compiled only with `--features git-attestation`
- keyring dependency is optional, compiled only with `--features keyring`
- `cargo build --workspace` (default) does NOT compile git2 or keyring
- All tests pass with both features enabled
- All non-gated tests pass without features
- No clippy warnings in either mode
- trustedge-cli forwards keyring feature to trustedge-core
- Helpful error messages when users try to use keyring without the feature
</success_criteria>

<output>
After completion, create `.planning/phases/15-feature-gating/15-01-SUMMARY.md`
</output>
