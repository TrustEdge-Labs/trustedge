---
phase: 15-feature-gating
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - scripts/ci-check.sh
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "CI pipeline tests default build (no features) for workspace"
    - "CI pipeline tests trustedge-core with git-attestation feature"
    - "CI pipeline tests trustedge-core with keyring feature"
    - "CI pipeline tests trustedge-core with all features combined"
    - "Local ci-check.sh mirrors CI behavior for git-attestation and keyring features"
  artifacts:
    - path: "scripts/ci-check.sh"
      provides: "Local CI script with git-attestation and keyring feature testing"
      contains: "git-attestation"
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI with git-attestation and keyring feature testing"
      contains: "git-attestation"
  key_links:
    - from: "scripts/ci-check.sh"
      to: ".github/workflows/ci.yml"
      via: "Local script mirrors CI behavior"
      pattern: "git-attestation"
    - from: ".github/workflows/ci.yml"
      to: "crates/core/Cargo.toml"
      via: "CI enables features defined in Cargo.toml"
      pattern: "features.*git-attestation"
---

<objective>
Update CI pipeline to test both default (no features) and feature-enabled builds for git-attestation and keyring

Purpose: CI must validate that feature gating works correctly -- that the default build excludes these dependencies and that feature-enabled builds compile and pass tests. This prevents silent regressions where code accidentally becomes unconditional again.

Output: Updated ci-check.sh and ci.yml with new test steps for git-attestation and keyring features.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-feature-gating/15-01-SUMMARY.md
@scripts/ci-check.sh
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update local CI script with feature-gated test steps</name>
  <files>scripts/ci-check.sh</files>
  <action>
Add new CI steps to `scripts/ci-check.sh` for the git-attestation and keyring features. Insert these AFTER Step 5 (yubikey clippy) and BEFORE Step 6 (cargo-hack). Re-number subsequent steps as needed.

**New Step: Clippy (trustedge-core with git-attestation)**
```bash
step "Step N: Clippy (trustedge-core with git-attestation)"
if cargo clippy --package trustedge-core --all-targets --features git-attestation -- -D warnings; then
    pass "clippy git-attestation"
else
    fail "clippy git-attestation"
fi
```

**New Step: Clippy (trustedge-core with keyring)**
```bash
step "Step N: Clippy (trustedge-core with keyring)"
if cargo clippy --package trustedge-core --all-targets --features keyring -- -D warnings; then
    pass "clippy keyring"
else
    fail "clippy keyring"
fi
```

**New Step: Tests (trustedge-core with git-attestation)** -- Insert after the main test steps (after yubikey tests, before all-features combined):
```bash
step "Step N: Tests (trustedge-core with git-attestation)"
if cargo test --package trustedge-core --features git-attestation --locked; then
    pass "git-attestation tests"
else
    fail "git-attestation tests"
fi
```

**New Step: Tests (trustedge-core with keyring)** -- Insert after git-attestation tests:
```bash
step "Step N: Tests (trustedge-core with keyring)"
if cargo test --package trustedge-core --features keyring --locked; then
    pass "keyring tests"
else
    fail "keyring tests"
fi
```

Also update the "All features combined" step (currently Step 10) to include git-attestation and keyring. Change `--all-features` to explicitly list all features or keep `--all-features` (which already includes them since they are defined in Cargo.toml). The current `--all-features` approach already works since it picks up all features, so just verify this step's description mentions the new features.

IMPORTANT: Do NOT change the feature powerset step (cargo-hack). The powerset already tests all feature combinations automatically.

Keep step numbering clean -- renumber all steps sequentially after insertions.
  </action>
  <verify>
- `./scripts/ci-check.sh` runs without syntax errors (test with `bash -n scripts/ci-check.sh`)
- Script contains steps for git-attestation clippy and tests
- Script contains steps for keyring clippy and tests
- Step numbers are sequential with no gaps or duplicates
  </verify>
  <done>
Local CI script tests git-attestation and keyring features independently, catching regressions where gated code breaks or where unconditional code accidentally references gated types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update GitHub Actions CI with feature-gated test steps</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Add new CI steps to `.github/workflows/ci.yml` that mirror the local script changes. Insert these in the appropriate positions.

**After "clippy (trustedge-core with yubikey)":**
```yaml
- name: clippy (trustedge-core with git-attestation)
  run: cargo clippy --package trustedge-core --all-targets --features git-attestation -- -D warnings

- name: clippy (trustedge-core with keyring)
  run: cargo clippy --package trustedge-core --all-targets --features keyring -- -D warnings
```

**After "tests (trustedge-core with yubikey simulation only)":**
```yaml
- name: tests (trustedge-core with git-attestation)
  run: cargo test --package trustedge-core --features git-attestation --locked --verbose

- name: tests (trustedge-core with keyring)
  run: cargo test --package trustedge-core --features keyring --locked --verbose
```

These steps are NOT conditional (no `if:` clause) since git-attestation and keyring have no system library dependencies -- they are pure Rust crates that always compile. This matches the pattern of unconditional testing (like the yubikey steps that run after libpcsclite is installed).

The existing "Build and test all features" step already uses `--all-features` which will include the new features. No change needed there.

IMPORTANT: These steps should be blocking (no `continue-on-error: true`) since git-attestation and keyring are part of the core crate (Tier 1 stable). Feature breakage should block the PR.
  </action>
  <verify>
- `.github/workflows/ci.yml` is valid YAML (check with `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"` or similar)
- CI file contains steps for git-attestation clippy and tests
- CI file contains steps for keyring clippy and tests
- New steps are blocking (no continue-on-error)
  </verify>
  <done>
GitHub Actions CI validates feature gating on every PR -- both default (no features) and feature-enabled builds are tested, preventing silent breakage of gated code.
  </done>
</task>

</tasks>

<verification>
Run the following to verify Phase 15 Plan 02 is complete:

```bash
# 1. Local CI script syntax check
bash -n scripts/ci-check.sh && echo "PASS: Script syntax valid"

# 2. CI YAML syntax check
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml')); print('PASS: YAML valid')"

# 3. Verify git-attestation steps exist in both files
grep -q "git-attestation" scripts/ci-check.sh && echo "PASS: ci-check.sh has git-attestation"
grep -q "git-attestation" .github/workflows/ci.yml && echo "PASS: ci.yml has git-attestation"

# 4. Verify keyring steps exist in both files
grep -q "features keyring" scripts/ci-check.sh && echo "PASS: ci-check.sh has keyring"
grep -q "features keyring" .github/workflows/ci.yml && echo "PASS: ci.yml has keyring"

# 5. Full CI run (optional -- only if time permits)
# ./scripts/ci-check.sh
```
</verification>

<success_criteria>
- ci-check.sh has dedicated clippy and test steps for git-attestation feature
- ci-check.sh has dedicated clippy and test steps for keyring feature
- ci.yml has dedicated clippy and test steps for git-attestation feature
- ci.yml has dedicated clippy and test steps for keyring feature
- All new CI steps are blocking (not continue-on-error)
- Local script and GitHub CI are in sync
- No syntax errors in either file
</success_criteria>

<output>
After completion, create `.planning/phases/15-feature-gating/15-02-SUMMARY.md`
</output>
