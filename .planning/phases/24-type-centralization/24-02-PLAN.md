---
phase: 24-type-centralization
plan: 02
type: execute
wave: 2
depends_on:
  - 24-01
files_modified:
  - Cargo.toml
  - crates/core/Cargo.toml
  - crates/core/src/lib.rs
  - crates/trst-cli/Cargo.toml
  - crates/trst-cli/src/main.rs
  - CLAUDE.md
  - scripts/ci-check.sh
autonomous: true
requirements:
  - TYPE-01
  - TYPE-02

must_haves:
  truths:
    - "trustedge-core depends on trustedge-types and re-exports its types"
    - "Downstream crates can access wire types through trustedge_core without directly depending on trustedge-types"
    - "trst-cli uses trustedge-types wire types instead of local struct definitions"
    - "CI validates trustedge-types as Tier 1 (blocking)"
    - "Full workspace builds and all existing tests continue to pass"
  artifacts:
    - path: "crates/core/Cargo.toml"
      provides: "trustedge-types dependency declaration"
      contains: "trustedge-types"
    - path: "crates/core/src/lib.rs"
      provides: "Re-export of trustedge_types"
      contains: "pub use trustedge_types"
    - path: "crates/trst-cli/src/main.rs"
      provides: "Uses shared wire types instead of local duplicates"
      contains: "trustedge_types"
  key_links:
    - from: "crates/core/Cargo.toml"
      to: "crates/types/Cargo.toml"
      via: "workspace dependency"
      pattern: "trustedge-types"
    - from: "crates/core/src/lib.rs"
      to: "crates/types/src/lib.rs"
      via: "pub use re-export"
      pattern: "pub use trustedge_types"
    - from: "crates/trst-cli/src/main.rs"
      to: "crates/types/src/verification.rs"
      via: "import of shared types"
      pattern: "trustedge_types"
---

<objective>
Integrate trustedge-types into the workspace dependency graph: core re-exports the types, trst-cli uses shared types instead of local duplicates, and CI validates the new crate.

Purpose: TYPE-01 requires the types to be consumable from the workspace. The CONTEXT decision specifies "trustedge-core depends on trustedge-types and re-exports. Downstream crates only need trustedge-core in their dependencies." This plan wires that up and eliminates duplicate type definitions in trst-cli. TYPE-02 ensures Uuid/DateTime are available through core.

Output: Core re-exports types, trst-cli deduplication, CI integration, updated docs.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-type-centralization/24-CONTEXT.md
@.planning/phases/24-type-centralization/24-01-SUMMARY.md

# Key files to modify:
@crates/core/Cargo.toml
@crates/core/src/lib.rs
@crates/trst-cli/Cargo.toml
@crates/trst-cli/src/main.rs
@CLAUDE.md
@scripts/ci-check.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire trustedge-types into core and eliminate trst-cli duplicates</name>
  <files>
    Cargo.toml
    crates/core/Cargo.toml
    crates/core/src/lib.rs
    crates/trst-cli/Cargo.toml
    crates/trst-cli/src/main.rs
  </files>
  <action>
    **Workspace Cargo.toml:**
    - Add `trustedge-types = { path = "crates/types" }` to [workspace.dependencies]

    **crates/core/Cargo.toml:**
    - Add `trustedge-types = { workspace = true }` to [dependencies]

    **crates/core/src/lib.rs:**
    - Add `pub use trustedge_types;` at the top-level public API section
    - This allows downstream crates to use `trustedge_core::trustedge_types::prelude::*` or `trustedge_core::trustedge_types::VerifyReport` etc.
    - Also add convenience re-exports: `pub use trustedge_types::{Uuid, DateTime, Utc};` so common types are directly accessible from core

    **crates/trst-cli/Cargo.toml:**
    - Add `trustedge-types = { workspace = true }` to [dependencies] (trst-cli already depends on trustedge-core but the types are useful directly)

    **crates/trst-cli/src/main.rs:**
    - Replace the local `VerifyReport` struct definition (lines ~36-50) with `use trustedge_types::verify_report::VerifyReport;`
    - Replace the local `SegmentRef` struct definition (lines ~53-56) with `use trustedge_types::verification::SegmentRef;`
    - Replace the local `VerifyRequestOptions` struct (lines ~58-62) with `use trustedge_types::verification::VerifyOptions;` -- rename usage from VerifyRequestOptions to VerifyOptions throughout the file
    - Replace the local `VerifyRequest` struct (lines ~64-70) with `use trustedge_types::verification::VerifyRequest;`
    - IMPORTANT: The trst-cli local VerifyReport has `out_of_order: Option<bool>` while the shared type has `out_of_order: Option<OutOfOrder>`. These are DIFFERENT semantically. The trst-cli constructs a VerifyReport to output JSON for the verify command. Two approaches:
      a. If the trst-cli only ever sets out_of_order to None or uses it as a boolean flag, switch to using the shared OutOfOrder type
      b. If there is a genuine difference, keep the trst-cli local VerifyReport but add a comment referencing the shared type
    - Read the trst-cli verify command implementation carefully to determine which approach. Check how out_of_order is populated -- if it's only ever set to None, use approach (a). If it's set to true/false, we need a minor adaptation.
    - Also check: trst-cli VerifyRequest uses `manifest: CamVideoManifest` while shared type uses `manifest: serde_json::Value`. The CamVideoManifest is a local type from trst-protocols. Evaluate whether the trst-cli VerifyRequest can switch to the shared type (it's used for JSON output to API). If CamVideoManifest serializes to a Value, the shared type works fine since serde_json::Value accepts any JSON-serializable struct.
    - For any types that genuinely differ: keep the local definition but add a comment like `// NOTE: Differs from trustedge_types::verification::VerifyRequest -- this version uses typed CamVideoManifest`

    After modifications, run:
    - `cargo build --workspace` to verify everything compiles
    - `cargo test --workspace` to verify no regressions
    - `cargo test -p trustedge-trst-cli --test acceptance` to verify archive acceptance tests still pass
  </action>
  <verify>
    `cargo build --workspace` succeeds.
    `cargo test --workspace` passes all tests (existing 235+ plus new types tests).
    `cargo test -p trustedge-trst-cli --test acceptance` passes all 7 acceptance tests.
    `cargo clippy --workspace -- -D warnings` passes.
  </verify>
  <done>
    trustedge-core depends on and re-exports trustedge-types. Uuid and DateTime accessible via `trustedge_core::Uuid` and `trustedge_core::DateTime`. trst-cli uses shared wire types where applicable, eliminating duplicated struct definitions. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CI and documentation for new types crate</name>
  <files>
    CLAUDE.md
    scripts/ci-check.sh
  </files>
  <action>
    **scripts/ci-check.sh:**
    - Find the Tier 1 (stable) crate validation section in ci-check.sh
    - Add `trustedge-types` to the list of Tier 1 crates that receive blocking validation (cargo build, cargo test, cargo clippy)
    - trustedge-types tests should run alongside trustedge-core tests as blocking (not experimental/non-blocking)
    - Verify the step numbering is consistent after insertion

    **CLAUDE.md:**
    - In the "Architecture Overview" section, add trustedge-types to the "Core Platform" list:
      `- \`trustedge-types\` - Shared wire types for platform services (verification, receipts, policies)`
    - Update the workspace crate count from 10 to 11
    - In the "Key Modules" table or architecture description, note that trustedge-core re-exports trustedge-types
    - Add a test command example: `cargo test -p trustedge-types` in the Build & Test Commands section

    After modifications, run:
    - `./scripts/ci-check.sh` to verify the full CI pipeline passes with the new crate included
  </action>
  <verify>
    `./scripts/ci-check.sh` passes completely with trustedge-types validated as Tier 1.
    CLAUDE.md accurately reflects the 11-crate workspace with trustedge-types listed.
    `cargo fmt --check --all` passes.
  </verify>
  <done>
    CI validates trustedge-types as Tier 1 (blocking). CLAUDE.md documents the new crate in architecture overview and test commands. Full CI pipeline passes.
  </done>
</task>

</tasks>

<verification>
1. `cargo build --workspace` compiles all 11 crates
2. `cargo test --workspace` passes all tests (235+ existing + new types tests)
3. `cargo clippy --workspace -- -D warnings` clean
4. `./scripts/ci-check.sh` passes completely
5. `trustedge_core::trustedge_types` accessible from downstream crates
6. `trustedge_core::Uuid` and `trustedge_core::DateTime` re-exported
7. trst-cli no longer has duplicate wire type definitions (or has documented deviations)
8. CLAUDE.md reflects 11-crate workspace
</verification>

<success_criteria>
- Core re-exports trustedge-types; downstream access works through core
- Uuid and DateTime available via `trustedge_core::Uuid`, `trustedge_core::DateTime`
- trst-cli deduplicated (shared types used where compatible)
- CI treats trustedge-types as Tier 1 (blocking)
- Full workspace build + test passes with zero regressions
- Documentation updated to reflect new crate
</success_criteria>

<output>
After completion, create `.planning/phases/24-type-centralization/24-02-SUMMARY.md`
</output>
