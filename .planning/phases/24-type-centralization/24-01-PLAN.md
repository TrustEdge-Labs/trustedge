---
phase: 24-type-centralization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/types/Cargo.toml
  - crates/types/src/lib.rs
  - crates/types/src/policy.rs
  - crates/types/src/receipt.rs
  - crates/types/src/verification.rs
  - crates/types/src/verify_report.rs
  - crates/types/src/schema.rs
  - crates/types/tests/schema_snapshot.rs
  - crates/types/tests/fixtures/verify_report.v1.json
  - crates/types/tests/fixtures/receipt.v1.json
  - crates/types/tests/fixtures/verify_request.v1.json
  - crates/types/tests/fixtures/verify_response.v1.json
autonomous: true
requirements:
  - TYPE-01
  - TYPE-02
  - TYPE-03

must_haves:
  truths:
    - "trustedge-types crate exists in crates/types/ and compiles as part of the workspace"
    - "All 8 wire types from te_shared (PolicyV0, Receipt, VerifyReport, OutOfOrder, SegmentRef, VerifyOptions, VerifyRequest, VerifyResponse) are defined in the crate"
    - "uuid::Uuid and chrono::DateTime<Utc> are re-exported as type aliases (no newtype wrappers)"
    - "JSON schema generation produces exact-match output for all 4 schema files"
    - "Round-trip serde tests pass for all wire types"
    - "Schema snapshot regression tests prevent output drift"
  artifacts:
    - path: "crates/types/Cargo.toml"
      provides: "Crate manifest with serde, serde_json, thiserror, schemars, uuid, chrono"
      contains: "name = \"trustedge-types\""
    - path: "crates/types/src/lib.rs"
      provides: "Module index, prelude, Uuid/DateTime re-exports"
      exports: ["prelude", "schema", "Uuid", "DateTime"]
    - path: "crates/types/src/schema.rs"
      provides: "Schema generation function"
      exports: ["generate"]
    - path: "crates/types/tests/schema_snapshot.rs"
      provides: "Snapshot regression tests for all 4 schemas"
      min_lines: 30
  key_links:
    - from: "Cargo.toml"
      to: "crates/types/Cargo.toml"
      via: "workspace members list"
      pattern: "crates/types"
    - from: "crates/types/src/schema.rs"
      to: "schemars::schema_for!"
      via: "schema generation macro"
      pattern: "schema_for!"
    - from: "crates/types/tests/schema_snapshot.rs"
      to: "crates/types/tests/fixtures/*.json"
      via: "include_str! or file read for fixture comparison"
      pattern: "fixtures"
---

<objective>
Create the trustedge-types crate with all wire types migrated from te_shared, plus schema generation and snapshot regression testing.

Purpose: TYPE-01 requires te_shared types to live in the main workspace. TYPE-02 requires Uuid/DateTime re-exports. TYPE-03 requires preserved JSON schema generation. This plan creates the crate, migrates all types, and ensures schema output matches the original shared-libs version exactly.

Output: A new `crates/types/` crate in the workspace with all wire types, schema generation, and comprehensive tests.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-type-centralization/24-CONTEXT.md

# Source material to migrate from (external repos -- READ ONLY, do not modify):
# /home/john/vault/projects/github.com/trustedge-shared-libs/te_shared/src/ (all .rs files)
# /home/john/vault/projects/github.com/trustedge-shared-libs/te_shared/Cargo.toml
# /home/john/vault/projects/github.com/trustedge-shared-libs/te_shared/schemas/*.json (fixture files)

# Workspace root:
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trustedge-types crate with wire type definitions</name>
  <files>
    Cargo.toml
    crates/types/Cargo.toml
    crates/types/src/lib.rs
    crates/types/src/policy.rs
    crates/types/src/receipt.rs
    crates/types/src/verification.rs
    crates/types/src/verify_report.rs
  </files>
  <action>
    Create the `crates/types/` directory and crate skeleton.

    **crates/types/Cargo.toml:**
    - Package name: `trustedge-types`
    - Version: `0.2.0` (matching workspace convention)
    - Edition: 2021
    - Description: "Shared wire types for TrustEdge platform services"
    - Add Tier 1 (Stable) metadata in package.metadata matching the pattern used by other stable crates (check crates/core/Cargo.toml for the exact metadata format)
    - License: MPL-2.0
    - Dependencies (use workspace deps where available):
      - `serde = { workspace = true }` (already in workspace)
      - `serde_json = { workspace = true }` (already in workspace)
      - `thiserror = { workspace = true }` (already in workspace)
      - `chrono = { workspace = true }` (already in workspace, has serde feature)
      - `uuid = { version = "1", features = ["serde"] }` -- upgrade to latest uuid v1 per CONTEXT decision. Do NOT add v4 generation features; types crate defines the type only
      - `schemars = { version = "0.8", features = ["chrono", "uuid1"] }` -- default (not feature-gated) per CONTEXT decision. The "uuid1" feature enables schemars to understand uuid::Uuid.
    - Do NOT add uuid to workspace.dependencies yet (that happens in Plan 02 when integrating with core)

    **crates/types/src/lib.rs:**
    - Add MPL-2.0 copyright header
    - Declare modules: `pub mod policy;`, `pub mod receipt;`, `pub mod verification;`, `pub mod verify_report;`, `pub mod schema;`
    - Re-export types: `pub use uuid::Uuid;` and `pub use chrono::{DateTime, Utc};` -- direct re-exports, no newtype wrappers per CONTEXT decision
    - Define `pub mod prelude` that re-exports: PolicyV0, Receipt, SegmentRef, VerifyOptions, VerifyRequest, VerifyResponse, VerifyReport, OutOfOrder, Uuid, DateTime, Utc
    - Include round-trip serde tests in `#[cfg(test)] mod tests` block -- migrate ALL 11 tests from `/home/john/vault/projects/github.com/trustedge-shared-libs/te_shared/src/lib.rs` (lines 14-312). These cover: verify_report round-trip, verify_report minimal, receipt round-trip, policy_v0 round-trip, policy_v0 default, json key preservation, segment_ref round-trip, verify_options round-trip, verify_options default, verify_request round-trip, verify_response round-trip, verify_request with defaults

    **crates/types/src/policy.rs:**
    - Add MPL-2.0 copyright header
    - Migrate PolicyV0 struct from shared-libs. Add `#[derive(Serialize, Deserialize, Clone, Debug, Default, JsonSchema)]` (JsonSchema is always-on, not feature-gated per CONTEXT)
    - Fields: required_profile (Option<String>), min_segments (Option<u32>), chunk_seconds_range (Option<(f32, f32)>), allowed_codecs (Option<Vec<String>>)

    **crates/types/src/receipt.rs:**
    - Add MPL-2.0 copyright header
    - Migrate Receipt struct from shared-libs (NOT the core Receipt which is a different type for envelope-based transferable claims)
    - Add `#[derive(Serialize, Deserialize, Clone, Debug, JsonSchema)]`
    - Fields: verification_id, profile, device_id, manifest_digest, segments (u32), duration_s (f32), signature, continuity, issued_at, service_kid, chain_tip -- all String types matching shared-libs exactly

    **crates/types/src/verification.rs:**
    - Add MPL-2.0 copyright header
    - Migrate SegmentRef, VerifyOptions, VerifyRequest, VerifyResponse from shared-libs
    - Preserve all serde attributes: `#[serde(deny_unknown_fields, rename_all = "snake_case")]`, `#[serde(default)]`, `#[serde(skip_serializing_if = "Option::is_none")]`
    - VerifyRequest.manifest field is `serde_json::Value` (matching shared-libs)
    - VerifyOptions includes Default impl with return_receipt: false, device_id: None

    **crates/types/src/verify_report.rs:**
    - Add MPL-2.0 copyright header
    - Migrate VerifyReport and OutOfOrder from shared-libs
    - Preserve all serde attributes exactly
    - VerifyReport has Default derive

    **Workspace Cargo.toml:**
    - Add `"crates/types"` to workspace members list (insert after `"crates/core"` in the list)
    - Add `schemars = { version = "0.8", features = ["chrono", "uuid1"] }` to [workspace.dependencies]
    - Add `uuid = { version = "1", features = ["serde"] }` to [workspace.dependencies]
    - Do NOT add trustedge-types itself to workspace.dependencies yet (Plan 02 does that)

    After creating all files, run: `cargo build -p trustedge-types` to verify compilation.
    Then run: `cargo test -p trustedge-types --lib` to verify all round-trip tests pass.
  </action>
  <verify>
    `cargo build -p trustedge-types` succeeds.
    `cargo test -p trustedge-types --lib` shows all 11 round-trip tests passing.
    `cargo clippy -p trustedge-types -- -D warnings` passes.
  </verify>
  <done>
    trustedge-types crate exists in crates/types/, compiles, and all 11 migrated round-trip serde tests pass. Uuid and DateTime are re-exported directly. Crate is listed in workspace members.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add schema generation and snapshot regression tests</name>
  <files>
    crates/types/src/schema.rs
    crates/types/tests/schema_snapshot.rs
    crates/types/tests/fixtures/verify_report.v1.json
    crates/types/tests/fixtures/receipt.v1.json
    crates/types/tests/fixtures/verify_request.v1.json
    crates/types/tests/fixtures/verify_response.v1.json
  </files>
  <action>
    **crates/types/src/schema.rs:**
    - Add MPL-2.0 copyright header
    - Create a `pub fn generate() -> std::collections::BTreeMap<String, serde_json::Value>` function that:
      1. Uses `schemars::schema_for!()` to generate schemas for: VerifyReport, Receipt, VerifyRequest, VerifyResponse
      2. Returns a BTreeMap mapping schema name (e.g., "verify_report.v1") to the schema JSON Value
    - Also create individual schema functions: `pub fn verify_report_schema() -> schemars::schema::RootSchema`, etc. for each of the 4 types
    - This is exposed as `trustedge_types::schema::generate()` per CONTEXT decision

    **Fixture files:**
    - Copy the 4 JSON schema files from `/home/john/vault/projects/github.com/trustedge-shared-libs/te_shared/schemas/` into `crates/types/tests/fixtures/`:
      - verify_report.v1.json
      - receipt.v1.json
      - verify_request.v1.json
      - verify_response.v1.json
    - These are the "golden" fixtures for snapshot comparison

    **crates/types/tests/schema_snapshot.rs:**
    - Add MPL-2.0 copyright header
    - Create integration tests that:
      1. For each of the 4 types (VerifyReport, Receipt, VerifyRequest, VerifyResponse):
         a. Generate the schema using trustedge_types::schema functions
         b. Serialize to pretty-printed JSON
         c. Load the corresponding fixture file from tests/fixtures/
         d. Parse both as serde_json::Value and compare for equality
         e. If they differ, print a helpful diff message showing expected vs actual
      2. Test the `generate()` function returns all 4 schemas

    The snapshot test ensures TYPE-03 (exact-match schema output) is enforced. If schema output ever drifts from the shared-libs baseline, tests fail.

    After creating all files, run: `cargo test -p trustedge-types` to verify all tests pass (both lib and integration).
  </action>
  <verify>
    `cargo test -p trustedge-types` passes (all unit tests + schema snapshot integration tests).
    All 4 schema snapshot comparisons match the shared-libs originals exactly.
    `cargo clippy -p trustedge-types -- -D warnings` passes.
  </verify>
  <done>
    Schema generation function exists at `trustedge_types::schema::generate()`. Snapshot regression tests verify exact-match output against shared-libs baseline for all 4 schema types. Any future schema drift causes test failure.
  </done>
</task>

</tasks>

<verification>
1. `cargo build -p trustedge-types` compiles the new crate
2. `cargo test -p trustedge-types` passes all tests (11 round-trip + 4+ schema snapshot)
3. `cargo clippy -p trustedge-types -- -D warnings` clean
4. `cargo fmt --check -p trustedge-types` clean
5. crates/types/ directory exists with correct structure
6. All 8 wire types are defined and accessible via prelude
7. Uuid and DateTime are direct re-exports (not newtypes)
8. Schema output matches shared-libs baseline exactly
</verification>

<success_criteria>
- trustedge-types crate compiles and passes all tests
- All 8 wire types from te_shared migrated with identical serde behavior
- Schema generation produces exact-match JSON for all 4 types
- Uuid and DateTime re-exported from uuid/chrono crates
- Crate is Tier 1 (Stable) in workspace members
</success_criteria>

<output>
After completion, create `.planning/phases/24-type-centralization/24-01-SUMMARY.md`
</output>
