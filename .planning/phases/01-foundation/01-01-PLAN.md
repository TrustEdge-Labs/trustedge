---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - scripts/ci-check.sh
autonomous: true

must_haves:
  truths:
    - "cargo-semver-checks, cargo-hack, cargo-machete, cargo-modules, and cargo-workspace-analyzer are installed and executable"
    - "CI workflow runs cargo-semver-checks and cargo-hack on every push/PR"
    - "scripts/ci-check.sh includes the new tool checks matching the CI workflow"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI workflow with cargo-semver-checks and cargo-hack steps"
      contains: "cargo-semver-checks"
    - path: "scripts/ci-check.sh"
      provides: "Local CI mirror script with new tool checks"
      contains: "cargo-semver-checks"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "scripts/ci-check.sh"
      via: "Same check sequence mirrored"
      pattern: "cargo.semver.checks|cargo.hack"
---

<objective>
Install Rust analysis tools and integrate them into CI.

Purpose: Ensure regression detection from Phase 1 forward by adding cargo-semver-checks (API compatibility) and cargo-hack (feature combination testing) to both GitHub Actions CI and the local ci-check.sh mirror script.
Output: Updated CI workflow, updated local CI script, 5 cargo tools available.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.github/workflows/ci.yml
@scripts/ci-check.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Rust analysis tooling</name>
  <files>
    (no files modified -- tool installation only)
  </files>
  <action>
Install the 5 required cargo tools:

```bash
cargo install cargo-semver-checks --locked
cargo install cargo-hack --locked
cargo install cargo-machete
cargo install cargo-modules
cargo install cargo-workspace-analyzer
```

After installation, verify each tool is accessible:

```bash
cargo semver-checks --version
cargo hack --version
cargo machete --version
cargo modules --version
cargo-workspace-analyzer --version
```

Also verify graphviz is available for rendering (install via system package manager if not present -- `sudo apt-get install -y graphviz` on Linux or `brew install graphviz` on macOS). graphviz is optional but useful for SVG rendering of module graphs.

NOTE: Do NOT install mermaid-cli (npm) -- it's heavy and Mermaid diagrams are readable as text.
  </action>
  <verify>
Run `cargo semver-checks --version && cargo hack --version && cargo machete --version && cargo modules --version && cargo-workspace-analyzer --version` -- all 5 commands return version info without error.
  </verify>
  <done>All 5 tools installed and version-verified.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate cargo-semver-checks and cargo-hack into CI</name>
  <files>
    .github/workflows/ci.yml
    scripts/ci-check.sh
  </files>
  <action>
**Update `.github/workflows/ci.yml`:**

Add a new job step (or add steps to the existing `rust` job) that:

1. Installs cargo-semver-checks and cargo-hack in CI:
   ```yaml
   - name: Install analysis tools
     run: |
       cargo install cargo-semver-checks --locked
       cargo install cargo-hack --locked
   ```

2. Adds a cargo-hack feature check step AFTER the existing clippy steps but BEFORE the test steps:
   ```yaml
   - name: Feature compatibility check (cargo-hack)
     run: cargo hack check --feature-powerset --no-dev-deps --package trustedge-core
   ```
   This verifies all feature flag combinations compile. Only check trustedge-core since it's the only crate with meaningful feature flags (audio, yubikey).

3. Adds a cargo-semver-checks step AFTER tests pass. Since trustedge-core is NOT published to crates.io, use `--baseline-rev` against HEAD~1 or main branch:
   ```yaml
   - name: API compatibility check (cargo-semver-checks)
     run: cargo semver-checks --package trustedge-core --baseline-rev HEAD~1
   ```
   NOTE: On the initial commit this may warn about no baseline -- that's expected. The step should use `continue-on-error: true` initially until a proper baseline exists from Phase 1 completion.

Keep the tool install step cached with Swatinem/rust-cache so it's not re-downloaded every run. The tools go into `~/.cargo/bin/` which is covered by the existing cargo cache.

**Update `scripts/ci-check.sh`:**

Add matching steps to mirror the CI workflow. Insert after the existing clippy steps:

1. A cargo-hack feature check step:
   ```bash
   echo "Step N: Feature compatibility check (cargo-hack)..."
   cargo hack check --feature-powerset --no-dev-deps --package trustedge-core
   echo "Feature check passed"
   ```

2. A cargo-semver-checks step (conditional -- only runs if the tool is installed):
   ```bash
   echo "Step N: API compatibility check (cargo-semver-checks)..."
   if command -v cargo-semver-checks &> /dev/null; then
       cargo semver-checks --package trustedge-core --baseline-rev HEAD~1 || echo "Semver check: no baseline yet (expected for first run)"
   else
       echo "cargo-semver-checks not installed, skipping"
   fi
   ```

Renumber all existing steps in ci-check.sh to accommodate the new ones. Preserve the script header comment about matching ci.yml. Update step numbers sequentially.

IMPORTANT: Do NOT add `cargo clean` if it's already there. Do NOT remove any existing steps. Only ADD new steps.
  </action>
  <verify>
1. `grep -c 'cargo-semver-checks\|cargo.hack' .github/workflows/ci.yml` returns at least 2 (both tools referenced).
2. `grep -c 'cargo-semver-checks\|cargo.hack' scripts/ci-check.sh` returns at least 2 (both tools referenced).
3. `bash scripts/ci-check.sh` completes without errors (NOTE: this is the full CI check -- it takes time; if impractical, at minimum run `cargo hack check --feature-powerset --no-dev-deps --package trustedge-core` to verify the cargo-hack step works).
  </verify>
  <done>CI workflow and local ci-check.sh both include cargo-semver-checks and cargo-hack steps. The workflow runs these checks on every push/PR to main.</done>
</task>

</tasks>

<verification>
- All 5 cargo tools installed and executable
- .github/workflows/ci.yml contains cargo-semver-checks and cargo-hack steps
- scripts/ci-check.sh mirrors the CI workflow with matching tool checks
- `cargo hack check --feature-powerset --no-dev-deps --package trustedge-core` completes successfully
</verification>

<success_criteria>
1. Running `cargo semver-checks --version && cargo hack --version` both succeed
2. CI workflow has explicit steps for feature-powerset checking and API compatibility
3. Local ci-check.sh script has matching steps for the same tools
4. cargo-hack feature powerset check passes for trustedge-core
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
