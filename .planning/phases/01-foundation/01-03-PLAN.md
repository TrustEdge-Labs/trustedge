<!--
Copyright (c) 2025 TRUSTEDGE LABS LLC
MPL-2.0: https://mozilla.org/MPL/2.0/
Project: trustedge â€” Privacy and trust at the edge.
GitHub: https://github.com/TrustEdge-Labs/trustedge
-->


---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - scripts/test-inventory.sh
  - .planning/phases/01-foundation/TEST-BASELINE.md
  - .planning/phases/01-foundation/WORKSPACE-DEPS.mmd
  - .planning/phases/01-foundation/WORKSPACE-TREE.txt
  - .planning/phases/01-foundation/MACHETE-REPORT.md
autonomous: true

must_haves:
  truths:
    - "scripts/test-inventory.sh is executable and produces per-crate + per-module test counts with full test names"
    - "TEST-BASELINE.md documents every test in the workspace by name, grouped by crate and module"
    - "Running scripts/test-inventory.sh produces output in the same format as TEST-BASELINE.md for future comparison"
    - "Dependency graph shows all 10 crates and their inter-dependencies in Mermaid format"
    - "WORKSPACE-TREE.txt shows cargo tree output for quick reference"
  artifacts:
    - path: "scripts/test-inventory.sh"
      provides: "Reusable test inventory script for baseline comparison"
      contains: "cargo test"
    - path: ".planning/phases/01-foundation/TEST-BASELINE.md"
      provides: "Full test name inventory per crate and module"
      contains: "trustedge-core"
    - path: ".planning/phases/01-foundation/WORKSPACE-DEPS.mmd"
      provides: "Mermaid dependency graph of workspace crates"
      contains: "graph"
    - path: ".planning/phases/01-foundation/WORKSPACE-TREE.txt"
      provides: "Text-based dependency tree"
      contains: "trustedge-core"
  key_links:
    - from: "scripts/test-inventory.sh"
      to: ".planning/phases/01-foundation/TEST-BASELINE.md"
      via: "Script generates baseline in same format"
      pattern: "test-inventory"
---

<objective>
Generate the test inventory baseline and workspace dependency graph.

Purpose: Create the reusable test-inventory.sh script and baseline snapshot so test regressions are detectable during consolidation. Generate the workspace dependency graph showing all cross-crate dependencies to inform merge ordering in later phases.
Output: test-inventory.sh script, TEST-BASELINE.md, WORKSPACE-DEPS.mmd, WORKSPACE-TREE.txt, MACHETE-REPORT.md
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test inventory script and generate baseline</name>
  <files>
    scripts/test-inventory.sh
    .planning/phases/01-foundation/TEST-BASELINE.md
  </files>
  <action>
Create `scripts/test-inventory.sh` that produces a comprehensive test inventory.

**Per user decision, the script MUST:**
- Report per-crate AND per-module granularity (e.g., "core::backends: 15, core::envelope: 12")
- Include full test names per crate/module, not just counts
- Output in a consistent format so future runs can diff against the baseline
- Be re-runnable after each phase to compare against the baseline

**Script requirements:**

1. Accept an optional output file argument (default: stdout for re-runs, but initial baseline goes to TEST-BASELINE.md)
2. For each crate in the workspace:
   - List unit tests via `cargo test --package $PKG --lib -- --list 2>/dev/null`
   - List integration tests by discovering test files in `crates/$CRATE/tests/*.rs` and running `cargo test --package $PKG --test $TEST_NAME -- --list 2>/dev/null`
   - Group unit tests by module path (extract module from test name, e.g., `backends::software_hsm::tests::test_foo` belongs to module `backends::software_hsm`)
3. Handle the package naming convention:
   - Directory `core` -> package `trustedge-core`
   - Directory `trustedge-cli` -> package `trustedge-cli`
   - Directory `trst-core` -> package `trustedge-trst-core`
   - Directory `trst-cli` -> package `trustedge-trst-cli`
   - Directory `trst-wasm` -> package `trustedge-trst-wasm`
   - Others: `trustedge-$DIR`
   - Use `cargo metadata --format-version 1` to get actual package names rather than guessing
4. Output format (Markdown):
   ```
   # Test Inventory Baseline

   **Generated:** YYYY-MM-DD
   **Total tests:** NNN

   ## Package: trustedge-core (N tests)

   ### Unit Tests (lib)

   #### Module: backends::software_hsm (N tests)
   ```
   - test_name_1: test
   - test_name_2: test
   ```

   #### Module: envelope (N tests)
   ```
   - test_name_1: test
   ```

   ### Integration Tests: auth_integration (N tests)
   ```
   - test_name_1: test
   ```
   ```
5. Print summary at the end: total tests per crate and grand total
6. Make the script executable: `chmod +x scripts/test-inventory.sh`

**Per research pitfall #3:** Don't forget integration tests -- `--lib` only gets unit tests. Iterate over test files in tests/ directories.

**Per research pitfall #1:** Always use `--package` flag, never aggregate with `--workspace` for per-crate counting.

After creating the script, run it to generate the initial baseline:
```bash
./scripts/test-inventory.sh > .planning/phases/01-foundation/TEST-BASELINE.md
```

Or if the script takes an output argument:
```bash
./scripts/test-inventory.sh .planning/phases/01-foundation/TEST-BASELINE.md
```

Review the output to ensure all 10 crates are covered and the total matches or exceeds 150 tests (research says 202).
  </action>
  <verify>
1. `test -x scripts/test-inventory.sh` -- script is executable.
2. `wc -l .planning/phases/01-foundation/TEST-BASELINE.md` -- file exists and has substantial content.
3. `grep -c "## Package:" .planning/phases/01-foundation/TEST-BASELINE.md` -- at least 5 packages documented (some may have zero tests).
4. `grep "Total tests:" .planning/phases/01-foundation/TEST-BASELINE.md` -- total count is present and >= 150.
5. `grep "test_" .planning/phases/01-foundation/TEST-BASELINE.md | head -5` -- full test names are present.
  </verify>
  <done>scripts/test-inventory.sh exists, is executable, and generates per-crate + per-module test listings with full test names. TEST-BASELINE.md captures the initial snapshot with 150+ tests accounted for.</done>
</task>

<task type="auto">
  <name>Task 2: Generate workspace dependency graph and cargo-machete report</name>
  <files>
    .planning/phases/01-foundation/WORKSPACE-DEPS.mmd
    .planning/phases/01-foundation/WORKSPACE-TREE.txt
    .planning/phases/01-foundation/MACHETE-REPORT.md
  </files>
  <action>
Generate three analysis artifacts:

**1. Mermaid dependency graph (WORKSPACE-DEPS.mmd):**

Run cargo-workspace-analyzer to generate a Mermaid diagram:
```bash
cargo-workspace-analyzer --working-dir . -o mmd > .planning/phases/01-foundation/WORKSPACE-DEPS.mmd
```

If cargo-workspace-analyzer output needs adjustment (e.g., missing crates, wrong format), manually create/fix the Mermaid file. The diagram should show:
- All 10 workspace crates as nodes
- Directed edges for dependencies (A --> B means A depends on B)
- External dependency edges are optional (focus on intra-workspace deps)

Review the output to identify:
- Which crates depend on trustedge-core (should be most of them)
- Any circular dependencies (should be none)
- The dependency ordering for merge phases (leaf crates first)

**2. Text dependency tree (WORKSPACE-TREE.txt):**

```bash
cargo tree --workspace --depth 1 > .planning/phases/01-foundation/WORKSPACE-TREE.txt
```

This provides a quick-reference text view. Depth 1 shows direct dependencies only, keeping the output manageable.

**3. cargo-machete unused dependency report (MACHETE-REPORT.md):**

Run cargo-machete across the workspace:
```bash
cargo machete 2>&1 | tee /tmp/machete-raw.txt
```

Create a Markdown report at `.planning/phases/01-foundation/MACHETE-REPORT.md` with:
- Header with generation date
- Raw output from cargo-machete
- Note about false positives (renamed imports)
- Decision: defer removals to Phase 8 per research recommendation (unless a dependency clearly causes issues)

If cargo-machete reports false positives from renamed dependencies, document them but do NOT fix in Phase 1.
  </action>
  <verify>
1. `test -f .planning/phases/01-foundation/WORKSPACE-DEPS.mmd` -- Mermaid file exists.
2. `grep -c "trustedge" .planning/phases/01-foundation/WORKSPACE-DEPS.mmd` -- contains workspace crate names.
3. `test -f .planning/phases/01-foundation/WORKSPACE-TREE.txt` -- text tree exists.
4. `test -f .planning/phases/01-foundation/MACHETE-REPORT.md` -- machete report exists.
  </verify>
  <done>Workspace dependency graph exists in Mermaid format showing all 10 crates and their inter-dependencies. Text tree available for quick reference. cargo-machete report generated with findings documented.</done>
</task>

</tasks>

<verification>
- scripts/test-inventory.sh is executable and produces consistent output format
- TEST-BASELINE.md documents every test by full name, grouped by crate and module
- Re-running scripts/test-inventory.sh produces output diffable against TEST-BASELINE.md
- WORKSPACE-DEPS.mmd contains a valid Mermaid graph with all workspace crates
- WORKSPACE-TREE.txt shows workspace dependency tree
- MACHETE-REPORT.md documents unused dependency findings
</verification>

<success_criteria>
1. TEST-BASELINE.md captures 150+ tests with full names and per-module grouping
2. scripts/test-inventory.sh is reusable for future phase comparisons
3. Dependency graph shows all 10 workspace crates and their relationships
4. cargo-machete findings are documented (action deferred to later phase)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
