<!--
Copyright (c) 2025 TRUSTEDGE LABS LLC
MPL-2.0: https://mozilla.org/MPL/2.0/
Project: trustedge â€” Privacy and trust at the edge.
GitHub: https://github.com/TrustEdge-Labs/trustedge
-->


---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/core/src/primitives/mod.rs
  - crates/core/src/protocols/mod.rs
  - crates/core/src/applications/mod.rs
  - crates/core/src/io/mod.rs
  - crates/core/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "4 new directories exist in crates/core/src/ (primitives, protocols, applications, io)"
    - "Each new directory has a mod.rs with layer contract documentation"
    - "Existing flat modules (crypto.rs, envelope.rs, etc.) are unchanged"
    - "lib.rs declares the 4 new modules"
    - "cargo build --workspace compiles without error"
  artifacts:
    - path: "crates/core/src/primitives/mod.rs"
      provides: "Layer 1 contract: pure crypto primitives"
      contains: "NEVER imports"
    - path: "crates/core/src/protocols/mod.rs"
      provides: "Layer 3 contract: wire formats, envelopes, chains"
      contains: "NEVER imports"
    - path: "crates/core/src/applications/mod.rs"
      provides: "Layer 4 contract: high-level APIs (receipts, attestation)"
      contains: "NEVER imports"
    - path: "crates/core/src/io/mod.rs"
      provides: "Layer 6 contract: I/O adapters (audio, archive)"
      contains: "NEVER imports"
    - path: "crates/core/src/lib.rs"
      provides: "Root module with 4 new module declarations"
      contains: "pub mod primitives"
  key_links:
    - from: "crates/core/src/lib.rs"
      to: "crates/core/src/primitives/mod.rs"
      via: "pub mod primitives"
      pattern: "pub mod primitives"
    - from: "crates/core/src/lib.rs"
      to: "crates/core/src/protocols/mod.rs"
      via: "pub mod protocols"
      pattern: "pub mod protocols"
    - from: "crates/core/src/lib.rs"
      to: "crates/core/src/applications/mod.rs"
      via: "pub mod applications"
      pattern: "pub mod applications"
    - from: "crates/core/src/lib.rs"
      to: "crates/core/src/io/mod.rs"
      via: "pub mod io"
      pattern: "pub mod io"
---

<objective>
Create the layered module hierarchy scaffolding in trustedge-core.

Purpose: Establish the 6-layer directory structure (primitives/backends/protocols/applications/transport/io) that will receive code during later consolidation phases. Phase 1 creates directories and documented contracts only -- no code moves, no re-exports.
Output: 4 new directories with mod.rs files, updated lib.rs.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@crates/core/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create layer directories with contract documentation</name>
  <files>
    crates/core/src/primitives/mod.rs
    crates/core/src/protocols/mod.rs
    crates/core/src/applications/mod.rs
    crates/core/src/io/mod.rs
  </files>
  <action>
Create 4 new directories under `crates/core/src/` with a `mod.rs` in each. The 2 existing directories (backends/, transport/) already have the correct layer position and are NOT modified.

**Per user decision:** Flat layout -- directories sit alongside existing backends/ and transport/. NO src/layers/ parent directory.

Each mod.rs MUST include:
1. MPL-2.0 copyright header (standard project header)
2. Module-level doc comment (`//!`) with:
   - Layer name and number
   - Layer contract: what belongs in this layer
   - Dependency rules: what it CAN import (allowed layers) and what it NEVER imports (forbidden layers)
   - Post-consolidation contents: list of existing flat modules that will move here (current location -> future location)
   - Brief usage example showing the layer's purpose
   - Status note: "Phase 1 scaffolding - no code yet"
3. No actual code or re-exports -- just the comment block

**Layer definitions:**

**primitives/ (Layer 1):**
- Contract: Pure cryptographic primitives with no external dependencies beyond standard crypto libraries. Zero business logic, zero I/O.
- CAN import: Standard library, crypto crates (aes-gcm, ed25519-dalek, blake3, chacha20poly1305, p256, x25519-dalek, pbkdf2, hkdf)
- NEVER imports: backends, protocols, applications, transport, io
- Post-consolidation:
  - `crypto.rs` -> `primitives/crypto.rs` (AES-256-GCM, XChaCha20-Poly1305 encrypt/decrypt, sign/verify)
  - `asymmetric.rs` -> `primitives/asymmetric.rs` (Ed25519, P256, RSA key operations)
  - `chain.rs` primitives -> `primitives/chain.rs` (BLAKE3 hashing, genesis seed)
  - `hybrid.rs` crypto ops -> `primitives/hybrid.rs` (X25519 ECDH, RSA hybrid)
- Example: `use trustedge_core::primitives::{encrypt_segment, sign_manifest};`

**protocols/ (Layer 3):**
- Contract: Wire formats, envelope construction, chain validation, manifest serialization. Depends on primitives for crypto ops and backends for key management.
- CAN import: primitives, backends
- NEVER imports: applications, transport, io
- Post-consolidation:
  - `envelope.rs` -> `protocols/envelope.rs` (Envelope seal/unseal, metadata)
  - `envelope_v2_bridge.rs` -> `protocols/envelope_v2_bridge.rs` (format detection)
  - `chain.rs` validation -> `protocols/chain.rs` (chain validation, continuity verification)
  - `manifest.rs` -> `protocols/manifest.rs` (CamVideoManifest, canonical JSON)
  - `format.rs` -> `protocols/format.rs` (SignedManifest, format version, algorithm enums)
  - `vectors.rs` -> `protocols/vectors.rs` (test vectors)
- Example: `use trustedge_core::protocols::{Envelope, ChainSegment, CamVideoManifest};`

**applications/ (Layer 4):**
- Contract: High-level business logic APIs built on primitives, backends, and protocols. Self-contained domain features that compose lower layers.
- CAN import: primitives, backends, protocols
- NEVER imports: transport, io
- Post-consolidation:
  - `crates/receipts/` -> `applications/receipts/` (digital receipt system, 1,281 LOC, 23 tests)
  - `crates/attestation/` -> `applications/attestation/` (software attestation, provenance tracking)
  - `crates/trst-core/` manifest types -> `applications/archives/` (cam.video manifest types, WASM-compatible)
  - `auth.rs` -> `applications/auth.rs` (Ed25519 mutual authentication, session management)
- Example: `use trustedge_core::applications::{Receipt, Attestation, ArchiveManifest};`

**io/ (Layer 6):**
- Contract: Input/output adapters connecting the core library to external systems (filesystem, audio hardware, archive formats). Highest layer -- can import everything below.
- CAN import: primitives, backends, protocols, applications, transport
- NEVER imports: nothing forbidden (top layer)
- Post-consolidation:
  - `audio.rs` -> `io/audio.rs` (live audio capture, cpal integration, feature-gated)
  - `archive.rs` -> `io/archive.rs` (archive read/write, .trst format I/O)
- Example: `use trustedge_core::io::{AudioCapture, read_archive, write_archive};`
  </action>
  <verify>
1. `ls crates/core/src/primitives/mod.rs crates/core/src/protocols/mod.rs crates/core/src/applications/mod.rs crates/core/src/io/mod.rs` -- all 4 files exist.
2. `grep -l "NEVER imports" crates/core/src/primitives/mod.rs crates/core/src/protocols/mod.rs crates/core/src/applications/mod.rs crates/core/src/io/mod.rs` -- all 4 files contain layer contract documentation.
3. `grep -l "Post-consolidation" crates/core/src/primitives/mod.rs crates/core/src/protocols/mod.rs crates/core/src/applications/mod.rs crates/core/src/io/mod.rs` -- all 4 files document future contents.
  </verify>
  <done>4 new directories created with fully documented mod.rs files containing layer contracts, dependency rules, and post-consolidation migration plans.</done>
</task>

<task type="auto">
  <name>Task 2: Declare new modules in lib.rs</name>
  <files>
    crates/core/src/lib.rs
  </files>
  <action>
Add 4 new `pub mod` declarations to `crates/core/src/lib.rs` for the new layer directories.

Insert them alongside the existing module declarations. Group them logically -- place them AFTER the existing module declarations, with a comment separating the layer scaffolding:

```rust
// Layer hierarchy (Phase 1 scaffolding -- populated in later phases)
pub mod primitives;
pub mod protocols;
pub mod applications;
pub mod io;
```

NOTE: The module name `io` may conflict with `std::io`. This is fine because:
- Rust allows modules named `io` -- they're accessed as `crate::io` or `trustedge_core::io`
- If there's a compile conflict, rename to `io_adapters` instead (Claude's discretion)

Do NOT modify any existing module declarations, re-exports, types, or functions in lib.rs. Only ADD the 4 new module declarations.

Verify the build compiles:
```bash
cargo build --package trustedge-core
cargo test --package trustedge-core --lib
```

If `pub mod io` causes a naming conflict, rename to `pub mod io_adapters` and update the io/mod.rs directory name to `io_adapters/mod.rs` accordingly. Document this in the summary.
  </action>
  <verify>
1. `grep "pub mod primitives" crates/core/src/lib.rs` -- declaration exists.
2. `grep "pub mod protocols" crates/core/src/lib.rs` -- declaration exists.
3. `grep "pub mod applications" crates/core/src/lib.rs` -- declaration exists.
4. `grep "pub mod io" crates/core/src/lib.rs` (or `pub mod io_adapters`) -- declaration exists.
5. `cargo build --package trustedge-core` -- compiles without errors.
6. `cargo test --package trustedge-core --lib` -- all existing tests still pass.
  </verify>
  <done>lib.rs declares all 4 new layer modules. Full workspace builds and all existing tests pass unchanged.</done>
</task>

</tasks>

<verification>
- `ls crates/core/src/{primitives,protocols,applications,io}/mod.rs` confirms all 4 directories and mod.rs files exist
- Each mod.rs contains layer contract documentation with dependency rules
- `cargo build --workspace` compiles without errors
- `cargo test --workspace` passes (all 150+ tests unchanged)
- No existing files were modified except lib.rs (4 new lines added)
</verification>

<success_criteria>
1. 4 new directories exist under crates/core/src/ (primitives, protocols, applications, io)
2. Each mod.rs has layer contract doc with: what belongs, CAN import, NEVER imports, post-consolidation contents
3. lib.rs declares all 4 new modules
4. `cargo build --workspace && cargo test --workspace` passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
