<!--
Copyright (c) 2025 TRUSTEDGE LABS LLC
MPL-2.0: https://mozilla.org/MPL/2.0/
Project: trustedge â€” Privacy and trust at the edge.
GitHub: https://github.com/TrustEdge-Labs/trustedge
-->


---
phase: 01-foundation
plan: 04
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .planning/phases/01-foundation/AUDIT.md
  - .planning/phases/01-foundation/trustedge-core-api-baseline.json
  - .planning/phases/01-foundation/trustedge-receipts-api-baseline.json
  - .planning/phases/01-foundation/trustedge-attestation-api-baseline.json
  - .planning/phases/01-foundation/trustedge-trst-core-api-baseline.json
autonomous: true

must_haves:
  truths:
    - "AUDIT.md documents both exact and near-duplicate functions/types across crate boundaries"
    - "AUDIT.md includes cross-crate dependency usage table (who imports what from whom)"
    - "AUDIT.md includes best-implementation recommendation for each duplicate"
    - "API surface baseline exists as rustdoc JSON for each public crate"
    - "Future cargo-semver-checks can run against these baselines to detect API breakage"
  artifacts:
    - path: ".planning/phases/01-foundation/AUDIT.md"
      provides: "Complete duplication and dependency audit"
      contains: "Recommendation"
    - path: ".planning/phases/01-foundation/trustedge-core-api-baseline.json"
      provides: "API surface baseline for trustedge-core"
      min_lines: 10
    - path: ".planning/phases/01-foundation/trustedge-receipts-api-baseline.json"
      provides: "API surface baseline for trustedge-receipts"
      min_lines: 10
    - path: ".planning/phases/01-foundation/trustedge-attestation-api-baseline.json"
      provides: "API surface baseline for trustedge-attestation"
      min_lines: 10
    - path: ".planning/phases/01-foundation/trustedge-trst-core-api-baseline.json"
      provides: "API surface baseline for trustedge-trst-core"
      min_lines: 10
  key_links:
    - from: ".planning/phases/01-foundation/AUDIT.md"
      to: ".planning/ROADMAP.md"
      via: "Audit findings inform merge order in Phases 3-5"
      pattern: "merge order|consolidation"
    - from: ".planning/phases/01-foundation/trustedge-core-api-baseline.json"
      to: ".github/workflows/ci.yml"
      via: "CI cargo-semver-checks validates against this baseline"
      pattern: "baseline"
---

<objective>
Conduct the code duplication audit and capture API surface baselines.

Purpose: Map all duplicated code across crate boundaries (exact and near-duplicates) with best-implementation recommendations to guide merge decisions in later phases. Capture rustdoc JSON baselines for each public crate so cargo-semver-checks can detect API breakage during consolidation.
Output: AUDIT.md with duplication findings and cross-crate dependency map. API baseline JSON files for 4 public crates.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/codebase/ARCHITECTURE.md
@crates/core/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Conduct duplication audit</name>
  <files>
    .planning/phases/01-foundation/AUDIT.md
  </files>
  <action>
Produce `.planning/phases/01-foundation/AUDIT.md` with three sections:

**Per user decision:** Map both exact duplicates AND near-duplicates. Table summary format with module paths, crates affected, duplicate type, and best-implementation recommendation. Also map cross-crate dependency usage.

**Section 1: Duplicate Functions**

Search across all crates for functions with identical or similar names/signatures:

```bash
# Find public function definitions across crates
grep -rn "pub fn \|pub async fn " crates/*/src --include="*.rs" | sort
```

Focus on known duplication-prone areas from the architecture:
- Encryption/decryption functions (encrypt_segment, decrypt_segment in core vs any equivalents in receipts/attestation)
- Signing/verification (sign_manifest, verify_manifest)
- Serialization helpers (canonical JSON, manifest serialization)
- Key handling (DeviceKeypair creation, key derivation)
- Error construction patterns

For each finding, record a table row:
```
| Function/Type | Location 1 | Location 2 | Type | Recommendation |
|---------------|-----------|-----------|------|----------------|
| `encrypt_segment` | core::crypto | (check others) | exact/near | Keep core version |
```

Classify each as:
- **exact**: Identical implementation (copy-paste)
- **near**: Same purpose, different implementation (parameter differences, error handling variations, different algorithms)
- **pattern**: Same pattern but different domain (e.g., both create envelopes but for different data types)

**Section 2: Duplicate Types**

Search for struct/enum/trait definitions that overlap:

```bash
# Find type definitions across crates
grep -rn "pub struct \|pub enum \|pub trait " crates/*/src --include="*.rs" | sort
```

Focus on:
- Error types (CryptoError, ManifestError, ArchiveError, TrustEdgeError -- known duplication area per ARCHITECTURE.md)
- Manifest types (CamVideoManifest in core vs trst-core -- known duplicate per ROADMAP)
- Envelope types
- Key types (DeviceKeypair, KeyPair, PublicKey, PrivateKey)

**Section 3: Cross-Crate Dependency Usage**

Map who imports what from whom:
```bash
# Find cross-crate imports
grep -rn "use trustedge_core::" crates/*/src --include="*.rs" | grep -v "crates/core/"
grep -rn "use trustedge_receipts::" crates/*/src --include="*.rs"
grep -rn "use trustedge_attestation::" crates/*/src --include="*.rs"
grep -rn "use trustedge_trst_core::" crates/*/src --include="*.rs"
```

Also check Cargo.toml dependency declarations:
```bash
grep -A2 "trustedge-core\|trustedge-receipts\|trustedge-attestation\|trustedge-trst-core" crates/*/Cargo.toml
```

Create a dependency usage table:
```
| Consumer Crate | Imports From | Specific Items Used |
|----------------|-------------|---------------------|
| trustedge-cli | trustedge-core | Envelope, encrypt_segment, DeviceKeypair |
| trustedge-receipts | trustedge-core | envelope, crypto, DeviceKeypair |
```

This informs merge order: crates with no consumers can be merged first; crates with many consumers need careful API preservation.

**Section 4: Merge Order Recommendation**

Based on the findings, recommend a merge order that aligns with (and validates) the ROADMAP phases:
- Phase 3: trst-core (WASM-safe types, no consumers outside trst-cli/trst-wasm)
- Phase 4: receipts (depends on core envelope)
- Phase 5: attestation (depends on core envelope)

Note any findings that suggest the ROADMAP order should change.

The AUDIT.md should be thorough but focused. Include actual code snippets for near-duplicates to make the difference clear. Each finding should have a concrete recommendation (keep A, keep B, merge both, or design new).
  </action>
  <verify>
1. `test -f .planning/phases/01-foundation/AUDIT.md` -- file exists.
2. `grep -c "|" .planning/phases/01-foundation/AUDIT.md` -- contains table rows (at least 10 pipe-separated table entries).
3. `grep -c "Recommendation" .planning/phases/01-foundation/AUDIT.md` -- has recommendation column/section.
4. `grep "Cross-Crate" .planning/phases/01-foundation/AUDIT.md` -- has dependency usage section.
5. `grep "Merge Order" .planning/phases/01-foundation/AUDIT.md` -- has merge order recommendation.
  </verify>
  <done>AUDIT.md documents all duplicate functions, types, and cross-crate dependency usage with per-finding best-implementation recommendations and merge order validation.</done>
</task>

<task type="auto">
  <name>Task 2: Generate API surface baselines</name>
  <files>
    .planning/phases/01-foundation/trustedge-core-api-baseline.json
    .planning/phases/01-foundation/trustedge-receipts-api-baseline.json
    .planning/phases/01-foundation/trustedge-attestation-api-baseline.json
    .planning/phases/01-foundation/trustedge-trst-core-api-baseline.json
  </files>
  <action>
Generate rustdoc JSON baselines for the 4 public crates that will be affected by consolidation. These baselines enable `cargo semver-checks --baseline-rustdoc` to detect API breakage in later phases.

**Per user decision:** Save API surface snapshot as a baseline artifact in the phase directory (not just pass/fail gate).

**Per research pitfall #2:** Since these crates are NOT published to crates.io, use rustdoc JSON output, not crates.io baseline.

For each crate (trustedge-core, trustedge-receipts, trustedge-attestation, trustedge-trst-core):

```bash
# Generate rustdoc JSON (requires nightly toolchain for JSON output)
rustup run nightly cargo rustdoc --package trustedge-core -- -Z unstable-options --output-format json
cp target/doc/trustedge_core.json .planning/phases/01-foundation/trustedge-core-api-baseline.json
```

Repeat for each crate, adjusting package name and output filename:
- `trustedge-receipts` -> `trustedge_receipts.json` -> `trustedge-receipts-api-baseline.json`
- `trustedge-attestation` -> `trustedge_attestation.json` -> `trustedge-attestation-api-baseline.json`
- `trustedge-trst-core` -> `trustedge_trst_core.json` -> `trustedge-trst-core-api-baseline.json`

**If nightly is not installed:**
```bash
rustup install nightly
```

**If rustdoc JSON generation fails** (some crates may not support it due to dependencies):
- Try with `--no-deps` flag
- If still fails, use `cargo semver-checks --package $CRATE --baseline-rev HEAD` as fallback to verify the tool works, and document the limitation
- As a last resort, generate a text-based API snapshot using `cargo doc --package $CRATE` and capture the public items list

**Per research (Open Question #3):** Exclude pubky crates from API baseline -- they're community contributions, not published libraries. Only track the 4 crates listed above.

After generation, verify each baseline file is valid JSON and non-trivial:
```bash
python3 -c "import json; json.load(open('$FILE'))" 2>/dev/null && echo "Valid JSON"
wc -c $FILE  # Should be substantial (>10KB for core)
```
  </action>
  <verify>
1. `ls .planning/phases/01-foundation/*-api-baseline.json | wc -l` -- 4 baseline files exist.
2. Each file is valid JSON (or document fallback approach if rustdoc JSON was unavailable).
3. `wc -c .planning/phases/01-foundation/trustedge-core-api-baseline.json` -- core baseline is substantial (>10KB).
4. `cargo semver-checks --package trustedge-core --baseline-rustdoc .planning/phases/01-foundation/trustedge-core-api-baseline.json` runs without error (may report no changes, which is correct).
  </verify>
  <done>API surface baselines captured as rustdoc JSON for all 4 public crates. Future phases can validate API compatibility by running cargo-semver-checks against these baselines.</done>
</task>

</tasks>

<verification>
- AUDIT.md contains function duplicates, type duplicates, cross-crate dependency map, and merge order recommendation
- All findings have concrete best-implementation recommendations
- API baseline JSON files exist for trustedge-core, trustedge-receipts, trustedge-attestation, trustedge-trst-core
- cargo-semver-checks can validate against the baseline files
</verification>

<success_criteria>
1. AUDIT.md maps all cross-crate duplication (functions + types) with recommendations
2. Cross-crate dependency usage table shows who imports what from whom
3. Merge order recommendation validates or amends the ROADMAP phase sequence
4. 4 API baseline JSON files captured for semver validation in future phases
5. `cargo semver-checks --baseline-rustdoc` works against at least trustedge-core baseline
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
