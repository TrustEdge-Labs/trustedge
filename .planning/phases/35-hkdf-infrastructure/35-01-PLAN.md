---
phase: 35-hkdf-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/core/Cargo.toml
  - crates/core/src/envelope.rs
autonomous: true
requirements:
  - ENV-04
  - ENV-05
  - ENV-06

must_haves:
  truths:
    - "hkdf crate is a workspace dependency with a pinned version"
    - "trustedge-core depends on hkdf via workspace reference"
    - "derive_shared_encryption_key uses HKDF-SHA256 instead of PBKDF2"
    - "ECDH shared secret is passed as IKM to HKDF-Extract, not concatenated with other data"
    - "HKDF info parameter contains TRUSTEDGE domain separation string"
    - "No ad-hoc CatKDF construction remains in envelope.rs"
    - "All existing envelope tests pass with the new KDF"
  artifacts:
    - path: "Cargo.toml"
      provides: "hkdf workspace dependency"
      contains: "hkdf"
    - path: "crates/core/Cargo.toml"
      provides: "hkdf dependency reference"
      contains: "hkdf"
    - path: "crates/core/src/envelope.rs"
      provides: "HKDF-based key derivation replacing PBKDF2 CatKDF"
      contains: "Hkdf"
  key_links:
    - from: "crates/core/src/envelope.rs"
      to: "hkdf crate"
      via: "use hkdf::Hkdf and Hkdf::<Sha256>::new"
      pattern: "hkdf::Hkdf"
    - from: "crates/core/src/envelope.rs"
      to: "x25519_dalek shared_secret"
      via: "shared_secret.as_bytes() passed as IKM to HKDF-Extract"
      pattern: "Hkdf.*new.*shared_secret"
    - from: "crates/core/src/envelope.rs"
      to: "domain separation"
      via: "info parameter in HKDF-Expand"
      pattern: "TRUSTEDGE_ENVELOPE"
---

<objective>
Wire the `hkdf` crate into the workspace and replace the ad-hoc CatKDF construction in envelope.rs with proper HKDF-SHA256, using structured inputs with domain separation.

Purpose: The current `derive_shared_encryption_key()` concatenates ECDH shared secret + salt + sequence + metadata hash as a single IKM blob fed into PBKDF2. This is cryptographically incorrect -- PBKDF2 is designed for password stretching, not ECDH output. HKDF (RFC 5869) is the correct primitive for extracting and expanding key material from a Diffie-Hellman shared secret.

Output: Updated Cargo.toml files with hkdf dependency, and envelope.rs using HKDF-Extract(salt, IKM=ecdh_shared_secret) -> HKDF-Expand(PRK, info=domain_string, L=32) instead of the PBKDF2 CatKDF.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@crates/core/src/envelope.rs
@crates/core/Cargo.toml
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hkdf workspace dependency and wire into trustedge-core</name>
  <files>Cargo.toml, crates/core/Cargo.toml</files>
  <action>
1. In the root `Cargo.toml`, add `hkdf = "0.12"` to the `[workspace.dependencies]` section under the Cryptography group (after the `pbkdf2` line). Use version "0.12" to match the `sha2 = "0.10"` ecosystem (both are RustCrypto, same trait versions).

2. In `crates/core/Cargo.toml`, add `hkdf = { workspace = true }` to the `[dependencies]` section, placing it alphabetically near the other crypto deps (after `hex`).

3. Run `cargo check -p trustedge-core` to verify the dependency resolves correctly.

Do NOT remove `pbkdf2` from either Cargo.toml -- it is still used by keyring backends and will remain in the workspace. The `sha2` crate is already a dependency of trustedge-core (version 0.10), which provides the `Sha256` type needed by `Hkdf<Sha256>`.
  </action>
  <verify>Run `cargo check -p trustedge-core` -- should compile with no errors. Verify hkdf appears in Cargo.lock with `grep "name = \"hkdf\"" Cargo.lock`.</verify>
  <done>hkdf 0.12 appears in root Cargo.toml workspace.dependencies, crates/core/Cargo.toml dependencies, and Cargo.lock.</done>
</task>

<task type="auto">
  <name>Task 2: Replace PBKDF2 CatKDF with HKDF-SHA256 in derive_shared_encryption_key</name>
  <files>crates/core/src/envelope.rs</files>
  <action>
Replace the internals of `derive_shared_encryption_key()` in `crates/core/src/envelope.rs` with proper HKDF-SHA256. The specific changes:

**1. Update imports (top of file):**
- Add: `use hkdf::Hkdf;`
- Keep: `use sha2::Sha256;` (already imported for PBKDF2)
- Remove: `use pbkdf2::pbkdf2_hmac;` (no longer used in this file)

**2. Remove the PBKDF2_ITERATIONS constant** (line 24). It is no longer used in envelope.rs. Keyring backends define their own iteration counts.

**3. Rewrite `derive_shared_encryption_key()` function:**

Keep the same function signature for now (Phase 36 will restructure callers). The function currently takes `(my_private_key, their_public_key, salt, sequence, metadata_hash, iterations)`.

Replace the function body after the ECDH and zero-check (keep lines 77-88 exactly as they are) with:

```rust
// HKDF-Extract: extract pseudorandom key from ECDH shared secret
// Salt provides randomness; IKM is the raw ECDH output (NOT concatenated with other data)
let hkdf = Hkdf::<Sha256>::new(Some(salt), shared_secret.as_bytes());

// HKDF-Expand: derive output key material with domain separation
// The info parameter binds the derived key to the TrustEdge envelope context
let info = b"TRUSTEDGE_ENVELOPE_V1";
let mut derived_key = [0u8; 32];
hkdf.expand(info, &mut derived_key)
    .map_err(|_| anyhow::anyhow!("HKDF expand failed"))?;

Ok(derived_key)
```

The critical changes vs the old code:
- ECDH shared secret goes ONLY as IKM to HKDF-Extract (not concatenated with salt/sequence/metadata)
- Salt goes as the salt parameter to HKDF-Extract (not mixed into IKM)
- Domain separation via info parameter in HKDF-Expand
- No more PBKDF2 iterations (HKDF is a single-pass extract-then-expand)
- The `sequence`, `metadata_hash`, and `iterations` parameters become unused -- leave them in the signature for now (Phase 36 will clean up the calling pattern). Prefix with underscores to suppress compiler warnings: `_sequence`, `_metadata_hash`, `_iterations`.

**4. Update ChunkManifest struct:**
Keep the `pbkdf2_iterations` field in `ChunkManifest` for now (it is serialized in the manifest and removing it would break the format -- Phase 36 handles format versioning). The field will still be populated with the constant value in `create_encrypted_chunk`.

**5. Update PBKDF2_ITERATIONS usage:**
Since the constant was removed, replace the two references to `PBKDF2_ITERATIONS` in `create_encrypted_chunk` (manifest creation at ~line 255 and the call to `derive_shared_encryption_key` at ~line 279) with the literal `100_000u32`. This preserves the manifest field value for format compatibility. The value is now semantically meaningless (HKDF ignores it) but keeps the serialized format stable.

**6. Keep all existing tests unchanged.** The tests do NOT check specific derived key values -- they test seal/unseal roundtrips which will still work because both seal and unseal use the same new HKDF path. The derived keys will be different from before, but since tests generate fresh keys each run and roundtrip through both encrypt and decrypt, they will pass.

**7. Run the copyright header check**: Ensure the MPL-2.0 header is still present at the top of envelope.rs.
  </action>
  <verify>
Run `cargo test -p trustedge-core --lib -- envelope` to verify all 8 envelope tests pass. Then run the full `cargo test -p trustedge-core --lib` to check for no regressions across the entire core crate. Also run `cargo clippy -p trustedge-core -- -D warnings` to ensure no warnings from unused parameters or imports.
  </verify>
  <done>
1. `derive_shared_encryption_key()` uses `Hkdf::<Sha256>::new(Some(salt), shared_secret.as_bytes())` followed by `.expand(b"TRUSTEDGE_ENVELOPE_V1", &mut derived_key)` -- no CatKDF concatenation
2. ECDH shared secret is the sole IKM (not concatenated with salt/sequence/metadata)
3. Domain separation string "TRUSTEDGE_ENVELOPE_V1" is passed as info to HKDF-Expand
4. `pbkdf2::pbkdf2_hmac` import is removed from envelope.rs
5. All 8 envelope tests pass
6. Full `cargo test -p trustedge-core --lib` passes with no regressions
7. `cargo clippy` passes with no warnings
  </done>
</task>

</tasks>

<verification>
1. `grep -n "hkdf" Cargo.toml` shows hkdf in workspace dependencies
2. `grep -n "hkdf" crates/core/Cargo.toml` shows hkdf in core dependencies
3. `grep -n "pbkdf2_hmac\|pbkdf2::pbkdf2" crates/core/src/envelope.rs` returns NO matches (PBKDF2 gone from envelope)
4. `grep -n "Hkdf" crates/core/src/envelope.rs` returns match showing HKDF usage
5. `grep -n "TRUSTEDGE_ENVELOPE" crates/core/src/envelope.rs` returns match showing domain separation
6. `grep -n "key_material.extend" crates/core/src/envelope.rs` returns NO matches (CatKDF concatenation gone)
7. `cargo test -p trustedge-core --lib` passes all tests
8. `cargo clippy -p trustedge-core -- -D warnings` passes
</verification>

<success_criteria>
- hkdf 0.12 is a workspace dependency in root Cargo.toml
- trustedge-core depends on hkdf via workspace reference
- derive_shared_encryption_key uses HKDF-SHA256 Extract+Expand, not PBKDF2
- ECDH shared secret is IKM only (no CatKDF concatenation)
- "TRUSTEDGE_ENVELOPE_V1" domain separation in HKDF info parameter
- All envelope tests pass (8 tests)
- Full core lib tests pass (160+ tests)
- cargo clippy clean
</success_criteria>

<output>
After completion, create `.planning/phases/35-hkdf-infrastructure/35-01-SUMMARY.md`
</output>
