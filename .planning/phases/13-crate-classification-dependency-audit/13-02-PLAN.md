---
phase: 13-crate-classification-dependency-audit
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - crates/core/Cargo.toml
  - crates/trustedge-cli/Cargo.toml
  - crates/trst-cli/Cargo.toml
  - crates/trst-protocols/Cargo.toml
  - crates/trst-wasm/Cargo.toml
  - Cargo.toml
  - DEPENDENCIES.md
autonomous: true

must_haves:
  truths:
    - "Every dependency in the 5 core crates has a documented justification"
    - "No unused or redundant dependencies remain in core crates"
    - "Tokio feature flags are trimmed from 'full' to only what's actually used"
    - "reqwest in trst-cli is reviewed and removed if not needed"
    - "Duplicate crypto deps pulled directly instead of through core are consolidated"
  artifacts:
    - path: "DEPENDENCIES.md"
      provides: "Dependency audit documentation for all 5 core crates"
      contains: "trustedge-core"
    - path: "crates/trst-cli/Cargo.toml"
      provides: "trst-cli with reqwest reviewed/removed"
    - path: "crates/core/Cargo.toml"
      provides: "Core crate with trimmed tokio features"
  key_links:
    - from: "DEPENDENCIES.md"
      to: "crates/*/Cargo.toml"
      via: "audit documentation references actual dependency lists"
      pattern: "Justification"
    - from: "crates/trustedge-cli/Cargo.toml"
      to: "crates/core/Cargo.toml"
      via: "CLI deps should come through core, not duplicated"
      pattern: "trustedge-core"
---

<objective>
Audit and rationalize dependencies across all 5 core crates: document every dependency with justification, remove unused/redundant deps, consolidate duplicates, trim tokio features, and review reqwest in trst-cli.

Purpose: Reduce build time, attack surface, and maintenance burden. A solo developer needs to know exactly why each dependency exists.
Output: DEPENDENCIES.md documenting all core crate deps, cleaned-up Cargo.toml files, passing workspace build.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

**Core crates to audit:**
1. `trustedge-core` (crates/core) — heaviest dep list: ~30 deps
2. `trustedge-cli` (crates/trustedge-cli) — depends on core + CLI deps
3. `trustedge-trst-protocols` (crates/trst-protocols) — minimal (serde, serde_json, thiserror)
4. `trustedge-trst-cli` (crates/trst-cli) — has reqwest (DEPS-05 target) and tokio "full"
5. `trustedge-trst-wasm` (crates/trst-wasm) — WASM deps

**Known issues from requirements:**
- DEPS-03: trustedge-cli pulls aead, aes-gcm, blake3, ed25519-dalek directly — these may be redundant if only used via trustedge-core
- DEPS-04: tokio = { version = "1.0", features = ["full"] } in both core and trst-cli — should be trimmed
- DEPS-05: reqwest in trst-cli — archive tool shouldn't need HTTP client

**Out of scope:** Rewriting code to drop dependencies. If a dep is genuinely used, keep it and document it.

**WASM gotcha (from project memory):** cargo-machete flags getrandom as unused in WASM crates but it MUST stay. serde_bytes is also a false positive (attribute usage). Do NOT remove these.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and document all core crate dependencies</name>
  <files>
    DEPENDENCIES.md
  </files>
  <action>
    Perform a full dependency audit of all 5 core crates. For each crate, examine every dependency in its Cargo.toml, then grep the crate's source code to verify actual usage.

    **Audit process for each crate:**
    1. Read Cargo.toml to list all dependencies
    2. For each dependency, grep the crate's `src/` directory for `use {dep_name}` or `{dep_name}::` patterns
    3. Classify each dep as: USED (code imports it directly), TRANSITIVE (needed for features/re-exports but not directly imported), or UNUSED (no evidence of use)
    4. Note any dep that appears in multiple core crates (duplicate candidate)

    **Create `DEPENDENCIES.md` in the project root** with the following structure:

    ```markdown
    # Dependency Audit — Core Crates

    *Last audited: YYYY-MM-DD*
    *Milestone: v1.2 (DEPS-01)*

    ## trustedge-core

    | Dependency | Version | Justification | Status |
    |------------|---------|---------------|--------|
    | aead | 0.5 | AEAD trait for encryption backends | Used |
    | aes-gcm | 0.10.3 | AES-256-GCM envelope encryption | Used |
    | ... | ... | ... | ... |

    ## trustedge-cli

    | Dependency | Version | Justification | Status |
    |------------|---------|---------------|--------|
    | trustedge-core | path | Core library | Used |
    | ... | ... | ... | ... |

    [repeat for all 5 core crates]

    ## Findings

    ### Redundant Dependencies
    [List deps that appear in child crates but are already re-exported by trustedge-core]

    ### Unused Dependencies
    [List deps with no evidence of use]

    ### Optimization Opportunities
    [List deps where feature flags can be trimmed]
    ```

    Be thorough but don't spend excessive time on obvious deps (serde, clap, anyhow). Focus investigation time on crypto deps that might be redundant and utility deps that might be unused.

    **Important:** Run `cargo-machete` if available to cross-reference findings, but remember the known false positives: serde_bytes (attribute usage) and getrandom (WASM feature activation).
  </action>
  <verify>
    `test -f DEPENDENCIES.md` — file exists.
    `grep -c "trustedge-core" DEPENDENCIES.md` — should show the core crate section.
    `grep -c "trustedge-cli" DEPENDENCIES.md` — should show the CLI crate section.
    `grep -c "trustedge-trst-protocols" DEPENDENCIES.md` — should show the protocols crate section.
    `grep -c "trustedge-trst-cli" DEPENDENCIES.md` — should show the trst-cli crate section.
    `grep -c "trustedge-trst-wasm" DEPENDENCIES.md` — should show the trst-wasm crate section.
  </verify>
  <done>DEPENDENCIES.md exists with full audit of all 5 core crates. Every dependency has documented justification and usage status. Redundant, unused, and optimization opportunities are identified.</done>
</task>

<task type="auto">
  <name>Task 2: Remove unused deps, consolidate duplicates, trim tokio, review reqwest</name>
  <files>
    crates/core/Cargo.toml
    crates/trustedge-cli/Cargo.toml
    crates/trst-cli/Cargo.toml
    crates/trst-protocols/Cargo.toml
    crates/trst-wasm/Cargo.toml
    Cargo.toml
  </files>
  <action>
    Based on findings from Task 1's audit, make the following changes. Only remove deps that are genuinely unused — do NOT remove deps that are used even indirectly.

    **DEPS-02: Remove unused dependencies.**
    For each dep marked UNUSED in the audit, remove it from the crate's Cargo.toml. If it was the only consumer of a workspace dep, also remove from workspace Cargo.toml `[workspace.dependencies]`.

    **DEPS-03: Consolidate duplicate crypto dependencies.**
    Examine `trustedge-cli`'s direct crypto deps (aead, aes-gcm, blake3, ed25519-dalek, rand_core). For each:
    - Grep `crates/trustedge-cli/src/` to check if the crate directly uses the dep's types
    - If the CLI only uses these types through trustedge-core's re-exports, remove the direct dependency
    - If the CLI directly imports from the dep (e.g., `use ed25519_dalek::SigningKey`), keep it

    Similarly check `trst-cli` for duplicate deps already available through trustedge-core.

    **DEPS-04: Trim tokio feature flags.**
    For `crates/core/Cargo.toml`: Change `tokio = { version = "1.0", features = ["full"] }` to the minimal feature set actually used. Grep for tokio usage patterns:
    - `tokio::net` → needs "net"
    - `tokio::io` → needs "io-util"
    - `tokio::sync` → needs "sync"
    - `tokio::time` → needs "time"
    - `#[tokio::main]` or `#[tokio::test]` → needs "macros", "rt-multi-thread"
    - `tokio::fs` → needs "fs"
    - `tokio::spawn` → needs "rt"

    For `crates/trst-cli/Cargo.toml`: Same analysis — trim "full" to minimal features.

    Keep "full" in workspace `[workspace.dependencies]` since it's used by dev-dependencies and experimental crates. Only trim in the specific core crate `[dependencies]` sections by overriding the workspace version.

    **DEPS-05: Review reqwest in trst-cli.**
    Grep `crates/trst-cli/src/` for `reqwest` usage. The archive CLI tool (trst) does wrap/verify operations on local files. If reqwest is not used in any code path, remove it. If it IS used (e.g., fetching remote manifests), document the justification and keep it.

    **After all changes:**
    1. Run `cargo check --workspace` to verify nothing is broken
    2. Run `cargo test --workspace` to verify all tests pass
    3. Update DEPENDENCIES.md with any changes made (mark removed deps, note consolidations)
  </action>
  <verify>
    `cargo check --workspace` — must succeed.
    `cargo test --workspace` — must pass.
    `cargo build --workspace --release` — must succeed.
    If reqwest was removed: `grep -c "reqwest" crates/trst-cli/Cargo.toml` should return 0.
    If tokio was trimmed in core: `grep "full" crates/core/Cargo.toml` should NOT match tokio line.
  </verify>
  <done>Unused dependencies removed from core crates. Duplicate crypto deps consolidated where possible. Tokio feature flags trimmed from "full" to minimal in core crates. reqwest reviewed and removed if unused. Workspace builds and all tests pass. DEPENDENCIES.md updated with changes.</done>
</task>

</tasks>

<verification>
1. `cargo check --workspace` passes
2. `cargo test --workspace` passes (all 340+ tests)
3. `cargo build --workspace --release` succeeds
4. DEPENDENCIES.md exists with full audit of 5 core crates
5. No dep marked UNUSED in audit still exists in any core crate Cargo.toml
6. tokio features trimmed from "full" in core crate Cargo.toml files
7. reqwest in trst-cli reviewed (removed if unused, documented if kept)
8. WASM build still works: `cargo check -p trustedge-wasm --target wasm32-unknown-unknown` (if target installed)
</verification>

<success_criteria>
Requirements covered: DEPS-01, DEPS-02, DEPS-03, DEPS-04, DEPS-05
- Every dependency in core crates documented with justification (DEPS-01)
- Unused/redundant dependencies removed (DEPS-02)
- Duplicate crypto deps consolidated where CLI was pulling same libs as core (DEPS-03)
- tokio trimmed from "full" to minimal features in core crates (DEPS-04)
- reqwest in trst-cli reviewed and acted upon (DEPS-05)
- All tests pass, workspace builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-crate-classification-dependency-audit/13-02-SUMMARY.md`
</output>
