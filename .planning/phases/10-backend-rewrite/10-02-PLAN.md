---
phase: 10-backend-rewrite
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - crates/core/src/backends/yubikey.rs
  - crates/core/src/backends/universal_registry.rs
autonomous: true

must_haves:
  truths:
    - "X.509 certificate generation uses rcgen with hardware-backed signing -- zero manual ASN.1/DER encoding"
    - "Certificate signing delegates to YubiKey hardware via rcgen's custom key pair pattern"
    - "Generated certificates contain the public key extracted from the hardware slot"
    - "YubiKey backend is registered in UniversalBackendRegistry when feature is enabled"
    - "Workspace compiles and all existing tests pass with and without yubikey feature"
  artifacts:
    - path: "crates/core/src/backends/yubikey.rs"
      provides: "Certificate generation via rcgen + registry integration"
      contains: "rcgen"
    - path: "crates/core/src/backends/universal_registry.rs"
      provides: "YubiKey backend auto-registration"
      contains: "YubiKeyBackend"
  key_links:
    - from: "crates/core/src/backends/yubikey.rs"
      to: "rcgen"
      via: "CustomKeyPair/SigningKey delegates signing to YubiKey hardware"
      pattern: "rcgen::"
    - from: "crates/core/src/backends/universal_registry.rs"
      to: "crates/core/src/backends/yubikey.rs"
      via: "register YubiKeyBackend in with_defaults()"
      pattern: "YubiKeyBackend"
---

<objective>
Add X.509 certificate generation using rcgen with hardware-backed signing, and register the YubiKey backend in the universal registry.

Purpose: Complete the backend rewrite by adding the final major capability (certificate generation) and integrating the backend into the discovery/registry system so applications can find and use it.

Output: Certificate generation method in yubikey.rs using rcgen's custom key pair pattern, and YubiKey backend registered in UniversalBackendRegistry::with_defaults() behind feature gate.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-backend-rewrite/10-RESEARCH.md
@.planning/phases/10-backend-rewrite/10-01-SUMMARY.md
@crates/core/src/backends/yubikey.rs (from Plan 01)
@crates/core/src/backends/universal_registry.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement X.509 certificate generation with rcgen hardware-backed signing</name>
  <files>crates/core/src/backends/yubikey.rs</files>
  <action>
Add certificate generation to the YubiKeyBackend using rcgen's custom key pair pattern. This is requirement BACK-10.

**IMPORTANT:** Before implementing, verify the exact rcgen API for custom/remote key pairs. The research notes rcgen v0.13+ may use `RemoteKeyPair` or v0.14+ may use `SigningKey`. Check the actual API:
- Look at rcgen 0.13 docs for `RemoteKeyPair` trait or `KeyPair::from_remote()`
- The pattern requires: providing public key bytes, specifying signature algorithm, and a callback/trait impl that delegates actual signing to hardware

**Implementation steps:**

1. **Add rcgen imports** at the top of yubikey.rs (inside the cfg block):
   ```rust
   use rcgen::{CertificateParams, DistinguishedName, DnType, KeyPair};
   ```
   Add any additional rcgen imports needed for the custom key pair pattern.

2. **Create a YubiKeySigningKeyPair struct** that implements rcgen's custom key pair trait (RemoteKeyPair or equivalent):

   This struct needs:
   - A reference or Arc to the YubiKey mutex (to perform signing)
   - The PIV slot to use
   - The public key DER bytes
   - The PIN (cloned from config)

   The `sign()` method must:
   - Lock the YubiKey mutex
   - Pre-hash the input data with SHA-256
   - Call the hardware signing function
   - Return the signature bytes

   **Handle the lifetime/ownership challenge:** Since rcgen likely takes ownership of the key pair, you cannot borrow from `&self`. Solutions:
   - Use `Arc<Mutex<Option<YubiKey>>>` (backend already uses Mutex, wrap in Arc for shared ownership)
   - OR restructure YubiKeyBackend to use `Arc<Mutex<...>>` internally so the signing key pair can clone the Arc
   - The simplest approach: make `YubiKeyBackend` store `Arc<Mutex<Option<YubiKey>>>` instead of `Mutex<Option<YubiKey>>` (update from Plan 01 if needed)

3. **Add `generate_certificate` method** to YubiKeyBackend:

   ```rust
   pub fn generate_certificate(&self, slot_id: &str, subject: &str) -> Result<Vec<u8>, BackendError>
   ```

   Steps:
   a. Parse slot from slot_id string
   b. Get public key DER from hardware slot (call piv_get_public_key)
   c. Create CertificateParams:
      - Set distinguished name with CommonName = subject
      - Set validity period (1 year default)
      - Set serial number (random)
   d. Create the custom key pair wrapping YubiKey hardware
   e. Assign key pair to params
   f. Generate self-signed certificate using rcgen
   g. Serialize to DER
   h. Return DER bytes

   Map rcgen errors to `BackendError::OperationFailed("Certificate generation failed: {error}")`.

4. **Wire certificate generation into perform_operation** if there's a suitable CryptoOperation variant, OR expose it as a standalone public method. Currently CryptoOperation doesn't have a certificate-generation variant, so expose it as:
   - A public method `generate_certificate(&self, slot_id: &str, subject: &str) -> Result<Vec<u8>, BackendError>`
   - This is consistent with how software_hsm.rs exposes specialized methods beyond the trait

**CRITICAL CONSTRAINTS:**
- NEVER use `rcgen::generate_simple_self_signed()` -- this creates SOFTWARE key pairs
- NEVER use `rcgen::KeyPair::generate()` -- this creates SOFTWARE key pairs
- Public key MUST come from hardware via `piv_get_public_key()`
- Signing callback MUST delegate to YubiKey hardware
- Zero manual DER encoding -- rcgen handles all certificate DER
- If rcgen API doesn't support the exact callback pattern described in research, adapt to whatever the actual 0.13 API provides. The key requirement is: public key from hardware + signing from hardware.
  </action>
  <verify>
Run `cargo check -p trustedge-core --features yubikey` -- should compile with zero errors.
Run `cargo clippy -p trustedge-core --features yubikey -- -D warnings` -- should pass.
Verify: `grep -c "generate_simple_self_signed\|KeyPair::generate" crates/core/src/backends/yubikey.rs` returns 0 (no software key generation).
Verify: `grep "rcgen" crates/core/src/backends/yubikey.rs | head -5` shows rcgen imports and usage.
  </verify>
  <done>
generate_certificate() method exists on YubiKeyBackend. It uses rcgen's custom key pair pattern to delegate signing to YubiKey hardware. Public key comes from hardware slot. Zero manual DER encoding.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register YubiKey backend in universal registry</name>
  <files>crates/core/src/backends/universal_registry.rs</files>
  <action>
Register the YubiKey backend in the UniversalBackendRegistry so it's discoverable at runtime when the yubikey feature is enabled.

**Changes to universal_registry.rs:**

1. **Add conditional import** at the top of the file:
   ```rust
   #[cfg(feature = "yubikey")]
   use crate::backends::yubikey::YubiKeyBackend;
   ```

2. **Update `with_defaults()` method** to try registering the YubiKey backend:

   After the existing Software HSM registration block, add:
   ```rust
   // Add YubiKey backend if available (feature-gated)
   #[cfg(feature = "yubikey")]
   {
       if let Ok(yubikey_backend) = YubiKeyBackend::new() {
           registry.register_backend("yubikey".to_string(), Box::new(yubikey_backend));
       }
       // YubiKey not found is not fatal -- it's optional hardware
   }
   ```

   This follows the exact same pattern used for the existing keyring and software_hsm registrations: try to create, register if successful, silently skip if not available.

3. **Do NOT modify** any existing tests, BackendPreferences, or other methods. The existing `hardware_preferred()` preference already lists "yubikey" in preferred_backends, so it will automatically prefer the YubiKey backend when available.

**Verify the integration:**
- With `--features yubikey` on a machine without a YubiKey: registry should still work, YubiKey backend won't be registered (because new() will succeed but backend_info().available will be false -- OR new() might fail if YubiKey::open() is called). Actually, based on Plan 01's design, `new()` succeeds even without hardware (connect_if_available doesn't fail), so the backend WILL be registered but with `available: false`. This is correct behavior.
- Without `--features yubikey`: the `#[cfg]` block is compiled out entirely.
  </action>
  <verify>
Run `cargo check -p trustedge-core --features yubikey` -- should compile.
Run `cargo check -p trustedge-core` -- should compile (yubikey code compiled out).
Run `cargo test --workspace` -- all existing tests pass.
Run `cargo clippy -p trustedge-core --features yubikey -- -D warnings` -- zero warnings.
Verify: `grep "YubiKeyBackend" crates/core/src/backends/universal_registry.rs` shows registration code.
  </verify>
  <done>
YubiKey backend is registered in UniversalBackendRegistry::with_defaults() behind #[cfg(feature = "yubikey")] gate. Existing tests and non-yubikey builds are unaffected.
  </done>
</task>

</tasks>

<verification>
1. `cargo check -p trustedge-core --features yubikey` compiles
2. `cargo check -p trustedge-core` compiles (without feature)
3. `cargo clippy -p trustedge-core --features yubikey -- -D warnings` passes
4. `cargo test --workspace` all tests pass (without yubikey feature, as no hardware)
5. Certificate generation method exists and uses rcgen (not manual DER)
6. YubiKey registered in UniversalBackendRegistry behind feature gate
7. No software key generation functions used (generate_simple_self_signed, KeyPair::generate)
</verification>

<success_criteria>
- generate_certificate() uses rcgen with hardware-backed custom key pair
- Public key in certificate comes from hardware slot
- Signing during certificate generation delegates to YubiKey
- Zero manual ASN.1/DER encoding in certificate generation
- YubiKey backend auto-registered in UniversalBackendRegistry when feature enabled
- All existing tests pass with and without yubikey feature
</success_criteria>

<output>
After completion, create `.planning/phases/10-backend-rewrite/10-02-SUMMARY.md`
</output>
