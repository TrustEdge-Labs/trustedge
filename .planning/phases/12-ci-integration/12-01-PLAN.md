---
phase: 12-ci-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - scripts/ci-check.sh
autonomous: true

must_haves:
  truths:
    - "CI always compiles trustedge-core with --features yubikey regardless of dependency availability"
    - "CI runs 18 YubiKey simulation tests (non-#[ignore]) on every pull request"
    - "Clippy passes with --features yubikey with zero warnings in CI"
    - "Local ci-check.sh still skips YubiKey steps when libpcsclite-dev is not installed (developer convenience)"
    - "Hardware integration tests (tests/yubikey_integration.rs) are NOT run in CI"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "Unconditional YubiKey CI steps"
      contains: "cargo test --package trustedge-core --features yubikey --lib"
    - path: "scripts/ci-check.sh"
      provides: "Local CI script with simulation-only YubiKey tests"
      contains: "cargo test --package trustedge-core --features yubikey --lib"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "crates/core/src/backends/yubikey.rs"
      via: "cargo test --features yubikey --lib runs #[cfg(test)] module"
      pattern: "cargo test --package trustedge-core --features yubikey --lib"
    - from: ".github/workflows/ci.yml"
      to: "apt-get install libpcsclite-dev"
      via: "unconditional install without fallback"
      pattern: "sudo apt-get install -y libpcsclite-dev pkgconf"
---

<objective>
Make YubiKey feature compilation and simulation testing unconditional in GitHub Actions CI, so broken YubiKey code can never be merged silently.

Purpose: The current CI conditionally skips YubiKey steps when libpcsclite-dev installation reports failure, which means broken YubiKey code can be merged without detection. By removing the conditional logic, CI always validates the YubiKey feature.

Output: Updated CI workflow and local script that unconditionally compile and test the YubiKey feature (simulation tests only, no hardware).
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.github/workflows/ci.yml
@scripts/ci-check.sh
@.planning/phases/12-ci-integration/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make YubiKey CI steps unconditional in GitHub Actions workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Edit `.github/workflows/ci.yml` to make all YubiKey steps unconditional:

1. **Replace the YubiKey dependency install step** (lines 63-70):
   - Remove the `id: yubikey-deps` attribute
   - Remove the `if/else` shell logic with output capture
   - Change step name from "Install YubiKey dependencies (if possible)" to "Install YubiKey dependencies"
   - Use unconditional install (fail loudly if packages missing):
     ```yaml
     - name: Install YubiKey dependencies
       run: sudo apt-get install -y libpcsclite-dev pkgconf
     ```
   - NOTE: `sudo apt-get update` already runs in the audio deps step above (line 57). Do NOT add a redundant `apt-get update` here.

2. **Remove `if` condition from clippy yubikey step** (line 80):
   - Delete the line: `if: steps.yubikey-deps.outputs.yubikey-available == 'true'`
   - Keep the run command unchanged

3. **Remove `if` condition from build yubikey step** (line 101):
   - Delete the line: `if: steps.yubikey-deps.outputs.yubikey-available == 'true'`
   - Keep the run command unchanged

4. **Update the YubiKey test step** (lines 104-106):
   - Delete the `if` condition (line 105)
   - Change step name to "tests (trustedge-core with yubikey simulation only)"
   - Change test command to use `--lib` flag (runs only unit/simulation tests, skips integration tests):
     ```yaml
     - name: tests (trustedge-core with yubikey simulation only)
       run: cargo test --package trustedge-core --features yubikey --lib --locked --verbose
     ```

5. **Update the "all features" step** (lines 108-113):
   - Remove the yubikey portion from the `if` condition. It should check ONLY audio availability:
     ```yaml
     if: steps.audio-deps.outputs.audio-available == 'true'
     ```
   - Change the test command to use `--lib` so all-features tests also skip hardware integration tests:
     ```yaml
     - name: Build and test all features (trustedge-core)
       if: steps.audio-deps.outputs.audio-available == 'true'
       run: |
         cargo clean
         cargo build --workspace --bins --all-features
         cargo test -p trustedge-core --all-features --lib --locked --verbose
     ```

Do NOT modify any non-YubiKey steps (audio steps stay conditional on audio-deps, workspace steps stay as-is). Keep the copyright header, permissions, triggers, and all other steps unchanged.
  </action>
  <verify>
Verify the updated workflow:
1. `grep -c "yubikey-available" .github/workflows/ci.yml` returns 0 (no conditional yubikey references remain)
2. `grep -c "yubikey-deps" .github/workflows/ci.yml` returns 0 (no yubikey-deps step ID references remain)
3. `grep "features yubikey --lib" .github/workflows/ci.yml` shows the `--lib` flag in the test command
4. `grep "Install YubiKey dependencies" .github/workflows/ci.yml` shows unconditional step name (no "if possible")
5. `grep -c "if:.*yubikey" .github/workflows/ci.yml` returns 0 (no conditional yubikey steps)
  </verify>
  <done>
All YubiKey CI steps (install, clippy, build, test) run unconditionally. The test step uses `--lib` to run only simulation tests. The "all features" step is conditional only on audio availability (not yubikey). No references to `yubikey-available` or `yubikey-deps` remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update local ci-check.sh to use --lib for YubiKey simulation tests</name>
  <files>scripts/ci-check.sh</files>
  <action>
Edit `scripts/ci-check.sh` to update YubiKey test execution:

1. **Step 5 (Clippy yubikey, lines 105-115):** Keep conditional on `pkg-config --exists libpcsclite` (developer convenience). No changes needed.

2. **Step 9 (YubiKey tests, lines 151-162):** Keep conditional on `pkg-config --exists libpcsclite` (developer convenience), but update the test command to use `--lib` to match CI behavior:
   - Change step header comment to "Tests (trustedge-core with yubikey simulation)"
   - Change the test command from:
     ```bash
     cargo test --package trustedge-core --features yubikey --locked
     ```
     to:
     ```bash
     cargo test --package trustedge-core --features yubikey --lib --locked
     ```
   - This ensures local script runs only simulation tests (matching CI), not hardware integration tests

3. **Step 10 (All features, lines 164-176):** Keep conditional on both audio + yubikey, but update the test command to use `--lib`:
   - Change from:
     ```bash
     cargo test -p trustedge-core --all-features --locked
     ```
     to:
     ```bash
     cargo test -p trustedge-core --all-features --lib --locked
     ```

Do NOT change the conditional logic (pkg-config checks) for local script -- research recommends keeping local script conditional for developer convenience while CI is unconditional for enforcement. Do NOT modify steps 1-4, 6-8, or 11-13.
  </action>
  <verify>
1. `grep "features yubikey --lib" scripts/ci-check.sh` shows the `--lib` flag in YubiKey test command
2. `grep "all-features --lib" scripts/ci-check.sh` shows the `--lib` flag in all-features test command
3. `grep "pkg-config --exists libpcsclite" scripts/ci-check.sh` still shows conditional checks (kept for developer convenience)
4. Run `bash -n scripts/ci-check.sh` to verify no syntax errors
  </verify>
  <done>
Local CI script uses `--lib` for YubiKey tests (simulation only, matching CI behavior). Conditional pkg-config checks preserved for developer convenience. Script has no syntax errors.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **CI workflow validation:**
   - No conditional yubikey references remain: `grep -c "yubikey-available\|yubikey-deps" .github/workflows/ci.yml` returns 0
   - YubiKey install is unconditional (no `if/else`, no output capture)
   - Clippy runs unconditionally with `--features yubikey`
   - Test command uses `--lib` flag

2. **Local script validation:**
   - `bash -n scripts/ci-check.sh` passes (no syntax errors)
   - YubiKey test uses `--lib` flag
   - Conditional pkg-config checks preserved

3. **Functional validation (if libpcsclite-dev is installed):**
   - `cargo clippy --package trustedge-core --all-targets --features yubikey -- -D warnings` passes with zero warnings
   - `cargo test --package trustedge-core --features yubikey --lib --locked --verbose` runs 18 simulation tests, 0 ignored, all pass
</verification>

<success_criteria>
1. CI workflow always compiles crates/core with --features yubikey (CI-01)
2. CI runs YubiKey simulation tests (non-#[ignore]) on every pull request (CI-02)
3. Clippy passes with --features yubikey with zero warnings (CI-03)
4. Hardware integration tests are NOT run in CI (--lib flag excludes them)
5. Local ci-check.sh mirrors CI test behavior (--lib) while keeping developer-convenience conditionals
</success_criteria>

<output>
After completion, create `.planning/phases/12-ci-integration/12-01-SUMMARY.md`
</output>
