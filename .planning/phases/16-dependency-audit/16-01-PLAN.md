---
phase: 16-dependency-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/core/Cargo.toml
  - crates/trustedge-cli/Cargo.toml
  - crates/trst-cli/Cargo.toml
  - crates/trst-protocols/Cargo.toml
  - crates/trst-wasm/Cargo.toml
  - crates/wasm/Cargo.toml
  - crates/pubky/Cargo.toml
  - crates/pubky-advanced/Cargo.toml
  - crates/receipts/Cargo.toml
  - crates/attestation/Cargo.toml
  - examples/cam.video/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "cargo-machete has been run against all 10 crates and the results are documented"
    - "No genuinely unused dependencies remain in any crate Cargo.toml"
    - "No workspace-level dependencies exist that are not referenced by at least one crate"
    - "cargo build --workspace succeeds after all removals"
    - "cargo test --workspace succeeds after all removals"
    - "Known false positives (serde_bytes, getrandom) are preserved with cargo-machete ignore annotations"
  artifacts:
    - path: "Cargo.toml"
      provides: "Workspace dependency declarations with unused entries removed"
    - path: "crates/core/Cargo.toml"
      provides: "Core crate dependencies with unused entries removed"
  key_links:
    - from: "workspace [workspace.dependencies]"
      to: "crate [dependencies]"
      via: "workspace = true references"
      pattern: "workspace = true"
---

<objective>
Run cargo-machete across all 10 workspace crates and the examples crate, analyze results distinguishing genuine unused dependencies from false positives, remove all genuinely unused dependencies from both crate-level and workspace-level Cargo.toml files.

Purpose: Reduce the dependency tree by eliminating dependencies that are declared but not actually used in code, shrinking compile times and attack surface.
Output: Clean Cargo.toml files across the workspace with no unused dependencies; documented machete results.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@Cargo.toml
@crates/core/Cargo.toml
@crates/trustedge-cli/Cargo.toml
@crates/trst-cli/Cargo.toml
@crates/trst-protocols/Cargo.toml
@crates/trst-wasm/Cargo.toml
@crates/wasm/Cargo.toml
@crates/pubky/Cargo.toml
@crates/pubky-advanced/Cargo.toml
@crates/receipts/Cargo.toml
@crates/attestation/Cargo.toml
@examples/cam.video/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run cargo-machete and analyze results across all crates</name>
  <files>
    crates/core/Cargo.toml
    crates/trustedge-cli/Cargo.toml
    crates/trst-cli/Cargo.toml
    crates/trst-protocols/Cargo.toml
    crates/trst-wasm/Cargo.toml
    crates/wasm/Cargo.toml
    crates/pubky/Cargo.toml
    crates/pubky-advanced/Cargo.toml
    crates/receipts/Cargo.toml
    crates/attestation/Cargo.toml
    examples/cam.video/Cargo.toml
  </files>
  <action>
    Install cargo-machete if not already installed: `cargo install cargo-machete` (skip if already present).

    Run cargo-machete against the entire workspace:
    ```
    cargo machete --skip-target-dir 2>&1
    ```

    Also run per-crate for precise results if the workspace run is unclear:
    ```
    for crate in core trustedge-cli trst-cli trst-protocols trst-wasm wasm pubky pubky-advanced receipts attestation; do
      echo "=== crates/$crate ==="
      cargo machete "crates/$crate" 2>&1
    done
    cargo machete "examples/cam.video" 2>&1
    ```

    Analyze each flagged dependency and classify:

    **Known false positives (DO NOT REMOVE):**
    - `serde_bytes` in trustedge-core: used via `#[serde(with = "serde_bytes")]` attribute, not direct import. Already in cargo-machete ignore list.
    - `getrandom` in trustedge-wasm and trustedge-trst-wasm: required to activate "js" feature for wasm32-unknown-unknown target. Already in cargo-machete ignore lists.

    **Classification rules:**
    - If a dependency is imported in source code (`use crate_name::...`) -> NOT unused
    - If a dependency is used via derive macros or attributes (`#[derive(Serialize)]` for serde) -> NOT unused
    - If a dependency is used only for feature activation (like getrandom) -> NOT unused (document as false positive)
    - If a dependency is only in `[dev-dependencies]` and used in tests -> NOT unused
    - If a dependency enables features on transitive deps -> NOT unused
    - If a dependency is truly not referenced anywhere in the crate's source -> GENUINELY UNUSED

    Record all findings: for each crate, list what machete reported and your classification (genuine vs false positive with reason).
  </action>
  <verify>
    cargo-machete runs successfully against all crates. Results are documented in the SUMMARY.md (created at end of plan).
  </verify>
  <done>
    Every dependency flagged by cargo-machete across all 10 crates + examples is classified as either genuinely unused (to be removed in Task 2) or false positive (with documented reason).
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove unused dependencies and clean workspace</name>
  <files>
    Cargo.toml
    crates/core/Cargo.toml
    crates/trustedge-cli/Cargo.toml
    crates/trst-cli/Cargo.toml
    crates/trst-protocols/Cargo.toml
    crates/trst-wasm/Cargo.toml
    crates/wasm/Cargo.toml
    crates/pubky/Cargo.toml
    crates/pubky-advanced/Cargo.toml
    crates/receipts/Cargo.toml
    crates/attestation/Cargo.toml
    examples/cam.video/Cargo.toml
  </files>
  <action>
    Based on Task 1 analysis, remove all genuinely unused dependencies:

    **Step 1: Remove unused crate-level dependencies (REM-02)**
    For each crate where cargo-machete found genuinely unused deps:
    - Remove the dependency line from the crate's `[dependencies]` section
    - If the dependency was also in `[dev-dependencies]` and unused there, remove it too
    - If a removed dep was the ONLY user of a workspace dep, note it for Step 2

    **Step 2: Clean workspace-level dependencies (REM-03)**
    Cross-reference every entry in `[workspace.dependencies]` (root Cargo.toml) against ALL crate Cargo.toml files:
    - For each workspace dependency, grep all crate Cargo.toml files for `workspace = true` references to it
    - If NO crate references a workspace dependency, remove it from `[workspace.dependencies]`
    - Be thorough: check all 10 crates + examples/cam.video

    Workspace deps to verify are still referenced (check each):
    - `aead`, `aes-gcm`, `blake3`, `ed25519-dalek`, `p256`, `pbkdf2`, `rand`, `rand_core`, `rsa`, `x25519-dalek`, `hkdf`
    - `pubky`
    - `bincode`, `serde`, `serde_bytes`, `serde_json`
    - `git2`, `sha2`
    - `anyhow`, `async-trait`, `chrono`, `hex`, `num-traits`, `thiserror`, `zeroize`
    - `clap`, `keyring`
    - `wasm-bindgen`, `js-sys`, `serde-wasm-bindgen`, `getrandom`
    - `tokio`, `tokio-test`

    **Step 3: Add cargo-machete ignore annotations for any NEW false positives discovered**
    If Task 1 found new false positives not already annotated, add them to the relevant crate's `[package.metadata.cargo-machete]` section.

    **Step 4: Verify everything still builds and tests pass**
    ```
    cargo build --workspace
    cargo test --workspace
    cargo build --workspace --all-features
    cargo clippy --workspace -- -D warnings
    ```

    If any command fails, the removed dependency was NOT truly unused. Re-add it and add a cargo-machete ignore annotation instead.

    **Step 5: Run cargo-machete again to confirm clean results**
    ```
    cargo machete --skip-target-dir 2>&1
    ```
    Should report no unused dependencies (only false positives in ignore lists).
  </action>
  <verify>
    Run in sequence:
    1. `cargo build --workspace` succeeds
    2. `cargo test --workspace` succeeds
    3. `cargo build --workspace --all-features` succeeds
    4. `cargo clippy --workspace -- -D warnings` succeeds
    5. `cargo machete --skip-target-dir` reports no unused deps (ignoring annotated false positives)
  </verify>
  <done>
    All genuinely unused dependencies removed from crate Cargo.toml files. All unreferenced workspace dependencies removed from root Cargo.toml. Build, test, clippy, and machete all pass clean.
  </done>
</task>

</tasks>

<verification>
1. `cargo machete --skip-target-dir` reports no unused dependencies (all false positives annotated)
2. `cargo build --workspace` succeeds
3. `cargo test --workspace` succeeds
4. `cargo build --workspace --all-features` succeeds (features still work)
5. `cargo clippy --workspace -- -D warnings` passes
6. Every workspace dependency in root Cargo.toml is referenced by at least one crate
7. No crate Cargo.toml contains a dependency not actually used in its source code
</verification>

<success_criteria>
- cargo-machete run results documented for all 10 crates + examples (REM-01)
- All genuinely unused crate dependencies removed (REM-02)
- All unreferenced workspace dependencies removed (REM-03)
- Full workspace build and test suite passes after cleanup
- No false positives accidentally removed (serde_bytes, getrandom preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/16-dependency-audit/16-01-SUMMARY.md`
</output>
