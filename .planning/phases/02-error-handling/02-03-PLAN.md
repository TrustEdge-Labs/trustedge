<!--
Copyright (c) 2025 TRUSTEDGE LABS LLC
MPL-2.0: https://mozilla.org/MPL/2.0/
Project: trustedge — Privacy and trust at the edge.
GitHub: https://github.com/TrustEdge-Labs/trustedge
-->


---
phase: 02-error-handling
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - crates/core/src/backends/traits.rs
  - crates/core/src/backends/universal.rs
  - crates/core/src/backends/software_hsm.rs
  - crates/core/src/backends/universal_keyring.rs
  - crates/core/src/backends/universal_registry.rs
  - crates/core/src/backends/mod.rs
  - crates/core/src/backends/keyring.rs
  - crates/core/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "Backend trait methods return Result<T, BackendError> instead of anyhow::Result<T>"
    - "All backend implementations compile with structured BackendError"
    - "lib.rs re-exports TrustEdgeError and BackendError from error.rs"
    - "Library code (trustedge-core) no longer uses anyhow for error returns in backend traits"
    - "All 348+ workspace tests pass"
  artifacts:
    - path: "crates/core/src/backends/traits.rs"
      provides: "KeyBackend trait with BackendError return types"
      contains: "use crate::error::BackendError"
    - path: "crates/core/src/backends/universal.rs"
      provides: "UniversalBackend trait with BackendError return types"
      contains: "Result<CryptoResult, BackendError>"
    - path: "crates/core/src/lib.rs"
      provides: "Public re-exports of unified error types"
      contains: "pub use error::"
  key_links:
    - from: "crates/core/src/backends/traits.rs"
      to: "crates/core/src/error.rs"
      via: "BackendError import for trait return types"
      pattern: "use crate::error::BackendError"
    - from: "crates/core/src/lib.rs"
      to: "crates/core/src/error.rs"
      via: "pub use re-exports for public API"
      pattern: "pub use error::"
---

<objective>
Migrate backend traits from anyhow::Result to structured BackendError and update the public API re-exports.

Purpose: Backend code is library code (not CLI), so it must use structured errors per ERR-03. This plan replaces anyhow::Result in backend trait signatures with Result<T, BackendError>, updates all implementations, and exposes the unified error types through lib.rs. After this plan, the error consolidation is complete.

Output: Backend traits using BackendError, lib.rs exposing TrustEdgeError + subsystem errors, workspace compiling and all tests passing.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-error-handling/02-RESEARCH.md
@.planning/phases/02-error-handling/02-01-SUMMARY.md
@.planning/phases/02-error-handling/02-02-SUMMARY.md
@crates/core/src/error.rs
@crates/core/src/lib.rs
@crates/core/src/backends/traits.rs
@crates/core/src/backends/universal.rs
@crates/core/src/backends/software_hsm.rs
@crates/core/src/backends/universal_keyring.rs
@crates/core/src/backends/universal_registry.rs
@crates/core/src/backends/mod.rs
@crates/core/src/backends/keyring.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate backend trait signatures to BackendError</name>
  <files>crates/core/src/backends/traits.rs, crates/core/src/backends/universal.rs, crates/core/src/backends/software_hsm.rs, crates/core/src/backends/universal_keyring.rs, crates/core/src/backends/universal_registry.rs, crates/core/src/backends/mod.rs, crates/core/src/backends/keyring.rs</files>
  <action>
Migrate backend traits and implementations from `anyhow::Result` to `Result<T, BackendError>`.

**Step 1: Update trait definitions**

In `crates/core/src/backends/traits.rs`:
1. Replace `use anyhow::Result;` with `use crate::error::BackendError;`
2. Change `fn derive_key(...) -> Result<[u8; 32]>` to `fn derive_key(...) -> Result<[u8; 32], BackendError>`
3. Change `fn store_key(...) -> Result<()>` to `fn store_key(...) -> Result<(), BackendError>`
4. Change `fn rotate_key(...) -> Result<()>` to `fn rotate_key(...) -> Result<(), BackendError>`
5. Change `fn list_keys(&self) -> Result<Vec<KeyMetadata>>` to `fn list_keys(&self) -> Result<Vec<KeyMetadata>, BackendError>`

In `crates/core/src/backends/universal.rs`:
1. Replace `use anyhow::Result;` with `use crate::error::BackendError;`
2. Change `fn perform_operation(&self, key_id: &str, operation: CryptoOperation) -> Result<CryptoResult>` to `fn perform_operation(...) -> Result<CryptoResult, BackendError>`

**Step 2: Update all backend implementations**

For EACH implementation file, apply these changes:

In `crates/core/src/backends/software_hsm.rs`:
1. Add `use crate::error::BackendError;`
2. Remove or update `use anyhow::Result;` — keep anyhow if used internally for non-trait methods, but convert all trait method signatures
3. In trait impl methods: replace `anyhow::bail!(...)` with `return Err(BackendError::OperationFailed(...))` or appropriate variant
4. Replace `.context("...")` with `.map_err(|e| BackendError::OperationFailed(format!("...: {}", e)))` for trait methods
5. Replace `Err(anyhow::anyhow!("..."))` with `Err(BackendError::OperationFailed("...".to_string()))` or the appropriate variant (KeyNotFound, UnsupportedOperation, etc.)
6. Match error semantics: "Key not found" messages -> `BackendError::KeyNotFound(...)`, "not supported" -> `BackendError::UnsupportedOperation(...)`, generic failures -> `BackendError::OperationFailed(...)`

In `crates/core/src/backends/universal_keyring.rs`:
1. Same pattern as software_hsm.rs — update trait method signatures and error constructions
2. Keyring-specific errors (access denied, not available) -> `BackendError::OperationFailed(...)`

In `crates/core/src/backends/keyring.rs`:
1. Update KeyBackend trait impl methods to return `Result<T, BackendError>` instead of anyhow::Result
2. Convert error constructions accordingly

In `crates/core/src/backends/universal_registry.rs`:
1. Update `perform_operation` method (this is not a trait impl but a struct method) — change return type
2. Convert anyhow error patterns

In `crates/core/src/backends/mod.rs`:
1. Update any re-exports or wrapper functions that use anyhow::Result

**Step 3: Handle YubiKey backend (feature-gated)**

The YubiKey backend (`crates/core/src/backends/yubikey.rs`) is behind `#[cfg(feature = "yubikey")]`. It also implements UniversalBackend with `anyhow::Result`. Update it the same way:
1. Add `use crate::error::BackendError;`
2. Update trait impl method signatures
3. Convert anyhow patterns to BackendError variants
4. `HardwareError(String)` variant is designed for YubiKey-specific hardware failures

NOTE: If the yubikey feature is not available in the build environment, you can still edit the file. The code is valid Rust — it just won't be compiled without the feature flag. Run `cargo build -p trustedge-core` (without --features yubikey) to test the non-yubikey path. If yubikey feature builds are available, also run `cargo build -p trustedge-core --features yubikey`.

**Step 4: Update callers of backend methods**

Search for code that calls backend trait methods and expects `anyhow::Result`:
- `crates/core/src/bin/software-hsm-demo.rs` — binary, uses anyhow, will auto-convert BackendError -> anyhow via `.context()`
- `crates/core/src/bin/yubikey-demo.rs` — binary, uses anyhow
- `crates/trustedge-cli/src/main.rs` — uses `KeyringBackend::new().context(...)` — will need BackendError -> anyhow conversion

For CLI binaries that use `anyhow::Result`, BackendError will automatically convert to anyhow::Error if we add `impl From<BackendError> for anyhow::Error` — but thiserror already provides this via the `Error` trait implementation. The `?` operator in anyhow::Result functions will work because anyhow accepts any `std::error::Error`.

Run `cargo build --workspace` after each major step to catch issues early.
  </action>
  <verify>
`cargo build --workspace` compiles. `cargo test --workspace` passes all 348+ tests. `grep -rn "anyhow::Result" crates/core/src/backends/traits.rs crates/core/src/backends/universal.rs` returns zero matches (anyhow removed from trait definitions).
  </verify>
  <done>
KeyBackend and UniversalBackend traits return `Result<T, BackendError>` instead of `anyhow::Result`. All backend implementations (software_hsm, universal_keyring, keyring, yubikey) updated. CLI binaries still work via automatic Error trait conversion. Workspace builds and all tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update lib.rs re-exports and run final workspace verification</name>
  <files>crates/core/src/lib.rs</files>
  <action>
Update `crates/core/src/lib.rs` to expose the unified error types through the public API.

**Step 1: Add error re-exports**

Add a new `pub use error::` block in lib.rs, placed near the other `pub use` statements:

```rust
pub use error::{
    TrustEdgeError,
    BackendError,
    TransportError,
};
```

Note: CryptoError, ChainError, ManifestError, AsymmetricError, ArchiveError are ALREADY re-exported through their original module paths (e.g., `pub use crypto::{..., CryptoError, ...}`). Do NOT duplicate these re-exports. Only add types that are NEW and not re-exported elsewhere (TrustEdgeError, BackendError, TransportError).

Also add `BackendError` to the existing `pub use backends::{ ... }` block if it makes sense for discoverability, but since BackendError is defined in error.rs (not backends/), it should be exported from `pub use error::` instead.

**Step 2: Verify re-export consistency**

After adding, verify that all error types are accessible from the crate root:
- `trustedge_core::TrustEdgeError` — from error.rs (NEW)
- `trustedge_core::BackendError` — from error.rs (NEW)
- `trustedge_core::TransportError` — from error.rs (NEW)
- `trustedge_core::CryptoError` — from crypto.rs re-export (EXISTING, now delegates to error.rs)
- `trustedge_core::ChainError` — from chain.rs re-export (EXISTING)
- `trustedge_core::ManifestError` — from manifest.rs re-export (EXISTING)
- `trustedge_core::AsymmetricError` — from asymmetric.rs re-export (EXISTING)
- `trustedge_core::ArchiveError` — from archive.rs re-export (EXISTING)

**Step 3: Run comprehensive verification**

1. `cargo build --workspace` — must compile
2. `cargo test --workspace` — all 348+ tests must pass
3. `cargo clippy --workspace -- -D warnings` — no warnings
4. `cargo fmt --check` — formatting clean (run `cargo fmt` if needed)
5. Run `./scripts/ci-check.sh` if available — full CI validation

**Step 4: Verify success criteria from ROADMAP**

Manually verify against Phase 2 success criteria:
1. "Single TrustEdgeError enum exists with subsystem variants" — grep for it
2. "All 10+ duplicate error types consolidated" — count unique error enum definitions
3. "Library code uses thiserror, CLI binaries use anyhow" — grep patterns
4. "Error conversion paths preserve context" — verify #[from] and #[source] attributes in error.rs

Note on success criterion 2: The ROADMAP says "10+ duplicate error types". The actual count is 9 error enums in the workspace (CryptoError, ChainError, AsymmetricError, ManifestError in core, ManifestError in trst-core, ArchiveError, TrustEdgeError in hybrid, PubkyAdapterError, PubkyError). Of these:
- 6 in core are consolidated into error.rs (CryptoError, ChainError, AsymmetricError, ManifestError, ArchiveError, plus hybrid's TrustEdgeError renamed)
- 2 new types created (BackendError, TransportError) for previously-anyhow code
- ManifestError in trst-core remains (deferred to Phase 3 per ROADMAP)
- Pubky errors remain independent (out of scope per research recommendation)
  </action>
  <verify>
`cargo build --workspace` compiles. `cargo test --workspace` passes all 348+ tests. `cargo clippy --workspace -- -D warnings` clean. `grep "pub enum.*Error" crates/core/src/error.rs | wc -l` returns 8 (TrustEdgeError + 7 subsystem enums). `grep -rn "pub use error::" crates/core/src/lib.rs` shows TrustEdgeError, BackendError, TransportError re-exported.
  </verify>
  <done>
TrustEdgeError, BackendError, and TransportError are accessible from `trustedge_core::*`. All Phase 2 success criteria met: unified TrustEdgeError with subsystem variants, error types consolidated, thiserror for library / anyhow for CLIs, error conversion paths preserve context via #[from]/#[source]. Full CI passing.
  </done>
</task>

</tasks>

<verification>
1. `cargo build --workspace` compiles without errors
2. `cargo test --workspace` passes all 348+ tests
3. `cargo clippy --workspace -- -D warnings` passes
4. Backend traits use `Result<T, BackendError>` (no anyhow in trait signatures)
5. `trustedge_core::TrustEdgeError` is accessible from crate root
6. Phase 2 ROADMAP success criteria all satisfied
</verification>

<success_criteria>
- Backend traits migrated from anyhow::Result to BackendError
- Public API exposes TrustEdgeError, BackendError, TransportError
- Zero test regressions — all 348+ tests pass
- Clippy clean with -D warnings
- All 4 Phase 2 success criteria from ROADMAP verified
</success_criteria>

<output>
After completion, create `.planning/phases/02-error-handling/02-03-SUMMARY.md`
</output>
