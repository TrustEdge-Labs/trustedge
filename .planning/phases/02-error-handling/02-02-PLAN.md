<!--
Copyright (c) 2025 TRUSTEDGE LABS LLC
MPL-2.0: https://mozilla.org/MPL/2.0/
Project: trustedge — Privacy and trust at the edge.
GitHub: https://github.com/TrustEdge-Labs/trustedge
-->


---
phase: 02-error-handling
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - crates/core/src/crypto.rs
  - crates/core/src/chain.rs
  - crates/core/src/asymmetric.rs
  - crates/core/src/manifest.rs
  - crates/core/src/archive.rs
autonomous: true

must_haves:
  truths:
    - "Leaf modules (crypto, chain, manifest) import error types from error.rs instead of defining their own"
    - "Dependent module (archive) imports error types from error.rs instead of defining its own"
    - "Asymmetric module uses error.rs AsymmetricError without anyhow::Error variant"
    - "All existing function signatures and return types still work"
    - "All 348+ tests pass without modification"
  artifacts:
    - path: "crates/core/src/crypto.rs"
      provides: "Crypto functions using error::CryptoError"
      contains: "use crate::error::CryptoError"
    - path: "crates/core/src/chain.rs"
      provides: "Chain functions using error::ChainError"
      contains: "use crate::error::ChainError"
    - path: "crates/core/src/manifest.rs"
      provides: "Manifest types using error::ManifestError"
      contains: "use crate::error::ManifestError"
    - path: "crates/core/src/archive.rs"
      provides: "Archive functions using error::ArchiveError"
      contains: "use crate::error::ArchiveError"
    - path: "crates/core/src/asymmetric.rs"
      provides: "Asymmetric types using error::AsymmetricError"
      contains: "use crate::error::AsymmetricError"
  key_links:
    - from: "crates/core/src/crypto.rs"
      to: "crates/core/src/error.rs"
      via: "use crate::error::CryptoError import"
      pattern: "use crate::error::CryptoError"
    - from: "crates/core/src/archive.rs"
      to: "crates/core/src/error.rs"
      via: "imports ArchiveError, ManifestError, ChainError from error.rs"
      pattern: "use crate::error::"
---

<objective>
Migrate all core module error definitions to use the unified error.rs types.

Purpose: Remove the duplicate error enum definitions from individual modules and replace them with imports from error.rs. After this plan, all error types in trustedge-core are defined in exactly one place (error.rs). Function signatures and public behavior remain identical.

Output: 5 modules (crypto, chain, asymmetric, manifest, archive) using error.rs types instead of locally-defined enums.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-error-handling/02-RESEARCH.md
@.planning/phases/02-error-handling/02-01-SUMMARY.md
@crates/core/src/error.rs
@crates/core/src/crypto.rs
@crates/core/src/chain.rs
@crates/core/src/asymmetric.rs
@crates/core/src/manifest.rs
@crates/core/src/archive.rs
@crates/core/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate leaf error modules (crypto, chain, manifest)</name>
  <files>crates/core/src/crypto.rs, crates/core/src/chain.rs, crates/core/src/manifest.rs</files>
  <action>
These three modules define error enums with NO cross-dependencies on other TrustEdge error types. Migrate them in this order:

**crypto.rs:**
1. Remove the `use thiserror::Error;` import (no longer needed locally)
2. Remove the entire `#[derive(Error, Debug)] pub enum CryptoError { ... }` block (7 variants)
3. Add `use crate::error::CryptoError;` near the top of the imports
4. Verify all functions returning `Result<_, CryptoError>` still compile — the type is identical, just imported from a different location
5. Run `cargo build -p trustedge-core` after this file

**chain.rs:**
1. Remove `use thiserror::Error;`
2. Remove the entire `#[derive(Error, Debug)] pub enum ChainError { ... }` block (3 variants)
3. Add `use crate::error::ChainError;`
4. Run `cargo build -p trustedge-core` after this file

**manifest.rs:**
1. Remove `use thiserror::Error;`
2. Remove the entire `#[derive(Error, Debug)] pub enum ManifestError { ... }` block (2 variants)
3. Add `use crate::error::ManifestError;`
4. Verify the `to_canonical_bytes` and other functions that return `Result<_, ManifestError>` still compile
5. Run `cargo build -p trustedge-core` after this file

IMPORTANT: The error.rs versions must have IDENTICAL variant names, field types, and error messages to the originals. If Plan 01 was implemented correctly, this is a drop-in replacement. If there are any compile errors, check that error.rs variants match exactly.

After all three files are migrated, run `cargo test -p trustedge-core --lib` to verify no test regressions.
  </action>
  <verify>
`cargo build -p trustedge-core` compiles. `cargo test -p trustedge-core --lib` passes all tests. `grep -n "pub enum CryptoError\|pub enum ChainError\|pub enum ManifestError" crates/core/src/crypto.rs crates/core/src/chain.rs crates/core/src/manifest.rs` returns zero matches (definitions removed from these files).
  </verify>
  <done>
CryptoError, ChainError, and ManifestError are no longer defined in their respective modules. All three modules import from `crate::error`. All functions still return the same error types. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate dependent error modules (asymmetric, archive)</name>
  <files>crates/core/src/asymmetric.rs, crates/core/src/archive.rs</files>
  <action>
These modules have error types that depend on other error types. Migrate after leaf errors.

**asymmetric.rs:**
1. Remove the `#[derive(Debug, thiserror::Error)] pub enum AsymmetricError { ... }` block
2. Add `use crate::error::AsymmetricError;`
3. CRITICAL: The original AsymmetricError has `BackendError(#[from] anyhow::Error)`. The error.rs version replaces this with `BackendError(String)`. This means any code that does `AsymmetricError::BackendError(anyhow_err)` or uses `?` to convert anyhow::Error into AsymmetricError will break.
4. Search asymmetric.rs for all usages of `AsymmetricError::BackendError` and update:
   - Where anyhow::Error was being converted via `#[from]`: use `.map_err(|e| AsymmetricError::BackendError(e.to_string()))?` instead of `?`
   - Where AsymmetricError::BackendError was constructed directly with anyhow: use `.to_string()` on the error
5. Also check if asymmetric.rs still needs `use anyhow::{Context, Result};`. If it only used anyhow for the BackendError variant, it may no longer need the anyhow import. However, if functions return `anyhow::Result`, keep it for now (function signature migration happens in Plan 03).
6. Run `cargo build -p trustedge-core` to verify

**archive.rs:**
1. Remove `use thiserror::Error;`
2. Remove the entire `#[derive(Error, Debug)] pub enum ArchiveError { ... }` block
3. Remove `use crate::manifest::{CamVideoManifest, ManifestError};` and replace with `use crate::error::{ArchiveError, ManifestError};` plus `use crate::manifest::CamVideoManifest;`
4. Remove `use crate::chain::ChainError;` if it was imported for the ArchiveError definition — now it comes from error.rs transitively through ArchiveError
5. Verify all functions returning `Result<_, ArchiveError>` still compile
6. Run `cargo build -p trustedge-core` to verify

After both files are migrated:
- Run `cargo build --workspace` (not just trustedge-core, because other crates import these error types)
- Run `cargo test --workspace` to verify no regressions across the entire workspace
- If other crates (receipts, attestation, trst-cli, etc.) directly import error types from `trustedge_core::crypto::CryptoError` or similar paths, they will still work because lib.rs re-exports them: `pub use crypto::{..., CryptoError, ...}`. Since we removed the definition from crypto.rs but crypto.rs now re-exports via `use crate::error::CryptoError`, the pub use in lib.rs will still find the type through the module.

WAIT — there is a subtlety. lib.rs says `pub use crypto::{..., CryptoError, ...}`. This means CryptoError must be accessible at the `crypto` module level. After removing the definition from crypto.rs and adding `use crate::error::CryptoError;`, the type IS accessible in the crypto module (it's imported and available). But it's a private import — `use` without `pub`. For lib.rs `pub use crypto::CryptoError` to work, the import in crypto.rs must be `pub use crate::error::CryptoError;`.

CORRECTION: In ALL migrated files, use `pub use crate::error::CryptoError;` (not just `use`) so that the type remains publicly accessible from the module path. This applies to ALL five modules:
- crypto.rs: `pub use crate::error::CryptoError;`
- chain.rs: `pub use crate::error::ChainError;`
- manifest.rs: `pub use crate::error::ManifestError;`
- asymmetric.rs: `pub use crate::error::AsymmetricError;`
- archive.rs: `pub use crate::error::ArchiveError;`

This ensures backward compatibility: `trustedge_core::crypto::CryptoError` still resolves.
  </action>
  <verify>
`cargo build --workspace` compiles. `cargo test --workspace` passes all 348+ tests. `grep -rn "pub enum AsymmetricError\|pub enum ArchiveError" crates/core/src/asymmetric.rs crates/core/src/archive.rs` returns zero matches. `grep -rn "pub use crate::error::" crates/core/src/crypto.rs crates/core/src/chain.rs crates/core/src/manifest.rs crates/core/src/asymmetric.rs crates/core/src/archive.rs` returns 5 matches (one per file).
  </verify>
  <done>
All 5 error enums (CryptoError, ChainError, ManifestError, AsymmetricError, ArchiveError) are defined exclusively in error.rs. Each original module re-exports via `pub use crate::error::*Error`. Workspace builds and all 348+ tests pass. Error types are accessible from both `trustedge_core::error::CryptoError` and `trustedge_core::crypto::CryptoError` (backward-compatible).
  </done>
</task>

</tasks>

<verification>
1. `cargo build --workspace` compiles without errors
2. `cargo test --workspace` passes all 348+ tests
3. No error enum definitions remain in crypto.rs, chain.rs, manifest.rs, asymmetric.rs, archive.rs
4. All 5 modules have `pub use crate::error::*Error;` re-exports
5. `trustedge_core::crypto::CryptoError` path still resolves (backward compatible)
</verification>

<success_criteria>
- All 5 core error types consolidated into error.rs (single source of truth)
- Zero test regressions across the entire workspace
- Backward-compatible module paths preserved via pub use re-exports
- No function signature changes (same return types)
</success_criteria>

<output>
After completion, create `.planning/phases/02-error-handling/02-02-SUMMARY.md`
</output>
