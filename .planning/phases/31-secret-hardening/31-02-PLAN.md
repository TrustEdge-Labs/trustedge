---
phase: 31-secret-hardening
plan: 02
type: execute
wave: 2
depends_on:
  - 31-01
files_modified:
  - crates/core/src/backends/yubikey.rs
  - crates/core/src/backends/software_hsm.rs
  - crates/core/src/bin/software-hsm-demo.rs
  - crates/core/tests/software_hsm_integration.rs
  - crates/core/tests/yubikey_integration.rs
  - crates/core/examples/verify_yubikey.rs
  - crates/core/examples/verify_yubikey_custom_pin.rs
  - crates/platform/src/ca/service.rs
autonomous: true
requirements:
  - SEC-01
  - SEC-02
  - SEC-03

must_haves:
  truths:
    - "YubiKeyConfig no longer derives Serialize or Deserialize — the compiler rejects any attempt to serialize it"
    - "SoftwareHsmConfig no longer derives Serialize or Deserialize — the compiler rejects any attempt to serialize it"
    - "YubiKeyConfig.pin is wrapped in Secret<String> and zeroized on drop"
    - "SoftwareHsmConfig.default_passphrase is wrapped in Secret<String> and zeroized on drop"
    - "Debug output of YubiKeyConfig shows [REDACTED] for the pin field, not the actual value"
    - "Debug output of SoftwareHsmConfig shows [REDACTED] for the passphrase field, not the actual value"
    - "Builder pattern is available: YubiKeyConfig::builder().pin(secret).build()"
    - "All existing tests compile and pass with updated config construction"
  artifacts:
    - path: "crates/core/src/backends/yubikey.rs"
      provides: "YubiKeyConfig with Secret<String> pin, builder pattern, manual Debug, no Serialize/Deserialize"
      contains: "Secret"
    - path: "crates/core/src/backends/software_hsm.rs"
      provides: "SoftwareHsmConfig with Secret<String> passphrase, builder pattern, manual Debug, no Serialize/Deserialize"
      contains: "Secret"
  key_links:
    - from: "crates/core/src/backends/yubikey.rs"
      to: "crates/core/src/secret.rs"
      via: "use crate::secret::Secret"
      pattern: "use crate::secret::Secret"
    - from: "crates/core/src/backends/software_hsm.rs"
      to: "crates/core/src/secret.rs"
      via: "use crate::secret::Secret"
      pattern: "use crate::secret::Secret"
---

<objective>
Harden YubiKeyConfig and SoftwareHsmConfig by removing Serialize/Deserialize, wrapping secret fields with Secret<T>, adding builder pattern constructors, and implementing manual Debug that redacts sensitive values.

Purpose: Prevents accidental serialization of PINs and passphrases. Ensures zeroization on drop and redacted Debug output for all config structs holding secrets in trustedge-core.

Output: Hardened YubiKeyConfig and SoftwareHsmConfig with updated tests, examples, and demo binaries.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-secret-hardening/31-01-SUMMARY.md
@crates/core/src/backends/yubikey.rs
@crates/core/src/backends/software_hsm.rs
@crates/core/tests/software_hsm_integration.rs
@crates/core/tests/yubikey_integration.rs
@crates/core/examples/verify_yubikey.rs
@crates/core/examples/verify_yubikey_custom_pin.rs
@crates/core/src/bin/software-hsm-demo.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden YubiKeyConfig — remove serde, wrap pin in Secret, add builder</name>
  <files>
    crates/core/src/backends/yubikey.rs
    crates/core/tests/yubikey_integration.rs
    crates/core/examples/verify_yubikey.rs
    crates/core/examples/verify_yubikey_custom_pin.rs
  </files>
  <action>
In `crates/core/src/backends/yubikey.rs`:

1. Remove `use serde::{Deserialize, Serialize};` (or keep it only if other structs in this file still need it — check first).

2. Change `YubiKeyConfig` struct:
   - Remove `#[derive(Debug, Clone, Serialize, Deserialize)]` — replace with just `#[derive(Clone)]`
   - Change `pub pin: Option<String>` to `pin: Option<Secret<String>>` (private field)
   - Keep `pub default_slot: String`, `pub verbose: bool`, `pub max_pin_retries: u8` as public
   - Add `use crate::secret::Secret;` import

3. Implement `fmt::Debug for YubiKeyConfig` manually:
   - Output struct-like format with all fields visible except `pin` which shows `[REDACTED]`
   - Example: `YubiKeyConfig { pin: [REDACTED], default_slot: "9c", verbose: false, max_pin_retries: 3 }`

4. Add getter: `pub fn pin(&self) -> Option<&str>` that returns `self.pin.as_ref().map(|s| s.expose_secret().as_str())`.

5. Add builder pattern:
   ```rust
   pub struct YubiKeyConfigBuilder {
       pin: Option<Secret<String>>,
       default_slot: String,
       verbose: bool,
       max_pin_retries: u8,
   }

   impl YubiKeyConfig {
       pub fn builder() -> YubiKeyConfigBuilder { ... }
   }

   impl YubiKeyConfigBuilder {
       pub fn pin(mut self, pin: String) -> Self { self.pin = Some(Secret::new(pin)); self }
       pub fn default_slot(mut self, slot: String) -> Self { ... }
       pub fn verbose(mut self, verbose: bool) -> Self { ... }
       pub fn max_pin_retries(mut self, retries: u8) -> Self { ... }
       pub fn build(self) -> YubiKeyConfig { ... }
   }
   ```

6. Update `Default for YubiKeyConfig` to use builder internally or direct construction (keeping same defaults).

7. Update all internal usages of `self.config.pin.clone()` to use `self.config.pin()` (returns Option<&str>). Search for `.pin` access throughout the file and update. The `connect_with_pin` and similar methods that need the PIN string should receive it from `pin()`.

8. Add test in the existing `#[cfg(test)]` module:
   - `test_config_debug_redacts_pin`: Create config with a pin, format with `{:?}`, assert contains `[REDACTED]` and does NOT contain the actual pin value.
   - `test_config_builder`: Verify builder constructs correct config.

9. Update `crates/core/tests/yubikey_integration.rs` `create_test_config()`:
   - Change from struct literal `YubiKeyConfig { pin: Some(pin), ... }` to `YubiKeyConfig::builder().pin(pin).default_slot("9c".to_string()).verbose(true).max_pin_retries(3).build()`

10. Update `crates/core/examples/verify_yubikey.rs` and `verify_yubikey_custom_pin.rs`:
    - Change from struct literal to builder pattern
    - Ensure PIN string is wrapped via builder `.pin()` method

11. Also update `crates/platform/src/ca/service.rs` `create_yubikey_ca_service()` function. IMPORTANT: Note that this function currently uses fields `pkcs11_module_path` and `slot` that do NOT exist on the actual YubiKeyConfig struct (this is stale code from platform consolidation). Convert this to use the builder pattern with the correct fields: `.pin(pin)`, `.default_slot(...)`, `.verbose(true)`, `.build()`. Drop the non-existent `pkcs11_module_path` and `slot` fields.
  </action>
  <verify>
    Run `cargo build -p trustedge-core --features yubikey` to verify YubiKey compiles.
    Run `cargo test -p trustedge-core --lib -- yubikey` to verify YubiKey unit tests pass.
    Run `cargo build -p trustedge-platform --features "ca,yubikey"` to verify platform compiles.
    Run `cargo clippy -p trustedge-core --features yubikey -- -D warnings` to verify no lint issues.
  </verify>
  <done>
    YubiKeyConfig has no Serialize/Deserialize, pin is Secret<String>, Debug redacts pin, builder pattern works, all call sites updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Harden SoftwareHsmConfig — remove serde, wrap passphrase in Secret, add builder</name>
  <files>
    crates/core/src/backends/software_hsm.rs
    crates/core/src/bin/software-hsm-demo.rs
    crates/core/tests/software_hsm_integration.rs
  </files>
  <action>
In `crates/core/src/backends/software_hsm.rs`:

1. Change `SoftwareHsmConfig` struct:
   - Remove `Serialize, Deserialize` from derive — keep only `Clone`
   - Change `pub default_passphrase: String` to `default_passphrase: Secret<String>` (private field)
   - Keep `pub key_store_path: PathBuf` and `pub metadata_file: PathBuf` as public
   - Add `use crate::secret::Secret;` import

2. Implement `fmt::Debug for SoftwareHsmConfig` manually:
   - Show all fields except `default_passphrase` which shows `[REDACTED]`

3. Add getter: `pub fn default_passphrase(&self) -> &str` that returns `self.default_passphrase.expose_secret().as_str()`.

4. Add builder pattern:
   ```rust
   pub struct SoftwareHsmConfigBuilder {
       key_store_path: PathBuf,
       default_passphrase: Secret<String>,
       metadata_file: PathBuf,
   }

   impl SoftwareHsmConfig {
       pub fn builder() -> SoftwareHsmConfigBuilder { ... }
   }

   impl SoftwareHsmConfigBuilder {
       pub fn key_store_path(mut self, path: PathBuf) -> Self { ... }
       pub fn default_passphrase(mut self, passphrase: String) -> Self {
           self.default_passphrase = Secret::new(passphrase); self
       }
       pub fn metadata_file(mut self, path: PathBuf) -> Self { ... }
       pub fn build(self) -> SoftwareHsmConfig { ... }
   }
   ```

5. Update `Default for SoftwareHsmConfig` to use builder or direct construction with `Secret::new(...)`.

6. Update all internal usages of `self.config.default_passphrase` in `SoftwareHsmBackend`:
   - Search for `.default_passphrase` throughout the file
   - Replace with `self.config.default_passphrase()` (the getter returning `&str`)
   - The internal methods that encrypt/decrypt keys with the passphrase should use the getter

7. Add test in the existing `#[cfg(test)]` module:
   - `test_config_debug_redacts_passphrase`: Create config with a passphrase, format with `{:?}`, assert contains `[REDACTED]` and does NOT contain the actual passphrase.
   - `test_config_builder`: Verify builder produces correct config.

8. Update `crates/core/src/bin/software-hsm-demo.rs`:
   - Change from struct literal `SoftwareHsmConfig { ... }` to builder pattern

9. Update `crates/core/tests/software_hsm_integration.rs`:
   - Change ALL struct literal constructions of `SoftwareHsmConfig { ... }` to builder pattern
   - There are ~5 instances in this file (create_test_hsm_setup, test_backend_creation_default_config, test_key_store_directory_creation, test_metadata_persistence, and the readonly config)

10. Update internal tests in `software_hsm.rs` (the `#[cfg(test)]` module):
    - Change the `create_test_backend()` helper and any other `SoftwareHsmConfig { ... }` literals to builder pattern
  </action>
  <verify>
    Run `cargo test -p trustedge-core --lib -- software_hsm` to verify SoftwareHsm unit tests pass.
    Run `cargo test -p trustedge-core --test software_hsm_integration` to verify integration tests pass.
    Run `cargo clippy -p trustedge-core -- -D warnings` to verify no lint issues.
  </verify>
  <done>
    SoftwareHsmConfig has no Serialize/Deserialize, default_passphrase is Secret<String>, Debug redacts passphrase, builder pattern works, all call sites updated (tests, demo binary, integration tests).
  </done>
</task>

</tasks>

<verification>
1. `cargo build --workspace` — entire workspace compiles
2. `cargo test -p trustedge-core --lib` — all core unit tests pass
3. `cargo test -p trustedge-core --test software_hsm_integration` — integration tests pass
4. `cargo build -p trustedge-core --features yubikey` — YubiKey feature compiles
5. `cargo clippy --workspace -- -D warnings` — no new warnings
6. Confirm: `grep -n "Serialize" crates/core/src/backends/yubikey.rs` shows no Serialize on YubiKeyConfig
7. Confirm: `grep -n "Serialize" crates/core/src/backends/software_hsm.rs` shows no Serialize on SoftwareHsmConfig
</verification>

<success_criteria>
- YubiKeyConfig and SoftwareHsmConfig cannot be serialized (compile error if attempted)
- Secret fields are zeroized on drop via Secret<T>
- Debug output shows [REDACTED] for PIN and passphrase fields
- Builder pattern available for both configs
- All existing tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/31-secret-hardening/31-02-SUMMARY.md`
</output>
