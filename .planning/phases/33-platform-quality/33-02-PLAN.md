---
phase: 33-platform-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/platform/src/http/router.rs
  - crates/platform/src/ca/mod.rs
  - crates/platform/src/ca/api.rs
  - crates/platform/src/ca/database.rs
  - crates/platform/src/ca/auth.rs
  - crates/platform/src/ca/service.rs
  - crates/platform/src/ca/models.rs
  - crates/platform/src/ca/error.rs
  - crates/platform/src/lib.rs
autonomous: true
requirements:
  - PLT-02
  - PLT-03

must_haves:
  truths:
    - "Building trustedge-platform without postgres feature produces a server with restrictive CORS that rejects cross-origin requests"
    - "Building trustedge-platform with postgres feature produces a server that allows localhost:3000 and localhost:8080 origins with only Content-Type, Authorization, and Accept headers"
    - "CA module api.rs contains plain service functions, not Axum handlers — no axum::extract or axum::Router references remain"
    - "Each CA sub-module has a doc comment explaining its current status and usage"
  artifacts:
    - path: "crates/platform/src/http/router.rs"
      provides: "Restrictive CORS for non-postgres, header-restricted CORS for postgres"
      contains: "CorsLayer::new()"
    - path: "crates/platform/src/ca/mod.rs"
      provides: "Library-only documentation with no HTTP exposure note"
      contains: "library-only"
    - path: "crates/platform/src/ca/api.rs"
      provides: "Plain service functions without Axum coupling"
  key_links:
    - from: "crates/platform/src/http/router.rs"
      to: "tower_http::cors::CorsLayer"
      via: "CORS layer configuration"
      pattern: "CorsLayer::new"
---

<objective>
Harden CORS policy for both platform build variants and clarify the CA module's disposition as library-only code without HTTP exposure.

Purpose: Eliminate the security gap where the verify-only build accepts all cross-origin requests, restrict allowed headers on the full build, and remove Axum coupling from the CA module to accurately reflect its status as a library-only component.

Output: Hardened router.rs with restrictive CORS, refactored CA module with plain service functions and status annotations.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@crates/platform/src/http/router.rs
@crates/platform/src/ca/mod.rs
@crates/platform/src/ca/api.rs
@crates/platform/src/ca/service.rs
@crates/platform/src/ca/auth.rs
@crates/platform/src/ca/database.rs
@crates/platform/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden CORS policy for both build variants</name>
  <files>crates/platform/src/http/router.rs</files>
  <action>
Modify `create_router()` in `crates/platform/src/http/router.rs`:

1. **Non-postgres build** (the `#[cfg(not(feature = "postgres"))]` block):
   - Replace `CorsLayer::permissive()` with a restrictive CORS that effectively blocks all cross-origin requests.
   - Use `CorsLayer::new()` with NO `allow_origin`, NO `allow_methods`, NO `allow_headers` — this creates a CORS layer that will reject all preflight requests and not add Access-Control-Allow-Origin headers to responses. This means same-origin requests work fine but cross-origin requests get blocked by the browser.
   - Alternatively, use `CorsLayer::very_restrictive()` if available, or construct with: `CorsLayer::new()` (default denies everything per tower-http docs).
   - Add a comment: `// Same-origin only — no cross-origin requests allowed for verify-only builds`

2. **Postgres build** (the `#[cfg(feature = "postgres")]` block):
   - Keep the existing allowed origins: `http://localhost:3000` and `http://localhost:8080`
   - Keep the existing allowed methods: GET and POST
   - **Replace** `.allow_headers(tower_http::cors::Any)` with explicit headers:
     ```rust
     .allow_headers([
         axum::http::header::CONTENT_TYPE,
         axum::http::header::AUTHORIZATION,
         axum::http::header::ACCEPT,
     ])
     ```
   - Add a comment: `// Dashboard dev origins — restrict to Content-Type, Authorization, Accept`

3. The imports at the top of the file may need updating — ensure `tower_http::cors::CorsLayer` is imported (it already is).
  </action>
  <verify>
Run `cargo build -p trustedge-platform --features http` — non-postgres variant compiles.
Run `cargo build -p trustedge-platform --features "http,postgres"` — postgres variant compiles.
Run `cargo clippy -p trustedge-platform --features "http,postgres" -- -D warnings` — no warnings.
Run `cargo test -p trustedge-platform --test verify_integration --features http` — integration tests pass (they don't test CORS directly but must not regress).
Inspect router.rs: confirm `CorsLayer::permissive()` no longer appears anywhere in the file.
Inspect router.rs: confirm `tower_http::cors::Any` no longer appears anywhere in the file.
  </verify>
  <done>
Non-postgres build uses restrictive (same-origin only) CORS. Postgres build allows localhost:3000 and localhost:8080 with only Content-Type, Authorization, and Accept headers. No `permissive()` or `Any` references remain in router.rs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor CA module as library-only and annotate sub-modules</name>
  <files>
    crates/platform/src/ca/mod.rs
    crates/platform/src/ca/api.rs
    crates/platform/src/ca/database.rs
    crates/platform/src/ca/auth.rs
    crates/platform/src/ca/service.rs
    crates/platform/src/ca/models.rs
    crates/platform/src/ca/error.rs
    crates/platform/src/lib.rs
  </files>
  <action>
**Step 1: Update `crates/platform/src/ca/mod.rs` module-level doc comment:**
- Replace the existing doc comment with:
  ```
  //! Certificate Authority module — library-only, not wired into the HTTP router.
  //!
  //! This module provides enterprise-grade PKI services using TrustEdge's Universal Backend system.
  //! It is feature-gated behind the `ca` feature flag and currently used only as a library
  //! (imported directly by consumers, not exposed via HTTP endpoints in `create_router()`).
  //!
  //! **Future:** CA routes may be exposed via the platform HTTP layer behind the `ca` feature flag.
  //! When that happens, `api.rs` service functions will be wrapped with Axum handler shims.
  ```
- Remove the stale comment `// Phase 26 will wire up all CA internals; suppress dead_code until then` — phase 26 is done, the suppress is just for the library-only status now. Keep the `#![allow(dead_code)]` but update the comment to: `// Library-only module: functions are public API but not called from HTTP handlers yet`

**Step 2: Refactor `crates/platform/src/ca/api.rs`:**
Remove all Axum coupling — convert Axum handlers to plain service functions:
- Remove the `use axum::{...}` import block entirely
- Remove `pub type AppState = Arc<CertificateAuthorityService>;`
- Remove the `pub fn create_router(...)` function
- Convert each handler to a plain async service function:
  - `health_check()` -> remove entirely (trivial, not needed as library function)
  - `get_ca_certificate(State(ca_service): State<AppState>)` -> `pub fn get_ca_certificate(ca_service: &CertificateAuthorityService) -> String`
  - `issue_certificate(State(ca_service): State<AppState>, Json(request): Json<IssueCertificateRequest>)` -> `pub async fn issue_certificate(ca_service: &CertificateAuthorityService, request: &IssueCertificateRequest) -> Result<IssueCertificateResponse, CAError>`
  - `revoke_certificate(State(ca_service): State<AppState>, Path(serial): Path<String>, Json(request): Json<RevokeCertificateRequest>)` -> `pub async fn revoke_certificate(ca_service: &CertificateAuthorityService, serial: &str, request: &RevokeCertificateRequest) -> Result<(), CAError>`
  - `list_certificates(State(_ca_service): State<AppState>, Query(query): Query<ListCertificatesQuery>)` -> `pub fn list_certificates(query: &ListCertificatesQuery) -> Result<ListCertificatesResponse, String>`
- Keep the validation functions (`validate_certificate_request`, `validate_revocation_request`, `validate_list_query`) as they are — they're already plain functions
- Keep the `map_ca_error_to_http` function but rename it to `map_ca_error_to_status` and return `(u16, ErrorResponse)` instead of `(StatusCode, ErrorResponse)` to remove the axum dependency. Or simply remove it since it's HTTP-specific and will only be needed when/if routes are wired.
- Remove `ListCertificatesQuery`'s `#[derive(Deserialize)]` from `serde::Deserialize` — wait, it still needs Deserialize for potential future use. Keep Deserialize, just remove axum-specific `Query` extractor usage.
- Keep `create_mock_certificates` as-is (it's a data function, no Axum coupling).
- Remove the `#[cfg(feature = "http")]` gate from `pub mod api;` in `ca/mod.rs` — the refactored api.rs has no HTTP dependencies and should always compile when `ca` is enabled.
- Update all existing tests in `api.rs` to work with the new signatures — they should be simpler since no Axum extractors involved.

**Step 3: Annotate each CA sub-module with a doc comment about current status:**
- `ca/auth.rs`: Add/update doc comment: `//! CA authentication module — JWT-based tenant authentication.\n//!\n//! Status: Library-only. Provides token generation and validation\n//! for CA service consumers. Not wired into the platform HTTP auth middleware.`
- `ca/database.rs`: Add/update doc comment: `//! CA database module — in-memory certificate storage.\n//!\n//! Status: Library-only. Provides multi-tenant certificate storage\n//! backed by an in-memory HashMap. Not connected to the platform PostgreSQL backend.`
- `ca/service.rs`: Add/update doc comment: `//! CA service — core certificate authority operations.\n//!\n//! Status: Library-only. Provides certificate issuance, revocation,\n//! and listing via the Universal Backend system. Consumed directly by library callers.`
- `ca/models.rs`: Add/update doc comment: `//! CA data models — certificate, tenant, and request types.\n//!\n//! Status: Stable types used by the CA service and its consumers.`
- `ca/error.rs`: Add/update doc comment: `//! CA error types.\n//!\n//! Status: Stable error enum used by all CA operations.`

**Step 4: Update `crates/platform/src/lib.rs`:**
- The `ca` module is currently `mod ca` (private). Keep it private — this is correct for library-only status. Add a comment if not already present: `// CA module is library-only; not exposed via HTTP routes`
  </action>
  <verify>
Run `cargo build -p trustedge-platform --features ca` — CA module compiles without Axum deps.
Run `cargo build -p trustedge-platform --features "http,ca"` — compiles when both features are on.
Run `cargo build -p trustedge-platform --features "http,postgres,ca"` — full feature set compiles.
Run `cargo test -p trustedge-platform --features ca --lib` — CA module tests pass.
Run `cargo clippy -p trustedge-platform --features "http,postgres,ca" -- -D warnings` — no warnings.
Inspect `ca/api.rs`: confirm no `axum::` references remain.
Inspect `ca/mod.rs`: confirm "library-only" appears in the doc comment.
  </verify>
  <done>
CA api.rs contains plain service functions with no Axum imports. Each CA sub-module has a status doc comment. ca/mod.rs documents the module as library-only with a note about future HTTP exposure. The `#[cfg(feature = "http")]` gate on `pub mod api` is removed so api.rs compiles with just the `ca` feature.
  </done>
</task>

</tasks>

<verification>
1. `cargo build -p trustedge-platform --features http` — verify-only build with restrictive CORS compiles
2. `cargo build -p trustedge-platform --features "http,postgres"` — full build with hardened CORS compiles
3. `cargo build -p trustedge-platform --features ca` — CA module compiles without http feature
4. `cargo build -p trustedge-platform --features "http,postgres,ca"` — all features compile
5. `cargo test -p trustedge-platform --lib` — all unit tests pass
6. `cargo test -p trustedge-platform --features ca --lib` — CA tests pass
7. `cargo test -p trustedge-platform --test verify_integration --features http` — integration tests pass
8. `cargo clippy -p trustedge-platform --features "http,postgres,ca" -- -D warnings` — zero clippy warnings
9. grep router.rs: "permissive" returns 0 matches
10. grep router.rs: "cors::Any" returns 0 matches
11. grep ca/api.rs: "axum" returns 0 matches
12. grep ca/mod.rs: "library-only" returns 1+ matches
</verification>

<success_criteria>
- Non-postgres CORS blocks cross-origin requests (no permissive layer)
- Postgres CORS allows only Content-Type, Authorization, Accept headers
- CA api.rs has zero Axum coupling (no axum imports)
- All CA sub-modules have status doc comments
- ca/mod.rs clearly documents library-only status with future exposure note
- All builds compile and all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/33-platform-quality/33-02-SUMMARY.md`
</output>
