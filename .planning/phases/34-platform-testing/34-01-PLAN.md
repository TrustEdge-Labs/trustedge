---
phase: 34-platform-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/platform-server/tests/wiring.rs
  - crates/platform-server/Cargo.toml
autonomous: true
requirements: [TST-01]

must_haves:
  truths:
    - "cargo test -p trustedge-platform-server runs wiring integration tests without panicking"
    - "Config::from_env uses sensible defaults and does not require env vars to succeed in verify-only mode"
    - "AppState construction with KeyManager succeeds and the router responds to health checks"
  artifacts:
    - path: "crates/platform-server/tests/wiring.rs"
      provides: "Platform-server integration tests for startup wiring and env config"
      min_lines: 60
    - path: "crates/platform-server/Cargo.toml"
      provides: "Dev-dependencies for integration tests (tower, hyper)"
      contains: "[dev-dependencies]"
  key_links:
    - from: "crates/platform-server/tests/wiring.rs"
      to: "trustedge_platform::http::Config"
      via: "Config::from_env() call"
      pattern: "Config::from_env"
    - from: "crates/platform-server/tests/wiring.rs"
      to: "trustedge_platform::http::create_router"
      via: "router construction and oneshot request"
      pattern: "create_router"
---

<objective>
Add integration tests to the `trustedge-platform-server` binary crate that validate startup wiring: Config loading from environment, AppState construction, and router health check.

Purpose: TST-01 requires that `cargo test -p trustedge-platform-server` exercises AppState construction, env var wiring, and confirms the router starts without panicking.

Output: `crates/platform-server/tests/wiring.rs` with 3-4 tests, updated Cargo.toml dev-dependencies.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@crates/platform-server/src/main.rs
@crates/platform-server/Cargo.toml
@crates/platform/src/http/config.rs
@crates/platform/src/http/state.rs
@crates/platform/src/http/router.rs
@crates/platform/src/http/mod.rs
@crates/platform/src/verify/jwks.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dev-dependencies and create wiring integration tests</name>
  <files>
    crates/platform-server/Cargo.toml
    crates/platform-server/tests/wiring.rs
  </files>
  <action>
1. Add dev-dependencies to `crates/platform-server/Cargo.toml`:
   - `tower = { workspace = true, features = ["util"] }` (for ServiceExt::oneshot)
   - `axum = { workspace = true }` (for Body, Request, StatusCode)
   - `tokio = { workspace = true }` (already a dep, but needed with test macro)

2. Create `crates/platform-server/tests/wiring.rs` with the MPL-2.0 copyright header.

   The platform-server has `default = ["postgres"]` features, but wiring tests cover verify-only mode only (per user decision). Use `#[cfg(not(feature = "postgres"))]` to gate the entire test module so tests run only in verify-only mode.

   Actually, since the test binary inherits the crate's default features, and `default = ["postgres"]` is set, the tests would be gated out by default. Instead, run the tests explicitly with `--no-default-features`. The test module should NOT be feature-gated — it should test the non-postgres code path unconditionally. The CI command will be `cargo test -p trustedge-platform-server --no-default-features --test wiring`.

   Write these tests:

   a. `test_config_from_env_defaults`: Call `Config::from_env()` without setting any env vars. Assert it succeeds, port defaults to 3001, jwt_audience defaults to "trustedge-platform".

   b. `test_config_from_env_custom_port`: Set `PORT=9999` env var, call `Config::from_env()`, assert port is 9999. Use `std::env::set_var` / `remove_var` with care (or use a serial test approach). Since these tests manipulate env vars, they should run sequentially. Add a note about this.

   c. `test_appstate_construction_and_router_health`: Construct a `KeyManager::new()`, create `AppState { keys: Arc::new(RwLock::new(key_manager)) }`, call `create_router(state)`, send a GET /healthz request via `tower::ServiceExt::oneshot`, assert HTTP 200 and body contains `"status":"OK"`.

   d. `test_router_verify_rejects_empty_body`: Using the same router construction as above, send a POST /v1/verify with empty JSON `{}`, assert HTTP 400 (bad request due to missing fields — serde deserialization fails).

   All tests use `#[tokio::test]` and import from `trustedge_platform::http::{create_router, AppState, Config}` and `trustedge_platform::verify::jwks::KeyManager`.

   IMPORTANT: The platform-server crate depends on `trustedge-platform` with features `["http", "openapi"]`. When testing with `--no-default-features`, the `postgres` feature is dropped from platform-server, but `http` and `openapi` remain (they are hardcoded in [dependencies], not in features). This means Config, AppState, create_router are all available in the non-postgres variant. Verify this compiles.
  </action>
  <verify>
Run: `cargo test -p trustedge-platform-server --no-default-features --test wiring -- --nocapture`
All 4 tests should pass. Also verify: `cargo clippy -p trustedge-platform-server --no-default-features --tests -- -D warnings` has no warnings.
  </verify>
  <done>
`cargo test -p trustedge-platform-server --no-default-features --test wiring` runs 4 tests, all pass. AppState constructs, router responds to health, Config defaults work.
  </done>
</task>

</tasks>

<verification>
```bash
# All wiring tests pass in verify-only mode
cargo test -p trustedge-platform-server --no-default-features --test wiring

# Clippy clean
cargo clippy -p trustedge-platform-server --no-default-features --tests -- -D warnings

# Existing workspace tests still pass
cargo test -p trustedge-platform --test verify_integration
```
</verification>

<success_criteria>
- `cargo test -p trustedge-platform-server --no-default-features --test wiring` passes with 4 tests
- Tests validate Config defaults, custom env vars, AppState+router health, and verify endpoint rejection
- No clippy warnings
- No regression in existing platform tests
</success_criteria>

<output>
After completion, create `.planning/phases/34-platform-testing/34-01-SUMMARY.md`
</output>
