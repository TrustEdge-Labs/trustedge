---
phase: 09-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/core/src/backends/yubikey.rs
  - crates/core/src/backends/mod.rs
  - crates/core/src/backends/universal_registry.rs
  - crates/core/src/transport/quic.rs
  - crates/core/src/lib.rs
  - crates/core/Cargo.toml
  - crates/core/src/bin/yubikey-demo.rs
  - crates/core/tests/yubikey_certificate_debug.rs
  - crates/core/tests/yubikey_hardware_detection.rs
  - crates/core/tests/yubikey_hardware_tests.rs
  - crates/core/tests/yubikey_integration.rs
  - crates/core/tests/yubikey_piv_analysis.rs
  - crates/core/tests/yubikey_simulation_tests.rs
  - crates/core/tests/yubikey_strict_hardware.rs
  - crates/core/tests/yubikey_real_operations.rs
  - crates/core/examples/yubikey_certificate_demo.rs
  - crates/core/examples/yubikey_demo.rs
  - crates/core/examples/yubikey_enhanced_cert_demo.rs
  - crates/core/examples/yubikey_hardware_signing_demo.rs
  - crates/core/examples/yubikey_phase2c_demo.rs
  - crates/core/examples/yubikey_pubkey_demo.rs
  - crates/core/examples/yubikey_quic_demo.rs
  - crates/core/examples/yubikey_quic_hardware_demo.rs
autonomous: true

must_haves:
  truths:
    - "Old yubikey.rs backend (3,263 lines) is completely deleted"
    - "All 8 YubiKey test files are deleted"
    - "All 8 YubiKey example files and 1 binary are deleted"
    - "untested feature flag is removed from yubikey dependency"
    - "Codebase contains zero placeholder keys, placeholder signatures, or manual DER encoding in backends/transport"
    - "Project compiles without features, with audio feature, and full workspace tests pass"
    - "yubikey dependency and feature flag are preserved for v1.1 reuse"
  artifacts:
    - path: "crates/core/src/backends/yubikey.rs"
      provides: "DELETED — must not exist"
    - path: "crates/core/src/backends/mod.rs"
      provides: "Module exports without yubikey references"
      contains: "pub mod software_hsm"
    - path: "crates/core/Cargo.toml"
      provides: "yubikey dep without untested flag, no yubikey-demo binary"
      contains: "yubikey = { version = \"0.7\", optional = true }"
    - path: "crates/core/src/transport/quic.rs"
      provides: "QUIC transport without any yubikey-gated placeholder code"
    - path: "crates/core/src/backends/universal_registry.rs"
      provides: "Registry without YubiKeyBackend import or registration block"
    - path: "crates/core/src/lib.rs"
      provides: "Feature docs updated to mark yubikey as experimental/v1.1"
  key_links:
    - from: "crates/core/src/backends/mod.rs"
      to: "crates/core/src/backends/yubikey.rs"
      via: "pub mod yubikey — must be removed"
      pattern: "pub mod yubikey"
    - from: "crates/core/src/backends/universal_registry.rs"
      to: "crates/core/src/backends/yubikey.rs"
      via: "cfg-gated import and registration block — must be removed"
      pattern: "YubiKeyBackend"
    - from: "crates/core/Cargo.toml"
      to: "yubikey dependency"
      via: "features = [\"untested\"] must be removed, dep:yubikey must stay"
      pattern: "features = \\[\"untested\"\\]"
---

<objective>
Scorched-earth deletion of all broken YubiKey code from trustedge-core.

Purpose: Remove 3,263-line broken backend, 8 test files, 8 example files, 1 demo binary, and all placeholder/manual-DER patterns. This clears the way for a clean v1.1 rewrite. The yubikey dependency and feature flag are preserved for reuse.

Output: Clean codebase with zero YubiKey implementation code, passing compilation and tests.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-cleanup/09-RESEARCH.md
@crates/core/src/backends/mod.rs
@crates/core/src/backends/universal_registry.rs
@crates/core/src/transport/quic.rs
@crates/core/src/lib.rs
@crates/core/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete YubiKey files and update module references</name>
  <files>
    crates/core/src/backends/yubikey.rs
    crates/core/src/backends/mod.rs
    crates/core/src/backends/universal_registry.rs
    crates/core/src/lib.rs
    crates/core/Cargo.toml
    crates/core/src/bin/yubikey-demo.rs
    crates/core/tests/yubikey_certificate_debug.rs
    crates/core/tests/yubikey_hardware_detection.rs
    crates/core/tests/yubikey_hardware_tests.rs
    crates/core/tests/yubikey_integration.rs
    crates/core/tests/yubikey_piv_analysis.rs
    crates/core/tests/yubikey_simulation_tests.rs
    crates/core/tests/yubikey_strict_hardware.rs
    crates/core/tests/yubikey_real_operations.rs
    crates/core/examples/yubikey_certificate_demo.rs
    crates/core/examples/yubikey_demo.rs
    crates/core/examples/yubikey_enhanced_cert_demo.rs
    crates/core/examples/yubikey_hardware_signing_demo.rs
    crates/core/examples/yubikey_phase2c_demo.rs
    crates/core/examples/yubikey_pubkey_demo.rs
    crates/core/examples/yubikey_quic_demo.rs
    crates/core/examples/yubikey_quic_hardware_demo.rs
  </files>
  <action>
    Delete all YubiKey implementation files, then update module references so the codebase compiles.

    **Step 1 — Delete files via git rm (18 files total):**

    Backend (1 file):
    - `git rm crates/core/src/backends/yubikey.rs`

    Tests (8 files):
    - `git rm crates/core/tests/yubikey_certificate_debug.rs`
    - `git rm crates/core/tests/yubikey_hardware_detection.rs`
    - `git rm crates/core/tests/yubikey_hardware_tests.rs`
    - `git rm crates/core/tests/yubikey_integration.rs`
    - `git rm crates/core/tests/yubikey_piv_analysis.rs`
    - `git rm crates/core/tests/yubikey_simulation_tests.rs`
    - `git rm crates/core/tests/yubikey_strict_hardware.rs`
    - `git rm crates/core/tests/yubikey_real_operations.rs`

    Examples (8 files):
    - `git rm crates/core/examples/yubikey_*.rs`

    Binary (1 file):
    - `git rm crates/core/src/bin/yubikey-demo.rs`

    **Step 2 — Edit `crates/core/src/backends/mod.rs`:**

    Remove line 29: `pub mod yubikey;`

    Remove line 37: `pub use yubikey::{CertificateParams, HardwareCertificate, YubiKeyBackend, YubiKeyConfig};`

    Update the module doc comment (line 17) — remove "- YubiKey backend (PKCS#11 hardware tokens)" from the list. Optionally add "- YubiKey backend (planned for v1.1)" to the "Planned backends" section.

    **Step 3 — Edit `crates/core/src/backends/universal_registry.rs`:**

    Remove lines 16-17 entirely (the cfg-gated import):
    ```rust
    #[cfg(feature = "yubikey")]
    use crate::backends::yubikey::YubiKeyBackend;
    ```

    Remove lines 53-59 entirely (the cfg-gated registration block):
    ```rust
    // Add YubiKey backend if available and feature enabled
    #[cfg(feature = "yubikey")]
    {
        if let Ok(yubikey_backend) = YubiKeyBackend::new() {
            registry.register_backend("yubikey".to_string(), Box::new(yubikey_backend));
        }
    }
    ```

    These blocks reference the deleted YubiKeyBackend type. They will be re-added in Phase 10 with the new backend.

    **Step 4 — Edit `crates/core/Cargo.toml`:**

    Line 62: Change `yubikey = { version = "0.7", optional = true, features = ["untested"] }` to `yubikey = { version = "0.7", optional = true }` (remove `features = ["untested"]`).

    Lines 35-38: Remove the entire `[[bin]]` block for yubikey-demo:
    ```toml
    [[bin]]
    name = "yubikey-demo"
    path = "src/bin/yubikey-demo.rs"
    required-features = ["yubikey"]
    ```

    KEEP the `yubikey = ["pkcs11", "dep:yubikey", "x509-cert", "der", "spki", "signature"]` feature flag (line 95) — it will be reused by v1.1.

    **Step 5 — Edit `crates/core/src/lib.rs`:**

    Update line 24: Change `- **Hardware Integration**: Full YubiKey PKCS#11 support with real hardware signing` to `- **Hardware Integration**: YubiKey PIV support (experimental, v1.1 rewrite in progress)`

    Update line 72: Change `//! - **\`yubikey\`** — YubiKey PIV hardware signing and key management via PKCS#11.` to `//! - **\`yubikey\`** — YubiKey PIV support (experimental, v1.1 rewrite in progress).`

    Update line 73: Change `//!   Requires PCSC libraries (\`libpcsclite-dev\` on Linux, built-in on macOS).` to `//!   Requires PCSC libraries (\`libpcsclite-dev\` on Linux, built-in on macOS). Implementation removed pending rewrite.`

    **Step 6 — Verify compilation:**

    Run `cargo check` (default, no features) — must pass.
  </action>
  <verify>
    `cargo check` passes with no errors. All 18 files confirmed deleted (git status shows them as deleted).
  </verify>
  <done>
    yubikey.rs deleted, 8 test files deleted, 8 example files deleted, yubikey-demo binary deleted. Module exports in mod.rs updated. Registry import/block removed. Cargo.toml untested flag removed and yubikey-demo binary section removed. lib.rs docs updated. Default cargo check passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean quic.rs YubiKey code and run full verification</name>
  <files>
    crates/core/src/transport/quic.rs
  </files>
  <action>
    Remove all YubiKey-specific placeholder code from quic.rs, then run comprehensive verification for all CLEAN requirements.

    **Step 1 — Edit `crates/core/src/transport/quic.rs`:**

    Remove the top-level import (lines 12-13):
    ```rust
    #[cfg(feature = "yubikey")]
    use crate::backends::HardwareCertificate;
    ```

    Remove the `create_hardware_server_endpoint` method (lines 123-150) — the entire `#[cfg(feature = "yubikey")]` block that creates a server endpoint with placeholder private key.

    Remove the `create_placeholder_private_key` method (lines 152-171) — the `#[cfg(feature = "yubikey")]` helper that returns a hardcoded Ed25519 PKCS#8 key.

    Remove the `connect_with_yubikey_certificate` method (lines 192-263) — the `#[cfg(feature = "yubikey")]` async method that references deleted YubiKeyBackend and CertificateParams types.

    Remove the `create_yubikey_server` method (lines 265-315) — the `#[cfg(feature = "yubikey")]` async method for creating QUIC server with YubiKey cert.

    Remove the `create_yubikey_server_endpoint` method (lines 317-355) — the `#[cfg(feature = "yubikey")]` method that uses `create_demo_private_key()`.

    Remove the `accept_connection` method (lines 357-381) — the `#[cfg(feature = "yubikey")]` accept method.

    Remove the standalone `create_demo_private_key` function (lines 760-793) — the `#[cfg(feature = "yubikey")]` function with hardcoded ECDSA P-256 key bytes.

    Remove the `test_certificate_requirements` test's `#[cfg(feature = "yubikey")]` block (lines 854-872) — references deleted CertificateParams type.

    Remove the `test_yubikey_integration_stubs` test (lines 875-896) — entirely `#[cfg(feature = "yubikey")]` gated, references deleted CertificateParams type.

    After all removals, confirm no remaining `#[cfg(feature = "yubikey")]` annotations exist in quic.rs. The `test_certificate_requirements` test function itself should remain but its body should only contain non-yubikey code. If the function body is now empty (only had the cfg block), delete the entire test function.

    **Step 2 — Multi-stage compilation verification:**

    ```bash
    cargo check                           # Default (no features)
    cargo check --features audio          # Audio feature
    cargo check --features yubikey        # YubiKey feature (deps present, no impl)
    cargo test --workspace                # Full workspace tests
    cargo build --workspace --release     # Release build
    ```

    The `--features yubikey` check may fail because the feature still pulls in deps but there is no backend code. That is acceptable — if it fails, note the error. The important checks are: default, audio, and workspace tests.

    **Step 3 — CLEAN-04 pattern verification (grep):**

    Run these grep commands and verify results:

    ```bash
    # Placeholder patterns — should find ONLY archive.rs and attestation/mod.rs hits
    grep -r "placeholder" crates/core/src/ --include="*.rs"

    # Manual DER encoding — should find ZERO hits
    grep -rn "fn.*to_der\|fn.*encode_asn1\|fn.*build_tbs\|fn.*encode_distinguished\|fn.*encode_validity\|fn.*encode_public_key_info\|fn.*encode_certificate_extensions\|fn.*encode_basic_constraints\|fn.*encode_key_usage\|fn.*encode_san\|fn.*encode_ecdsa_signature\|fn.*build_subject_public_key\|fn.*generate_placeholder\|fn.*build_placeholder" crates/core/src/ --include="*.rs"

    # Fake/dummy keys — should find ZERO hits
    grep -r "fake_key\|dummy_key\|placeholder_key" crates/core/src/ --include="*.rs"

    # Placeholder private key constants — should find ZERO hits
    grep -r "placeholder_key\|create_placeholder_private_key\|create_demo_private_key" crates/core/src/ --include="*.rs"
    ```

    Legitimate remaining "placeholder" hits (DO NOT remove):
    - `archive.rs`: `continuity_hash: "placeholder"` — legitimate manifest field
    - `attestation/mod.rs`: git hash placeholder fallback — legitimate

    Any hit in `backends/`, `transport/`, or `examples/` is a failure — investigate and remove.

    **Step 4 — Final file count verification:**

    ```bash
    # Should return 0 results
    ls crates/core/tests/yubikey_*.rs 2>/dev/null | wc -l
    ls crates/core/examples/yubikey_*.rs 2>/dev/null | wc -l
    ls crates/core/src/bin/yubikey-demo.rs 2>/dev/null | wc -l
    ls crates/core/src/backends/yubikey.rs 2>/dev/null | wc -l
    ```
  </action>
  <verify>
    1. `cargo check` passes (default, audio features).
    2. `cargo test --workspace` passes (all existing tests still pass).
    3. `grep -r "placeholder" crates/core/src/ --include="*.rs"` returns ONLY archive.rs and attestation/mod.rs hits.
    4. `grep -r "create_placeholder_private_key\|create_demo_private_key\|encode_asn1\|build_tbs\|build_placeholder" crates/core/src/ --include="*.rs"` returns zero hits.
    5. No yubikey_*.rs files remain in tests/ or examples/.
    6. `grep -r 'cfg(feature = "yubikey")' crates/core/src/transport/quic.rs` returns zero hits.
  </verify>
  <done>
    All YubiKey placeholder code removed from quic.rs. Multi-stage compilation passes (default + audio + workspace tests). CLEAN-04 grep verification confirms zero placeholder keys, zero manual DER encoding, zero fake keys in backends/transport. Only legitimate "placeholder" references remain in archive.rs and attestation/mod.rs.
  </done>
</task>

</tasks>

<verification>
Requirements verification:

- **CLEAN-01**: `crates/core/src/backends/yubikey.rs` does not exist. Confirmed by `ls` returning no result.
- **CLEAN-02**: All 8 `crates/core/tests/yubikey_*.rs` files do not exist. Confirmed by `ls` returning 0 files.
- **CLEAN-03**: `grep "untested" crates/core/Cargo.toml` returns zero hits. The yubikey dependency line reads `yubikey = { version = "0.7", optional = true }`.
- **CLEAN-04**: `grep -r "placeholder" crates/core/src/ --include="*.rs"` returns only archive.rs and attestation/mod.rs hits. `grep -r "encode_asn1\|build_tbs\|build_placeholder\|create_placeholder\|create_demo_private_key\|fake_key\|dummy_key\|placeholder_key" crates/core/src/ --include="*.rs"` returns zero hits.

Build verification:
- `cargo check` passes (no features)
- `cargo check --features audio` passes
- `cargo test --workspace` passes
- `cargo build --workspace --release` passes
</verification>

<success_criteria>
1. Zero YubiKey implementation files remain (0 backend, 0 tests, 0 examples, 0 binaries)
2. Module system compiles cleanly — no orphaned imports or pub mod declarations
3. `untested` feature flag removed from Cargo.toml, yubikey dep and feature flag preserved
4. All placeholder keys, manual DER functions, and fake key patterns removed from codebase (CLEAN-04)
5. Full workspace compilation and test suite passes
6. lib.rs docs updated to mark yubikey as experimental/v1.1
</success_criteria>

<output>
After completion, create `.planning/phases/09-cleanup/09-01-SUMMARY.md`
</output>
