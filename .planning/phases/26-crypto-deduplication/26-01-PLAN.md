---
phase: 26-crypto-deduplication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/platform/Cargo.toml
  - crates/platform/src/verify/engine.rs
  - crates/platform/src/http/handlers.rs
  - crates/platform/src/ca/api.rs
  - crates/platform/src/ca/auth.rs
  - crates/platform/src/ca/database.rs
  - crates/platform/src/ca/service.rs
autonomous: true
requirements:
  - CRYPTO-01
  - CRYPTO-02

must_haves:
  truths:
    - "engine.rs no longer imports blake3 or ed25519_dalek directly — all crypto goes through trustedge_core"
    - "verify_signature() uses trustedge_core::crypto::verify_manifest for Ed25519 verification"
    - "verify_continuity() and chain functions use trustedge_core::chain::{genesis, chain_next} for BLAKE3 chaining"
    - "handlers.rs uses trustedge_core::chain for manifest digest instead of direct blake3 call"
    - "All Phase 26 placeholder markers in the CA module are renamed to Future"
    - "trustedge-core is an always-on dependency (not gated behind ca feature)"
  artifacts:
    - path: "crates/platform/src/verify/engine.rs"
      provides: "Verification engine using trustedge_core primitives"
      contains: "trustedge_core::chain"
    - path: "crates/platform/Cargo.toml"
      provides: "trustedge-core as mandatory dependency"
      contains: "trustedge-core"
  key_links:
    - from: "crates/platform/src/verify/engine.rs"
      to: "trustedge_core::chain"
      via: "genesis(), chain_next(), blake3_hex_or_b64()"
      pattern: "trustedge_core::chain"
    - from: "crates/platform/src/verify/engine.rs"
      to: "trustedge_core::crypto"
      via: "verify_manifest()"
      pattern: "trustedge_core::crypto"
---

<objective>
Replace all direct blake3 and ed25519-dalek crypto calls in the verification engine and HTTP handlers with calls through trustedge_core's chain and crypto modules. Make trustedge-core an always-on dependency. Rename all "Phase 26:" placeholder markers in the CA module to "Future:".

Purpose: The principle is "trustedge-core owns all cryptographic operations." After this plan, the verify engine and HTTP handlers use core's unified API instead of maintaining parallel hand-rolled implementations.

Output: engine.rs and handlers.rs call trustedge_core for all crypto; CA markers renamed; trustedge-core is always-on in Cargo.toml.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-crypto-deduplication/26-CONTEXT.md
@crates/core/src/chain.rs
@crates/core/src/crypto.rs
@crates/core/src/lib.rs
@crates/platform/Cargo.toml
@crates/platform/src/verify/engine.rs
@crates/platform/src/http/handlers.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace engine.rs crypto with trustedge-core and update Cargo.toml</name>
  <files>
    crates/platform/Cargo.toml
    crates/platform/src/verify/engine.rs
  </files>
  <action>
**Cargo.toml changes:**

1. Move `trustedge-core` from optional (ca-gated) to always-on dependency:
   - Change `trustedge-core = { path = "../core", optional = true }` to `trustedge-core = { path = "../core" }`
   - Remove `"dep:trustedge-core"` from the `ca` feature list (it's no longer optional)

**engine.rs replacement — signature verification:**

Replace the `verify_signature()` function. Currently it manually decodes base64 keys/signatures and calls `ed25519_dalek::{VerifyingKey, Signature, Verifier}`. Replace with `trustedge_core::crypto::verify_manifest()`.

Key API mapping:
- Current: parses "ed25519:" prefix, base64-decodes pubkey, creates `VerifyingKey`, base64-decodes signature, creates `Signature`, calls `verifying_key.verify()`
- New: `trustedge_core::crypto::verify_manifest(device_pub, canonical_bytes, signature_str)` returns `Result<bool, CryptoError>`

BUT there's a format difference: the current engine expects the signature as raw base64 in the manifest JSON `signature` field (no "ed25519:" prefix). And `verify_manifest` in core expects "ed25519:BASE64" format. Also, the current engine's `canonicalize_manifest_for_signature()` removes the `signature` field and re-serializes, while core's `verify_manifest` takes `canonical_bytes` directly.

So the replacement should:
1. Keep `canonicalize_manifest_for_signature()` as-is (it's JSON logic, not crypto)
2. Extract the signature from manifest, prepend "ed25519:" prefix if not already present
3. Ensure device_pub has "ed25519:" prefix (the current code strips it; core expects it present)
4. Call `trustedge_core::crypto::verify_manifest(device_pub, canonical_bytes, &signature_with_prefix)`
5. Map the result: `Ok(true)` → passed, `Ok(false)` → failed, `Err(e)` → error string

The new `verify_signature()`:
```rust
fn verify_signature(manifest: &serde_json::Value, device_pub: &str) -> Result<VerificationResult> {
    // device_pub must have "ed25519:" prefix (unchanged from current API contract)
    if !device_pub.starts_with("ed25519:") {
        return Err(anyhow!("Device public key must have ed25519: prefix"));
    }

    let signature_b64 = manifest
        .get("signature")
        .and_then(|s| s.as_str())
        .ok_or_else(|| anyhow!("Missing signature in manifest"))?;

    let canonicalized = canonicalize_manifest_for_signature(manifest)?;

    // Core expects "ed25519:BASE64" format for signature
    let signature_str = format!("ed25519:{}", signature_b64);

    match trustedge_core::crypto::verify_manifest(device_pub, canonicalized.as_bytes(), &signature_str) {
        Ok(true) => Ok(VerificationResult { passed: true, error: None }),
        Ok(false) => Ok(VerificationResult {
            passed: false,
            error: Some("Signature verification failed".to_string()),
        }),
        Err(e) => Ok(VerificationResult {
            passed: false,
            error: Some(format!("Signature verification failed: {}", e)),
        }),
    }
}
```

**engine.rs replacement — BLAKE3 chaining:**

Replace `compute_genesis_hash()`, `compute_chain_link()`, and `compute_chain_tip()`.

API mapping:
- `compute_genesis_hash()` → `trustedge_core::chain::blake3_hex_or_b64(&trustedge_core::chain::genesis())`
  (core's `genesis()` returns `[u8; 32]`, `blake3_hex_or_b64()` formats as "b3:BASE64")
- `compute_chain_link(prev, hash)` → decode both from "b3:BASE64", call `trustedge_core::chain::chain_next()`, re-encode
- `compute_chain_tip(segments)` → walk segments using genesis + chain_next

Replace these functions using `trustedge_core::chain::{genesis, chain_next, blake3_hex_or_b64}`:

```rust
fn compute_genesis_hash() -> String {
    trustedge_core::chain::blake3_hex_or_b64(&trustedge_core::chain::genesis())
}

fn compute_chain_link(prev: &str, hash: &str) -> String {
    let prev_clean = prev.strip_prefix("b3:").unwrap_or(prev);
    let hash_clean = hash.strip_prefix("b3:").unwrap_or(hash);

    let prev_bytes = BASE64.decode(prev_clean).unwrap_or_default();
    let hash_bytes = BASE64.decode(hash_clean).unwrap_or_default();

    let mut prev_arr = [0u8; 32];
    let mut hash_arr = [0u8; 32];
    if prev_bytes.len() == 32 { prev_arr.copy_from_slice(&prev_bytes); }
    if hash_bytes.len() == 32 { hash_arr.copy_from_slice(&hash_bytes); }

    trustedge_core::chain::blake3_hex_or_b64(&trustedge_core::chain::chain_next(&prev_arr, &hash_arr))
}
```

IMPORTANT: Verify that core's `blake3_hex_or_b64` produces the same output format as the current `compute_genesis_hash`. Both use "b3:" prefix + base64. Core uses its own `base64_encode()` implementation. The current engine uses the `base64` crate's `STANDARD` encoder. These MUST produce identical output. Check by running the genesis test. If they differ, adapt the engine's format functions to decode core's `[u8; 32]` and re-encode with the `base64` crate's STANDARD encoder — e.g.:
```rust
fn format_b3(bytes: &[u8; 32]) -> String {
    format!("b3:{}", BASE64.encode(bytes))
}
```
And use `format_b3(&trustedge_core::chain::genesis())` instead of `blake3_hex_or_b64`.

**Remove unused imports:** Delete `use blake3::Hasher;` and `use ed25519_dalek::{Signature, Verifier, VerifyingKey};` from engine.rs.

**Update engine.rs tests:** The tests in engine.rs that directly use `blake3::Hasher` (test_genesis_hash_computation, test_chain_link_computation) need to be updated. Replace `Hasher` usage with `trustedge_core::chain` equivalents in the test assertions. Keep the same test intent — just use core's API in assertions.
  </action>
  <verify>
Run: `cargo test -p trustedge-platform --lib` — all 12 unit tests must pass.
Run: `cargo test -p trustedge-platform --test verify_integration` — all 5 pure-crypto integration tests must pass.
Grep: `grep -n "use blake3" crates/platform/src/verify/engine.rs` — must return no results.
Grep: `grep -n "use ed25519_dalek" crates/platform/src/verify/engine.rs` — must return no results.
  </verify>
  <done>
engine.rs uses only trustedge_core::chain and trustedge_core::crypto for all cryptographic operations. No direct blake3 or ed25519_dalek imports remain in engine.rs. All existing unit and integration tests pass unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace handlers.rs blake3 digest and rename CA Phase 26 markers</name>
  <files>
    crates/platform/src/http/handlers.rs
    crates/platform/src/ca/api.rs
    crates/platform/src/ca/auth.rs
    crates/platform/src/ca/database.rs
    crates/platform/src/ca/service.rs
  </files>
  <action>
**handlers.rs — replace blake3 digest computation:**

In `compute_manifest_digest_blake3()`, replace `blake3::hash(canonical.as_bytes())` with trustedge_core. Since this function computes a hash of arbitrary bytes, use `trustedge_core::chain::segment_hash()` which does `blake3::hash(bytes).into()` returning `[u8; 32]`, then format with base64:

```rust
fn compute_manifest_digest_blake3(manifest: &Value) -> String {
    let canonical = serde_json::to_string(manifest).unwrap_or_default();
    let hash = trustedge_core::chain::segment_hash(canonical.as_bytes());
    format!("b3:{}", BASE64.encode(&hash))
}
```

This preserves the exact same output format ("b3:" + base64 of BLAKE3 hash).

**CA module — rename all "Phase 26:" markers to "Future:":**

Per the user's locked decision: "Rename all `// Phase 26:` markers to `// Future:` since this phase won't address them — avoids confusion."

Files to update (global find-replace within each file):
- `crates/platform/src/ca/api.rs` — 7 occurrences of "// Phase 26:"
- `crates/platform/src/ca/auth.rs` — 3 occurrences
- `crates/platform/src/ca/database.rs` — 5 occurrences
- `crates/platform/src/ca/service.rs` — 4 occurrences

Replace `// Phase 26:` with `// Future:` in all occurrences. Do NOT change any functional code in the CA module — only the comment markers.
  </action>
  <verify>
Run: `cargo build -p trustedge-platform --features "http"` — must compile successfully.
Run: `cargo build -p trustedge-platform --features "http,postgres,ca"` — must compile with all features.
Grep: `grep -rn "blake3::" crates/platform/src/http/handlers.rs` — must return no results.
Grep: `grep -rn "Phase 26:" crates/platform/src/ca/` — must return no results.
Grep: `grep -rn "// Future:" crates/platform/src/ca/` — must return 19 occurrences (all former Phase 26 markers).
  </verify>
  <done>
handlers.rs uses trustedge_core for BLAKE3 digest computation. All 19 "Phase 26:" markers in CA module are renamed to "Future:". Full platform builds with all feature combinations.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p trustedge-platform --lib` — 12 unit tests pass
2. `cargo test -p trustedge-platform --test verify_integration` — 5 integration tests pass
3. `cargo test -p trustedge-platform --test verify_integration --features http` — 7 integration tests pass (adds HTTP endpoint tests)
4. `grep -rn "use blake3" crates/platform/src/verify/engine.rs` — no direct blake3 imports
5. `grep -rn "use ed25519_dalek" crates/platform/src/verify/engine.rs` — no direct ed25519_dalek imports
6. `grep -rn "blake3::" crates/platform/src/http/handlers.rs` — no direct blake3 usage
7. `grep -rn "Phase 26:" crates/platform/src/ca/` — no remaining Phase 26 markers
8. `cargo clippy -p trustedge-platform -- -D warnings` — no warnings
</verification>

<success_criteria>
- engine.rs imports only trustedge_core for cryptographic operations
- handlers.rs uses trustedge_core for digest computation
- trustedge-core is an always-on dependency of trustedge-platform
- All Phase 26 markers renamed to Future
- All existing tests pass without modification to test assertions
</success_criteria>

<output>
After completion, create `.planning/phases/26-crypto-deduplication/26-01-SUMMARY.md`
</output>
