---
phase: 32-workspace-cleanup
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - Cargo.toml
  - crates/experimental/Cargo.toml
  - crates/experimental/.gitignore
  - .gitignore
autonomous: true
requirements:
  - WRK-03
  - WRK-04

must_haves:
  truths:
    - "Pubky crates live under crates/experimental/ with their own workspace Cargo.toml"
    - "Root workspace members list does not include pubky or pubky-advanced"
    - "Experimental workspace Cargo.lock is gitignored"
    - "Root Cargo.lock no longer contains pubky-specific heavy deps (rsa, x25519-dalek as direct)"
    - "Root workspace.dependencies no longer includes pubky, rsa, x25519-dalek, hkdf"
    - "cargo-machete reports no unused workspace-level deps in the root workspace"
  artifacts:
    - path: "crates/experimental/Cargo.toml"
      provides: "Experimental workspace definition with pubky crates as members"
      contains: "[workspace]"
    - path: "crates/experimental/.gitignore"
      provides: "Gitignore for experimental workspace Cargo.lock"
      contains: "Cargo.lock"
    - path: "Cargo.toml"
      provides: "Root workspace without pubky crates or their workspace deps"
  key_links:
    - from: "crates/experimental/Cargo.toml"
      to: "crates/experimental/pubky/Cargo.toml"
      via: "workspace members"
      pattern: "members.*pubky"
    - from: "crates/experimental/pubky/Cargo.toml"
      to: "crates/core"
      via: "path dependency"
      pattern: 'path = "../../core"'
---

<objective>
Move pubky crates into a separate experimental workspace and clean unused workspace dependencies from the root.

Purpose: Pubky crates bring heavy transitive deps (rsa, x25519-dalek, reqwest, pubky) into the shared Cargo.lock. Isolating them into their own workspace prevents dep graph contamination and simplifies the root workspace. Cleaning unused workspace-level deps after the move keeps the root Cargo.toml honest.
Output: Experimental workspace at `crates/experimental/` with its own Cargo.toml; root workspace cleaned of pubky-specific deps.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-workspace-cleanup/32-01-SUMMARY.md
@Cargo.toml
@crates/pubky/Cargo.toml
@crates/pubky-advanced/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create experimental workspace and move pubky crates</name>
  <files>crates/experimental/Cargo.toml, crates/experimental/.gitignore, crates/experimental/pubky/, crates/experimental/pubky-advanced/</files>
  <action>
1. Create directory structure: `mkdir -p crates/experimental`

2. Move pubky crates into experimental workspace:
   - `mv crates/pubky crates/experimental/pubky`
   - `mv crates/pubky-advanced crates/experimental/pubky-advanced`

3. Create `crates/experimental/Cargo.toml` as a new workspace root:
   ```toml
   # Copyright (c) 2025 TRUSTEDGE LABS LLC
   # MPL-2.0: https://mozilla.org/MPL/2.0/
   # Project: trustedge — Privacy and trust at the edge.
   #
   # Experimental workspace — community/experimental crates.
   # These crates are NOT part of the main workspace CI pipeline.
   # Build with: cd crates/experimental && cargo build

   [workspace]
   members = [
       "pubky",
       "pubky-advanced",
   ]
   resolver = "2"
   ```
   Do NOT add `[workspace.dependencies]` — each crate pins its own versions. This avoids coupling the experimental workspace config to the root workspace.

4. Create `crates/experimental/.gitignore`:
   ```
   /target/
   Cargo.lock
   ```

5. Edit `crates/experimental/pubky/Cargo.toml`:
   - Change all `{ workspace = true }` deps to explicit version pins (copy versions from root Cargo.toml `[workspace.dependencies]`). For example: `anyhow = { workspace = true }` becomes `anyhow = "1.0"`; `tokio = { workspace = true }` becomes `tokio = { version = "1.0", features = ["full"] }`; `clap = { workspace = true }` becomes `clap = { version = "4.5", features = ["derive"] }`; `serde = { workspace = true }` becomes `serde = { version = "1.0", features = ["derive"] }`; etc.
   - Change `trustedge-core = { path = "../core" }` to `trustedge-core = { path = "../../core" }` (path goes up two levels now)
   - Change `pubky = { workspace = true }` to `pubky = "0.5.4"`

6. Edit `crates/experimental/pubky-advanced/Cargo.toml`:
   - Same workspace-to-explicit transformation for all deps. For example: `ed25519-dalek = { workspace = true }` becomes `ed25519-dalek = { version = "2", features = ["rand_core"] }`; `x25519-dalek = { workspace = true, features = ["static_secrets"] }` becomes `x25519-dalek = { version = "2.0", features = ["static_secrets"] }`; `aes-gcm = { workspace = true }` becomes `aes-gcm = "0.10.3"`; etc.
   - Change `trustedge-core = { path = "../core" }` to `trustedge-core = { path = "../../core" }`
   - Change `pubky = { workspace = true }` to `pubky = "0.5.4"`

7. Verify experimental workspace builds: `cd crates/experimental && cargo build`

8. Verify experimental workspace tests: `cd crates/experimental && cargo test`
  </action>
  <verify>
- `ls crates/experimental/Cargo.toml` exists
- `ls crates/experimental/pubky/Cargo.toml` exists
- `ls crates/experimental/pubky-advanced/Cargo.toml` exists
- `cd crates/experimental && cargo build` succeeds
- `ls crates/pubky 2>&1` returns "No such file or directory" (moved)
  </verify>
  <done>Pubky crates live under crates/experimental/ in their own workspace with explicit dep versions and path dependency to trustedge-core.</done>
</task>

<task type="auto">
  <name>Task 2: Clean root workspace deps and verify dep tree reduction</name>
  <files>Cargo.toml</files>
  <action>
1. Edit root `Cargo.toml`:
   - Remove `"crates/pubky"` and `"crates/pubky-advanced"` from `[workspace] members`
   - Remove the Tier 2 classification comment lines that mention trustedge-pubky, trustedge-pubky-advanced (and trustedge-wasm if only listed in Tier 2)
   - Simplify the Crate Classification comment to just list the workspace crates without tier labels, or remove the tier system entirely per user decision ("drop Tier 1/Tier 2 classification since experimental crates are in a separate workspace")

2. Remove workspace deps that are ONLY used by pubky crates (not by any remaining workspace member). The candidates are:
   - `pubky = "0.5.4"` — only used by pubky crates
   - `rsa = { version = "0.9.10", features = ["pem"] }` — check if trustedge-core still uses it (it does, for hybrid.rs via Pubky). Actually, trustedge-core Cargo.toml needs checking. Read `crates/core/Cargo.toml` to verify which of these are still used.
   - `x25519-dalek` — check if trustedge-core uses it directly
   - `hkdf` — check if trustedge-core uses it directly

   For each candidate, grep `crates/` (excluding `crates/experimental/`) for usage. Only remove from `[workspace.dependencies]` if no remaining crate uses it.

3. Run `cargo build --workspace --bins --no-default-features` to verify root workspace still builds.

4. Run `cargo test --workspace --no-default-features --locked` to verify tests pass.

5. If cargo-machete is available, run `cargo machete` on root workspace to find any other unused deps.

6. Record the new dependency tree count: `cargo tree --workspace --depth 1 --prefix none --no-dedupe 2>/dev/null | sort -u | wc -l`. This is the new baseline for ci-check.sh Step 21 (to be updated in Plan 03).
  </action>
  <verify>
- `cargo build --workspace --bins --no-default-features` succeeds
- `cargo test -p trustedge-core --lib` passes
- `grep -c 'name = "trustedge-pubky"' Cargo.lock` returns 0
- Root Cargo.toml no longer has `pubky = "0.5.4"` in workspace.dependencies
  </verify>
  <done>Root workspace is free of pubky crate references, unused workspace deps are removed, and the dependency tree is smaller. New baseline count is recorded for Plan 03 to update in CI.</done>
</task>

</tasks>

<verification>
- `crates/experimental/` contains pubky and pubky-advanced with their own workspace Cargo.toml
- `crates/experimental/.gitignore` ignores Cargo.lock
- Root `Cargo.toml` has no pubky crate members or pubky-only workspace deps
- `cargo build --workspace` succeeds (root workspace)
- `cd crates/experimental && cargo build` succeeds (experimental workspace)
- Root `Cargo.lock` does not contain `trustedge-pubky` or `trustedge-pubky-advanced` as package names
</verification>

<success_criteria>
Pubky crates are fully isolated in their own experimental workspace. Their heavy transitive deps (pubky, possibly rsa, x25519-dalek) are absent from the root Cargo.lock. Unused workspace-level deps are cleaned. Both workspaces build successfully.
</success_criteria>

<output>
After completion, create `.planning/phases/32-workspace-cleanup/32-02-SUMMARY.md`
</output>
