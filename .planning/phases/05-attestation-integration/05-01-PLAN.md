<!--
Copyright (c) 2025 TRUSTEDGE LABS LLC
MPL-2.0: https://mozilla.org/MPL/2.0/
Project: trustedge — Privacy and trust at the edge.
GitHub: https://github.com/TrustEdge-Labs/trustedge
-->


---
phase: 05-attestation-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/core/src/applications/attestation/mod.rs
  - crates/core/src/applications/mod.rs
  - crates/core/src/lib.rs
  - crates/core/Cargo.toml
  - crates/core/examples/attest.rs
  - crates/core/examples/verify_attestation.rs
  - crates/core/examples/attestation_demo.rs
  - crates/attestation/src/lib.rs
  - crates/attestation/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "All 10 attestation lib tests pass inside trustedge-core (cargo test -p trustedge-core --lib -- applications::attestation)"
    - "Attestation types and functions are importable from trustedge_core crate root (Attestation, AttestationConfig, AttestationResult, OutputFormat, KeySource, VerificationConfig, VerificationResult, VerificationDetails, VerificationInfo, create_signed_attestation, verify_attestation)"
    - "No circular dependencies in trustedge-core module graph (cargo modules --acyclic)"
    - "Full workspace builds and all tests pass (cargo test --workspace)"
    - "Attestation examples are runnable (cargo run -p trustedge-core --example attestation_demo)"
    - "Envelope integration is direct (no feature flag gating -- Envelope is always available inside core)"
  artifacts:
    - path: "crates/core/src/applications/attestation/mod.rs"
      provides: "Attestation implementation (structs, create, verify, sealed envelope)"
      contains: "pub struct Attestation"
    - path: "crates/core/src/applications/mod.rs"
      provides: "Layer 4 module declaration including attestation"
      contains: "pub mod attestation"
    - path: "crates/core/examples/attestation_demo.rs"
      provides: "Runnable attestation demo example"
      contains: "fn main"
    - path: "crates/core/examples/attest.rs"
      provides: "CLI-style attest tool as cargo example"
      contains: "fn main"
    - path: "crates/core/examples/verify_attestation.rs"
      provides: "CLI-style verify tool as cargo example"
      contains: "fn main"
  key_links:
    - from: "crates/core/src/applications/attestation/mod.rs"
      to: "crates/core/src/envelope.rs"
      via: "crate::Envelope import (direct, no feature gate)"
      pattern: "use crate::Envelope"
    - from: "crates/core/src/lib.rs"
      to: "crates/core/src/applications/attestation/mod.rs"
      via: "pub use re-export"
      pattern: "pub use applications::attestation"
---

<objective>
Move the attestation crate (826 LOC, 10 lib tests, 2 CLI binaries, 1 example) into trustedge-core at applications/attestation/, preserving all tests, adding crate-root re-exports, and converting binaries and demo to cargo examples.

Purpose: Consolidate the software attestation system into the monolithic core, eliminating the separate crate while maintaining full API access through core's public interface. Follow the proven Phase 4 receipts migration pattern exactly.
Output: Attestation code lives in core, all 10 lib tests pass, 3 examples work (attest, verify_attestation, attestation_demo), no circular dependencies.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-attestation-integration/05-RESEARCH.md
@.planning/phases/04-receipts-integration/04-01-SUMMARY.md
@crates/attestation/src/lib.rs
@crates/attestation/src/bin/attest.rs
@crates/attestation/src/bin/verify.rs
@crates/attestation/examples/attestation_demo.rs
@crates/attestation/Cargo.toml
@crates/core/src/lib.rs
@crates/core/src/applications/mod.rs
@crates/core/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move attestation implementation into core applications layer</name>
  <files>
    crates/core/src/applications/attestation/mod.rs
    crates/core/src/applications/mod.rs
    crates/core/src/lib.rs
    crates/core/Cargo.toml
  </files>
  <action>
    Move the attestation implementation into trustedge-core's application layer:

    1. **Add git2 dependency to core Cargo.toml:**
       - Add `git2 = { workspace = true }` to the `[dependencies]` section (attestation uses git2 for source commit hash capture; it's in the workspace but not yet in core).
       - Do NOT add clap -- it's already in core's deps. Do NOT add tempfile as a dep -- it's already in dev-deps.

    2. **Create the attestation module directory and file:**
       - `mkdir -p crates/core/src/applications/attestation/`
       - `git mv crates/attestation/src/lib.rs crates/core/src/applications/attestation/mod.rs`
       - This preserves git history for the file.

    3. **Update imports in the moved file** (`crates/core/src/applications/attestation/mod.rs`):

       **Critical: Remove feature gates for envelope.** Inside core, `Envelope` is always available (it's defined in `crate::envelope`). The `#[cfg(feature = "envelope")]` feature flag only existed because attestation was a *separate* crate with an *optional* dependency on trustedge-core. Inside core, this gating is meaningless and would require creating an artificial `envelope` feature in core.

       Changes to make:
       - Change `use trustedge_core::Envelope;` to `use crate::Envelope;` (in `create_sealed_attestation` and `read_envelope_attestation` functions)
       - **Remove** `#[cfg(feature = "envelope")]` from `create_sealed_attestation` function
       - **Remove** the entire `#[cfg(not(feature = "envelope"))]` version of `create_sealed_attestation` (the JSON fallback when envelope is unavailable -- this scenario can't happen inside core)
       - **Remove** `#[cfg(feature = "envelope")]` from `read_envelope_attestation` function
       - In `verify_attestation`, remove the `#[cfg(feature = "envelope")]` / `#[cfg(not(feature = "envelope"))]` conditional blocks and keep only the envelope path (try envelope first, fallback to JSON)
       - **Remove** `#[cfg(feature = "envelope")]` and `#[cfg(not(feature = "envelope"))]` from tests:
         - `test_centralized_envelope_attestation` -- remove `#[cfg(feature = "envelope")]`, keep the test
         - `test_provided_key_source` -- remove `#[cfg(feature = "envelope")]`, keep the test
         - **Delete** `test_provided_key_source_json_fallback` entirely (tests a scenario impossible inside core)
         - **Delete** `test_sealed_envelope_fallback_without_feature` entirely (tests a scenario impossible inside core)
       - Update the module-level doc comments: change `trustedge_attestation` references to `trustedge_core::applications::attestation`
       - Update the doc example `use trustedge_attestation::{...}` to `use trustedge_core::{...}`

       After these changes: 10 lib tests remain (8 always-on + 2 formerly envelope-gated, now always-on). The 2 `not(feature = "envelope")` tests are deleted as dead code.

    4. **Declare the attestation module in applications/mod.rs:**
       - Add `pub mod attestation;` to `crates/core/src/applications/mod.rs`
       - Update the Status section in the doc comment to add attestation as live:
         `- ✔ attestation/ - Software attestation with cryptographic provenance (826 LOC, 10 tests)`

    5. **Add re-exports to core lib.rs:**
       - Add to the re-export section in `crates/core/src/lib.rs` (after the receipts re-exports):
         ```rust
         // Attestation system re-exports (Layer 4 applications)
         pub use applications::attestation::{
             Attestation, AttestationConfig, AttestationResult,
             OutputFormat, KeySource, VerificationConfig, VerificationResult,
             VerificationDetails, VerificationInfo,
             create_signed_attestation, verify_attestation,
         };
         ```

    6. **Verify the move compiles:**
       - `cargo check -p trustedge-core` must succeed
       - `cargo test -p trustedge-core --lib -- applications::attestation` must run all 10 tests

    **Important:** Do NOT modify the attestation crate yet (Cargo.toml changes and facade are Task 2). The separate crate still needs to compile for workspace validation in Task 2.
  </action>
  <verify>
    - `cargo check -p trustedge-core` compiles without errors
    - `cargo test -p trustedge-core --lib -- applications::attestation 2>&1 | grep "test result:"` shows "10 passed"
    - `grep "pub mod attestation" crates/core/src/applications/mod.rs` finds the declaration
    - `grep "pub use applications::attestation" crates/core/src/lib.rs` finds the re-exports
    - `grep "git2" crates/core/Cargo.toml` confirms git2 dependency added
    - No `#[cfg(feature = "envelope")]` remains in `crates/core/src/applications/attestation/mod.rs` (grep confirms 0 matches)
  </verify>
  <done>
    Attestation implementation (826 LOC) lives at crates/core/src/applications/attestation/mod.rs with all 10 lib tests passing. All feature gates for envelope removed (Envelope always available inside core). All attestation types and functions importable from trustedge_core crate root. git2 dependency added to core.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert binaries to examples, create facade, validate workspace</name>
  <files>
    crates/core/examples/attest.rs
    crates/core/examples/verify_attestation.rs
    crates/core/examples/attestation_demo.rs
    crates/attestation/src/lib.rs
    crates/attestation/Cargo.toml
  </files>
  <action>
    Move CLI binaries and demo to cargo examples, create backward-compatibility facade, validate full workspace:

    1. **Move attest.rs to core examples:**
       - `git mv crates/attestation/src/bin/attest.rs crates/core/examples/attest.rs`
       - Update imports in the moved file:
         - Change `use trustedge_attestation::{create_signed_attestation, AttestationConfig, KeySource, OutputFormat};` to `use trustedge_core::{create_signed_attestation, AttestationConfig, KeySource, OutputFormat};`
       - **Remove** `#[cfg(feature = "envelope")]` and `#[cfg(not(feature = "envelope"))]` blocks in the success message section. Keep only the envelope version of the success message (since Envelope is always available in core). The `#[cfg(not(feature = "envelope"))]` note about installing with --features envelope is no longer relevant.
       - Keep the copyright header (preserved from git mv).

    2. **Move verify.rs to core examples:**
       - `git mv crates/attestation/src/bin/verify.rs crates/core/examples/verify_attestation.rs`
       - Note: renamed to `verify_attestation.rs` to avoid potential name collision with other verify examples.
       - Update imports:
         - Change `use trustedge_attestation::{verify_attestation, VerificationConfig};` to `use trustedge_core::{verify_attestation, VerificationConfig};`
       - **Remove** `#[cfg(feature = "envelope")]` and `#[cfg(not(feature = "envelope"))]` blocks in the progress message section. Keep only the envelope version.
       - Keep the copyright header.

    3. **Move attestation_demo.rs to core examples:**
       - `git mv crates/attestation/examples/attestation_demo.rs crates/core/examples/attestation_demo.rs`
       - Update imports:
         - Change `use trustedge_attestation::{create_signed_attestation, AttestationConfig, KeySource, OutputFormat};` to `use trustedge_core::{create_signed_attestation, AttestationConfig, KeySource, OutputFormat};`
       - **Remove** `#[cfg(feature = "envelope")]` and `#[cfg(not(feature = "envelope"))]` blocks. The sealed envelope section should always run (no conditional compilation). Remove the "not envelope" message about enabling the feature.
       - Update the final println to say "Use the cargo examples (attest/verify_attestation) for CLI use." instead of referencing trustedge-attest/trustedge-verify binaries.
       - Keep the copyright header.

    4. **Create stub lib.rs for attestation crate (backward-compat facade):**
       - Replace `crates/attestation/src/lib.rs` with a minimal re-export file:
         ```rust
         //
         // Copyright (c) 2025 TRUSTEDGE LABS LLC
         // This source code is subject to the terms of the Mozilla Public License, v. 2.0.
         // If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
         //
         // Project: trustedge — Privacy and trust at the edge.
         //

         //! # TrustEdge Attestation
         //!
         //! **DEPRECATED:** Attestation functionality has moved to `trustedge_core::applications::attestation`.
         //! This crate re-exports from core for backward compatibility.
         //! It will be fully deprecated in Phase 7.

         pub use trustedge_core::{
             Attestation, AttestationConfig, AttestationResult,
             OutputFormat, KeySource, VerificationConfig, VerificationResult,
             VerificationDetails, VerificationInfo,
             create_signed_attestation, verify_attestation,
         };
         ```

    5. **Update attestation Cargo.toml:**
       - Remove both `[[bin]]` sections (attest.rs and verify.rs no longer exist there)
       - Delete the now-empty `crates/attestation/src/bin/` directory: `rm -rf crates/attestation/src/bin/`
       - Delete the now-empty `crates/attestation/examples/` directory: `rm -rf crates/attestation/examples/`
       - Make `trustedge-core` a required dependency (not optional): change `trustedge-core = { path = "../core", optional = true }` to `trustedge-core = { path = "../core" }`
       - Remove the `[features]` section entirely (no more envelope feature needed -- facade just re-exports from core)
       - Remove dependencies only needed by the implementation (they're now in core): `sha2`, `chrono`, `git2`, `bincode`, `clap`, `ed25519-dalek`, `rand`, `thiserror`, `hex`, `tempfile` (from both deps and dev-deps). Keep only: `anyhow`, `serde`, `serde_json`, `trustedge-core`.

         Actually, be conservative: keep `anyhow`, `serde`, `serde_json`, and `trustedge-core` as dependencies. The facade only needs trustedge-core for re-exports, but keeping serde/anyhow avoids breaking any downstream that might import them through this crate. Remove all others.

    6. **Verify no circular dependencies:**
       - `cargo modules dependencies --lib -p trustedge-core --acyclic` (should succeed)

    7. **Full workspace validation:**
       - `cargo check --workspace` -- all crates compile
       - `cargo test --workspace` -- all tests pass
       - `cargo clippy --workspace -- -D warnings` -- clean
       - `cargo run -p trustedge-core --example attestation_demo` -- demo runs
       - `cargo run -p trustedge-core --example attest -- --help` -- CLI help shows
       - `cargo run -p trustedge-core --example verify_attestation -- --help` -- CLI help shows

    8. **Verify test count integrity:**
       - `cargo test -p trustedge-core --lib -- applications::attestation` -- 10 passed
       - `cargo test -p trustedge-attestation` -- 0 tests (re-export facade only)
       - Total workspace test count should be approximately the same (10 lib tests moved from attestation to core; 2 cfg(not) tests removed as dead code)
  </action>
  <verify>
    - `cargo run -p trustedge-core --example attestation_demo` runs without error
    - `cargo run -p trustedge-core --example attest -- --help` shows CLI help
    - `cargo run -p trustedge-core --example verify_attestation -- --help` shows CLI help
    - `cargo check --workspace` succeeds
    - `cargo test --workspace 2>&1 | grep "test result:"` shows all tests passing
    - `cargo clippy --workspace -- -D warnings` succeeds
    - `cargo modules dependencies --lib -p trustedge-core --acyclic` shows no cycles
    - `ls crates/attestation/src/bin/` fails (directory removed)
    - `ls crates/attestation/examples/` fails (directory removed)
    - `ls crates/core/examples/attest.rs crates/core/examples/verify_attestation.rs crates/core/examples/attestation_demo.rs` succeeds
    - No `#[cfg(feature = "envelope")]` in any moved example files
  </verify>
  <done>
    CLI binaries converted to cargo examples (attest.rs, verify_attestation.rs, attestation_demo.rs). Attestation crate reduced to thin re-export facade. Full workspace compiles, all tests pass (10 attestation tests in core, 0 in attestation crate), no circular dependencies, clippy clean. All feature gates removed from examples.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p trustedge-core --lib -- applications::attestation` -- 10 tests pass
2. `cargo test --workspace` -- total test count stable (attestation tests moved to core)
3. `cargo modules dependencies --lib -p trustedge-core --acyclic` -- no cycles
4. `cargo run -p trustedge-core --example attestation_demo` -- demo executes
5. `cargo run -p trustedge-core --example attest -- --help` -- shows CLI help
6. `cargo run -p trustedge-core --example verify_attestation -- --help` -- shows CLI help
7. `cargo clippy --workspace -- -D warnings` -- clean
8. Attestation types importable: `use trustedge_core::{Attestation, create_signed_attestation, verify_attestation};`
9. No `#[cfg(feature = "envelope")]` remains in any migrated file (core module or examples)
</verification>

<success_criteria>
- All 10 attestation lib tests pass inside trustedge-core
- Attestation structs and functions available at crate root (pub use re-exports)
- No circular dependencies in core module graph
- All 3 examples runnable (attestation_demo, attest, verify_attestation)
- Full workspace builds clean (check + clippy + test)
- Attestation crate still compiles as thin re-export facade
- Envelope integration is direct (no feature flag gating inside core)
- git2 dependency added to core for source commit hash capture
</success_criteria>

<output>
After completion, create `.planning/phases/05-attestation-integration/05-01-SUMMARY.md`
</output>
